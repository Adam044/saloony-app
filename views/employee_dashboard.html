<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="/offline-detect.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Saloony - Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
  <!-- NOTE: Assuming dashboard.css and admin.css are not essential for styling the *new* components -->
  <link rel="stylesheet" href="/admin/assets/dashboard.css">
  <link rel="stylesheet" href="/admin/assets/admin.css">
  <style>
    /* Global Variables & Colors */
    :root {
      --color-primary: #1E293B; /* Dark Blue */
      --color-secondary: #06C167; /* Green Accent */
      --tier-bronze: #CC8757; /* Richer Bronze */
      --tier-silver: #A9B3BD; /* Polished Silver */
      --tier-gold: #FFC72C; /* Bright Gold */
      --tier-diamond: #4FD1C5; /* Aqua/Teal for Elite */
    }
    /* Base Styles */
    body { background-color: #f8fafc; } /* Light background for integrated feel */
    .bg-primary-dark { background-color: var(--color-primary); }
    .text-primary-dark { color: var(--color-primary); }
    .text-secondary { color: var(--color-secondary); }
    .bg-secondary { background-color: var(--color-secondary); }
    .bg-secondary-soft { background-color: rgba(6, 193, 103, 0.08); }
    .border-secondary { border-color: var(--color-secondary); }
    
    /* Bottom nav active styling */
    #bottom-nav { border-top: 1px solid #e2e8f0; }
    #bottom-nav .nav-item.nav-active { color: var(--color-secondary); background-color: rgba(6, 193, 103, 0.10); }
    
    /* Card Polish - Sleeker and more unified */
    .card { background: #ffffff; border-radius: 14px; padding: 16px; margin-bottom: 12px; }
    .card.modern { box-shadow: 0 4px 10px rgba(30,41,59,0.05); transition: transform .15s ease, box-shadow .15s ease; }
    .kpi-card .label { font-weight: 600; color: #4b5563; }
    .kpi-card .value { font-weight: 800; color: var(--color-primary); font-size: 1.5rem; }
    .section-title { font-weight: 800; color: var(--color-primary); margin-bottom: 8px; font-size: 1.5rem; }
    
    /* Grid Layouts */
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    
    /* Buttons */
    .btn-primary-soft { background:var(--color-secondary); color:#fff; border-radius:12px; padding:10px 14px; font-weight:700; box-shadow:0 6px 14px rgba(6,193,103,0.18); transition: transform .15s ease, box-shadow .15s ease; }
    .btn-primary-soft:hover { transform: translateY(-1px); box-shadow:0 8px 18px rgba(6,193,103,0.24); }

    /* NEW: Gamified Card Styling */
    .milestone-card {
        background: #ffffff;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        border: 2px solid #f0f4f8; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 1rem;
    }
    .milestone-card.claimable { 
        border: 2px solid var(--tier-gold); 
        box-shadow: 0 0 20px rgba(255, 199, 44, 0.5); 
        animation: neon-glow 1.5s infinite alternate; 
    }
    @keyframes neon-glow {
        from { box-shadow: 0 0 10px rgba(255, 199, 44, 0.3), 0 0 0 rgba(255, 199, 44, 0); }
        to { box-shadow: 0 0 20px rgba(255, 199, 44, 0.6), 0 0 5px rgba(255, 199, 44, 0.1); }
    }
    
    .tier-badge-icon {
        min-width: 44px; height: 44px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .tier-bronze .tier-badge-icon { background: var(--tier-bronze); }
    .tier-silver .tier-badge-icon { background: var(--tier-silver); }
    .tier-gold .tier-badge-icon { background: var(--tier-gold); }
    .tier-diamond .tier-badge-icon { background: var(--tier-diamond); }

    /* Progress Ring */
    .ring { position:relative; width:64px; height:64px; border-radius:50%; display:grid; place-items:center; background: conic-gradient(var(--color-secondary) 0% var(--pct, 0%), #e5e7eb var(--pct, 0%) 100%); }
    .ring .ring-val { font-weight:800; color:#0b1320; font-size:12px; }

    /* NEW: The Ascent Progress Bar (Hero Component) */
    .ascent-container {
        position: relative;
        min-height: 140px;
        background: var(--color-primary);
        border-radius: 18px;
        padding: 16px 20px;
        overflow: visible;
        box-shadow: inset 0 0 15px rgba(0,0,0,0.4), 0 4px 15px rgba(0,0,0,0.2);
        background-image: linear-gradient(135deg, #1E293B, #111827);
        margin-bottom: 20px;
    }
    .ascent-track {
        height: 40px;
        background: #2D3A4B; 
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.4) inset;
    }
    .ascent-fill {
        height: 100%;
        background: linear-gradient(90deg, #14b8a6, var(--color-secondary)); 
        width: 0%;
        transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        position: relative;
    }
    .ascent-marker {
        position: absolute;
        top: 0;
        transform: translate(-50%, -15px);
        font-size: 10px;
        color: #fff;
        font-weight: 700;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    .ascent-icon {
        position: absolute;
        height: 50px;
        width: 50px;
        top: -5px;
        left: var(--icon-pos, 0%);
        transform: translateX(-50%);
        transition: left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 0 15px rgba(6, 193, 103, 0.8), 0 0 3px rgba(0,0,0,0.3);
        z-index: 10;
        color: var(--color-primary);
        font-size: 24px;
        animation: progress-pulse 0.5s ease-in-out;
    }
    @keyframes progress-pulse { 0%{ transform: translateX(-50%) scale(1)} 50%{ transform: translateX(-50%) scale(1.1)} 100%{ transform: translateX(-50%) scale(1)} }

    .next-reward-callout {
        color: #fff;
        text-align: center;
        margin-top: 12px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .next-reward-amount {
        font-size: 1.25rem;
        color: var(--tier-gold);
        margin-right: 4px;
    }
    .pulse { animation: pulse .8s ease; }
    @keyframes pulse { 0%{ transform:scale(1)} 50%{ transform:scale(1.03)} 100%{ transform:scale(1)} }
    
  </style>
</head>
<body class="modal-closed page-transition page-fade-in">

<div class="min-h-screen flex flex-col" style="padding-bottom: 80px;">
  <!-- App Header (same as home_user/home_salon) -->
  <header id="app-header" class="bg-primary-dark shadow-lg p-2 w-full z-20" style="padding-top: env(safe-area-inset-top);">
    <div class="flex justify-between items-center">
      <div class="flex items-center pl-8 pr-4">
        <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1E293B/ffffff?text=EMP';" alt="Ø´Ø¹Ø§Ø± ØµØ§Ù„ÙˆÙ†ÙŠ" class="w-12 h-12 object-contain object-center scale-[2.5]">
      </div>
      <div class="flex items-center gap-2">
        <button id="logout-btn" class="text-white/80 hover:text-red-400 transition duration-150 p-2 rounded-lg hover:bg-white/10">
          <i class="fas fa-sign-out-alt text-lg"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow pt-[60px] w-full p-4"> <!-- Added p-4 to main for mobile padding -->
    <canvas id="confetti-canvas" style="position:fixed;inset:0;pointer-events:none;z-index:9999"></canvas>
    <!-- Motivational Today View -->
    <div id="message-box" class="hidden p-3 mb-4 text-center rounded-xl font-medium" role="alert"></div>

    <!-- Tab: Today -->
    <section class="card kpi-card view-content" id="today-view" style="padding: 16px;">
      <div class="flex justify-between items-center">
        <div>
          <div class="label text-xl font-extrabold" style="color:var(--color-primary)">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="emp-name" style="color:#0b1320"></span></div>
          <div class="muted text-sm flex items-center gap-1">Ù„Ù†Ø¨Ù†ÙŠ ÙŠÙˆÙ…Ù†Ø§ Ø¨Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© <i class="fas fa-fist-raised text-yellow-500"></i></div>
    </section>

    <!-- Today summary KPIs -->
  <section class="grid grid-2 view-content" id="today-summary">
    <div class="card kpi-card modern">
      <div class="label">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="flex justify-end">
        <div id="ring-visits" class="ring" style="--pct:0%"><span id="ring-visits-val" class="ring-val">0/15</span></div>
      </div>
    </div>
    <div class="card kpi-card modern">
      <div class="label">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</div>
      <div class="value text-2xl" id="kpi-last">â€”</div>
    </div>
  </section>

    <!-- Today Registrations and Commissions -->
  <section class="grid grid-2 view-content" id="today-kpis" style="margin-top:0;">
    <div class="card kpi-card modern">
      <div class="label">Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="flex justify-end">
        <div id="ring-signups" class="ring" style="--pct:0%"><span id="ring-signups-val" class="ring-val">0/2</span></div>
      </div>
    </div>
      <div class="card kpi-card modern">
        <div class="label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="value text-2xl" id="kpi-commission-today">â‚ª0</div>
      </div>
    </section>

    <!-- Visits list -->
    <section class="card view-content" id="today-visits">
      <div class="card-header flex justify-between items-center mb-3">
        <span class="text-lg font-bold">Ø³Ø¬Ù„ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
        <button id="new-visit-btn" class="btn btn-outline bg-secondary text-white rounded-lg px-3 py-1 text-sm font-medium hover:bg-green-600 transition duration-150"><i class="fas fa-plus mr-1"></i><span>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</span></button>
      </div>
      <div id="visits-list">
        <p class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>
      </div>
    </section>

    <!-- Tab: Visits (employee) -->
    <section id="visits-view" class="view-content hidden" style="margin-top:0;padding-top:0">
      <div class="analytics-header mb-3">
        <div class="section-title text-xl" style="color:var(--color-primary)">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <input id="emp-visits-search" class="input w-full min-w-0 border rounded-lg p-2" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµØ§Ù„ÙˆÙ†">
        <input id="emp-visits-from" type="date" class="input w-full min-w-0 border rounded-lg p-2">
        <input id="emp-visits-to" type="date" class="input w-full min-w-0 border rounded-lg p-2">
        <input id="emp-visits-il-min" type="number" min="0" max="10" class="input w-full min-w-0 border rounded-lg p-2" placeholder="Ø£Ø¯Ù†Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…">
        <input id="emp-visits-il-max" type="number" min="0" max="10" class="input w-full min-w-0 border rounded-lg p-2" placeholder="Ø£Ø¹Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
        <select id="emp-visits-status" class="input w-full min-w-0 border rounded-lg p-2">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="activated">ğŸŸ¢ Ù…ÙØ¹Ù‘Ù„ (Ù…Ø¯ÙÙˆØ¹)</option>
          <option value="signed_up">ğŸŸ¡ Ù…Ø³Ø¬Ù‘Ù„</option>
          <option value="interested">ğŸ•“ Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø± Ø¨Ø¹Ø¯</option>
          <option value="not_interested">ğŸ”´ ØºÙŠØ± Ù…Ù‡ØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹</option>
        </select>
        <label class="flex items-center gap-2">
          <input id="emp-visits-has-comments" type="checkbox">
          <span class="muted">ÙÙ‚Ø· Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
        </label>
      </div>
      <div id="emp-visits-list" class="table-wrapper p-3 mt-2"><p class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p></div>
    </section>

    <!-- Tab: Analytics & Revenue -->
    <section id="analytics-view" class="view-content hidden" style="margin-top:0;padding-top:0">
      <div class="analytics-header">
        <div class="section-title text-2xl"><i class="fas fa-chart-line text-blue-500 ml-2"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
        <div class="analytics-subtitle">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
      </div>
      <div class="grid gap-3" style="grid-template-columns: 160px 160px; margin-top:12px">
        <input id="emp-date-from" type="date" class="input w-full min-w-0 border rounded-lg p-2">
        <input id="emp-date-to" type="date" class="input w-full min-w-0 border rounded-lg p-2">
      </div>
      <div id="emp-range-kpis" class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3" style="margin-top:12px">
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-store text-secondary ml-1"></i> Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div><div class="value text-2xl" id="emp-range-visits-count">0</div></div>
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-check-circle text-green-500 ml-1"></i> ØªÙØ¹ÙŠÙ„Ø§Øª</div><div class="value text-2xl" id="emp-range-acts">0</div></div>
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-user-plus text-amber-500 ml-1"></i> Ù…Ø³Ø¬Ù‘Ù„</div><div class="value text-2xl" id="emp-range-int-registered">0</div></div>
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-hourglass-half text-blue-500 ml-1"></i> Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø±</div><div class="value text-2xl" id="emp-range-int-needs">0</div></div>
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-times-circle text-red-500 ml-1"></i> ØºÙŠØ± Ù…Ù‡ØªÙ…ÙˆÙ†</div><div class="value text-2xl" id="emp-range-no">0</div></div>
        <div class="card kpi-card modern"><div class="label"><i class="fas fa-money-bill-wave text-green-600 ml-1"></i> Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</div><div class="value text-2xl" id="emp-range-rev">â‚ª0</div></div>
      </div>
      
    </section>

    <!-- Tab: Milestones -->
    <section id="milestones-view" class="view-content hidden">
      <!-- Motivational Title: Operation Peak Performance -->
      <div class="analytics-header mb-4">
        <div class="section-title text-2xl" style="color:var(--color-primary)"><i class="fas fa-fighter-jet text-blue-500 ml-2"></i> Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ§Øª (Sales Quest)</div>
        <div class="muted text-sm">ÙƒÙ„ ØªÙØ¹ÙŠÙ„ ÙŠÙ‚Ø±Ù‘Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ù…Ù‰ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©!</div>
      </div>
      
      <div id="milestones-cta" class="milestone-cta modern" style="display:none">
        <div>
          <div class="label" style="font-size:1.1rem">Ø§Ø¨Ø¯Ø£ Ù…Ù‡Ù…Ø© Ø§Ù„ØµØ¹ÙˆØ¯ Ø§Ù„Ø¢Ù†!</div>
          <div class="muted text-sm">Ø³ØªÙ…ØªØ¯ Ø¯ÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª 60 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† Ù„Ø­Ø¸Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.</div>
        </div>
        <button id="milestones-start" class="btn-primary-soft"><i class="fas fa-rocket ml-2"></i> Ø§Ù†Ø·Ù„Ù‚</button>
      </div>

      <div id="milestones-content" style="display:none">
        
        <!-- Ascent Progress Bar (Hero Component) -->
        <div class="ascent-container">
          <div class="flex justify-between text-white font-bold mb-2">
            <span id="milestones-acts-hero">0 / 125 ØªÙØ¹ÙŠÙ„</span>
            <span id="milestones-days-left-hero"></span>
          </div>
          <div class="ascent-track">
            <!-- Markers -->
            <div class="ascent-marker" style="left: 10%;"><i class="fas fa-circle-notch"></i> 10</div>
            <div class="ascent-marker" style="left: 25%;"><i class="fas fa-circle-notch"></i> 25</div>
            <div class="ascent-marker" style="left: 60%;"><i class="fas fa-circle-notch"></i> 75</div>
            <div class="ascent-marker" style="left: 98%;">125 <i class="fas fa-trophy text-yellow-300"></i></div>
            <!-- Progress Fill -->
            <div id="milestones-ascent-fill" class="ascent-fill">
              <!-- Icon tracks the progress -->
              <div id="ascent-icon" class="ascent-icon" style="--icon-pos: 0%;"><i class="fas fa-star"></i></div>
            </div>
          </div>
          <!-- Next Reward Callout -->
          <div id="milestones-next-goal-hero" class="next-reward-callout"></div>
        </div>
        
        <!-- Quest Log / Milestone Cards -->
      <div id="milestone-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Cards will be populated by JS -->
      </div>

    </div>
  </section>

  <section id="helpful-view" class="view-content hidden">
    <div class="card modern p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="inline-flex items-center gap-2 text-gray-600"><i class="fas fa-hands-helping"></i><span>Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©</span></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <a href="tel:+970594444403" class="btn w-full"><i class="fas fa-phone"></i><span>Ø§ØªØµÙ„ Ø¨Ù€ Ø¢Ø¯Ù… Ø­ÙˆØ§Ø´ (IT)</span></a>
        <a href="tel:+972595522004" class="btn w-full"><i class="fas fa-phone"></i><span>Ø§ØªØµÙ„ Ø¨Ù€ Ø§Ø³Ø§Ù…Ø© Ø§Ù„ØµÙŠÙÙŠ (Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)</span></a>
        <a href="/views/salon_marketing.html" class="btn w-full"><i class="fas fa-info-circle"></i><span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚</span></a>
        <a href="/views/pricing.html" class="btn w-full"><i class="fas fa-tags"></i><span>Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span></a>
      </div>
      </div>
    </div>
  </section>

  <!-- Employee Visit Details Modal -->
  <div id="emp-visit-details-modal" class="hidden fixed inset-0 bg-black/40 z-[100000]">
    <div class="max-w-md mx-auto mt-24 bg-white rounded-2xl shadow-2xl p-4">
      <div class="flex justify-between items-center mb-2">
        <div class="text-lg font-extrabold" style="color:var(--color-primary)">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</div>
        <button id="emp-visit-modal-close" class="btn"><i class="fas fa-times"></i><span>Ø¥ØºÙ„Ø§Ù‚</span></button>
      </div>
      <div class="space-y-3 text-sm">
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-store"></i><span>Ø§Ù„ØµØ§Ù„ÙˆÙ†</span></div>
          <span id="emp-md-salon" class="font-semibold">â€”</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-calendar-day"></i><span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span></div>
          <span id="emp-md-time" class="font-semibold">â€”</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-tag"></i><span>Ø§Ù„Ø­Ø§Ù„Ø©</span></div>
          <span id="emp-md-status" class="font-semibold">â€”</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-heart"></i><span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…</span></div>
          <span id="emp-md-interest" class="font-semibold">â€”</span>
        </div>
        <div>
          <div class="inline-flex items-center gap-2 text-gray-500 mb-1"><i class="fas fa-comment-dots"></i><span>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span></div>
          <div id="emp-md-comments" class="text-gray-700 whitespace-pre-wrap break-words"></div>
        </div>
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-map-signs"></i><span>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span></div>
          <span id="emp-md-address" class="font-semibold">â€”</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="inline-flex items-center gap-2 text-gray-500"><i class="fas fa-location-dot"></i><span>Ø§Ù„Ù…ÙˆÙ‚Ø¹</span></div>
          <div class="inline-flex items-center gap-2">
            <span id="emp-md-location-name" class="font-semibold">â€”</span>
            <button id="emp-md-open-map" class="btn"><i class="fas fa-directions"></i><span>Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  </main>

  <!-- New Visit Modal -->
  <div id="visit-modal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <strong>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</strong>
        <button id="visit-cancel" class="btn btn-outline"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="grid grid-2">
          <div>
            <label class="muted">Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
            <select id="visit-type" class="w-full border rounded-lg p-2">
              <option value="first">Ø²ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ù‰</option>
              <option value="follow_up">Ù…ØªØ§Ø¨Ø¹Ø©</option>
            </select>
          </div>
          <div></div>
          <div>
            <label class="muted">Ø§Ø³Ù… Ø§Ù„ØµØ§Ù„ÙˆÙ†</label>
            <input id="visit-salon" class="w-full border rounded-lg p-2" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµØ§Ù„ÙˆÙ†" />
            <select id="visit-salon-existing" class="w-full border rounded-lg p-2" style="display:none"></select>
            <label class="muted" style="margin-top:8px; display:block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="visit-address" class="w-full border rounded-lg p-2" placeholder="ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
          </div>
          <div>
            <label class="muted">3ï¸âƒ£ Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="visit-status" class="w-full border rounded-lg p-2">
              <option value="activated">Ù…ÙØ¹Ù‘Ù„ â€” Ù…Ø³Ø¬Ù‘Ù„ ÙˆÙ…Ø¯ÙÙˆØ¹</option>
              <option value="signed_up">Ù…Ø³Ø¬Ù‘Ù„ â€” Ù„Ù… ÙŠØ¯ÙØ¹ Ø¨Ø¹Ø¯</option>
              <option value="interested">Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø±</option>
              <option value="not_interested">ØºÙŠØ± Ù…Ù‡ØªÙ…</option>
            </select>
          </div>
          <div>
            <label class="muted">4ï¸âƒ£ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</label>
            <select id="visit-plan-pref" class="w-full border rounded-lg p-2">
              <option value="">â€”</option>
              <option value="booking">Ù†Ø¸Ø§Ù… Ø­Ø¬ÙˆØ²Ø§Øª</option>
              <option value="visibility_only">Ø¨Ø¯ÙˆÙ† Ø­Ø¬ÙˆØ²Ø§Øª (99/Ø´Ù‡Ø±ÙŠ)</option>
            </select>
            <div id="visit-plan-suboptions" class="mt-2 hidden">
              <label class="muted">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
              <select id="visit-plan-option" class="w-full border rounded-lg p-2">
                <option value="">â€”</option>
                <option value="monthly_200">Ø´Ù‡Ø±ÙŠ 200</option>
                <option value="monthly_60">Ù„ÙƒÙ„ ÙƒØ±Ø³ÙŠ (60)</option>
                <option value="per_booking">Ù„ÙƒÙ„ Ø­Ø¬Ø² (1)</option>
              </select>
            </div>
          </div>
        </div>
        <div style="margin-top:12px">
          <label class="muted">4ï¸âƒ£ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… (0â€“10)</label>
          <input type="range" id="visit-interest" min="0" max="10" value="5" class="w-full">
          <div class="muted">ğŸ¯ Ù…Ø¯Ù‰ Ø§Ù‡ØªÙ…Ø§Ù… ØµØ§Ø­Ø¨ Ø§Ù„ØµØ§Ù„ÙˆÙ†: <span id="interest-value">5</span>/10</div>
        </div>
        <input type="hidden" id="visit-lat">
        <input type="hidden" id="visit-lng">
        <label class="muted" style="margin-top:8px; display:block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="visit-comments" class="w-full border rounded-lg p-2" rows="3" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
        <div class="actions" style="margin-top:12px">
          <button id="visit-save" class="btn btn-accent"><i class="fas fa-check"></i><span>Ø­ÙØ¸</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Bar (Fixed, same style as home pages) -->
  <nav id="bottom-nav" class="bg-white/95 backdrop-blur-sm p-2 flex items-center justify-around shadow-2xl" 
       style="position: fixed !important; 
              bottom: 0 !important; 
              left: 0 !important; 
              right: 0 !important; 
              width: 100vw !important; 
              z-index: 99999 !important;
              min-height: 60px !important;
              box-sizing: border-box !important;
              margin: 0 !important;
              padding-bottom: env(safe-area-inset-bottom) !important;
              transform: none !important;">
    <button id="nav-today" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-secondary bg-secondary/10 nav-active" data-view="today-view">
      <i class="fas fa-home text-xl"></i>
      <span class="text-xs font-bold mt-1">Ø§Ù„ÙŠÙˆÙ…</span>
    </button>
    <button id="nav-milestones" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="milestones-view">
      <i class="fas fa-flag-checkered text-xl"></i> <!-- Changed icon -->
      <span class="text-xs font-medium mt-1">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</span>
    </button>
    <button id="nav-analytics" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="analytics-view">
      <i class="fas fa-chart-line text-xl"></i>
      <span class="text-xs font-medium mt-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</span>
    </button>
    <button id="nav-visits" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="visits-view">
      <i class="fas fa-store text-xl"></i>
      <span class="text-xs font-medium mt-1">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span>
    </button>
    <button id="nav-help" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="helpful-view">
      <i class="fas fa-life-ring text-xl"></i>
      <span class="text-xs font-medium mt-1">Ù…Ø³Ø§Ø¹Ø¯Ø©</span>
    </button>
  </nav>

  <script>
    // Employee Visits (range) rendering
    function renderEmployeeVisits() {
      const token = ensureEmployeeOrRedirect(); if (!token) return;
      const vf = document.getElementById('emp-visits-from'); const vt = document.getElementById('emp-visits-to');
      if (!vf || !vt) return;
      const from = vf.value; const to = vt.value;
      const q = (document.getElementById('emp-visits-search')?.value || '').trim().toLowerCase();
      const st = document.getElementById('emp-visits-status')?.value || '';
      const ilMinRaw = document.getElementById('emp-visits-il-min')?.value || '';
      const ilMaxRaw = document.getElementById('emp-visits-il-max')?.value || '';
      const ilMin = ilMinRaw === '' ? null : Math.max(0, Math.min(10, Number(ilMinRaw)));
      const ilMax = ilMaxRaw === '' ? null : Math.max(0, Math.min(10, Number(ilMaxRaw)));
      const onlyComments = !!document.getElementById('emp-visits-has-comments')?.checked;
      fetch(`/api/employee/analytics/range?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`, { headers: { 'Authorization': `Bearer ${token}` } })
        .then(r => r.json()).then(data => {
          let visits = data.visits || [];
          if (q) visits = visits.filter(v => String(v.salon_name||'').toLowerCase().includes(q));
          if (st) {
            visits = visits.filter(v => {
              const s = String(v.status||'').toLowerCase();
              if (st === 'activated') return s === 'activated';
              if (st === 'signed_up') return s === 'signed_up';
              if (st === 'interested') return s === 'interested';
              if (st === 'not_interested') return s === 'not_interested';
              return true;
            });
          }
          if (onlyComments) visits = visits.filter(v => (String(v.comments||'').trim().length > 0));
          if (ilMin !== null) visits = visits.filter(v => { const lv = (v.interest_level!==undefined && v.interest_level!==null) ? Number(v.interest_level) : (()=>{ try { const m=(String(v.comments||'').match(/Ø§Ù‡ØªÙ…Ø§Ù…:\s*(\d+)\/10/)); return m?Number(m[1]):NaN; } catch(_) { return NaN; } })(); return !isNaN(lv) && lv >= ilMin; });
          if (ilMax !== null) visits = visits.filter(v => { const lv = (v.interest_level!==undefined && v.interest_level!==null) ? Number(v.interest_level) : (()=>{ try { const m=(String(v.comments||'').match(/Ø§Ù‡ØªÙ…Ø§Ù…:\s*(\d+)\/10/)); return m?Number(m[1]):NaN; } catch(_) { return NaN; } })(); return !isNaN(lv) && lv <= ilMax; });
          const box = document.getElementById('emp-visits-list'); if (!box) return;
          if (visits.length === 0) box.innerHTML = '<p class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>';
          else {
            const cards = visits.map(v => {
              const dateOnly = new Date(v.visited_at).toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'2-digit'});
              const s = String(v.status||'').toLowerCase();
              const label = s === 'activated' ? 'ğŸŸ¢ Ù…ÙØ¹Ù‘Ù„ (Ù…Ø¯ÙÙˆØ¹)' : (s === 'signed_up' ? 'ğŸŸ¡ Ù…Ø³Ø¬Ù‘Ù„' : (s === 'interested' ? 'ğŸ•“ Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø± Ø¨Ø¹Ø¯' : 'ğŸ”´ ØºÙŠØ± Ù…Ù‡ØªÙ… Ø­Ø§Ù„ÙŠØ§Ù‹'));
              const color = label.startsWith('ğŸŸ¢') ? 'badge-green' : label.startsWith('ğŸ”´') ? 'badge-red' : 'badge-blue';
              const il = (v.interest_level!==undefined && v.interest_level!==null) ? Number(v.interest_level) : (()=>{ try { const m=(String(v.comments||'').match(/Ø§Ù‡ØªÙ…Ø§Ù…:\s*(\d+)\/10/)); return m?Number(m[1]):NaN; } catch(_) { return NaN; } })();
              const interestBadge = isNaN(il) ? '' : `<span class="badge" style="background: rgba(6,193,103,0.10); color:#06C167; border: 1px solid rgba(6,193,103,0.25);">${il}/10</span>`;
              return `
                <div class="card modern p-3 border border-gray-100">
                  <div class="flex justify-between items-start border-b pb-2 mb-2 border-gray-100">
                    <div class="inline-flex items-center gap-2 text-sm font-semibold text-gray-700"><i class="fas fa-store"></i><span>${(v.salon_name||'â€”').replace(/</g,'&lt;')}</span></div>
                    <div class="inline-flex items-center gap-2 text-xs text-gray-400"><i class="fas fa-calendar-day"></i><span>${dateOnly}</span></div>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <div class="flex items-center gap-2">
                      <span class="badge ${color}">${label}</span>
                      ${interestBadge}
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="btn" data-open-emp-modal="true" data-salon="${(v.salon_name||'').replace(/"/g,'&quot;')}" data-time="${dateOnly}" data-status="${label}" data-interest="${isNaN(il)?'':il}" data-comments="${(String(v.comments||'').replace(/</g,'&lt;')).replace(/"/g,'&quot;')}" data-address="${(v.address||'').replace(/"/g,'&quot;')}" data-lat="${v.lat||''}" data-lng="${v.lng||''}"><i class="fas fa-eye"></i><span>ØªÙØ§ØµÙŠÙ„</span></button>
                    </div>
                  </div>
                </div>`;
              }).join('');
            box.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">${cards}</div>`;
            box.querySelectorAll('[data-open-emp-modal="true"]').forEach(btn => {
              btn.addEventListener('click', () => {
                const m = document.getElementById('emp-visit-details-modal'); if (!m) return;
                m.querySelector('#emp-md-salon').textContent = btn.getAttribute('data-salon') || 'â€”';
                m.querySelector('#emp-md-time').textContent = btn.getAttribute('data-time') || 'â€”';
                m.querySelector('#emp-md-status').textContent = btn.getAttribute('data-status') || 'â€”';
                m.querySelector('#emp-md-interest').textContent = (btn.getAttribute('data-interest') || '') ? (btn.getAttribute('data-interest') + '/10') : 'â€”';
                m.querySelector('#emp-md-comments').textContent = btn.getAttribute('data-comments') || 'â€”';
                m.querySelector('#emp-md-address').textContent = btn.getAttribute('data-address') || 'â€”';
                const lat = btn.getAttribute('data-lat'); const lng = btn.getAttribute('data-lng');
                const nameEl = m.querySelector('#emp-md-location-name'); const mapBtn = m.querySelector('#emp-md-open-map');
                if (lat && lng) {
                  resolvePlaceName(Number(lat), Number(lng)).then(n => { if (nameEl) nameEl.textContent = n || `${lat},${lng}`; }).catch(()=> { if (nameEl) nameEl.textContent = `${lat},${lng}`; });
                  const url = buildDirectionsUrl(Number(lat), Number(lng), m.querySelector('#emp-md-salon')?.textContent || 'Ø§Ù„ØµØ§Ù„ÙˆÙ†');
                  if (mapBtn) {
                    mapBtn.classList.remove('hidden');
                    mapBtn.onclick = () => { try { mapBtn.classList.add('animate-pulse'); setTimeout(()=> mapBtn.classList.remove('animate-pulse'), 800); } catch(_){} window.location.href = url; };
                  }
                } else { if (nameEl) nameEl.textContent = 'â€”'; if (mapBtn) mapBtn.classList.add('hidden'); }
                m.classList.remove('hidden');
              });
            });
          }
        });
    }
    function showMessage(text, type='info') {
      const box = document.getElementById('message-box');
      box.textContent = text;
      box.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-3xl mx-auto';
      if (type === 'success') box.classList.add('bg-green-100','text-green-800');
      else if (type === 'error') box.classList.add('bg-red-100','text-red-800');
      else box.classList.add('bg-blue-100','text-blue-800');
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }

    function buildDirectionsUrl(lat, lng, label) {
      const ua = navigator.userAgent || '';
      const name = label || 'Ø§Ù„ØµØ§Ù„ÙˆÙ†';
      if (/iP(hone|ad|od)|Macintosh/.test(ua)) {
        if (lat && lng) return `maps://?daddr=${lat},${lng}&q=${encodeURIComponent(name)}`;
        return `maps://?q=${encodeURIComponent(name)}`;
      }
      if (/Android/i.test(ua)) {
        if (lat && lng) return `google.navigation:q=${lat},${lng}(${encodeURIComponent(name)})`;
        return `geo:0,0?q=${encodeURIComponent(name)}`;
      }
      if (lat && lng) return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(name)}`;
    }

    async function resolvePlaceName(lat, lng) {
      try {
        const key = `geo_name_${lat}_${lng}`;
        const cached = localStorage.getItem(key);
        if (cached) return cached;
        const u = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ar`;
        const j = await fetch(u).then(r=>r.json()).catch(()=>null);
        const name = j && (j.display_name || j.address?.road || j.address?.suburb || j.address?.city || j.address?.town) || '';
        if (name) try { localStorage.setItem(key, name); } catch(_){}
        return name;
      } catch(_) { return ''; }
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (_) { return null; }
    }

    async function attemptRefresh() {
      try {
        const res = await fetch('/api/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({})
        });
        if (!res.ok) return null;
        const data = await res.json();
        if (data && data.access_token) {
          localStorage.setItem('salonni_token', data.access_token);
          return data.access_token;
        }
        return null;
      } catch (_) { return null; }
    }

    function tokenSecondsLeft(token) {
      const payload = parseJwt(token);
      if (!payload || !payload.exp) return 0;
      return Math.floor(payload.exp - (Date.now() / 1000));
    }

    function scheduleTokenRefresh() {
      const intervalMs = 60000;
      setInterval(async () => {
        try {
          const t = localStorage.getItem('salonni_token');
          if (!t) return;
          const left = tokenSecondsLeft(t);
          if (left <= 120) {
            await attemptRefresh();
          }
        } catch (_) {}
      }, intervalMs);
    }

    function ensureEmployeeOrRedirect() {
      const userStr = localStorage.getItem('salonni_user');
      const token = localStorage.getItem('salonni_token');
      if (!userStr || !token) { location.href = '/auth.html'; return null; }
      const user = JSON.parse(userStr);
      const payload = parseJwt(token);
      if (!user || user.user_type !== 'employee' || !payload || payload.role !== 'employee') {
        // Redirect based on type if known
        if (user && user.user_type === 'salon') location.href = '/home_salon.html';
        else if (user && user.user_type === 'user') location.href = '/home_user.html';
        else location.href = '/auth.html';
        return null;
      }
      return token;
    }

    const defaultGoals = { signups: 2, visits: 15 };

    function openVisitModal() {
      const backdrop = document.getElementById('visit-modal');
      backdrop.style.display = 'flex';
      const vt = document.getElementById('visit-type');
      const sTxt = document.getElementById('visit-salon');
      const sSel = document.getElementById('visit-salon-existing');
      if (vt) vt.value = 'first';
      if (sTxt) sTxt.style.display = '';
      if (sSel) sSel.style.display = 'none';
    }
    function closeVisitModal() {
      const backdrop = document.getElementById('visit-modal');
      backdrop.style.display = 'none';
      // reset fields
      const salonInput = document.getElementById('visit-salon');
      const addressInput = document.getElementById('visit-address');
      const statusSelect = document.getElementById('visit-status');
      const commentsArea = document.getElementById('visit-comments');
      const interestSlider = document.getElementById('visit-interest');
      const interestDisplay = document.getElementById('interest-value');
      if (salonInput) salonInput.value = '';
      if (addressInput) addressInput.value = '';
      if (statusSelect) statusSelect.selectedIndex = 0;
      if (commentsArea) commentsArea.value = '';
      if (interestSlider) interestSlider.value = 5;
      if (interestDisplay) interestDisplay.textContent = '5';
    }

    async function getLocationQuick() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) { resolve(null); return; }
        let done = false; const t = setTimeout(() => { if (!done) resolve(null); }, 4000);
        navigator.geolocation.getCurrentPosition((pos) => {
          done = true; clearTimeout(t);
          resolve({ lat: Number(pos.coords.latitude.toFixed(6)), lng: Number(pos.coords.longitude.toFixed(6)) });
        }, () => { done = true; clearTimeout(t); resolve(null); }, { enableHighAccuracy: true, timeout: 3500, maximumAge: 60000 });
      });
    }

    async function saveVisit() {
      const token = ensureEmployeeOrRedirect();
      if (!token) return;
      const vt = document.getElementById('visit-type');
      const type = vt ? vt.value : 'first';
      let salon = document.getElementById('visit-salon').value.trim();
      if (type === 'follow_up') salon = (document.getElementById('visit-salon-existing')?.value || '').trim();
      const statusEl = document.getElementById('visit-status');
      const status = statusEl.value;
      const interestLevel = Number(document.getElementById('visit-interest').value || 0);
      const comments = document.getElementById('visit-comments').value.trim();
      const planPref = document.getElementById('visit-plan-pref')?.value || '';
      const planCore = planPref || '';
      const planOption = planCore === 'booking' ? (document.getElementById('visit-plan-option')?.value || '') : '';
      const address = (document.getElementById('visit-address')?.value || '').trim();
      const saveBtn = document.getElementById('visit-save');
      if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset.orig = saveBtn.innerHTML; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸</span>'; }
      if (!address) { showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'error'); if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset.orig || '<i class="fas fa-check"></i><span>Ø­ÙØ¸</span>'; } return; }
      let lat = '';
      let lng = '';
      try {
        const geo = await getLocationQuick();
        if (geo) {
          lat = String(geo.lat);
          lng = String(geo.lng);
          const latEl = document.getElementById('visit-lat'); const lngEl = document.getElementById('visit-lng');
          if (latEl) latEl.value = lat; if (lngEl) lngEl.value = lng;
        }
      } catch (_) {}
      try {
        const res = await fetch('/api/employee/visit', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ salon_name: salon, status, comments, interest_level: interestLevel, lat, lng, address, plan_core: planCore || null, plan_option: (planCore==='booking' ? (planOption||null) : null) }) });
        const data = await res.json();
        if (res.ok && data.success) {
          showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©', 'success');
          closeVisitModal();
          loadToday();
        } else {
          showMessage(data.message || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©', 'error');
        }
      } catch (_) { showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); }
      finally { if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset.orig || '<i class="fas fa-check"></i><span>Ø­ÙØ¸</span>'; } }
    }

    async function loadEmployeeSalonsList() {
      const token = ensureEmployeeOrRedirect();
      if (!token) return;
      const sel = document.getElementById('visit-salon-existing');
      if (!sel) return;
      const r = await fetch('/api/employee/salons', { headers: { 'Authorization': `Bearer ${token}` } });
      const j = await r.json();
      const list = j.salons || [];
      sel.innerHTML = list.length ? list.map(x => `<option value="${String(x.salon_name||'').replace(/"/g,'&quot;')}">${String(x.salon_name||'â€”').replace(/</g,'&lt;')}</option>`).join('') : '<option value="">â€”</option>';
      try { sel.dataset.salons = JSON.stringify(list); } catch(_) { sel.dataset.salons = '[]'; }
      const addrInput = document.getElementById('visit-address');
      const updateAddr = () => {
        const salons = (()=>{ try { return JSON.parse(sel.dataset.salons || '[]'); } catch(_) { return []; } })();
        const name = sel.value;
        const rec = salons.find(s => String(s.salon_name||'') === name);
        if (addrInput) addrInput.value = String(rec && rec.address ? rec.address : '');
      };
      updateAddr();
      sel.onchange = updateAddr;
    }

  document.getElementById('visit-type')?.addEventListener('change', async (e) => {
      const v = e.target.value;
      const sTxt = document.getElementById('visit-salon');
      const sSel = document.getElementById('visit-salon-existing');
      if (v === 'follow_up') { if (sTxt) sTxt.style.display = 'none'; if (sSel) { sSel.style.display = ''; await loadEmployeeSalonsList(); } }
      else { if (sTxt) sTxt.style.display = ''; if (sSel) sSel.style.display = 'none'; }
    });

    document.getElementById('visit-plan-pref')?.addEventListener('change', (e) => {
      const v = e.target.value;
      const box = document.getElementById('visit-plan-suboptions');
      if (box) {
        if (v === 'booking') { box.classList.remove('hidden'); }
        else { box.classList.add('hidden'); const opt = document.getElementById('visit-plan-option'); if (opt) opt.value = ''; }
      }
    });

    

    async function loadToday() {
      const token = ensureEmployeeOrRedirect();
      if (!token) return;
      try {
        const res = await fetch('/api/employee/analytics/today', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (!res.ok || !data.success) { document.getElementById('visits-list').innerHTML = '<p class="text-center text-red-600 p-6">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>'; return; }
        const visits = data.visits || [];
        // Update KPIs
        
        const last = visits[0] || visits[visits.length - 1];
        document.getElementById('kpi-last').textContent = last ? new Date(last.visited_at).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'â€”';
        // Session removed: focus on today's analytics only
        if (visits.length === 0) {
          document.getElementById('visits-list').innerHTML = '<p class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>';
        } else {
          // Render visit cards: show ONLY time (no date)
          document.getElementById('visits-list').innerHTML = visits.map(v => {
            const timeOnly = new Date(v.visited_at).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const interestVal = (() => {
              if (typeof v.interest_level !== 'undefined' && v.interest_level !== null) return Number(v.interest_level);
              try { const m = (v.comments || '').match(/Ø§Ù‡ØªÙ…Ø§Ù…:\s*(\d+)\/10/); return m ? Number(m[1]) : NaN; } catch (_) { return NaN; }
            })();
            const interestBadge = isNaN(interestVal) ? '' : `<span class='badge badge-blue flex items-center gap-1 text-xs px-2 py-1 rounded-full' style='background: rgba(6,193,103,0.10); color:#06C167; border: 1px solid rgba(6,193,103,0.25);'><i class="fas fa-star text-xs"></i> ${interestVal.toLocaleString('en-US')}/10</span>`;
            const statusBadge = (v.status === 'activated')
              ? `<span class='badge badge-green text-xs px-2 py-1 rounded-full bg-green-500/10 text-green-700 flex items-center gap-1'><i class="fas fa-check-circle"></i> Ù…ÙØ¹Ù‘Ù„ â€” Ù…Ø³Ø¬Ù‘Ù„ ÙˆÙ…Ø¯ÙÙˆØ¹</span>`
              : (v.status === 'signed_up')
                ? `<span class='badge text-xs px-2 py-1 rounded-full bg-amber-500/10 text-amber-700 flex items-center gap-1'><i class="fas fa-user-plus"></i> Ù…Ø³Ø¬Ù‘Ù„ â€” Ù„Ù… ÙŠØ¯ÙØ¹ Ø¨Ø¹Ø¯</span>`
                : (v.status === 'interested')
                  ? `<span class='badge text-xs px-2 py-1 rounded-full bg-blue-500/10 text-blue-700 flex items-center gap-1'><i class="fas fa-hourglass-half"></i> Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø±</span>`
                  : `<span class='badge badge-red text-xs px-2 py-1 rounded-full bg-red-500/10 text-red-700 flex items-center gap-1'><i class="fas fa-times-circle"></i> ØºÙŠØ± Ù…Ù‡ØªÙ…</span>`;
            
            // Format card for better mobile integration
            return `
            <div class="card modern p-3 mb-3 border border-gray-100">
              <div class="flex justify-between items-start border-b pb-2 mb-2 border-gray-100">
                <div class="text-sm font-semibold text-gray-700">${(v.salon_name || 'â€”').replace(/</g,'&lt;')}</div>
                <div class="text-xs text-gray-400">${timeOnly}</div>
              </div>
              <div class="flex justify-between items-center text-sm">
                <div class="flex items-center gap-2">
                    ${statusBadge}
                    ${interestBadge}
                </div>
                <div class="text-xs text-gray-500 truncate max-w-[50%]">${(v.comments || '').replace(/</g,'&lt;').replace(/\|\s*paid/gi,'').split(' | ')[0]}</div>
              </div>
            </div>`;
          }).join('');
          // Compute and update today's KPIs locally (signups, interest, commissions)
          const activatedCount = visits.filter(v => v.status === 'activated').length;
          // Signups today (activated counts as paid signup) + progress
          const signupsTarget = Number((localStorage.getItem('emp_goal_signups')) || defaultGoals.signups);
          
          const pctSignups = Math.min(100, Math.round((activatedCount / Math.max(1, signupsTarget)) * 100));
          const ringSign = document.getElementById('ring-signups');
          if (ringSign) {
            ringSign.style.setProperty('--pct', pctSignups + '%');
            ringSign.style.backgroundImage = `conic-gradient(#06C167 0% ${pctSignups}%, #e5e7eb ${pctSignups}% 100%)`;
            const rlbl = document.getElementById('ring-signups-val'); if (rlbl) rlbl.textContent = `${activatedCount}/${signupsTarget}`;
          }
          const todayKey = new Date().toISOString().slice(0,10);
          if (pctSignups >= 100 && !localStorage.getItem(`dg_signups_${todayKey}`)) { localStorage.setItem(`dg_signups_${todayKey}`,'1'); confettiBurst(); showMessage('Ø£Ø­Ø³Ù†Øª! Ø£Ù†Ø¬Ø²Øª Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…', 'success'); }
          // Commissions today: 20 ILS per paid signup
          const commissionToday = activatedCount * 20;
          document.getElementById('kpi-commission-today').textContent = `â‚ª${commissionToday.toLocaleString('en-US')}`;
          const visitsTarget = Number((localStorage.getItem('emp_goal_visits')) || defaultGoals.visits);
          const pctVisits = Math.min(100, Math.round((visits.length / Math.max(1, visitsTarget)) * 100));
          const ringVisits = document.getElementById('ring-visits');
          if (ringVisits) {
            ringVisits.style.setProperty('--pct', pctVisits + '%');
            ringVisits.style.backgroundImage = `conic-gradient(#06C167 0% ${pctVisits}%, #e5e7eb ${pctVisits}% 100%)`;
            const vlbl = document.getElementById('ring-visits-val'); if (vlbl) vlbl.textContent = `${visits.length}/${visitsTarget}`;
          }
          const todayKey2 = new Date().toISOString().slice(0,10);
          if (pctVisits >= 100 && !localStorage.getItem(`dg_visits_${todayKey2}`)) { localStorage.setItem(`dg_visits_${todayKey2}`,'1'); confettiBurst(); showMessage('Ø±Ø§Ø¦Ø¹! Ø£Ù†Ø¬Ø²Øª Ù‡Ø¯Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…', 'success'); }
          
        }
      } catch (_) { document.getElementById('visits-list').innerHTML = '<p class="text-center text-red-600 p-6">Ø­Ø¯Ø« Ø®Ø·Ø£</p>'; }
    }

    async function loadAnalytics() {
      const token = ensureEmployeeOrRedirect();
      if (!token) return;
      try {
        const today = new Date(); const iso = (d) => d.toISOString().slice(0,10);
        const df = document.getElementById('emp-date-from'); const dt = document.getElementById('emp-date-to');
        if (df && dt) { df.value = iso(new Date(today.getTime() - 6*24*60*60*1000)); dt.value = iso(today); }
        const reloadRange = () => {
          const from = df?.value || ''; const to = dt?.value || '';
          fetch(`/api/employee/analytics/range?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json()).then(data => {
              if (!data.success) return;
              const m = data.map || {}; const visits = data.visits || []; const revenue = Number(data.revenue||0);
              const totalVisits = Array.isArray(visits) ? visits.length : 0;
              document.getElementById('emp-range-visits-count').textContent = totalVisits.toLocaleString('en-US');
              document.getElementById('emp-range-acts').textContent = Number(m.activated||0).toLocaleString('en-US');
              document.getElementById('emp-range-int-registered').textContent = Number(m.signed_up||0).toLocaleString('en-US');
              document.getElementById('emp-range-int-needs').textContent = Number(m.interested||0).toLocaleString('en-US');
              document.getElementById('emp-range-no').textContent = Number(m.not_interested||0).toLocaleString('en-US');
              try {
                const uid = getUidKey(); const claimsRaw = localStorage.getItem(`emp_claims_${uid}`) || '{}';
                const claimed = JSON.parse(claimsRaw);
                const milestones = [
                  { req:10, reward:75 }, { req:25, reward:200 }, { req:75, reward:400 }, { req:125, reward:1000 }
                ];
                const claimedSum = milestones.reduce((sum, m) => sum + (claimed[m.req] ? m.reward : 0), 0);
                const totalRev = revenue + claimedSum;
                document.getElementById('emp-range-rev').textContent = `â‚ª${totalRev.toLocaleString('en-US')}`;
              } catch (_) {
                document.getElementById('emp-range-rev').textContent = `â‚ª${revenue.toLocaleString('en-US')}`;
              }
              const box = document.getElementById('emp-range-visits');
              if (box) {
                if (visits.length === 0) { box.style.display = ''; box.innerHTML = '<p class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>'; }
                else {
                  const cards = visits.map(v => {
                    const dateOnly = new Date(v.visited_at).toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'2-digit'});
                    const s = String(v.status||'').toLowerCase();
              const label = s === 'activated' ? `<i class="fas fa-check-circle"></i> Ù…ÙØ¹Ù‘Ù„ â€” Ù…Ø³Ø¬Ù‘Ù„ ÙˆÙ…Ø¯ÙÙˆØ¹` : (s === 'signed_up' ? `<i class="fas fa-user-plus"></i> Ù…Ø³Ø¬Ù‘Ù„ â€” Ù„Ù… ÙŠØ¯ÙØ¹ Ø¨Ø¹Ø¯` : (s === 'interested' ? `<i class="fas fa-hourglass-half"></i> Ù…Ù‡ØªÙ… â€“ Ù„Ù… ÙŠÙ‚Ø±Ø±` : `<i class="fas fa-times-circle"></i> ØºÙŠØ± Ù…Ù‡ØªÙ…`));
              const color = s === 'activated' ? 'badge-green' : s === 'not_interested' ? 'badge-red' : 'badge-blue';
                    const il = (v.interest_level!==undefined && v.interest_level!==null) ? Number(v.interest_level) : (()=>{ try { const m=(String(v.comments||'').match(/Ø§Ù‡ØªÙ…Ø§Ù…:\s*(\d+)\/10/)); return m?Number(m[1]):NaN; } catch(_) { return NaN; } })();
                    const interestBadge = isNaN(il) ? '' : `<span class="badge" style="background: rgba(6,193,103,0.10); color:#06C167; border: 1px solid rgba(6,193,103,0.25);">${il}/10</span>`;
                    return `
                      <div class="card modern p-3 border border-gray-100">
                        <div class="flex justify-between items-start border-b pb-2 mb-2 border-gray-100">
                          <div class="inline-flex items-center gap-2 text-sm font-semibold text-gray-700"><i class="fas fa-store"></i><span>${(v.salon_name||'â€”').replace(/</g,'&lt;')}</span></div>
                          <div class="inline-flex items-center gap-2 text-xs text-gray-400"><i class="fas fa-calendar-day"></i><span>${dateOnly}</span></div>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                          <div class="flex items-center gap-2">
                            <span class="badge ${color}">${label}</span>
                            ${interestBadge}
                          </div>
                        </div>
                      </div>`;
                  }).join('');
                  box.style.display = '';
                  box.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">${cards}</div>`;
                }
              }
            });
        };
        df?.addEventListener('change', reloadRange); dt?.addEventListener('change', reloadRange);
        reloadRange();
      } catch (_) {}
    }

    function getUidKey() {
      try {
        const u = JSON.parse(localStorage.getItem('salonni_user') || '{}');
        return u.id || u.user_id || u.email || u.phone || 'emp_default';
      } catch (_) { return 'emp_default'; }
    }
    function getCycleBounds() {
      const uid = getUidKey();
      const raw = localStorage.getItem(`emp_cycle_start_${uid}`);
      if (!raw) return null;
      const start = new Date(Number(raw));
      if (isNaN(start.getTime())) return null;
      const end = new Date(start.getTime() + 60 * 24 * 60 * 60 * 1000);
      end.setHours(23,59,59,999);
      return { start, end };
    }
    function formatDateRange(start, end) {
      const f = (d) => `${d.getDate()}/${d.getMonth()+1}/${String(d.getFullYear()).slice(-2)}`;
      return `${f(start)} - ${f(end)}`;
    }
  function startMilestonesCycle() {
      const uid = getUidKey();
      const now = Date.now();
      localStorage.setItem(`emp_cycle_start_${uid}`, String(now));
      try { if (navigator.vibrate) navigator.vibrate(30); } catch (_) {}
      loadMilestones();
    }
    
    async function loadMilestones() {
      const token = ensureEmployeeOrRedirect();
      if (!token) return;
      let totalActivated = 0;
      try {
        const res = await fetch('/api/employee/analytics/summary', { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        const a = data.all || {};
        // totalActivated is the LIFETIME count.
        totalActivated = Number(a.activated || 0);
      } catch (_) {}
      
      const bounds = getCycleBounds();
      const cta = document.getElementById('milestones-cta');
      const content = document.getElementById('milestones-content');

      if (!bounds || Date.now() > bounds.end.getTime()) {
        if (bounds && Date.now() > bounds.end.getTime()) {
          const uid = getUidKey();
          localStorage.removeItem(`emp_cycle_start_${uid}`);
        }
        if (cta) cta.style.display = 'flex';
        if (content) content.style.display = 'none';
        const btn = document.getElementById('milestones-start');
        if (btn && !btn._wired) { btn._wired = true; btn.addEventListener('click', startMilestonesCycle); }
        return;
      } else {
        if (cta) cta.style.display = 'none';
        if (content) content.style.display = 'block';
      }
      
      const start = bounds.start;
      const end = bounds.end;
      const daysLeft = Math.max(0, Math.ceil((end.getTime() - Date.now())/(24*60*60*1000)));
      const totalGoal = 125;
      const percent = Math.min(100, Math.round((totalActivated / totalGoal) * 100));
      
      // 1. Update Hero/Ascent Bar
      const elActsHero = document.getElementById('milestones-acts-hero'); 
      if (elActsHero) elActsHero.textContent = `${totalActivated} / ${totalGoal} ØªÙØ¹ÙŠÙ„ (Ø¯ÙˆØ±Ø©: ${formatDateRange(start, end)})`;
      const elDaysHero = document.getElementById('milestones-days-left-hero'); 
      if (elDaysHero) elDaysHero.textContent = `Ù…ØªØ¨Ù‚ÙŠ: ${daysLeft} ÙŠÙˆÙ…`;
      const elAscentFill = document.getElementById('milestones-ascent-fill'); 
      if (elAscentFill) elAscentFill.style.width = `${percent}%`;
      const elAscentIcon = document.getElementById('ascent-icon'); 
      if (elAscentIcon) {
        // Position icon slightly before 100% to keep it on the bar
        const iconPos = Math.min(96, percent); 
        elAscentIcon.style.setProperty('--icon-pos', `${iconPos}%`);
      }

      const milestones = [
        { req:10, reward:75, title:'Ø¨Ø±ÙˆÙ†Ø²', gamifiedTitle:'Bronze Tier' },
        { req:25, reward:200, title:'ÙØ¶ÙŠ', gamifiedTitle:'Silver Tier' },
        { req:75, reward:400, title:'Ø°Ù‡Ø¨ÙŠ', gamifiedTitle:'Gold Tier' },
        { req:125, reward:1000, title:'Ø£Ù„Ù…Ø§Ø³', gamifiedTitle:'Diamond Tier' }
      ];

      const next = milestones.find(m => totalActivated < m.req);
      const leftToNext = next ? Math.max(0, next.req - totalActivated) : 0;
      const elNextHero = document.getElementById('milestones-next-goal-hero'); 
      if (elNextHero) {
        if (next) {
          elNextHero.innerHTML = `Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¹Ù†Ø¯ <span class="next-reward-amount">${next.req} ØªÙØ¹ÙŠÙ„</span> - ØªØ¨Ù‚Ù‰ Ù„Ùƒ ${leftToNext} ØªÙØ¹ÙŠÙ„Ø§Øª!`;
          elAscentIcon.innerHTML = `<i class="fas fa-star"></i>`;
        } else {
          elNextHero.innerHTML = `<span class="next-reward-amount text-white text-xl">ğŸ† ÙƒÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ù…ÙƒØªÙ…Ù„Ø©! Ø£Ù†Øª Ø¨Ø·Ù„! ğŸ†</span>`;
          elAscentIcon.innerHTML = `<i class="fas fa-trophy"></i>`;
        }
      }
      
      // 2. Update Milestone Cards
      const key = `emp_claims_${getUidKey()}`;
      const claimed = JSON.parse(localStorage.getItem(key) || '{}');
      const container = document.getElementById('milestone-cards');
      if (container) {
        container.innerHTML = milestones.map(m => {
          const pct = Math.min(100, Math.round((Math.min(totalActivated, m.req)/m.req)*100));
          const completed = totalActivated >= m.req;
          const claimedStatus = claimed[m.req];
          const status = completed ? (claimedStatus ? 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©') : 'Ù…Ù‚ÙÙ„';
          const near = m.req - totalActivated;
          const motivate = completed ? 'Ù…ÙƒØªÙ…Ù„Ø©! Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹!' : (near > 0 && near <= 5 ? `ØªØ¨Ù‚Ù‘Ù‰ ${near} ÙÙ‚Ø·! Ø£Ù†Øª Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ ğŸ”¥` : `Ø¥Ù„Ù‰ ${m.req} ØªÙØ¹ÙŠÙ„`);
          const tierClass = m.req === 10 ? 'tier-bronze' : m.req === 25 ? 'tier-silver' : m.req === 75 ? 'tier-gold' : 'tier-diamond';
          const claimable = completed && !claimedStatus;
          const lockIcon = `<i class="fas fa-lock text-lg text-gray-400"></i>`;
          const claimIcon = `<i class="fas fa-hand-holding-usd text-lg"></i>`;
          const completedIcon = `<i class="fas fa-check-circle text-lg text-secondary"></i>`;
          
          let statusIcon = lockIcon;
          if (completed) {
            statusIcon = claimedStatus ? completedIcon : claimIcon;
          }
          
          const badgeIcon = m.req === 10 ? 'fa-medal' : m.req === 25 ? 'fa-star-half-alt' : m.req === 75 ? 'fa-star' : 'fa-gem';

          return `
            <div class="milestone-card ${tierClass} ${claimable ? 'claimable pulse' : ''} p-4">
              <div class="flex items-start gap-4">
                <div class="tier-badge-icon">
                  <i class="fas ${badgeIcon}"></i>
                </div>
                <div class="flex-grow">
                  <div class="text-lg font-extrabold" style="color:var(--color-primary)">${m.gamifiedTitle}</div>
                  <div class="text-sm font-medium text-gray-600">${m.title}</div>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-2xl font-black" style="color:var(--color-secondary)">${m.reward}</span>
                    <span class="text-base text-gray-500">â‚ª Ù…ÙƒØ§ÙØ£Ø©</span>
                  </div>
                </div>
                <div class="w-1/4 text-left">
                    <div class="text-sm font-bold text-gray-700 mb-1">${Math.min(totalActivated, m.req)} / ${m.req}</div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full" style="width: ${pct}%; background-color: var(--color-secondary);"></div>
                    </div>
                </div>
              </div>
              <div class="actions flex justify-between items-center pt-3 border-t mt-4 border-gray-100">
                <span class="text-xs font-semibold text-gray-500">${motivate}</span>
                <button class="flex items-center gap-2 btn ${claimable ? 'btn-primary-soft' : 'bg-gray-200 text-gray-500 cursor-default'} px-4 py-2 text-sm" data-mreq="${m.req}" ${!claimable ? 'disabled' : ''}>
                  ${statusIcon}
                  <span>${status}</span>
                </button>
              </div>
            </div>`;
        }).join('');
        container.querySelectorAll('button[data-mreq]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const req = e.currentTarget.getAttribute('data-mreq');
            if (totalActivated >= Number(req) && !claimed[req]) {
              claimed[req] = true;
              localStorage.setItem(key, JSON.stringify(claimed));
              try { if (navigator.vibrate) navigator.vibrate(30); } catch (_) {}
              confettiBurst();
              showMessage(`Ù…Ø¨Ø±ÙˆÙƒ! ${milestones.find(m => m.req === Number(req))?.gamifiedTitle} ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡! ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙƒØ§ÙØ£Ø© ${milestones.find(m => m.req === Number(req))?.reward} Ø´ÙŠÙƒÙ„.`, 'success');
              loadMilestones();
            }
          });
        });
      }
    }

  function switchView(viewId) {
      // List of all sections that belong to the "Today" tab
      const todaySections = ['today-view', 'today-summary', 'today-kpis', 'today-visits'];

      // Hide ALL view-content sections first
      document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
      
      // Determine which sections to show
      if (viewId === 'today-view') {
        // Show all four "Today" sections
        todaySections.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('hidden');
        });
      } else {
        // Show only the single section corresponding to the Milestones/Analytics tab
        const el = document.getElementById(viewId);
        if (el) el.classList.remove('hidden');
      }

      // Update nav styles
      document.querySelectorAll('#bottom-nav .nav-item').forEach(nav => {
        nav.classList.remove('nav-active', 'text-secondary', 'bg-secondary/10');
        nav.classList.add('text-gray-500');
      });
      const activeNav = document.querySelector(`#bottom-nav .nav-item[data-view="${viewId}"]`);
      if (activeNav) {
        activeNav.classList.add('nav-active', 'text-secondary', 'bg-secondary/10');
        activeNav.classList.remove('text-gray-500');
      }
      
      // Load data per view
      if (viewId === 'today-view') { loadToday(); }
      if (viewId === 'milestones-view') { loadMilestones(); }
      if (viewId === 'analytics-view') { loadAnalytics(); }
      if (viewId === 'visits-view') {
        const today = new Date(); const iso = (d) => d.toISOString().slice(0,10);
        const vf = document.getElementById('emp-visits-from'); const vt = document.getElementById('emp-visits-to');
        if (vf && vt) { vf.value = iso(new Date(today.getTime() - 30*24*60*60*1000)); vt.value = iso(today); }
        ['input','change'].forEach(ev => {
          document.getElementById('emp-visits-search')?.addEventListener(ev, renderEmployeeVisits);
          document.getElementById('emp-visits-status')?.addEventListener(ev, renderEmployeeVisits);
          vf?.addEventListener(ev, renderEmployeeVisits); vt?.addEventListener(ev, renderEmployeeVisits);
          document.getElementById('emp-visits-il-min')?.addEventListener(ev, renderEmployeeVisits);
          document.getElementById('emp-visits-il-max')?.addEventListener(ev, renderEmployeeVisits);
          document.getElementById('emp-visits-has-comments')?.addEventListener(ev, renderEmployeeVisits);
        });
        renderEmployeeVisits();
      }

      // No forced scrolling; views are placed near top for natural alignment
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const userStr = localStorage.getItem('salonni_user');
      if (!userStr) { location.href = '/auth.html'; return; }
      let user = {};
      try { user = JSON.parse(userStr); } catch (_) { location.href = '/auth.html'; return; }
      if (!user || user.user_type !== 'employee') { if (user && user.user_type === 'salon') location.href = '/home_salon.html'; else if (user && user.user_type === 'user') location.href = '/home_user.html'; else location.href = '/auth.html'; return; }
      let token = localStorage.getItem('salonni_token');
      const payload = token && parseJwt(token);
      if (!token || !payload || tokenSecondsLeft(token) <= 60) {
        const nt = await attemptRefresh();
        if (!nt) { location.href = '/auth.html'; return; }
        token = nt;
      }
      scheduleTokenRefresh();
      try { const u = JSON.parse(localStorage.getItem('salonni_user') || '{}'); document.getElementById('emp-name').textContent = u.name || ''; } catch (_) {}
      document.getElementById('logout-btn').addEventListener('click', () => { try { localStorage.removeItem('salonni_token'); localStorage.removeItem('salonni_user'); } catch (_) {} location.href = '/auth.html'; });
      // Update interest display live
      const interestSlider = document.getElementById('visit-interest');
      const interestDisplay = document.getElementById('interest-value');
      if (interestSlider && interestDisplay) {
        interestSlider.addEventListener('input', () => { interestDisplay.textContent = String(interestSlider.value); });
      }
      document.getElementById('new-visit-btn').addEventListener('click', openVisitModal);
      document.getElementById('visit-cancel').addEventListener('click', closeVisitModal);
      document.getElementById('visit-save').addEventListener('click', saveVisit);
      try { loadToday(); } catch (_) {}
      // Bottom nav view switching
      document.querySelectorAll('#bottom-nav .nav-item').forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault(); const v = btn.getAttribute('data-view'); switchView(v);
      }));
      const md = document.getElementById('emp-visit-details-modal');
      const mdClose = document.getElementById('emp-visit-modal-close');
      if (md && mdClose) { mdClose.addEventListener('click', () => md.classList.add('hidden')); }
      if (md) { md.addEventListener('click', (e) => { if (e.target.id === 'emp-visit-details-modal') md.classList.add('hidden'); }); }
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const m = document.getElementById('emp-visit-details-modal'); if (m) m.classList.add('hidden'); } });
      switchView('today-view');
    });

    function confettiBurst() {
      const canvas = document.getElementById('confetti-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const colors = ['#06C167','#f59e0b','#14b8a6','#3b82f6','#ec4899'];
      const pieces = [];
      // Use the center of the ascent bar for a more targeted burst effect
      const milestoneView = document.getElementById('milestones-view');
      const burstX = canvas.width * 0.5;
      const burstY = milestoneView ? milestoneView.offsetTop + milestoneView.clientHeight / 3 : canvas.height * 0.35;

      for (let i = 0; i < 150; i++) {
        pieces.push({
          x: burstX,
          y: burstY,
          r: Math.random() * 4 + 2,
          c: colors[Math.floor(Math.random() * colors.length)],
          a: Math.random() * Math.PI * 2,
          s: Math.random() * 6 + 4, // Higher initial speed for more pop
          d: 0.02
        });
      }
      function step() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        pieces.forEach((p,i) => {
          p.x += Math.cos(p.a) * p.s;
          p.y += Math.sin(p.a) * p.s + 0.4;
          p.s *= (1 - p.d);
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = p.c;
          ctx.fill();
          if (p.s < 0.2) pieces.splice(i,1);
        });
        if (pieces.length) requestAnimationFrame(step);
        else { canvas.width = 0; canvas.height = 0; }
      }
      step();
    }
  </script>

</div>
</body>
</html>