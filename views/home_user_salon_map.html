<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="/offline-detect.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>صالوني - خريطة الصالونات</title>
  <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap');
    body { font-family: 'Tajawal', sans-serif; background: #F3F4F6; padding-bottom: 80px; padding-top: calc(12px + env(safe-area-inset-top)); }
    @supports (padding: constant(safe-area-inset-top)) {
      body { padding-top: calc(12px + constant(safe-area-inset-top)); }
    }
    #salon-map { height: calc(var(--vh, 1vh) * 70); min-height: 320px; width: 100%; position: relative; }
    .nav-active { color: #06C167 !important; background-color: rgba(6,193,103,0.1) !important; border-radius: 0.75rem !important; box-shadow: 0 2px 8px rgba(6,193,103,0.15) !important; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000000; display: none; justify-content: center; align-items: flex-end; inset: 0; overflow: hidden; -webkit-overflow-scrolling: touch; }
    .modal-content { background-color: #fff; width: 100%; max-width: 600px; height: 88vh; border-top-left-radius: 30px; border-top-right-radius: 30px; overflow-y: auto; transform: translateY(100%); transition: transform 0.4s ease-out; max-height: calc(100vh - env(safe-area-inset-top)); margin-top: env(safe-area-inset-top); }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal-overlay.is-open { display: flex; animation: fadeIn 0.25s ease-out forwards; }
    .modal-overlay.is-open .modal-content { transform: translateY(0); }
    .page-enter { animation: fadeIn 0.25s ease-out both; }
    .back-btn { position: fixed; top: calc(8px + env(safe-area-inset-top)); left: 12px; z-index: 100000; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 9999px; background: #FFFFFF; color: #1E293B; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 12px rgba(0,0,0,0.12); opacity: 0; transform: translateX(-8px); transition: opacity 0.25s ease, transform 0.25s ease; }
    .back-btn.show { opacity: 1; transform: translateX(0); }
    .maplibregl-ctrl-top-right { inset-inline-end: 8px; inset-block-start: calc(8px + env(safe-area-inset-top)); }
    .maplibregl-ctrl-bottom-left { inset-inline-start: 8px; inset-block-end: calc(8px + env(safe-area-inset-bottom)); }
    .maplibregl-ctrl-group { border-radius: 14px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 6px 16px rgba(0,0,0,0.12); overflow: hidden; }
    .maplibregl-ctrl-group > button { width: 36px; height: 36px; }
    .maplibregl-ctrl button { color: #1E293B; background: #FFFFFF; }
    .maplibregl-ctrl button:hover { background: #F3F4F6; }
    .maplibregl-ctrl-attrib { background: rgba(255,255,255,0.9); border-radius: 10px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .salon-marker { position: relative; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 50%; box-shadow: 0 6px 16px rgba(0,0,0,0.18); }
    .user-dot { position: absolute; left: 50%; top: 50%; width: 12px; height: 12px; transform: translate(-50%, -50%); background: #06C167; border: 2px solid #fff; border-radius: 9999px; box-shadow: 0 6px 14px rgba(6,193,103,0.35); }
    .user-ring { position: absolute; left: 50%; top: 50%; width: 24px; height: 24px; transform: translate(-50%, -50%); border: 2px solid rgba(6,193,103,0.35); border-radius: 9999px; animation: pulseRing 2s infinite; }
    @keyframes pulseRing { 0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0.6; } 70% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; } }
    .map-badge { position: absolute; top: 10px; left: 10px; z-index: 20; background: rgba(255,255,255,0.95); color: #1E293B; border: 1px solid rgba(0,0,0,0.08); border-radius: 9999px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); padding: 8px 12px; font-size: 12px; display: none; }
    .skeleton { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.94); z-index: 10; }
    .skeleton-inner { background: #fff; border: 1px solid rgba(0,0,0,0.06); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); padding: 18px; width: 88%; max-width: 520px; display: grid; gap: 10px; }
    .skeleton-bar { height: 12px; border-radius: 9999px; background: linear-gradient(90deg, #F3F4F6, #E5E7EB, #F3F4F6); background-size: 200% 100%; animation: subtleShimmer 1.2s ease-in-out infinite; }
    @keyframes subtleShimmer { 0% { background-position: 0 0; } 100% { background-position: 200% 0; } }
    .loading-overlay { position: fixed; inset: 0; z-index: 100000; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.98); }
    .loading-card { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 16px 20px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 8px 24px rgba(0,0,0,0.08); background: #fff; }
    .loading-spinner { width: 28px; height: 28px; border: 3px solid #06C167; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <script>
    (function(){
      var token = localStorage.getItem('salonni_token');
      var userRaw = localStorage.getItem('salonni_user');
      var user = userRaw ? JSON.parse(userRaw) : null;
      if (!token || !user || user.user_type !== 'user') { window.location.replace('/auth.html'); }
    })();
  </script>
</head>
<body class="min-h-screen bg-gray-50">
<main class="p-4 space-y-4 page-enter">
    <div class="bg-white rounded-2xl shadow-lg p-3">
      <div class="flex flex-col sm:flex-row gap-2 items-stretch">
        <input id="map-search" type="text" placeholder="ابحث عن صالون أو مدينة" class="flex-1 p-2 border border-gray-200 rounded-lg">
        <button id="filters-btn" class="p-2 rounded-lg border border-gray-200 text-[#1E293B] hover:bg-gray-50" title="فلاتر"><i class="fas fa-sliders"></i></button>
      </div>
    </div>
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden">
      <div id="salon-map"></div>
      <div id="map-loading-badge" class="map-badge">جارٍ تحميل الصالونات…</div>
      <div id="map-skeleton" class="skeleton"><div class="skeleton-inner"><div class="skeleton-bar" style="width: 60%"></div><div class="skeleton-bar" style="width: 40%"></div><div class="skeleton-bar" style="width: 80%"></div><div class="skeleton-bar" style="width: 50%"></div></div></div>
    </div>
    <div id="app-loading-overlay" class="loading-overlay">
      <div class="loading-card">
        <div class="loading-spinner"></div>
        <div class="text-sm font-bold" style="color:#1E293B">جارٍ التحميل…</div>
      </div>
    </div>
    <div id="map-status" class="text-center text-sm text-gray-600"></div>
  </main>
  <div id="filters-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold text-[#1E293B]">فلاتر</h3>
          <button id="close-filters-modal-btn" class="text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">التقييم</label>
            <select id="modal-rating-filter" class="w-full p-2 border border-gray-300 rounded-lg">
              <option value="">جميع التقييمات</option>
              <option value="4">4 نجوم فأكثر</option>
              <option value="3">3 نجوم فأكثر</option>
              <option value="2">2 نجوم فأكثر</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">المدينة</label>
            <select id="modal-city-filter" class="w-full p-2 border border-gray-300 rounded-lg">
              <option value="">جميع المدن</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><input type="checkbox" id="filter-open-now"><span class="text-sm">مفتوح الآن</span></label>
              <label class="flex items-center gap-2"><input type="checkbox" id="filter-available-today"><span class="text-sm">متاح اليوم</span></label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">المسافة بالوقت</label>
            <div class="flex items-center gap-2">
              <select id="distance-mode" class="p-2 border border-gray-300 rounded-lg">
                <option value="">بدون</option>
                <option value="walking">مشياً</option>
                <option value="driving">بالسيارة</option>
              </select>
              <input id="distance-minutes" type="number" min="0" placeholder="الدقائق" class="p-2 border border-gray-300 rounded-lg w-24">
            </div>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">الخدمة</label>
            <div class="relative">
              <button type="button" id="service-dropdown-btn" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-right flex items-center justify-between">
                <span id="service-dropdown-text">جميع الخدمات</span>
                <i id="service-dropdown-arrow" class="fas fa-chevron-down"></i>
              </button>
              <div id="service-dropdown-menu" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                <div class="p-2">
                  <label class="flex items-center gap-3 p-2 rounded">
                    <input type="checkbox" id="service-all" value="all" class="service-checkbox" checked>
                    <span class="text-sm">جميع الخدمات</span>
                  </label>
                </div>
                <div id="service-options-container" class="border-t border-gray-100"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex gap-3 justify-center mt-6">
          <button id="apply-filters-btn" class="px-6 py-2 rounded-xl bg-[#06C167] text-white font-bold">تطبيق الفلاتر</button>
          <button id="clear-filters-btn" class="px-6 py-2 rounded-xl bg-gray-300 text-gray-700 font-bold">مسح الفلاتر</button>
        </div>
  </div>
  </div>
  </div>
  <div id="salon-preview-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="preview-name" class="text-lg font-bold text-[#1E293B]"></h3>
          <button id="close-preview-modal-btn" class="text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-3">
          <div class="relative w-full rounded-xl overflow-hidden">
            <img id="preview-image" class="w-full" style="aspect-ratio: 16 / 9;" alt="">
            <span id="preview-status" class="absolute top-3 left-3 text-xs font-bold px-3 py-1 rounded-full"></span>
          </div>
          <div class="flex flex-wrap gap-2">
            <span id="preview-rating" class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-50 text-yellow-700 rounded-full text-xs font-medium"></span>
            <span id="preview-city-tag" class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">
            </span>
            <span id="preview-distance-tag" class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs"></span>
            <span id="preview-address-tag" class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs"></span>
          </div>
          <div class="pt-2 border-t border-gray-100">
            <h4 class="text-sm font-bold text-[#1E293B] mb-2">الخدمات المتاحة</h4>
            <div id="preview-services-list" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="pt-2 border-t border-gray-100 flex justify-center">
            <button id="preview-learn-more" class="px-4 py-2 rounded-lg bg-[#06C167] text-white font-bold">تعرف أكثر</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="service-bottom-bar" class="bg-white/95 backdrop-blur-sm border-t border-gray-200" style="position: fixed; bottom: 0; left: 0; right: 0; width: 100vw; z-index: 99999; box-sizing: border-box; min-height: 72px; display: flex; align-items: center; padding: 12px 14px; padding-bottom: calc(14px + env(safe-area-inset-bottom));">
    <div class="overflow-x-auto w-full">
      <div id="service-inline-strip" class="flex gap-2 p-1"></div>
    </div>
  </div>
  <button id="back-btn" class="back-btn" aria-label="رجوع"><i class="fas fa-arrow-left"></i></button>
  
  <script src="/app-mode.js"></script>
  <script>
    var currentUser = null;
    var map = null;
    var markers = [];
    var suspendAutoCenter = false;
    var salonsData = [];
    var allMasterServices = [];
    var userLocation = null;
    var hasCenteredOnUser = false;
    var bestAccuracy = Infinity;
    var lastCentered = null;
    var lastUserUpdateTs = 0;
    var minUpdateMs = 1500;
    var minMoveMeters = 7;
    var geoWatchId = null;
    var imagesReady = false;
    var salonLayerUpgraded = false;
    var restoredCamera = false;
    var __mapInitInProgress = false;
    var needFullReinit = false;
    var mapLoadOk = false;
    function showLoadingOverlay(){ try{ var ov=document.getElementById('app-loading-overlay'); if(ov) ov.style.display='flex'; }catch(_){} }
    function hideLoadingOverlay(){ try{ var ov=document.getElementById('app-loading-overlay'); if(ov) ov.style.display='none'; }catch(_){} }
    function recreateMap(){ try{ if(map && map.remove){ map.remove(); } }catch(_){} map=null; imagesReady=false; salonLayerUpgraded=false; hasCenteredOnUser=false; suspendAutoCenter=false; try{ showLoadingOverlay(); var sk=document.getElementById('map-skeleton'); if(sk) sk.style.display='flex'; var mb=document.getElementById('map-loading-badge'); if(mb) mb.style.display='block'; }catch(_){} try{ if(!__mapInitInProgress){ __mapInitInProgress=true; init().finally(function(){ __mapInitInProgress=false; }); } }catch(_){} }
    function applyMobileOffset(){ try{ if(window.innerWidth<=768){ map.panBy([-100,0]); } }catch(_){} }
    function uniqById(arr){
      var seen = new Set();
      var out = [];
      for (var i=0;i<arr.length;i++){ var s=arr[i]; var id=getSalonId(s); if(!id||seen.has(id)) continue; seen.add(id); out.push(s); }
      return out;
    }
    function getSalonId(s){ return s ? (s.salonId || s.salonid || s.id || s.salon_id) : null; }
    function setStatus(t){ var el=document.getElementById('map-status'); if(el) el.textContent=t||''; }
    async function fetchDiscovery(){
      var uRaw=localStorage.getItem('salonni_user');
      currentUser=uRaw?JSON.parse(uRaw):null;
      var city=currentUser&&currentUser.city?currentUser.city:'';
      var gender=currentUser&&currentUser.gender?currentUser.gender:'female';
      var url='/api/discovery/'+encodeURIComponent(city)+'/'+encodeURIComponent(gender);
      var r=await fetch(url).catch(function(){return null});
      if(!r||!r.ok){ return { services:[], citySalons:[], allSalons:[] }; }
      var d=await r.json();
      // FIX: Ensure data is valid array even if corrupted
      d.services=Array.isArray(d.services)?d.services:[]; 
      d.citySalons=Array.isArray(d.citySalons)?d.citySalons:[]; 
      d.allSalons=Array.isArray(d.allSalons)?d.allSalons:[];
      allMasterServices = d.services;
      return d;
    }
    async function getSalonLocation(id, salon){
      var key='salon_loc_'+id;
      try{ var c=localStorage.getItem(key); if(c){ return JSON.parse(c); } }catch(_){}
      try{
        var r=await fetch('/api/salon/location/'+id).catch(function(){return null});
        if(r&&r.ok){ var j=await r.json(); if(j&&j.success&&j.location&&j.location.latitude&&j.location.longitude){ var loc={ lat:Number(j.location.latitude), lng:Number(j.location.longitude) }; try{ localStorage.setItem(key, JSON.stringify(loc)); }catch(_){} return loc; } }
      }catch(_){}
      try{
        var q=[salon&&salon.salon_name, salon&&salon.address, salon&&salon.city].filter(Boolean).join('، ');
        var u='/api/proxy/nominatim?q='+encodeURIComponent(q);
        var g=await fetch(u).then(function(x){return x.json()}).catch(function(){return []});
        if(Array.isArray(g)&&g[0]){ var loc={ lat:Number(g[0].lat), lng:Number(g[0].lon) }; try{ localStorage.setItem(key, JSON.stringify(loc)); }catch(_){} return loc; }
      }catch(_){}
      return null;
    }
    function getSalonState(s){
      if(s && s.is_available_today){ if(s.status==='closing_soon') return 'closing_soon'; return 'open'; }
      if(s && s.status==='opening_soon') return 'opening_soon';
      return 'closed';
    }
    function toSalonFeature(s){
      var id=getSalonId(s);
      var st=getSalonState(s);
      return { type:'Feature', geometry:{ type:'Point', coordinates:[s._lng, s._lat] }, properties:{ id:id, status:st } };
    }
    function upgradeSalonLayer(){
      try{
        if(!map || !map.getSource('salons')) return;
        if(!map.getLayer('salons-symbols')){
          map.addLayer({ id:'salons-symbols', type:'symbol', source:'salons', layout:{ 'icon-image': 'salon-icon', 'icon-size': ['interpolate', ['linear'], ['zoom'], 10, 0.7, 14, 1.1], 'icon-allow-overlap': true, 'icon-ignore-placement': true, 'icon-anchor': 'center', 'visibility': 'visible' } });
        }
        if(map.getLayer('salons-circles')){ map.setLayoutProperty('salons-circles','visibility','none'); }
        salonLayerUpgraded = true;
      }catch(_){ }
    }
    function toggleSalonLayerVisibility(){
      try{
        var sym = map.getLayer('salons-symbols');
        var cir = map.getLayer('salons-circles');
        if(sym){ map.setLayoutProperty('salons-symbols','visibility','visible'); }
        if(cir){ map.setLayoutProperty('salons-circles','visibility','none'); }
      }catch(_){}
    }
    function ensureFallbackCirclesLayer(){
      try{
        if(!map) return;
        try{ if(!map.getSource('salons')){ map.addSource('salons', { type:'geojson', data:{ type:'FeatureCollection', features:[] } }); } }catch(_){ }
        if(!map.getLayer('salons-circles')){
          map.addLayer({
            id:'salons-circles', type:'circle', source:'salons',
            paint:{
              'circle-radius': 6,
              'circle-stroke-width': 2,
              'circle-stroke-color': '#FFFFFF',
              'circle-color': ['match',['get','status'],'open','#06C167','closing_soon','#F59E0B','opening_soon','#3B82F6','closed','#9CA3AF','#9CA3AF']
            },
            layout:{ 'visibility':'none' }
          });
        }
      }catch(_){}
    }
    function makeSalonImage(color){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(0,0,0,0.18)'; x.shadowBlur=10; var grad=x.createRadialGradient(cx, cy, 6, cx, cy, 28); grad.addColorStop(0,'#FFFFFF'); grad.addColorStop(1,'#F8FAFC'); x.beginPath(); x.arc(cx, cy, 24, 0, Math.PI*2); x.fillStyle=grad; x.fill(); x.lineWidth=5; x.strokeStyle=color; x.stroke(); x.restore(); x.lineCap='round'; x.lineJoin='round'; var sc='#0F172A'; var r=11; var h=7; x.lineWidth=2.6; x.strokeStyle=sc; x.beginPath(); x.moveTo(cx-r, cy-h); x.lineTo(cx+h, cy+h); x.moveTo(cx-r, cy+h); x.lineTo(cx+h, cy-h); x.stroke(); x.beginPath(); x.arc(cx-r, cy-h, 4, 0, Math.PI*2); x.fillStyle=sc; x.fill(); x.beginPath(); x.arc(cx-r, cy+h, 4, 0, Math.PI*2); x.fillStyle=sc; x.fill(); return c; }
    function makeUserImage(){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(26,115,232,0.35)'; x.shadowBlur=12; var grad=x.createRadialGradient(cx, cy, 6, cx, cy, 20); grad.addColorStop(0,'#4C8BF5'); grad.addColorStop(1,'#1A73E8'); x.beginPath(); x.arc(cx, cy, 14, 0, Math.PI*2); x.fillStyle=grad; x.fill(); x.lineWidth=4; x.strokeStyle='#FFFFFF'; x.stroke(); x.restore(); x.beginPath(); x.arc(cx, cy, 5, 0, Math.PI*2); x.fillStyle='#FFFFFF'; x.fill(); return c; }
    function toImageData(c){ try{ var ctx=c.getContext('2d'); return ctx.getImageData(0,0,c.width,c.height); }catch(_){ return null; } }
    function ringColorForStatus(st){ return st==='open' ? '#06C167' : st==='opening_soon' ? '#3B82F6' : st==='closing_soon' ? '#F59E0B' : '#9CA3AF'; }
    
    // UPDATED: Added race condition timeout to prevent iOS hang
    async function loadFAIconBitmap(){ 
      try{ 
        if(document && document.fonts && document.fonts.load){ 
          try{ 
             // FIX: Don't wait forever for fonts, timeout after 400ms
             await Promise.race([
               document.fonts.load('900 28px "Font Awesome 6 Free"'),
               new Promise(resolve => setTimeout(resolve, 400))
             ]);
          }catch(_){ } 
        }
        var size=32; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size);
        x.fillStyle='#1E293B'; x.textAlign='center'; x.textBaseline='middle'; x.font='900 20px "Font Awesome 6 Free"';
        var glyph='\uf0c4';
        try{ x.fillText(glyph, cx, cy); }catch(_){ }
        return c; 
      }catch(_){ }
      return null; 
    }

    function drawSalonIconWithBitmap(bm, ringColor){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(0,0,0,0.18)'; x.shadowBlur=10; var grad=x.createRadialGradient(cx, cy, 6, cx, cy, 28); grad.addColorStop(0,'#FFFFFF'); grad.addColorStop(1,'#F8FAFC'); x.beginPath(); x.arc(cx, cy, 24, 0, Math.PI*2); x.fillStyle=grad; x.fill(); x.lineWidth=5; x.strokeStyle=ringColor; x.stroke(); x.restore(); try{ var inner=26; var scale=Math.min(inner/bm.width, inner/bm.height); var w=bm.width*scale; var h=bm.height*scale; x.drawImage(bm, cx-w/2, cy-h/2, w, h); }catch(_){ } return c; }
    function drawSalonFARingIconWithDot(bm, ringColor){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(0,0,0,0.14)'; x.shadowBlur=10; var baseGrad=x.createRadialGradient(cx, cy, 6, cx, cy, 28); baseGrad.addColorStop(0,'#FFFFFF'); baseGrad.addColorStop(1,'#F8FAFC'); x.beginPath(); x.arc(cx, cy, 24, 0, Math.PI*2); x.fillStyle=baseGrad; x.fill(); x.restore(); var gap=0.48; x.lineCap='round'; x.lineJoin='round'; var ringGrad=x.createLinearGradient(cx-24, cy, cx+24, cy); ringGrad.addColorStop(0, ringColor); ringGrad.addColorStop(1, ringColor); x.lineWidth=4; x.strokeStyle=ringGrad; x.beginPath(); x.arc(cx, cy, 24, gap/2, Math.PI*2-gap/2); x.stroke(); x.lineWidth=2; x.strokeStyle='rgba(255,255,255,0.92)'; x.beginPath(); x.arc(cx, cy, 22, gap/2, Math.PI*2-gap/2); x.stroke(); try{ var inner=26; var scale=Math.min(inner/bm.width, inner/bm.height); var w=bm.width*scale; var h=bm.height*scale; x.drawImage(bm, cx-w/2, cy-h/2, w, h); }catch(_){ } x.save(); var dotR=5; var dotX=cx+16; var dotY=cy+16; x.beginPath(); x.arc(dotX, dotY, dotR, 0, Math.PI*2); x.fillStyle=ringColor; x.fill(); x.lineWidth=4; x.strokeStyle='#FFFFFF'; x.stroke(); x.restore(); return c; }
    function makeSalonImageWithDot(color){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(0,0,0,0.18)'; x.shadowBlur=10; var grad=x.createRadialGradient(cx, cy, 6, cx, cy, 28); grad.addColorStop(0,'#FFFFFF'); grad.addColorStop(1,'#F8FAFC'); x.beginPath(); x.arc(cx, cy, 24, 0, Math.PI*2); x.fillStyle=grad; x.fill(); x.lineWidth=4; x.strokeStyle=color; x.stroke(); x.restore(); x.lineCap='round'; x.lineJoin='round'; var sc='#1E293B'; var r=11; var h=7; x.lineWidth=2.6; x.strokeStyle=sc; x.beginPath(); x.moveTo(cx-r, cy-h); x.lineTo(cx+h, cy+h); x.moveTo(cx-r, cy+h); x.lineTo(cx+h, cy-h); x.stroke(); x.beginPath(); x.arc(cx-r, cy-h, 4, 0, Math.PI*2); x.fillStyle=sc; x.fill(); x.beginPath(); x.arc(cx-r, cy+h, 4, 0, Math.PI*2); x.fillStyle=sc; x.fill(); x.save(); var dotR=5; var dotX=cx+16; var dotY=cy+16; x.beginPath(); x.arc(dotX, dotY, dotR, 0, Math.PI*2); x.fillStyle=color; x.fill(); x.lineWidth=4; x.strokeStyle='#FFFFFF'; x.stroke(); x.restore(); return c; }
    function drawSalonFARingIcon(bm, ringColor){ var size=64; var c=document.createElement('canvas'); c.width=size; c.height=size; var x=c.getContext('2d'); var cx=size/2, cy=size/2; x.clearRect(0,0,size,size); x.save(); x.shadowColor='rgba(0,0,0,0.14)'; x.shadowBlur=10; var baseGrad=x.createRadialGradient(cx, cy, 6, cx, cy, 28); baseGrad.addColorStop(0,'#FFFFFF'); baseGrad.addColorStop(1,'#F8FAFC'); x.beginPath(); x.arc(cx, cy, 24, 0, Math.PI*2); x.fillStyle=baseGrad; x.fill(); x.restore(); var gap=0.48; x.lineCap='round'; x.lineJoin='round'; var ringGrad=x.createLinearGradient(cx-24, cy, cx+24, cy); ringGrad.addColorStop(0, ringColor); ringGrad.addColorStop(1, ringColor); x.lineWidth=5; x.strokeStyle=ringGrad; x.beginPath(); x.arc(cx, cy, 24, gap/2, Math.PI*2-gap/2); x.stroke(); x.lineWidth=2; x.strokeStyle='rgba(255,255,255,0.92)'; x.beginPath(); x.arc(cx, cy, 22, gap/2, Math.PI*2-gap/2); x.stroke(); try{ var inner=26; var scale=Math.min(inner/bm.width, inner/bm.height); var w=bm.width*scale; var h=bm.height*scale; x.drawImage(bm, cx-w/2, cy-h/2, w, h); }catch(_){ } return c; }
    async function getSalonPrimaryServiceIconUrl(salonId){ var cacheKey='salon_services_'+salonId; var sv=null; try{ var cached=localStorage.getItem(cacheKey); if(cached){ sv=JSON.parse(cached); } }catch(_){ }
      if(!sv){ try{ var r=await fetch('/api/salons/'+salonId+'/services').catch(function(){return null}); if(r&&r.ok){ var j=await r.json(); sv=j&&j.services?j.services:[]; try{ localStorage.setItem(cacheKey, JSON.stringify(sv)); }catch(_){ } } }catch(_){ }
      }
      var main=null; if(Array.isArray(sv)){ for(var i=0;i<sv.length;i++){ if(sv[i].service_type==='main'){ main=sv[i]; break; } } if(!main && sv.length){ main=sv[0]; } }
      if(!main) return null; var ms=null; for(var k=0;k<allMasterServices.length;k++){ if(allMasterServices[k].id==main.id){ ms=allMasterServices[k]; break; } }
      var icon=ms&&ms.icon?ms.icon:''; if(icon && (icon.indexOf('http')===0 || icon.indexOf('supabase')>=0)) return icon; return null; }
    var iconCache = {};
    var iconInflight = {};
    var unifiedBitmap = null;
    var triedLocalSalon = false;
    var triedLocalUser = false;
    
    // UPDATED: Local salon icon loader
    async function ensureLocalSalonIcon(){
      return new Promise(function(resolve){
        if(map.hasImage('salon-icon')) { resolve(true); return; }
        if(triedLocalSalon) { resolve(map.hasImage('salon-icon')); return; }
        triedLocalSalon = true;
        try{ map.loadImage('/map_icons/salon.png', function(err, image){
          if(err || !image){ resolve(false); return; }
          try{ map.addImage('salon-icon', image, { pixelRatio: 2 }); resolve(true); }catch(_){ resolve(false); }
        }); }catch(_){ resolve(false); }
      });
    }

    async function ensureUnifiedSalonImages(){ try{ if(!map) return; 
        
        // FIX: Retry if style not loaded yet (crucial for iOS)
        if(!(map.isStyleLoaded && map.isStyleLoaded())) {
            setTimeout(ensureUnifiedSalonImages, 200); 
            return;
        }

        var localOk = await ensureLocalSalonIcon();
        if(!localOk){
          if(!unifiedBitmap){ unifiedBitmap=await loadFAIconBitmap(); }
          var c = unifiedBitmap ? drawSalonFARingIconWithDot(unifiedBitmap, '#06C167') : makeSalonImageWithDot('#06C167');
          var img = toImageData(c);
          if(img && !map.hasImage('salon-icon')){ map.addImage('salon-icon', img, { pixelRatio: 2 }); }
        }
        imagesReady = map.hasImage('salon-icon');
    }catch(_){} }
    
    // UPDATED: Simplified to rely on local icon
    function ensureSalonImages(){
      if(!map) return;
      try{
        if(!(map.isStyleLoaded && map.isStyleLoaded())) {
            setTimeout(ensureSalonImages, 200);
            return;
        }
        imagesReady = map.hasImage('salon-icon');
        if(imagesReady) upgradeSalonLayer();
      }catch(_){}
    }

    // UPDATED: Added Retry Logic
    function ensureUserLayers(){
      try{
        if(!map) return; if(!userLocation) return; 
        
        // FIX: Retry if style not loaded yet
        if(!(map.isStyleLoaded && map.isStyleLoaded())) {
            setTimeout(ensureUserLayers, 200);
            return;
        }

        var pr = 2;

        var addedLocal = false;
        try{
          if(!triedLocalUser){
            triedLocalUser = true;
            map.loadImage('/map_icons/user.png', function(err, image){
              if(!err && image){ try{ if(!map.hasImage('user-pin')){ map.addImage('user-pin', image, { pixelRatio: pr }); } else { map.updateImage('user-pin', image); } addedLocal = true; }catch(_){ } }
            });
          }
        }catch(_){ }

        if(!addedLocal){
          try{ if(!map.hasImage('user-pin')){ var up = toImageData(makeUserImage()); if(up){ map.addImage('user-pin', up, { pixelRatio: pr }); } } else { var up2 = toImageData(makeUserImage()); if(up2){ map.updateImage('user-pin', up2); } } }catch(_){ }
        }
        var pt = { type:'Feature', geometry:{ type:'Point', coordinates:[userLocation.lng, userLocation.lat] } };
        if(!map.getSource('user-point')){ map.addSource('user-point', { type:'geojson', data: pt }); }
        if(!map.getLayer('user-halo')){ map.addLayer({ id:'user-halo', type:'circle', source:'user-point', paint:{ 'circle-color':'rgba(26,115,232,0.25)', 'circle-radius': 24, 'circle-blur': 0.8 }, layout:{ 'visibility':'visible' } }); }
        if(!map.getLayer('user-pin-symbol')){ map.addLayer({ id:'user-pin-symbol', type:'symbol', source:'user-point', layout:{ 'icon-image':'user-pin', 'icon-size': ['interpolate', ['linear'], ['zoom'], 10, 0.7, 14, 1.1], 'icon-allow-overlap': true, 'icon-anchor':'center' } }); }
        try{ map.getSource('user-point').setData(pt); }catch(_){}
      }catch(_){}
    }
    function clearMarkers(){ for(var i=0;i<markers.length;i++){ try{ markers[i].marker.remove(); }catch(_){} } markers=[]; }
    function applyFilters(){
      var q=document.getElementById('map-search').value.trim().toLowerCase();
      var cityF=document.getElementById('city-filter').value;
      var ratingMin=parseFloat(document.getElementById('rating-filter').value||0);
      clearMarkers();
      var visible=[];
      for(var i=0;i<salonsData.length;i++){
        var s=salonsData[i];
        var name=(s.salon_name||'').toLowerCase();
        var city=(s.city||'').toLowerCase();
        var addr=(s.address||'').toLowerCase();
        var rat=parseFloat(s.avg_rating||0);
        if(q && !(name.includes(q)||city.includes(q)||addr.includes(q))) continue;
        if(cityF && s.city!==cityF) continue;
        if(ratingMin && (!rat || rat<ratingMin)) continue;
        var marker=createMarker(s);
        markers.push({ salon:s, marker:marker });
        visible.push([s._lat, s._lng]);
      }
      if(visible.length){ try{ var b=new maplibregl.LngLatBounds(); for(var k=0;k<visible.length;k++){ var p=visible[k]; b.extend([p[1], p[0]]); } map.fitBounds(b, { padding: 40 }); }catch(_){} }
      setStatus(visible.length?('عدد الصالونات المعروضة: '+visible.length):'لا توجد نتائج');
    }
    function populateCityFilter(){
      var set=new Set();
      for(var i=0;i<salonsData.length;i++){ if(salonsData[i].city) set.add(salonsData[i].city); }
      var options = '<option value="">جميع المدن</option>'+[...set].sort().map(function(c){ return '<option value="'+c+'">'+c+'</option>'; }).join('');
      var sel=document.getElementById('city-filter');
      if(sel){ sel.innerHTML=options; }
      var msel=document.getElementById('modal-city-filter');
      if(msel){ msel.innerHTML=options; }
    }
    function populateServiceFilter(){
      var container=document.getElementById('service-options-container');
      if(!container) return;
      container.innerHTML='';
      for(var i=0;i<allMasterServices.length;i++){
        var s=allMasterServices[i];
        var id=s.id;
        var row='<label class="flex items-center gap-3 p-2 rounded"><input type="checkbox" class="service-checkbox" value="'+id+'"><span class="text-sm">'+(s.name_ar||s.name||'خدمة')+'</span></label>';
        container.insertAdjacentHTML('beforeend', row);
      }
    }
    var selectedChipIds=new Set();
    function renderServiceInlineStrip(){
      var strip=document.getElementById('service-inline-strip');
      if(!strip) return;
      strip.innerHTML='';
      var allChip=document.createElement('button');
      allChip.className='px-3 py-4 rounded-full border text-sm bg-gray-100 text-gray-700 whitespace-nowrap flex items-center gap-2 shadow-sm';
      allChip.innerHTML='<i class="fas fa-layer-group text-gray-500 text-lg"></i><span>جميع الخدمات</span>';
      allChip.onclick=function(){ selectedChipIds.clear(); var all=document.getElementById('service-all'); if(all) all.checked=true; document.querySelectorAll('.service-checkbox:not(#service-all)').forEach(function(cb){ cb.checked=false; }); renderServiceInlineStripHighlight(); applyFiltersNew(); };
      strip.appendChild(allChip);
      for(var i=0;i<allMasterServices.length;i++){
        var s=allMasterServices[i];
        var id=s.id;
        var name=s.name_ar||s.name||'خدمة';
        var icon=s.icon||'fa-cut';
        var isImg=icon&&((icon.indexOf('http')===0)||icon.indexOf('supabase')>=0);
        var chip=document.createElement('button');
        chip.className='px-3 py-4 rounded-full border text-sm bg-white text-gray-700 whitespace-nowrap flex items-center gap-2 shadow-sm';
        chip.innerHTML=(isImg?('<img src="'+icon+'" class="w-5 h-5 rounded-full" alt="">'):('<i class="fas '+icon+' text-gray-600 text-lg"></i>'))+'<span>'+name+'</span>';
        chip.dataset.id=id;
        chip.onclick=function(){ var sid=parseInt(this.dataset.id); if(selectedChipIds.has(sid)){ selectedChipIds.delete(sid); } else { selectedChipIds.add(sid); var all=document.getElementById('service-all'); if(all) all.checked=false; }
          var cb=document.querySelector('.service-checkbox[value="'+sid+'"]'); if(cb){ cb.checked=selectedChipIds.has(sid); }
          renderServiceInlineStripHighlight();
          applyFiltersNew(false);
        };
        strip.appendChild(chip);
      }
      renderServiceInlineStripHighlight();
    }
    function renderServiceInlineStripHighlight(){
      var strip=document.getElementById('service-inline-strip');
      if(!strip) return;
      var buttons=strip.querySelectorAll('button');
      buttons.forEach(function(btn,idx){
        if(idx===0){
          btn.className = selectedChipIds.size===0 ? 'px-3 py-4 rounded-full border text-sm bg-[#06C167] text-white whitespace-nowrap flex items-center gap-2 shadow' : 'px-3 py-4 rounded-full border text-sm bg-gray-100 text-gray-700 whitespace-nowrap flex items-center gap-2';
        } else {
          var sid=parseInt(btn.dataset.id);
          var active=selectedChipIds.has(sid);
          btn.className = active ? 'px-3 py-4 rounded-full border text-sm bg-[#06C167] text-white whitespace-nowrap flex items-center gap-2 shadow' : 'px-3 py-4 rounded-full border text-sm bg-white text-gray-700 whitespace-nowrap flex items-center gap-2';
        }
      });
    }
    function closeServiceDropdown(){ var m=document.getElementById('service-dropdown-menu'); var a=document.getElementById('service-dropdown-arrow'); if(m) m.classList.add('hidden'); if(a) a.classList.remove('rotate-180'); }
    function toggleServiceDropdown(){ var m=document.getElementById('service-dropdown-menu'); var a=document.getElementById('service-dropdown-arrow'); if(m) m.classList.toggle('hidden'); if(a) a.classList.toggle('rotate-180'); }
    function showFiltersModal(){ var modal=document.getElementById('filters-modal'); if(modal){ modal.classList.add('is-open'); document.body.classList.add('modal-open'); invalidateLater(); } }
    function hideFiltersModal(){ var modal=document.getElementById('filters-modal'); if(modal){ modal.classList.remove('is-open'); document.body.classList.remove('modal-open'); invalidateLater(); } }
    function haversineKm(lat1, lon1, lat2, lon2){ var R=6371; var dLat=(lat2-lat1)*Math.PI/180; var dLon=(lon2-lon1)*Math.PI/180; var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); var c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c; }
    
    // UPDATED: Added Retry Logic for map state
    async function applyFiltersNew(fit){
      
      // FIX: If map or style not ready, wait and retry. Crucial for race conditions.
      if(!map || !map.getStyle() || !map.isStyleLoaded()) {
          setTimeout(function() { applyFiltersNew(fit); }, 100);
          return;
      }

      fit = !!fit;
      var q=document.getElementById('map-search').value.trim().toLowerCase();
      var cityF=document.getElementById('modal-city-filter').value;
      var ratingMin=parseFloat(document.getElementById('modal-rating-filter').value||0);
      var needOpen=(function(){ var el=document.getElementById('filter-open-now'); return el?el.checked:false; })();
      var needAvail=(function(){ var el=document.getElementById('filter-available-today'); return el?el.checked:false; })();
      var selectedServiceIds=[];
      var allCb=document.getElementById('service-all');
      if(allCb && !allCb.checked){ var cbs=document.querySelectorAll('.service-checkbox:not(#service-all)'); cbs.forEach(function(cb){ if(cb.checked){ selectedServiceIds.push(parseInt(cb.value)); } }); }
      if(selectedChipIds.size){ selectedChipIds.forEach(function(id){ if(selectedServiceIds.indexOf(id)<0) selectedServiceIds.push(id); }); }
      clearMarkers();
      var filtered=[];
      for(var i=0;i<salonsData.length;i++){
        var s=salonsData[i];
        var name=(s.salon_name||'').toLowerCase();
        var city=(s.city||'').toLowerCase();
        var addr=(s.address||'').toLowerCase();
        var rat=parseFloat(s.avg_rating||0);
        if(q && !(name.includes(q)||city.includes(q)||addr.includes(q))) continue;
        if(cityF && s.city!==cityF) continue;
        if(ratingMin && (!rat || rat<ratingMin)) continue;
        if(needOpen && !(s.status==='open')) continue;
        if(needAvail && !(s.is_available_today)) continue;
        if(selectedServiceIds.length){
          var id=getSalonId(s);
          var cacheKey='salon_services_'+id;
          var sv=null;
          try{ var cached=localStorage.getItem(cacheKey); if(cached){ sv=JSON.parse(cached); } }catch(_){ }
          if(!sv){ try{ var r=await fetch('/api/salons/'+id+'/services').catch(function(){return null}); if(r&&r.ok){ var j=await r.json(); sv=j&&j.services?j.services:[]; try{ localStorage.setItem(cacheKey, JSON.stringify(sv)); }catch(_){ } } }catch(_){ } }
          var has=false;
          if(Array.isArray(sv)){ for(var k=0;k<sv.length;k++){ if(selectedServiceIds.indexOf(parseInt(sv[k].id))>=0){ has=true; break; } } }
          if(!has) continue;
        }
        var dm=(function(){ var el=document.getElementById('distance-mode'); return el?el.value:''; })();
        var dmin=(function(){ var el=document.getElementById('distance-minutes'); var v=el?el.value:''; return parseFloat(v||0); })();
        if(userLocation && dm && dmin>0){
          var distKm=haversineKm(userLocation.lat, userLocation.lng, s._lat, s._lng);
          var speedKmh = dm==='walking' ? 5 : 35;
          var minutes = (distKm / speedKmh) * 60;
          s._eta_minutes = minutes;
          if(minutes > dmin) continue;
        }
        filtered.push(s);
      }
      var dmSel=(function(){ var el=document.getElementById('distance-mode'); return el?el.value:''; })();
      if(dmSel){ filtered.sort(function(a,b){ return (a._eta_minutes||Infinity) - (b._eta_minutes||Infinity); }); }
      var visible=[];
      for(var j=0;j<filtered.length;j++){
        var s=filtered[j];
        visible.push([s._lat, s._lng]);
      }
      try{
        ensureSalonImages();
        await ensureUnifiedSalonImages();
        ensureFallbackCirclesLayer();
        if(!map.getSource('salons')){ map.addSource('salons', { type:'geojson', data:{ type:'FeatureCollection', features:[] } }); }
        if(!map.getLayer('salons-symbols')){ map.addLayer({ id:'salons-symbols', type:'symbol', source:'salons', layout:{ 'icon-image': 'salon-icon', 'icon-size': ['interpolate', ['linear'], ['zoom'], 10, 0.7, 14, 1.1], 'icon-allow-overlap': true, 'icon-ignore-placement': true, 'icon-anchor': 'center', 'visibility': imagesReady ? 'visible' : 'none' }, paint:{ } }); }
        // If images not ready, show circles until icons are loaded
        if(!imagesReady){ try{ map.setLayoutProperty('salons-circles','visibility','visible'); }catch(_){} try{ map.setLayoutProperty('salons-symbols','visibility','none'); }catch(_){} }
        if(map.getLayer('salons-circles')){ try{ map.setLayoutProperty('salons-circles','visibility','none'); }catch(_){ } }
        try{ if(!map._salonClickBound){ map.on('click','salons-symbols', function(e){ try{ var f=e.features&&e.features[0]; if(!f) return; var sid=f.properties&&f.properties.id; if(!sid) return; for(var i=0;i<salonsData.length;i++){ var ss=salonsData[i]; var iid=getSalonId(ss); if(iid==sid){ showSalonPreview(ss); break; } } }catch(_){} }); map.on('click','salons-circles', function(e){ try{ var f=e.features&&e.features[0]; if(!f) return; var sid=f.properties&&f.properties.id; if(!sid) return; for(var i=0;i<salonsData.length;i++){ var ss=salonsData[i]; var iid=getSalonId(ss); if(iid==sid){ showSalonPreview(ss); break; } } }catch(_){} }); map._salonClickBound=true; } }catch(_){ }
        var feats=[]; for(var j=0;j<filtered.length;j++){ feats.push(toSalonFeature(filtered[j])); }
        map.getSource('salons').setData({ type:'FeatureCollection', features:feats });
      }catch(_){ }
      if(userLocation){ visible.push([userLocation.lat, userLocation.lng]); }
      if(fit){ try{ var b=new maplibregl.LngLatBounds(); for(var k=0;k<visible.length;k++){ var p=visible[k]; b.extend([p[1], p[0]]); } map.fitBounds(b, { padding: 40, maxZoom: 15 }); }catch(_){} }
      setStatus(visible.length?('عدد الصالونات المعروضة: '+visible.length):'لا توجد نتائج');
    }
    function setVH(){ try{ var vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight) * 0.01; document.documentElement.style.setProperty('--vh', vh + 'px'); }catch(_){} }
    var invalidateTimer = null;
    function invalidateLater(){ try{ if(invalidateTimer) clearTimeout(invalidateTimer); invalidateTimer = setTimeout(function(){ try{ map && map.resize(); }catch(_){} }, 200); }catch(_){} }
    async function init(){
      setVH();
      window.addEventListener('resize', function(){ setVH(); invalidateLater(); });
      window.addEventListener('orientationchange', function(){ setVH(); invalidateLater(); });
      try{ if(window.visualViewport){ visualViewport.addEventListener('resize', function(){ setVH(); invalidateLater(); }, { passive: true }); visualViewport.addEventListener('scroll', function(){ setVH(); invalidateLater(); }, { passive: true }); } }catch(_){}
      window.addEventListener('pagehide', function(e){ needFullReinit=true; mapLoadOk=false; try{ if(map && map.remove){ map.remove(); } }catch(_){} map=null; });
      window.addEventListener('pageshow', function(e){ setVH(); invalidateLater(); try{ hideFiltersModal(); hideSalonPreview(); document.body.classList.remove('modal-open'); }catch(_){}
        try{ showLoadingOverlay(); recreateMap(); if(e && e.persisted){ setTimeout(function(){ try{ var already = sessionStorage.getItem('map_reload_done') === '1'; if(!mapLoadOk && !already){ sessionStorage.setItem('map_reload_done','1'); window.location.reload(); } }catch(_){} }, 600); } }
        catch(_){ try{ showLoadingOverlay(); recreateMap(); }catch(__){} }
      });
      
      var cfg=null; try{ var r=await fetch('/api/map/config'); if(r&&r.ok){ cfg=await r.json(); } }catch(_){ }
      var qsStyle=null; try{ qsStyle=new URL(window.location.href).searchParams.get('style'); }catch(_){ }
      var lsStyle=null; try{ lsStyle=localStorage.getItem('map_style_url'); }catch(_){ }
      if(qsStyle){ try{ localStorage.setItem('map_style_url', qsStyle); }catch(_){} }
      var styleUrl = qsStyle || lsStyle || ((cfg&&cfg.styleUrl)?cfg.styleUrl:null) || 'https://ogmap.com/styles/light_fresh.json';
      var cam=null; try{ var camRaw=localStorage.getItem('map_cam'); if(camRaw){ cam=JSON.parse(camRaw); } }catch(_){}
      var apiKey=(cfg&&cfg.apiKey)?cfg.apiKey:'';
      var tilesBase=(cfg&&cfg.tilesBase)?cfg.tilesBase:'https://tiles.ogmap.com/{z}/{x}/{y}.pbf';
      var styleObj=null; try{
        var cacheKey = 'map_style_cache:'+styleUrl; var tsKey = cacheKey+':ts';
        var cached=null; var ts=0; try{ cached=localStorage.getItem(cacheKey); ts=parseInt(localStorage.getItem(tsKey)||'0'); }catch(_){}
        var fresh = cached && ts && (Date.now() - ts < 24*60*60*1000);
        if (fresh) { try{ styleObj=JSON.parse(cached); }catch(_){ styleObj=null; } }
        if (!styleObj) { var rs=await fetch(styleUrl); if(rs&&rs.ok){ styleObj=await rs.json(); try{ localStorage.setItem(cacheKey, JSON.stringify(styleObj)); localStorage.setItem(tsKey, String(Date.now())); }catch(_){} } }
      }catch(_){ }
      if(styleObj&&styleObj.sources){
        for(var k in styleObj.sources){
          var src=styleObj.sources[k];
          if(!src) continue;
          if(typeof src.url==='string' && src.url.indexOf('tiles.ogmap.com')>=0){
            var tpl=src.url;
            var localTpl=(window.location.origin||'')+'/api/ogmap/tiles/{z}/{x}/{y}.pbf';
            delete src.url;
            src.tiles=[localTpl];
          }
          if(Array.isArray(src.tiles)){
            src.tiles=src.tiles.map(function(u){ return u.indexOf('tiles.ogmap.com')>=0 ? (window.location.origin||'')+'/api/ogmap/tiles/{z}/{x}/{y}.pbf' : u; });
          }
        }
        if(styleObj.sources.protomaps){ styleObj.sources.protomaps.attribution='© <a href="https://ogmap.com">OGMAP</a> © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'; }
      }
      map = new maplibregl.Map({ container: 'salon-map', style: styleObj||styleUrl, center: (cam&&Array.isArray(cam.center)?[cam.center[0], cam.center[1]]:[35.0, 31.95]), zoom: (cam&&typeof cam.zoom==='number'?cam.zoom:12), minZoom: 3, maxZoom: 19, dragRotate: false, pitchWithRotate: false, touchZoomRotate: true, doubleClickZoom: true, antialias: false, attributionControl: true, refreshExpiredTiles: false, maxTileCacheSize: 1024 });
      try { map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right'); } catch(_) {}
      try { map.addControl(new maplibregl.GeolocateControl({ trackUserLocation: false, showUserHeading: true, fitBoundsOptions: { maxZoom: 16 } }), 'top-right'); } catch(_) {}
      try { map.addControl(new maplibregl.ScaleControl({ maxWidth: 100, unit: 'metric' }), 'bottom-left'); } catch(_) {}
      
      map.on('load', async function(){ mapLoadOk=true; try{ sessionStorage.setItem('map_reload_done','0'); }catch(_){} try{ map.resize(); }catch(_){ } try{ map.setLight({ color: '#ffffff', intensity: 0.25 }); }catch(_){ } try{ map.setFog({ color: '#eaf7f0', 'horizon-blend': 0.06, range: [0.8, 8] }); }catch(_){ } try{ if(!map.getSource('salons')){ map.addSource('salons', { type:'geojson', data:{ type:'FeatureCollection', features:[] } }); } ensureFallbackCirclesLayer(); }catch(_){ } try{ ensureSalonImages(); await ensureUnifiedSalonImages(); toggleSalonLayerVisibility(); ensureUserLayers(); var sk=document.getElementById('map-skeleton'); if(sk) sk.style.display='none'; var mb=document.getElementById('map-loading-badge'); if(mb) mb.style.display='none'; }catch(_){ } try{ map.on('moveend', function(){ try{ var c=map.getCenter(); var z=map.getZoom(); localStorage.setItem('map_cam', JSON.stringify({ center:[c.lng,c.lat], zoom:z })); }catch(_){} }); }catch(_){ } });
      try{ map.on('idle', function(){ try{ ensureUnifiedSalonImages(); ensureFallbackCirclesLayer(); if(imagesReady){ try{ map.setLayoutProperty('salons-symbols','visibility','visible'); }catch(_){} try{ map.setLayoutProperty('salons-circles','visibility','none'); }catch(_){} } }catch(_){} }); }catch(_){}
      try{ map.on('styledata', async function(){ try{ imagesReady=false; ensureSalonImages(); await ensureUnifiedSalonImages(); toggleSalonLayerVisibility(); ensureUserLayers(); }catch(_){ } }); }catch(_){ }
      // Early retry loop to avoid races on slow devices/styles
      (function(){ var attempts=0; var max=8; var t=setInterval(function(){ attempts++; try{ ensureUnifiedSalonImages(); ensureFallbackCirclesLayer(); if(imagesReady){ try{ if(map.getLayer('salons-symbols')) map.setLayoutProperty('salons-symbols','visibility','visible'); }catch(_){} try{ if(map.getLayer('salons-circles')) map.setLayoutProperty('salons-circles','visibility','none'); }catch(_){} clearInterval(t); } }catch(_){ } if(attempts>=max){ clearInterval(t); } }, 350); })();
      
      // UPDATED: Fixed pixelRatio to 2 constant
      try{ map.on('styleimagemissing', async function(e){ try{ var id=e.id||''; 
        var pr = 2; 
        if(id==='user-pin'){ if(!map.hasImage('user-pin')){ var up = toImageData(makeUserImage()); if(up){ map.addImage('user-pin', up, { pixelRatio: pr }); ensureUserLayers(); } } return; }
        if(id==='salon-icon'){ await ensureUnifiedSalonImages(); toggleSalonLayerVisibility(); return; }
      }catch(_){} }); }catch(_){ }
      
      setTimeout(function(){ try{ map.resize(); }catch(_){} }, 500);
      if(cam){ restoredCamera=true; }
      try { navigator.geolocation.getCurrentPosition(function(pos){ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, !restoredCamera); ensureUserLayers(); }, function(){}, { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }); setTimeout(function(){ if(!hasCenteredOnUser && userLocation && !restoredCamera){ try{ map.setCenter([userLocation.lng, userLocation.lat]); map.setZoom(14); hasCenteredOnUser=true; applyMobileOffset(); }catch(_){} } }, 1500); } catch(_) {}
      try { navigator.geolocation.watchPosition(function(pos){ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, false); ensureUserLayers(); }, function(){}, { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }); } catch(_) {}
      try{ showLoadingOverlay(); var sk=document.getElementById('map-skeleton'); if(sk) sk.style.display='flex'; var mb=document.getElementById('map-loading-badge'); if(mb) mb.style.display='block'; }catch(_){}
      var d=await fetchDiscovery();
      var base=uniqById([].concat(d.citySalons, d.allSalons));
      var enriched=[];
      var cachedLocs = {};
      var unknownIds = [];
      for (var i=0;i<base.length;i++){
        var s=base[i]; var id=getSalonId(s); if(!id) continue;
        var key='salon_loc_'+id; var got=null;
        try{ var c=localStorage.getItem(key); if(c){ got=JSON.parse(c); } }catch(_){}
        if (got && typeof got.lat==='number' && typeof got.lng==='number') { cachedLocs[id]=got; } else { unknownIds.push(id); }
      }
      if (unknownIds.length){
        try{
          var resp=await fetch('/api/salons/locations/batch', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ ids: unknownIds }) });
          if (resp && resp.ok){ var j=await resp.json(); var arr=(j&&j.locations)||[]; for(var k=0;k<arr.length;k++){ var row=arr[k]; if(row && typeof row.latitude==='number' && typeof row.longitude==='number'){ var loc={ lat:Number(row.latitude), lng:Number(row.longitude) }; cachedLocs[row.salon_id]=loc; try{ localStorage.setItem('salon_loc_'+row.salon_id, JSON.stringify(loc)); }catch(_){} } }
          }
        }catch(_){}
      }
      for (var i=0;i<base.length;i++){
        var s=base[i]; var id=getSalonId(s); var loc=cachedLocs[id];
        if (!loc){ loc=await getSalonLocation(id, s); }
        if (loc){ s._lat=loc.lat; s._lng=loc.lng; enriched.push(s); }
      }
      salonsData=enriched;
      if(enriched.length){ populateCityFilter(); populateServiceFilter(); renderServiceInlineStrip(); var dmInit=document.getElementById('distance-mode'); if(dmInit) dmInit.value='driving'; applyFiltersNew(true); }
      if(!enriched.length){ populateCityFilter(); populateServiceFilter(); renderServiceInlineStrip(); var dmInit=document.getElementById('distance-mode'); if(dmInit) dmInit.value='driving'; applyFiltersNew(true); }
      try{ var sk2=document.getElementById('map-skeleton'); if(sk2) sk2.style.display='none'; var mb2=document.getElementById('map-loading-badge'); if(mb2) mb2.style.display='none'; hideLoadingOverlay(); }catch(_){ hideLoadingOverlay(); }
      document.getElementById('map-search').addEventListener('input', function(){ applyFiltersNew(false); });
      document.getElementById('modal-city-filter').addEventListener('change', function(){ applyFiltersNew(false); });
      document.getElementById('modal-rating-filter').addEventListener('change', function(){ applyFiltersNew(false); });
      var fb=document.getElementById('filters-btn'); if(fb) fb.addEventListener('click', showFiltersModal);
      var cfb=document.getElementById('close-filters-modal-btn'); if(cfb) cfb.addEventListener('click', hideFiltersModal);
      var adb=document.getElementById('apply-filters-btn'); if(adb) adb.addEventListener('click', function(){ closeServiceDropdown(); hideFiltersModal(); applyFiltersNew(true); });
      var clb=document.getElementById('clear-filters-btn'); if(clb) clb.addEventListener('click', function(){ var rf=document.getElementById('modal-rating-filter'); var cf=document.getElementById('modal-city-filter'); var all=document.getElementById('service-all'); var cbs=document.querySelectorAll('.service-checkbox:not(#service-all)'); if(rf) rf.value=''; if(cf) cf.value=''; if(all) all.checked=true; cbs.forEach(function(cb){ cb.checked=false; }); selectedChipIds.clear(); renderServiceInlineStripHighlight(); var openEl=document.getElementById('filter-open-now'); if(openEl) openEl.checked=false; var availEl=document.getElementById('filter-available-today'); if(availEl) availEl.checked=false; var dm=document.getElementById('distance-mode'); if(dm) dm.value='driving'; var dmin=document.getElementById('distance-minutes'); if(dmin) dmin.value=''; closeServiceDropdown(); hideFiltersModal(); applyFiltersNew(true); });
      var sdb=document.getElementById('service-dropdown-btn'); if(sdb) sdb.addEventListener('click', toggleServiceDropdown);
      var all=document.getElementById('service-all'); if(all) all.addEventListener('change', function(){ var cbs=document.querySelectorAll('.service-checkbox:not(#service-all)'); if(all.checked){ cbs.forEach(function(cb){ cb.checked=false; }); } });
      var bb=document.getElementById('back-btn'); if(bb){ bb.classList.add('show'); bb.addEventListener('click', function(){ try{ if(window.AppMode&&AppMode.transitionTo){ AppMode.transitionTo('/home_user.html', { delay: 200 }); } else { window.location.href='/home_user.html'; } }catch(_){ window.location.href='/home_user.html'; } }); }
      try{ map.on('dragstart', function(){ suspendAutoCenter=true; }); map.on('zoomstart', function(){ suspendAutoCenter=true; }); }catch(_){ }
    }
    document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='visible'){ try{ if(geoWatchId===null){ geoWatchId = navigator.geolocation.watchPosition(function(pos){ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, false); }, function(){}, { enableHighAccuracy: true, maximumAge: 5000, timeout: 30000 }); } }catch(_){} } else { try{ if(geoWatchId!==null){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; } }catch(_){} } });
    document.addEventListener('DOMContentLoaded', init);
    var pulseTimer=null; function startPulse(){ if(pulseTimer) return; var r=18; var dir=1; pulseTimer=setInterval(function(){ try{ r += dir*0.8; if(r>26){ dir=-1; } else if(r<18){ dir=1; } }catch(_){} }, 60); }
    function updateUserLocation(lat, lng, accuracy, center){
      var now = Date.now();
      var moved = userLocation ? (haversineKm(userLocation.lat, userLocation.lng, lat, lng) * 1000) : Infinity;
      var improved = (typeof accuracy==='number') ? (accuracy < bestAccuracy - 10) : false;
      if((now - lastUserUpdateTs) < minUpdateMs && !improved && moved < minMoveMeters){ return; }
      userLocation = { lat: lat, lng: lng };
      try{
        if(!map.getSource('user-point')){ map.addSource('user-point', { type:'geojson', data:{ type:'Feature', geometry:{ type:'Point', coordinates:[lng, lat] } } }); }
        
        // FIX: Always use pixelRatio 2 for user pin
        var pr = 2;

        try{ if(!map.hasImage('user-pin')){ var up2 = toImageData(makeUserImage()); if(up2){ map.addImage('user-pin', up2, { pixelRatio: pr }); } } else { var up3 = toImageData(makeUserImage()); if(up3){ map.updateImage('user-pin', up3); } } }catch(_){}
        if(!map.getLayer('user-pin-symbol')){ map.addLayer({ id:'user-pin-symbol', type:'symbol', source:'user-point', layout:{ 'icon-image':'user-pin', 'icon-size': ['interpolate', ['linear'], ['zoom'], 10, 0.7, 14, 1.1], 'icon-allow-overlap': true, 'icon-anchor':'center' } }); }
        try{ map.getSource('user-point').setData({ type:'Feature', geometry:{ type:'Point', coordinates:[lng, lat] } }); }catch(_){}
      }catch(_){ }
      if(center && !hasCenteredOnUser && !suspendAutoCenter){ try{ map.setCenter([lng, lat]); map.setZoom(16); hasCenteredOnUser=true; if(typeof accuracy==='number'){ bestAccuracy=accuracy; } lastCentered=[lat,lng]; }catch(_){} }
      else if(!suspendAutoCenter && hasCenteredOnUser && accuracy && accuracy < bestAccuracy && accuracy <= 50){ try{ map.setCenter([lng, lat]); map.setZoom(16); bestAccuracy=accuracy; lastCentered=[lat,lng]; }catch(_){} }
      if(accuracy && accuracy > 0){
        try{ if(map && map.isStyleLoaded && map.isStyleLoaded()){ var zoom=map.getZoom(); var mpp=156543.03392*Math.cos(lat*Math.PI/180)/Math.pow(2, zoom); var pr=Math.max(10, Math.min(220, accuracy/mpp)); var point={ type:'Feature', geometry:{ type:'Point', coordinates:[lng, lat] } }; var src=map.getSource('user-accuracy'); if(!src){ map.addSource('user-accuracy', { type:'geojson', data: point }); map.addLayer({ id:'user-accuracy-circle', type:'circle', source:'user-accuracy', paint:{ 'circle-color':'rgba(26,115,232,0.15)', 'circle-stroke-color':'rgba(26,115,232,0.35)', 'circle-stroke-width':1.5, 'circle-radius': pr } }); } else { src.setData(point); map.setPaintProperty('user-accuracy-circle', 'circle-radius', pr); } } }catch(_){}
      }
      lastUserUpdateTs = now;
    }
  </script>
  <script>
    var currentPreviewSalon = null;
    function showSalonPreview(s){
      currentPreviewSalon = s;
      var name = s.salon_name || '';
      var img = s.image_url || ('https://placehold.co/300x160/F9FAFB/1E293B?text='+(name.split(' ')[0]||'صالون'));
      var rating = parseFloat(s.avg_rating||0);
      var reviews = parseInt(s.review_count||0);
      var city = s.city || '';
      var address = s.address || '';
      var st = getSalonState(s);
      var statusText = (st==='open')?'مفتوح الآن':(st==='closing_soon')?'يغلق قريباً':(st==='opening_soon')?'يفتح قريباً':'مغلق';
      var statusClass = (st==='open')?'bg-green-100 text-green-800':(st==='closing_soon')?'bg-orange-100 text-orange-800':(st==='opening_soon')?'bg-blue-100 text-blue-800':'bg-gray-100 text-gray-600';
      var nameEl = document.getElementById('preview-name'); if(nameEl) nameEl.textContent = name;
      var imgEl = document.getElementById('preview-image'); if(imgEl){ imgEl.src = img; imgEl.alt = name; }
      var stEl = document.getElementById('preview-status'); if(stEl){ stEl.textContent = statusText; stEl.className = 'absolute top-3 left-3 text-xs font-bold px-3 py-1 rounded-full '+statusClass; }
      var rEl = document.getElementById('preview-rating'); if(rEl){ rEl.innerHTML = rating>0?('<i class="fas fa-star text-yellow-500"></i><span class="font-bold">'+rating.toFixed(1)+'</span>'+ (reviews>0?('<span class="text-gray-500">('+reviews+')</span>'):'') ):''; }
      var cEl = document.getElementById('preview-city-tag'); if(cEl){ cEl.innerHTML = city?('<i class="fas fa-map-marker-alt"></i><span>'+city+'</span>'):''; }
      var aTag = document.getElementById('preview-address-tag'); if(aTag){ aTag.innerHTML = address?('<i class="fas fa-map-pin"></i><span>'+address+'</span>'):''; }
      var dTag = document.getElementById('preview-distance-tag'); if(dTag){ var dm=(function(){ var el=document.getElementById('distance-mode'); return el?el.value:''; })(); if(userLocation){ var distKm=haversineKm(userLocation.lat, userLocation.lng, s._lat, s._lng); var txt=distKm?((distKm.toFixed(1))+' كم'):' '; if(dm){ var speedKmh=dm==='walking'?5:35; var minutes=(distKm/speedKmh)*60; var modeLabel=(dm==='walking'?'مشياً':'بالسيارة'); txt += ' • '+modeLabel+' ~'+Math.round(minutes)+' دقيقة'; } dTag.innerHTML = '<i class="fas fa-route"></i><span>'+txt+'</span>'; } else { dTag.innerHTML = ''; } }
      var svcEl = document.getElementById('preview-services-list');
      if(svcEl){
        svcEl.innerHTML='';
        var sid=getSalonId(s);
        var cacheKey='salon_services_'+sid;
        var sv=null;
        try{ var cached=localStorage.getItem(cacheKey); if(cached){ sv=JSON.parse(cached); } }catch(_){ }
        (async function(){
          if(!sv){ try{ var r=await fetch('/api/salons/'+sid+'/services').catch(function(){return null}); if(r&&r.ok){ var j=await r.json(); sv=j&&j.services?j.services:[]; try{ localStorage.setItem(cacheKey, JSON.stringify(sv)); }catch(_){ } } }catch(_){ } }
          var list=Array.isArray(sv)?sv:[];
          list.sort(function(a,b){ var aa=a.service_type==='main'?0:1; var bb=b.service_type==='main'?0:1; return aa-bb; });
          var top=list.slice(0,8);
          if(top.length===0){ svcEl.innerHTML='<span class="text-xs text-gray-500">لا توجد خدمات متاحة حالياً.</span>'; return; }
          for(var i=0;i<top.length;i++){
            var item=top[i];
            var ms=null;
            for(var k=0;k<allMasterServices.length;k++){ if(allMasterServices[k].id==item.id){ ms=allMasterServices[k]; break; } }
            var icon=ms&&ms.icon?ms.icon:'fa-cut';
            var isImg=icon&&((icon.indexOf('http')===0)||icon.indexOf('supabase')>=0);
            var iconHtml=isImg?('<img src="'+icon+'" class="w-4 h-4 rounded-full" alt="">'):('<i class="fas '+icon+' text-gray-600"></i>');
            var name=item.name_ar||item.name||'خدمة';
            var dur=item.service_type==='add_on'?'إضافة':(((parseInt(item.duration)||0)+' دقيقة'));
            var price=parseFloat(item.price||0);
            var chip='<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-gray-200 bg-white text-xs font-medium">'+iconHtml+'<span class="truncate max-w-[120px]">'+name+'</span><span class="text-gray-500">'+dur+'</span><span class="text-[#06C167] font-bold">'+(isNaN(price)?'':price.toFixed(0)+' شيكل')+'</span></span>';
            svcEl.insertAdjacentHTML('beforeend', chip);
          }
      })();
      }
      try{ var modal = document.getElementById('salon-preview-modal'); if(modal){ modal.classList.add('is-open'); document.body.classList.add('modal-open'); invalidateLater(); } }catch(_){}
    }
    function hideSalonPreview(){ var modal=document.getElementById('salon-preview-modal'); if(modal){ modal.classList.remove('is-open'); document.body.classList.remove('modal-open'); invalidateLater(); } }
    var cpm=document.getElementById('close-preview-modal-btn'); if(cpm){ cpm.addEventListener('click', hideSalonPreview); }
    var plm=document.getElementById('preview-learn-more'); if(plm){ plm.addEventListener('click', function(){ var s = currentPreviewSalon; if(!s) return; var id=getSalonId(s); if(id){ if(window.AppMode&&AppMode.transitionTo){ AppMode.transitionTo('/salon/'+id, { delay: 200, loading: true }); } else { window.location.href = '/salon/'+id; } } }); }
  </script>
</body>
</html>
