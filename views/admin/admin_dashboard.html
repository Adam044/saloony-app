<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="/offline-detect.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Saloony - لوحة تحكم الإدارة</title>
    <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link rel="stylesheet" href="./assets/dashboard.css">
  <link rel="stylesheet" href="./assets/admin.css">
  <script defer src="./assets/dashboard.js"></script>
  <script defer src="./assets/admin-header.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #F8FAFC; /* Light background */
            padding-bottom: 64px; /* Space for the fixed bottom navigation */
        }

        .bg-primary-dark { background-color: #1E293B; } /* Deep Charcoal Blue/Slate */
        .bg-secondary { background-color: #06C167; } /* Secondary background */
        .text-secondary { color: #06C167; } /* Vibrant Teal-Green Accent */
        .btn-approve { background-color: #06C167; color: #1E293B; }
        .btn-reject { background-color: #EF4444; color: white; }
        
        .nav-active {
            color: #06C167 !important; 
            background-color: rgba(6, 193, 103, 0.1) !important; 
            border-radius: 0.75rem !important;
            box-shadow: 0 2px 8px rgba(6, 193, 103, 0.2) !important;
        }
        .nav-item { padding: 0.5rem; }

        /* Card styles */
        .stat-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: flex-start;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 95%;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            margin: auto;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }
        .modal-open {
            display: flex !important;
            opacity: 1 !important;
        }
        .modal-open .modal-content {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }

        /* Responsive Table Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Payments-style badges reused for الحالة والخطة */
        .badge { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; display:inline-flex; align-items:center; gap:6px; }
        .badge-active { background:#D1FAE5; color:#065F46; border:1px solid #A7F3D0; }
        .badge-inactive { background:#FEE2E2; color:#991B1B; border:1px solid #FECACA; }
        .sub-badge { background:#DBEAFE; color:#1E40AF; border:1px solid #BFDBFE; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:700; }

        /* Payments page styles to match buttons and invoices modal */
        :root { --primary:#0f172a; --primary-darker:#0b1320; --border:#e5e7eb; --muted:#6b7280; }
        .btn { display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; border:none; }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-primary:hover { background:var(--primary-darker); }
        .actions { display:flex; gap:8px; }
        .muted { color: var(--muted); }
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:60; }
        .modal { width:96%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:0 16px 30px rgba(2,6,23,0.2); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid var(--border); }
        .modal-body { padding:16px; }
        .invoice-list { display:grid; gap:10px; }
        .invoice-item { display:flex; align-items:center; justify-content:space-between; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
    </style>
</head>
<body dir="rtl">
<script>
    // Security Check: Ensure admin token exists
    (function() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            // Redirect to splash/auth if no admin token
            window.location.replace('/auth.html'); 
        }
    })();
</script>

<div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-primary-dark shadow-lg p-2 flex justify-between items-center w-full z-20 fixed top-0" style="padding-top: env(safe-area-inset-top)">
        <div class="flex items-center pl-8 pr-4">
      <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1E293B/ffffff?text=ADM';" alt="Saloony Admin" class="h-10 w-auto object-contain object-center">
        </div>
        <h1 class="text-xl font-bold text-white">لوحة تحكم الإدارة</h1>
        <button id="logout-btn" class="text-white/80 hover:text-red-400 transition duration-150 p-2 rounded-lg hover:bg-white/10">
            <i class="fas fa-sign-out-alt text-lg"></i>
        </button>
    </header>

    <!-- Loading overlay -->
    <div id="dashboard-loading" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-[60] hidden">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300" style="border-top-color:#1E293B"></div>
    </div>

    <!-- Shared Top Navigation -->
        <nav class="top-nav">
        <a id="nav-dashboard" class="nav-link" href="/admin/admin_dashboard.html"><i class="fas fa-gauge"></i><span>لوحة الإدارة</span></a>
        <a id="nav-renewals" class="nav-link" href="/admin/renewals.html"><i class="fas fa-receipt"></i><span>التجديدات</span></a>
        <a id="nav-users" class="nav-link" href="/admin/users.html"><i class="fas fa-users"></i><span>المستخدمون</span></a>
        <a id="nav-progress" class="nav-link" href="/admin/progress.html"><i class="fas fa-chart-line"></i><span>التقدم</span></a>
        <a id="nav-analytics" class="nav-link" href="/admin/ai_analytics.html"><i class="fas fa-robot"></i><span>تحليلات الذكاء</span></a>
        <a id="nav-employees" class="nav-link" href="/admin/saloony_employees.html"><i class="fas fa-id-badge"></i><span>الموظفون</span></a>
    </nav>

    <main class="flex-grow p-4 md:p-8" style="padding-top: calc(60px + env(safe-area-inset-top))">
        <div id="message-box" class="hidden p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto" role="alert"></div>
        <div class="max-w-6xl mx-auto space-y-8">

            <!-- 1. Dashboard -->
            <div id="dashboard-view" class="view-content">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 mt-8">نظرة عامة</h2>
                
                <!-- Quick links removed: already available in header navigation -->
                
                <div id="stats-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <p class="col-span-full text-center text-gray-500">جاري تحميل الإحصائيات...</p>
                </div>
            </div>

            <!-- 2. Pending Salons -->
            <div id="pending-salons-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-red-500/50 pb-2 flex justify-between items-center mt-8">
                    <span class="inline-flex items-center gap-2">
                         <i class="fas fa-clock-rotate-left text-red-500"></i> الصالونات قيد الانتظار (<span id="pending-count">0</span>)
                    </span>
                    <button id="refresh-pending-btn" class="text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-sync-alt ml-1"></i> تحديث
                    </button>
                </h2>
                <!-- Filters: name, plan, status, city, date sort (Pending) -->
                <div class="mb-4 bg-white p-4 rounded-xl shadow-sm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <input id="salon-name-search-pending" type="text" placeholder="البحث باسم الصالون..." 
                               class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div>
                        <select id="salon-plan-filter-pending" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل الخطط</option>
                            <option value="2months_offer">عرض شهرين</option>
                            <option value="monthly_200">200ils</option>
                            <option value="monthly_60">60ils</option>
                            <option value="per_booking">لكل حجز</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-status-filter-pending" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل الحالات</option>
                            <option value="accepted">نشط</option>
                            <option value="rejected">غير نشط</option>
                            <option value="pending">قيد الانتظار</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-city-filter-pending" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل المدن</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-date-sort-pending" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">ترتيب افتراضي</option>
                            <option value="newest">الأحدث أولاً</option>
                            <option value="oldest">الأقدم أولاً</option>
                        </select>
                    </div>
                </div>
                <div id="pending-salons-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل الصالونات...</p>
                </div>
            </div>

            <!-- 3. All Salons -->
            <div id="all-salons-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 mt-8">إدارة الصالونات</h2>
                <!-- Filters: name, plan, status, city, date sort (All) -->
                <div class="mb-4 bg-white p-4 rounded-xl shadow-sm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <input id="salon-name-search-all" type="text" placeholder="البحث باسم الصالون..." 
                               class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div>
                        <select id="salon-plan-filter-all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل الخطط</option>
                            <option value="2months_offer">عرض شهرين</option>
                            <option value="monthly_200">200ils</option>
                            <option value="monthly_60">60ils</option>
                            <option value="per_booking">لكل حجز</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-status-filter-all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل الحالات</option>
                            <option value="accepted">نشط</option>
                            <option value="rejected">غير نشط</option>
                            <option value="pending">قيد الانتظار</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-city-filter-all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">كل المدن</option>
                        </select>
                    </div>
                    <div>
                        <select id="salon-date-sort-all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">ترتيب افتراضي</option>
                            <option value="newest">الأحدث أولاً</option>
                            <option value="oldest">الأقدم أولاً</option>
                        </select>
                    </div>
                </div>
                <div id="all-salons-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل جميع الصالونات...</p>
                </div>
            </div>
            
            <!-- 4. All Users -->
            <div id="all-users-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 mt-8">إدارة المستخدمين</h2>
                <div id="all-users-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل المستخدمين...</p>
                </div>
            </div>
            
            <!-- 4.5 Bookings Management -->
            <div id="bookings-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 mt-8">إدارة الحجوزات</h2>

                <!-- Search and Filter Controls -->
                <div class="mb-6 space-y-4 bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <input type="text" id="admin-booking-search" placeholder="ابحث في الحجوزات (اسم الصالون، المستخدم، الخدمة...)" 
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-light focus:border-primary-dark transition-colors">
                            <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="refresh-bookings" class="px-4 py-3 bg-primary-dark text-white rounded-xl hover:bg-primary-darker transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <select id="admin-booking-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">جميع الحالات</option>
                            <option value="upcoming">قادمة</option>
                            <option value="completed">مكتملة</option>
                            <option value="cancelled">ملغاة</option>
                            <option value="past">ماضية</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <input type="date" id="admin-booking-date" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark" placeholder="تاريخ الحجز">
                            <label class="flex items-center gap-2 text-gray-700">
                                <input type="checkbox" id="admin-booking-all-dates" class="rounded" checked>
                                <span>جميع التواريخ</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="bookings-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل الحجوزات...</p>
                </div>
            </div>
            
            <!-- 5. Services Management -->
            <div id="services-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 flex items-center gap-2 mt-8">
                    <i class="fas fa-concierge-bell text-secondary"></i> إدارة الخدمات
                </h2>
                
                <!-- Services Filter -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex gap-3 mb-4">
                        <select id="services-gender-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="men">خدمات الرجال</option>
                            <option value="women">خدمات النساء</option>
                        </select>
                        <div class="relative flex-1">
                            <input type="text" id="services-search" placeholder="البحث في الخدمات..." 
                                   class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    <button id="add-service-btn" class="bg-secondary text-white px-6 py-3 rounded-lg hover:bg-secondary/90 transition-colors font-medium">
                        <i class="fas fa-plus ml-2"></i> إضافة خدمة جديدة
                    </button>
                </div>
                
                <div id="services-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل الخدمات...</p>
                </div>
            </div>

            <!-- 6. Payments -->
            <div id="payments-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2 mt-8">إدارة المدفوعات</h2>
                
                <!-- Search and Filter Controls -->
                <div class="mb-6 space-y-4 bg-white p-4 rounded-xl shadow-sm">
                    <!-- Search Bar -->
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <input type="text" id="admin-payment-search" placeholder="البحث في المدفوعات (رقم الفاتورة، اسم الصالون، المبلغ...)" 
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-light focus:border-primary-dark transition-colors">
                            <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <!-- Simple QR Button -->
                        <button id="qr-scanner-btn" class="px-4 py-3 bg-primary-dark text-white rounded-xl hover:bg-primary-darker transition-colors">
                            <i class="fas fa-qrcode text-lg"></i>
                        </button>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="flex flex-wrap gap-3">
                        <select id="admin-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">جميع الحالات</option>
                            <option value="completed">مكتملة</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="failed">فاشلة</option>
                        </select>
                        
                        <select id="admin-type-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">جميع الأنواع</option>
                            <option value="offer_200ils">عرض 200 شيكل</option>
                            <option value="monthly_subscription">اشتراك شهري</option>
                            <option value="annual_subscription">اشتراك سنوي</option>
                        </select>
                        
                        <div class="flex items-center gap-2">
                            <input type="date" id="admin-date-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark" placeholder="تاريخ الإنشاء">
                            <label class="flex items-center gap-2 text-gray-700">
                                <input type="checkbox" id="admin-all-dates" class="rounded" checked>
                                <span>جميع التواريخ</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="payments-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل المدفوعات...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar (Fixed for PWA feel) -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full p-2 pb-5 flex justify-around shadow-2xl z-20">
        <button id="nav-dashboard" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-secondary nav-active" data-view="dashboard-view">
            <i class="fas fa-tachometer-alt text-xl"></i>
            <span class="text-xs font-bold mt-1">الرئيسية</span>
        </button>
        <button id="nav-pending" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="pending-salons-view">
            <i class="fas fa-user-clock text-xl"></i>
            <span class="text-xs font-medium mt-1">الانتظار</span>
            <span id="nav-pending-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
        </button>
        <button id="nav-salons" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="all-salons-view">
            <i class="fas fa-store-alt text-xl"></i>
            <span class="text-xs font-medium mt-1">الصالونات</span>
        </button>
        <button id="nav-bookings" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="bookings-view">
            <i class="fas fa-calendar-check text-xl"></i>
            <span class="text-xs font-medium mt-1">الحجوزات</span>
        </button>
        <button id="nav-services" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="services-view">
            <i class="fas fa-concierge-bell text-xl"></i>
            <span class="text-xs font-medium mt-1">الخدمات</span>
        </button>
        <button id="nav-payments" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="payments-view">
            <i class="fas fa-receipt text-xl"></i>
            <span class="text-xs font-medium mt-1">المدفوعات</span>
        </button>
    </nav>
</div>

<!-- Salon Activation/Deactivation Modal -->
<div id="approval-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
            <button id="approval-close-icon" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold text-primary-dark">أداة إدارة الصالون</h3>
            <span class="w-6"></span>
        </div>

        <!-- Current status, plan, and last payment -->
        <div id="salon-status-plan" class="grid grid-cols-1 md:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
                <span class="font-bold text-primary-dark">الحالة الحالية:</span>
                <span id="modal-salon-status-badge"></span>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-bold text-primary-dark">الخطة الحالية:</span>
                <span id="modal-current-plan" class="text-gray-700">غير محدد</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-bold text-primary-dark">آخر دفعة:</span>
                <span id="modal-last-payment-date" class="text-gray-700">—</span>
            </div>
        </div>

        <!-- Plan selection (compact) -->
        <div id="plan-options" class="mt-3 p-4 border border-gray-200 rounded-lg bg-white">
            <p class="font-bold text-primary-dark mb-3">تغيير الباقة</p>
            <div class="space-y-2">
                <label class="flex items-center cursor-pointer gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <input type="radio" name="plan-type" id="plan-2months-offer" value="2months_offer" class="h-4 w-4 text-secondary">
                    <span class="font-semibold">عرض شهرين</span>
                </label>
                <label class="flex items-center cursor-pointer gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <input type="radio" name="plan-type" id="plan-monthly-200" value="monthly_200" class="h-4 w-4 text-secondary" checked>
                    <span class="font-semibold">شهري 200</span>
                </label>
                <label class="flex items-center cursor-pointer gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <input type="radio" name="plan-type" id="plan-monthly-60" value="monthly_60" class="h-4 w-4 text-secondary">
                    <span class="font-semibold">لكل كرسي (60)</span>
                </label>
                <label class="flex items-center cursor-pointer gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <input type="radio" name="plan-type" id="plan-per-booking" value="per_booking" class="h-4 w-4 text-secondary">
                    <span class="font-semibold">لكل حجز (1)</span>
                </label>
            </div>
        </div>
        <div id="chairs-input-container" class="mt-3 p-4 border border-gray-200 rounded-lg bg-white hidden">
            <label class="block text-sm font-semibold text-primary-dark mb-1">عدد الكراسي</label>
            <input type="number" id="plan-chairs-input" min="1" value="1" class="w-32 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary">
        </div>

        <!-- Actions -->
        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3 mt-6">
            <div class="flex items-center justify-between w-full md:w-auto bg-white border border-gray-200 rounded-xl px-4 py-3">
                <span class="font-bold text-primary-dark">تفعيل الصالون</span>
                <label class="inline-flex items-center cursor-pointer ml-3">
                    <input type="checkbox" id="status-toggle" class="sr-only peer">
                    <div class="w-12 h-6 bg-gray-300 peer-checked:bg-green-500 rounded-full relative transition">
                        <span class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition transform peer-checked:translate-x-6 peer-checked:scale-110 flex items-center justify-center">
                            <i class="fas fa-check text-green-500 opacity-0 transition-all duration-300 peer-checked:opacity-100 peer-checked:rotate-12"></i>
                        </span>
                    </div>
                </label>
            </div>
            <button id="save-plan-btn" class="hidden flex-1 px-4 py-3 rounded-xl font-bold bg-primary-dark text-white hover:bg-primary-dark transition">
                <i class="fas fa-save ml-2"></i> حفظ التغييرات
            </button>
        </div>
    </div>
</div>

<!-- Invoice Confirmation Modal -->
<div id="invoice-confirm-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-primary-dark">إنشاء فاتورة؟</h3>
            <button id="invoice-confirm-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-gray-700 mb-4">هل ترغب في إنشاء فاتورة لهذه الباقة الآن؟</p>
        <div class="flex items-center gap-3">
            <button id="invoice-confirm-yes" class="flex-1 py-2 rounded-lg bg-secondary text-white hover:bg-secondary/90 font-bold">نعم</button>
            <button id="invoice-confirm-no" class="flex-1 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-bold">لا</button>
        </div>
    </div>
</div>

<!-- Previous Invoices Modal (match payments.html) -->
<div class="modal-backdrop" id="invoices-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 style="font-size: 18px; font-weight: 800; color:#0f172a">فواتير سابقة</h3>
      <button class="btn" onclick="closeInvoicesModal()" style="color:#6b7280"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div id="invoices-container" class="invoice-list"></div>
    </div>
  </div>
  </div>

<!-- Salon Details Modal (no photo) -->
<div id="salon-details-modal" class="modal-overlay">
    <div class="modal-content max-w-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-primary-dark">تفاصيل الصالون</h3>
            <button id="close-salon-details-btn" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="space-y-2 p-2">
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-store text-primary-dark"></i><span class="font-bold text-primary-dark">اسم الصالون:</span><span id="details-salon-name" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-user text-primary-dark"></i><span class="font-bold text-primary-dark">اسم المالك:</span><span id="details-owner-name" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-phone-alt text-primary-dark"></i><span class="font-bold text-primary-dark">هاتف المالك:</span><span id="details-owner-phone" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-envelope text-primary-dark"></i><span class="font-bold text-primary-dark">البريد الإلكتروني:</span><span id="details-email" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-map-marker-alt text-primary-dark"></i><span class="font-bold text-primary-dark">العنوان:</span><span id="details-address" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-venus-mars text-primary-dark"></i><span class="font-bold text-primary-dark">الفئة المستهدفة:</span><span id="details-gender-focus" class="ml-1">---</span></div>
            <div class="flex items-center gap-2 text-gray-800"><i class="fas fa-calendar-plus text-primary-dark"></i><span class="font-bold text-primary-dark">تاريخ الانضمام:</span><span id="details-date-joined" class="ml-1">—</span></div>
        </div>
    </div>
</div>

<!-- Clean Payment Details Modal -->
<div id="clean-payment-modal" class="modal-overlay">
    <div class="modal-content max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-primary-dark">تفاصيل الفاتورة</h3>
            <button onclick="closeCleanPaymentModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-primary-light to-secondary-light rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-xl font-bold text-primary-dark mb-1" id="clean-salon-name">اسم الصالون</h4>
                        <p class="text-primary-dark opacity-80" id="clean-invoice-number">رقم الفاتورة</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary-dark" id="clean-amount">المبلغ</div>
                        <div class="text-sm text-primary-dark opacity-80" id="clean-payment-type">نوع الدفع</div>
                    </div>
                </div>
            </div>
            
            <!-- Status Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-info-circle text-primary-dark"></i>
                        <span class="font-medium text-gray-700">حالة الدفع</span>
                    </div>
                    <div id="clean-status-badge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium">
                        <i id="clean-status-icon"></i>
                        <span id="clean-status-text">الحالة</span>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-credit-card text-primary-dark"></i>
                        <span class="font-medium text-gray-700">طريقة الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-payment-method">طريقة الدفع</p>
                </div>
            </div>
            
            <!-- Date Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-calendar text-primary-dark"></i>
                        <span class="font-medium text-gray-700">تاريخ الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-payment-date">التاريخ</p>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4" id="clean-valid-until-container">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-clock text-primary-dark"></i>
                        <span class="font-medium text-gray-700">صالح حتى</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-valid-until">التاريخ</p>
                </div>
            </div>
            
            <!-- Description Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-4" id="clean-description-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-file-text text-primary-dark"></i>
                    <span class="font-medium text-gray-700">الوصف</span>
                </div>
                <p class="text-gray-700 leading-relaxed" id="clean-description">الوصف</p>
            </div>
            
            <!-- Admin Notes Section -->
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4" id="clean-admin-notes-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-sticky-note text-amber-600"></i>
                    <span class="font-medium text-amber-800">ملاحظات الإدارة</span>
                </div>
                <p class="text-amber-700 leading-relaxed" id="clean-admin-notes">الملاحظات</p>
            </div>
        </div>
        
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="closeCleanPaymentModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div id="payment-details-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-primary-dark">تفاصيل الدفعة</h3>
            <button onclick="hidePaymentDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Payment Status -->
            <div class="flex items-center justify-between p-3 rounded-lg" id="payment-status-section">
                <span class="font-semibold">الحالة:</span>
                <div class="flex items-center" id="payment-status-display">
                    <i id="payment-status-icon" class="ml-2"></i>
                    <span id="payment-status-text"></span>
                </div>
            </div>
            
            <!-- Payment Details -->
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">رقم الفاتورة:</span>
                    <span id="payment-invoice-number" class="text-primary-dark font-mono"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">اسم الصالون:</span>
                    <span id="payment-salon-name" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">تاريخ الدفع:</span>
                    <span id="payment-date" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">نوع الدفع:</span>
                    <span id="payment-type" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">المبلغ:</span>
                    <span id="payment-amount" class="text-primary-dark font-bold text-lg"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">طريقة الدفع:</span>
                    <span id="payment-method" class="text-primary-dark"></span>
                </div>
                
                <div id="payment-valid-until-section" class="flex justify-between">
                    <span class="font-semibold text-gray-700">صالح حتى:</span>
                    <span id="payment-valid-until" class="text-primary-dark"></span>
                </div>
                
                <div id="payment-description-section" class="border-t pt-3">
                    <span class="font-semibold text-gray-700 block mb-2">الوصف:</span>
                    <p id="payment-description" class="text-gray-600 text-sm"></p>
                </div>
                
                <div id="payment-admin-notes-section" class="border-t pt-3">
                    <span class="font-semibold text-gray-700 block mb-2">ملاحظات الإدارة:</span>
                    <p id="payment-admin-notes" class="text-gray-600 text-sm"></p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center mt-6">
            <button onclick="hidePaymentDetailsModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qr-scanner-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-primary-dark">مسح رمز QR للفاتورة</h3>
            <button onclick="closeQRScanner()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Camera Preview -->
            <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 300px;">
                <video id="qr-video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <div class="absolute inset-0 flex items-center justify-center" id="qr-loading">
                    <div class="text-center">
                        <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">جاري تشغيل الكاميرا...</p>
                    </div>
                </div>
                <div class="absolute inset-0 border-2 border-dashed border-primary-dark opacity-50 m-8 rounded-lg"></div>
            </div>
            
            <!-- Manual Input Fallback -->
            <div class="border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">أو أدخل رقم الفاتورة يدوياً:</label>
                <div class="flex gap-2">
                    <input type="text" id="manual-invoice-input" placeholder="رقم الفاتورة" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                    <button onclick="searchByManualInput()" class="px-4 py-2 bg-primary-dark text-white rounded-lg hover:bg-primary-darker transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div id="qr-scan-result" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span class="font-medium text-green-800">تم العثور على الفاتورة!</span>
                    </div>
                    <p id="qr-result-text" class="text-sm text-green-700"></p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeQRScanner()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                إلغاء
            </button>
        </div>
    </div>
</div>

<script>
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (_) { return null; }
    }

    async function attemptRefreshAdmin() {
        try {
            const res = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({})
            });
            if (!res.ok) return null;
            const data = await res.json();
            if (data && data.access_token) {
                localStorage.setItem('adminToken', data.access_token);
                return data.access_token;
            }
            return null;
        } catch (_) { return null; }
    }

    function tokenSecondsLeft(token) {
        const payload = parseJwt(token);
        if (!payload || !payload.exp) return 0;
        return Math.floor(payload.exp - (Date.now() / 1000));
    }

    function scheduleAdminRefresh() {
        setInterval(async () => {
            try {
                const t = localStorage.getItem('adminToken');
                if (!t) return;
                const left = tokenSecondsLeft(t);
                if (left <= 120) { await attemptRefreshAdmin(); }
            } catch (_) {}
        }, 60000);
    }

    let adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
        // Redirection already handled above, but here for local script safety
        window.location.replace('/auth.html'); 
    }

    (async () => {
        if (!adminToken) return;
        const left = tokenSecondsLeft(adminToken);
        if (left <= 60) {
            const nt = await attemptRefreshAdmin();
            if (!nt) { window.location.replace('/auth.html'); return; }
            adminToken = nt;
        }
        scheduleAdminRefresh();
    })();

    let currentView = 'dashboard-view';
    let pendingSalonsData = [];

    // Utility function to display messages
    const showMessage = (element, message, isSuccess = true) => {
        element.classList.remove('hidden'); 
        element.textContent = message;
        element.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
        
        element.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'border-red-200', 'border-green-200');
        
        element.classList.add('border');
        element.classList.add(...(isSuccess ? ['bg-green-100', 'text-green-700', 'border-green-200'] : ['bg-red-100', 'text-red-700', 'border-red-200']));
        
        setTimeout(() => { element.classList.add('hidden'); }, 5000);
    };
    const messageBox = document.getElementById('message-box');

    // Utility function to format date
    const formatDate = (dateString) => {
        if (!dateString) return 'غير محدد';
        try {
            // Handle different server date formats (ISO, YYYY-MM-DD HH:MM:SS)
            let date = new Date(dateString);
            if (dateString.includes(' ') && !dateString.includes('T')) {
                date = new Date(dateString.replace(' ', 'T'));
            }
            if (isNaN(date.getTime())) {
                return dateString;
            }
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch (e) {
            return dateString;
        }
    };
    
    // Utility: format status using payments-style badges
    const formatStatus = (status) => {
        if (status === 'accepted') {
            return `<span class="badge badge-active"><i class="fas fa-check-circle"></i> نشط</span>`;
        }
        if (status === 'rejected') {
            return `<span class="badge badge-inactive"><i class="fas fa-ban"></i> غير نشط</span>`;
        }
        // Pending or unknown fallbacks
        return `<span class="badge" style="background:#FEF3C7; color:#92400E; border:1px solid #FDE68A;"><i class="fas fa-clock"></i> قيد الانتظار</span>`;
    };

    // --- Plan formatting helpers ---
    function getLatestPaymentForSalon(salonId) {
        try {
            const payments = window.allAdminPayments || [];
            const related = payments.filter(p => p.salon_id === salonId);
            if (!related.length) return null;
            related.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            return related[0];
        } catch (e) { return null; }
    }

    function mapPaymentTypeToPlan(paymentType) {
        switch (paymentType) {
            case 'offer_200ils': return '2months_offer';
            case 'monthly_subscription': return 'monthly_200';
            case 'per_chair': return 'monthly_60';
            case 'per_booking': return 'per_booking';
            default: return undefined;
        }
    }

    // --- Revenue helpers (align with progress.html) ---
    function monthKey(d) {
        try {
            const dt = new Date(d);
            return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        } catch { return ''; }
    }
    function formatCurrencyILS(amount) {
        const num = Number(amount || 0);
        return `₪${num.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    }

    // Cache for salon signup dates
    window.salonLocationCache = window.salonLocationCache || {};
    async function getSalonSignupDate(salonId) {
        const cache = window.salonLocationCache;
        if (cache[salonId] !== undefined) return cache[salonId];
        try {
            const res = await fetch(`/api/salon/location/${salonId}`);
            if (!res.ok) { cache[salonId] = null; return null; }
            const data = await res.json();
            const created = data?.created_at || data?.location?.created_at || null;
            cache[salonId] = created;
            return created;
        } catch { cache[salonId] = null; return null; }
    }
    async function ensureSignupDates(salons) {
        const cache = window.salonLocationCache;
        const missing = salons.filter(s => cache[s.id] === undefined);
        if (missing.length === 0) return;
        await Promise.all(missing.map(async (s) => { await getSalonSignupDate(s.id); }));
    }

    function formatSalonPlanForRow(salon) {
        // Show plan badge only for accepted (active) salons, otherwise use muted placeholder
        const isActive = salon.status === 'accepted';
        if (!isActive) {
            return '<span class="text-gray-500">---</span>';
        }

        const override = (window.salonPlanOverrides || {})[salon.id];
        let planType = salon.plan || override?.planType;
        let chairs = (salon.plan_chairs != null ? parseInt(salon.plan_chairs, 10) : undefined);
        if (chairs == null) chairs = override?.planChairs ? parseInt(override.planChairs, 10) : 1;

        if (!planType) {
            const last = getLatestPaymentForSalon(salon.id);
            planType = mapPaymentTypeToPlan(last?.payment_type);
        }

        // Map to payments page labels and use the same sub-badge style
        if (planType === '2months_offer') {
            return '<span class="sub-badge">عرض شهرين</span>';
        }
        if (planType === 'monthly_200') {
            return '<span class="sub-badge">200ils</span>';
        }
        if (planType === 'monthly_60') {
            return '<span class="sub-badge">60ils</span>';
        }
        if (planType === 'per_booking') {
            return '<span class="sub-badge">لكل حجز</span>';
        }
        return '<span class="text-gray-500">---</span>';
    }

    // --- View Switching ---
    const views = {
        'dashboard-view': document.getElementById('dashboard-view'),
        'pending-salons-view': document.getElementById('pending-salons-view'),
        'all-salons-view': document.getElementById('all-salons-view'),
        'bookings-view': document.getElementById('bookings-view'),
        'all-users-view': document.getElementById('all-users-view'),
        'services-view': document.getElementById('services-view'),
        'payments-view': document.getElementById('payments-view'),
    };
    
    const navItems = document.querySelectorAll('.nav-item');

    const switchView = async (viewId) => {
        Object.values(views).forEach(view => view.classList.add('hidden'));
        views[viewId].classList.remove('hidden');

        navItems.forEach(btn => {
            btn.classList.remove('nav-active', 'text-secondary', 'text-gray-500');
            btn.classList.add('text-gray-500', 'hover:text-secondary', 'hover:bg-secondary/10');
            btn.querySelector('span:last-child').classList.remove('font-bold');
            btn.querySelector('span:last-child').classList.add('font-medium');
            if (btn.getAttribute('data-view') === viewId) {
                btn.classList.add('nav-active', 'text-secondary');
                btn.classList.remove('text-gray-500', 'hover:text-secondary', 'hover:bg-secondary/10');
                btn.querySelector('span:last-child').classList.add('font-bold');
                btn.querySelector('span:last-child').classList.remove('font-medium');
            }
        });
        
        currentView = viewId;
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if (viewId === 'dashboard-view') {
            await loadAdminStats();
        } else if (viewId === 'pending-salons-view') {
            await loadSalons('pending');
        } else if (viewId === 'all-salons-view') {
            await loadSalons('all');
        } else if (viewId === 'bookings-view') {
            await loadBookings();
        } else if (viewId === 'services-view') {
            await loadServices();
        } else if (viewId === 'payments-view') {
            await loadPayments();
        }
    };
    
    // --- Data Loading Functions ---

    const loadAdminStats = async () => {
        const grid = document.getElementById('stats-grid');
        grid.innerHTML = '<p class="col-span-full text-center text-gray-500">جاري تحميل الإحصائيات...</p>';
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const stats = await response.json();
            // Revenue KPIs: align with progress.html using payments
            let revenueCards = [];
            try {
                const pRes = await fetch('/api/admin/payments', { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const payments = pRes.ok ? await pRes.json() : [];
                const completed = payments.filter(p => p.payment_status === 'completed' || p.payment_status === 'مكتملة');
                const today = new Date();
                const todayKey = today.toISOString().slice(0,10);
                const monthKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
                const lastMonthKey = `${today.getFullYear()}-${String(today.getMonth()).padStart(2,'0')}`;
                const sumAll = completed.reduce((acc, p) => acc + Number(p.amount || 0), 0);
                const sumToday = completed.filter(p => (p.created_at || '').slice(0,10) === todayKey)
                                          .reduce((acc, p) => acc + Number(p.amount || 0), 0);
                const sumMonth = completed.filter(p => monthKey(p.created_at) === monthKeyStr)
                                          .reduce((acc, p) => acc + Number(p.amount || 0), 0);
                const sumLastMonth = completed.filter(p => monthKey(p.created_at) === lastMonthKey)
                                              .reduce((acc, p) => acc + Number(p.amount || 0), 0);
                const revGrowth = sumLastMonth === 0 ? (sumMonth > 0 ? 100 : 0) : Math.round(((sumMonth - sumLastMonth) / sumLastMonth) * 100);
                revenueCards = [
                    { title: 'إيراد اليوم', count: formatCurrencyILS(sumToday), icon: 'fa-bolt', color: 'text-amber-500' },
                    { title: 'إيراد هذا الشهر', count: formatCurrencyILS(sumMonth), icon: 'fa-wallet', color: 'text-indigo-600' },
                    { title: 'إجمالي الإيرادات', count: formatCurrencyILS(sumAll), icon: 'fa-money-bill-wave', color: 'text-green-600' },
                    { title: 'نمو الإيراد مقابل الشهر الماضي', count: `${revGrowth}%`, icon: 'fa-chart-line', color: 'text-blue-600' },
                ];
            } catch (_) {
                // Fallback to server-provided revenue if payments fetch fails
                revenueCards = [
                    { title: 'إجمالي الإيرادات', count: `${stats.totalRevenue || 0} ₪`, icon: 'fa-money-bill-wave', color: 'text-green-600' },
                ];
            }
            
            // Define stat cards
            const statCards = [
                { title: 'إجمالي المستخدمين', count: stats.totalUsers || 0, icon: 'fa-users', color: 'text-blue-500' },
                { title: 'إجمالي الصالونات', count: stats.totalSalons || 0, icon: 'fa-store-alt', color: 'text-primary-dark' },
                { title: 'صالونات قيد الانتظار', count: stats.pendingSalons || 0, icon: 'fa-user-clock', color: 'text-red-500' },
                { title: 'المواعيد الكلية', count: stats.totalAppointments || 0, icon: 'fa-calendar-check', color: 'text-secondary' },
                { title: 'الصالونات النشطة', count: stats.activeSalons || 0, icon: 'fa-check-circle', color: 'text-green-500' },
                { title: 'صالونات الرجال', count: stats.menSalons || 0, icon: 'fa-mars', color: 'text-indigo-500' },
                { title: 'صالونات النساء', count: stats.womenSalons || 0, icon: 'fa-venus', color: 'text-pink-500' },
            ];
            // Append revenue cards (computed client-side)
            statCards.push(...revenueCards);
            
            grid.innerHTML = statCards.map(card => `
                <div class="stat-card">
                    <div class="space-y-1">
                        <p class="text-gray-500 text-sm">${card.title}</p>
                        <p class="text-3xl font-extrabold text-primary-dark">${card.count}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center ${card.color} bg-gray-100/50">
                        <i class="fas ${card.icon} text-xl"></i>
                    </div>
                </div>
            `).join('');

            // Update pending badge in navigation
            const badge = document.getElementById('nav-pending-badge');
            const pendingCountEl = document.getElementById('pending-count');
            const pendingCount = parseInt(stats.pendingSalons || 0);
            if (badge) {
                badge.textContent = pendingCount;
                badge.classList.toggle('hidden', pendingCount === 0);
            }
            if (pendingCountEl) {
                 pendingCountEl.textContent = pendingCount;
            }

        } catch (error) {
            console.error('Error fetching stats:', error);
            grid.innerHTML = '<p class="col-span-full text-center text-red-500">فشل تحميل الإحصائيات.</p>';
            showMessage(messageBox, 'فشل تحميل الإحصائيات من الخادم.', false);
        }
    };

    function showDashboardLoading(){ document.getElementById('dashboard-loading')?.classList.remove('hidden'); }
    function hideDashboardLoading(){ document.getElementById('dashboard-loading')?.classList.add('hidden'); }

    const loadSalons = async (filter) => {
        const container = filter === 'pending' ? document.getElementById('pending-salons-list') : document.getElementById('all-salons-list');
        const listName = filter === 'pending' ? 'Pending Salons' : 'All Salons';
        
        container.innerHTML = `<p class="text-center text-gray-500 p-8">جاري تحميل ${listName}...</p>`;
        showDashboardLoading();

        try {
            const response = await fetch('/api/admin/salons', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const allSalons = await response.json();
            
            pendingSalonsData = allSalons.filter(s => s.status === 'pending');
            let baseSalons = filter === 'all' ? allSalons : pendingSalonsData;

            // Read filters for the current view
            const nameInputId = filter === 'all' ? 'salon-name-search-all' : 'salon-name-search-pending';
            const planSelectId = filter === 'all' ? 'salon-plan-filter-all' : 'salon-plan-filter-pending';
            const statusSelectId = filter === 'all' ? 'salon-status-filter-all' : 'salon-status-filter-pending';
            const citySelectId = filter === 'all' ? 'salon-city-filter-all' : 'salon-city-filter-pending';
            const sortSelectId = filter === 'all' ? 'salon-date-sort-all' : 'salon-date-sort-pending';

            const nameTerm = document.getElementById(nameInputId)?.value?.toLowerCase()?.trim() || '';
            const planTerm = document.getElementById(planSelectId)?.value || '';
            const statusTerm = document.getElementById(statusSelectId)?.value || '';
            const cityTerm = document.getElementById(citySelectId)?.value || '';
            const sortTerm = document.getElementById(sortSelectId)?.value || '';

            // Ensure payments available when plan filter requires inference
            if (planTerm && !window.allAdminPayments) {
                try {
                    const pRes = await fetch('/api/admin/payments', { headers: { 'Authorization': `Bearer ${adminToken}` } });
                    if (pRes.ok) window.allAdminPayments = await pRes.json();
                } catch (e) { /* ignore */ }
            }

            // Helper: derive a plan key for filtering
            const computePlanKey = (salon) => {
                const override = (window.salonPlanOverrides || {})[salon.id];
                let planType = salon.plan || override?.planType;
                if (!planType) {
                    const last = getLatestPaymentForSalon(salon.id);
                    planType = mapPaymentTypeToPlan(last?.payment_type);
                }
                return planType;
            };

            // Build counts for options (for display)
            const statusCounts = {
                accepted: baseSalons.filter(s => s.status === 'accepted').length,
                rejected: baseSalons.filter(s => s.status === 'rejected').length,
                pending: baseSalons.filter(s => s.status === 'pending').length
            };
            const planKeys = ['2months_offer','monthly_200','monthly_60','per_booking'];
            const planCounts = planKeys.reduce((acc, k) => { acc[k] = baseSalons.filter(s => s.status === 'accepted' && computePlanKey(s) === k).length; return acc; }, {});
            const cityCounts = {};
            baseSalons.forEach(s => { const c = (s.city || 'غير محدد'); cityCounts[c] = (cityCounts[c] || 0) + 1; });
            const sortedCities = Object.keys(cityCounts).sort((a,b) => a.localeCompare(b));

            // Update plan/status/city select options with counts (preserve selection)
            const planSel = document.getElementById(planSelectId);
            const stSel = document.getElementById(statusSelectId);
            const ctSel = document.getElementById(citySelectId);
            const prevPlan = planTerm; const prevStatus = statusTerm; const prevCity = cityTerm;
            if (planSel) {
                const totalPlans = Object.values(planCounts).reduce((a,b)=>a+b,0);
                planSel.innerHTML = `
                    <option value="">كل الخطط (${totalPlans})</option>
                <option value="2months_offer">عرض شهرين (${planCounts['2months_offer'] || 0})</option>
                <option value="monthly_200">200ils (${planCounts['monthly_200'] || 0})</option>
                <option value="monthly_60">60ils (${planCounts['monthly_60'] || 0})</option>
                <option value="per_booking">لكل حجز (${planCounts['per_booking'] || 0})</option>
                `;
                planSel.value = prevPlan;
            }
            if (stSel) {
                stSel.innerHTML = `
                    <option value="">كل الحالات (${baseSalons.length})</option>
                    <option value="accepted">نشط (${statusCounts.accepted})</option>
                    <option value="rejected">غير نشط (${statusCounts.rejected})</option>
                    <option value="pending">قيد الانتظار (${statusCounts.pending})</option>
                `;
                stSel.value = prevStatus;
            }
            if (ctSel) {
                ctSel.innerHTML = `
                    <option value="">كل المدن (${baseSalons.length})</option>
                    ${sortedCities.map(c => `<option value="${c}">${c} (${cityCounts[c]})</option>`).join('')}
                `;
                ctSel.value = prevCity;
            }

            // Apply filters
            let filteredSalons = baseSalons.filter(s => {
                const matchesName = !nameTerm || (s.salon_name || '').toLowerCase().includes(nameTerm);
                const matchesStatus = !statusTerm || s.status === statusTerm;
                const matchesCity = !cityTerm || (s.city || 'غير محدد') === cityTerm;
                const matchesPlan = !planTerm || (s.status === 'accepted' && computePlanKey(s) === planTerm);
                return matchesName && matchesStatus && matchesCity && matchesPlan;
            });

            if (sortTerm === 'newest' || sortTerm === 'oldest') {
                await ensureSignupDates(filteredSalons);
                const cache = window.salonLocationCache || {};
                const cmp = (a, b) => {
                    const da = cache[a.id] ? new Date(cache[a.id]).getTime() : 0;
                    const db = cache[b.id] ? new Date(cache[b.id]).getTime() : 0;
                    if (da && db) return sortTerm === 'newest' ? (db - da) : (da - db);
                    // Fallback to id if date missing
                    return sortTerm === 'newest' ? ((b.id ?? 0) - (a.id ?? 0)) : ((a.id ?? 0) - (b.id ?? 0));
                };
                filteredSalons.sort(cmp);
            }

            if (filter === 'pending') {
                 const badge = document.getElementById('nav-pending-badge');
                 const pendingCountEl = document.getElementById('pending-count');
                 const count = pendingSalonsData.length;
                 if (badge) {
                     badge.textContent = count;
                     badge.classList.toggle('hidden', count === 0);
                 }
                 if (pendingCountEl) {
                    pendingCountEl.textContent = count;
                 }
            }

            if (filteredSalons.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">لا توجد صالونات ${filter === 'pending' ? 'قيد الانتظار' : 'مسجلة'} حالياً.</p>`;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200 bg-white rounded-xl shadow-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم الصالون</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الخطة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">فواتير سابقة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${filteredSalons.map((salon, index) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-dark font-bold">${salon.salon_name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${formatSalonPlanForRow(salon)}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${formatStatus(salon.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="actions">
                                        <button class="btn btn-primary" onclick="openInvoicesModal(${salon.id})">
                                          <i class="fas fa-file-invoice"></i>
                                          فواتير سابقة
                                        </button>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="details-salon-btn text-blue-600 hover:text-blue-800 transition duration-150 p-1 rounded" data-id="${salon.id}">
                                        <i class="fas fa-eye ml-1"></i> عرض التفاصيل
                                    </button>
                                </td>
                                
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.querySelectorAll('.details-salon-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const salonId = parseInt(e.currentTarget.dataset.id);
                    const salon = pendingSalonsData.find(s => s.id === salonId) || allSalons.find(s => s.id === salonId);
                    if (salon) {
                        showSalonDetails(salon);
                    } else {
                        showMessage(messageBox, 'فشل العثور على بيانات الصالون.', false);
                    }
                });
            });

            // الإجراءات column removed; no need to attach manage-salon handlers.

            // No listeners needed for invoices buttons (onclick used to match payments logic)

        } catch (error) {
            console.error('Error fetching salons:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات الصالونات.</p>';
        } finally { hideDashboardLoading(); }
    };
    
    const loadUsers = async () => {
        const container = document.getElementById('all-users-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل المستخدمين...</p>';
        showDashboardLoading();
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const users = await response.json();

            if (users.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد سجلات مستخدمين حالياً.</p>';
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200 bg-white rounded-xl shadow-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">البريد الإلكتروني</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الهاتف</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المدينة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النوع</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${users.map((user, index) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-primary-dark">${user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.email}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.phone || '---'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.city || '---'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${user.user_type === 'user' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'}">
                                        ${user.user_type === 'user' ? 'مستخدم' : user.user_type === 'salon' ? 'صالون' : 'إدارة'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error fetching users:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات المستخدمين.</p>';
        } finally { hideDashboardLoading(); }
    };
    
    const loadPayments = async () => {
        const container = document.getElementById('payments-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل المدفوعات...</p>';
        showDashboardLoading();
        try {
            const response = await fetch('/api/admin/payments', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const payments = await response.json();

            // Store all payments globally for filtering
            window.allAdminPayments = payments;

            if (payments.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد سجلات مدفوعات حالياً.</p>';
                return;
            }

            renderAdminPayments(payments);
        } catch (error) {
            console.error('Error fetching payments:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات المدفوعات.</p>';
        } finally { hideDashboardLoading(); }
    };

    const renderAdminPayments = (payments) => {
        const container = document.getElementById('payments-list');
        
        if (payments.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد نتائج تطابق البحث.</p>';
            return;
        }

        // Clean and minimal payment cards
        container.innerHTML = `
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                ${payments.map((p, index) => {
                    const paymentDate = formatDate(p.created_at);
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden">
                            <div class="p-6">
                                <!-- Salon Name -->
                                <div class="mb-3">
                                    <h3 class="font-bold text-lg text-gray-800 truncate">${p.salon_name || 'غير محدد'}</h3>
                                </div>
                                
                                <!-- Invoice Number -->
                                <div class="mb-3">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-hashtag text-primary-dark text-sm"></i>
                                        <span class="text-sm text-gray-600">رقم الفاتورة:</span>
                                    </div>
                                    <p class="font-mono text-primary-dark font-medium mt-1">${p.invoice_number}</p>
                                </div>
                                
                                <!-- Date -->
                                <div class="mb-4">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-calendar text-primary-dark text-sm"></i>
                                        <span class="text-sm text-gray-600">التاريخ:</span>
                                    </div>
                                    <p class="text-gray-800 font-medium mt-1">${paymentDate}</p>
                                </div>
                                
                                <!-- View Details Button -->
                                <button onclick="showCleanPaymentModal(${JSON.stringify(p).replace(/"/g, '&quot;')})" 
                                        class="w-full flex items-center justify-center gap-2 px-4 py-3 border-2 border-primary-dark bg-transparent text-primary-dark rounded-lg hover:bg-primary-dark hover:text-white hover:shadow-md transition-all duration-200 font-medium">
                                    <i class="fas fa-eye text-primary-dark"></i>
                                    <span>عرض التفاصيل</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    };

    // Filter and search functionality for admin payments
    const filterAdminPayments = () => {
        if (!window.allAdminPayments) return;
        
        const searchTerm = document.getElementById('admin-payment-search')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-status-filter')?.value || '';
        const typeFilter = document.getElementById('admin-type-filter')?.value || '';
        const dateFilter = document.getElementById('admin-date-filter')?.value || '';
        const allDatesChecked = document.getElementById('admin-all-dates')?.checked || false;

        // Normalize status values (Arabic/English) to canonical English
        const statusCanonMap = {
            'completed': 'completed', 'مكتملة': 'completed',
            'pending': 'pending', 'معلق': 'pending', 'قيد الانتظار': 'pending',
            'failed': 'failed', 'فاشلة': 'failed', 'مرفوضة': 'failed'
        };

        let filteredPayments = window.allAdminPayments.filter(payment => {
            // Search filter
            const matchesSearch = !searchTerm || 
                payment.invoice_number?.toLowerCase().includes(searchTerm) ||
                payment.salon_name?.toLowerCase().includes(searchTerm) ||
                payment.amount?.toString().includes(searchTerm) ||
                payment.description?.toLowerCase().includes(searchTerm);

            // Status filter
            const paymentCanonStatus = statusCanonMap[payment.payment_status] || payment.payment_status;
            const matchesStatus = !statusFilter || paymentCanonStatus === statusFilter;

            // Type filter
            const matchesType = !typeFilter || payment.payment_type === typeFilter;

            // Date filter - only apply if "All dates" is unchecked and a date is selected
            let matchesDate = true;
            if (!allDatesChecked && dateFilter) {
                const paymentDate = new Date(payment.created_at);
                const filterDate = new Date(dateFilter);
                // Check if payment was created on the selected date
                matchesDate = paymentDate.toDateString() === filterDate.toDateString();
            }

            return matchesSearch && matchesStatus && matchesType && matchesDate;
        });

        renderAdminPayments(filteredPayments);
    };

    // --- Bookings (Appointments) Management ---
    let allAdminBookings = [];

    const loadBookings = async () => {
        const container = document.getElementById('bookings-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل الحجوزات...</p>';
        try {
            const response = await fetch('/api/admin/appointments', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const bookings = await response.json();

            allAdminBookings = Array.isArray(bookings) ? bookings : (bookings.appointments || []);

            if (!allAdminBookings.length) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد حجوزات حالياً.</p>';
                return;
            }

            renderAdminBookings(allAdminBookings);
        } catch (error) {
            console.error('Error fetching bookings:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات الحجوزات.</p>';
        }
    };

    const renderAdminBookings = (bookings) => {
        const container = document.getElementById('bookings-list');
        if (!bookings.length) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد نتائج مطابقة.</p>';
            return;
        }

        container.innerHTML = `
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                ${bookings.map(b => {
                    const start = new Date(b.start_time);
                    const end = b.end_time ? new Date(b.end_time) : null;
                    const dateStr = start.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeStr = start.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) + (end ? ` - ${end.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}` : '');
                    const status = b.status || 'Scheduled';
                    const statusBadge = status === 'Completed' ? 'bg-green-100 text-green-800' : status === 'Cancelled' ? 'bg-red-100 text-red-800' : status === 'Absent' ? 'bg-orange-100 text-orange-800' : 'bg-yellow-100 text-yellow-800';

                    return `
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden">
                            <div class="p-6 space-y-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-bold text-lg text-gray-800 truncate">${b.salon_name || 'صالون غير محدد'}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${statusBadge}">${status}</span>
                                </div>
                                <p class="text-sm text-gray-700">${b.user_name ? `العميل: ${b.user_name}` : ''}</p>
                                <p class="text-sm text-gray-700">${b.service_name ? `الخدمة: ${b.service_name}` : (b.services_names ? `الخدمات: ${b.services_names}` : '')}</p>
                                <div class="flex items-center gap-2 text-gray-700">
                                    <i class="fas fa-calendar text-primary-dark text-sm"></i>
                                    <span>${dateStr}</span>
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-clock text-primary-dark text-sm"></i>
                                    <span>${timeStr}</span>
                                </div>
                                ${b.price ? `<p class="text-sm text-gray-800 font-medium">المبلغ: ${b.price} ₪</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    };

    const filterAdminBookings = () => {
        if (!allAdminBookings.length) return;
        const term = document.getElementById('admin-booking-search')?.value.toLowerCase() || '';
        const status = document.getElementById('admin-booking-status')?.value || '';
        const dateVal = document.getElementById('admin-booking-date')?.value || '';
        const allDates = document.getElementById('admin-booking-all-dates')?.checked || false;

        const filtered = allAdminBookings.filter(b => {
            const matchesTerm = !term ||
                b.salon_name?.toLowerCase().includes(term) ||
                b.user_name?.toLowerCase().includes(term) ||
                b.service_name?.toLowerCase().includes(term) ||
                b.services_names?.toLowerCase().includes(term);

            const matchesStatus = !status ||
                (status === 'upcoming' && b.status === 'Scheduled' && new Date(b.start_time) > new Date()) ||
                (status === 'completed' && b.status === 'Completed') ||
                (status === 'cancelled' && b.status === 'Cancelled') ||
                (status === 'past' && new Date(b.start_time) <= new Date() && b.status !== 'Cancelled' && b.status !== 'Completed');

            let matchesDate = true;
            if (!allDates && dateVal) {
                const start = new Date(b.start_time);
                const filterDate = new Date(dateVal);
                matchesDate = start.toDateString() === filterDate.toDateString();
            }

            return matchesTerm && matchesStatus && matchesDate;
        });

        renderAdminBookings(filtered);
    };

    // --- Services Management Functions ---
    let allServices = [];

    const loadServices = async () => {
        const container = document.getElementById('services-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل الخدمات...</p>';
        
        try {
            const response = await fetch('/api/admin/services', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            
            if (!response.ok) throw new Error('Failed to fetch services');
            
            const data = await response.json();
            const services = data.services || [];
            allServices = services;
            filterServices(); // Apply the current filter instead of showing all services
        } catch (error) {
            console.error('Error loading services:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل الخدمات.</p>';
        }
    };

    const renderServices = (services) => {
        const container = document.getElementById('services-list');
        
        if (services.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد خدمات متاحة.</p>';
            return;
        }

        container.innerHTML = `
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                ${services.map(service => `
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                ${service.icon ? 
                                    `<img src="${service.icon}" alt="${service.name_ar}" class="w-12 h-12 object-cover rounded-lg border border-gray-200">` :
                                    `<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200">
                                        <i class="fas fa-concierge-bell text-xl text-gray-400"></i>
                                    </div>`
                                }
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${service.name_ar}</h3>
                                    <span class="text-sm px-2 py-1 rounded-full ${service.gender === 'women' ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700'}">${service.gender === 'women' ? 'نساء' : 'رجال'}</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="editService(${service.id})" class="flex-1 bg-secondary text-white px-3 py-2 rounded-lg hover:bg-secondary/90 transition-colors text-sm">
                                    <i class="fas fa-edit ml-1"></i> تعديل
                                </button>
                                <button onclick="deleteService(${service.id})" class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                    <i class="fas fa-trash ml-1"></i> حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    };

    const filterServices = () => {
        const genderFilter = document.getElementById('services-gender-filter').value;
        const searchTerm = document.getElementById('services-search').value.toLowerCase();
        
        let filtered = allServices.filter(service => {
            const matchesGender = service.gender === genderFilter;
            const matchesSearch = !searchTerm || service.name_ar.toLowerCase().includes(searchTerm);
            return matchesGender && matchesSearch;
        });
        
        renderServices(filtered);
    };

    const showServiceModal = (service = null) => {
        const modal = document.getElementById('service-modal');
        const form = document.getElementById('service-form');
        const title = document.getElementById('service-modal-title');
        
        if (service) {
            title.textContent = 'تعديل الخدمة';
            document.getElementById('service-name').value = service.name_ar;
            document.getElementById('service-gender').value = service.gender;
            document.getElementById('service-id').value = service.id;
        } else {
            title.textContent = 'إضافة خدمة جديدة';
            form.reset();
            document.getElementById('service-id').value = '';
        }
        
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    };

    const hideServiceModal = () => {
        const modal = document.getElementById('service-modal');
        modal.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
    };

    const saveService = async (event) => {
        event.preventDefault();
        
        const formData = new FormData();
        const serviceId = document.getElementById('service-id').value;
        const name = document.getElementById('service-name').value;
        const gender = document.getElementById('service-gender').value;
        const iconFile = document.getElementById('service-icon').files[0];
        
        formData.append('name_ar', name);
        formData.append('gender', gender);
        formData.append('service_type', 'main'); // Add required service_type field
        if (iconFile) {
            formData.append('icon', iconFile);
        }
        
        try {
            const url = serviceId ? `/api/admin/services/${serviceId}` : '/api/admin/services';
            const method = serviceId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method,
                headers: { 'Authorization': `Bearer ${adminToken}` },
                body: formData
            });
            
            if (!response.ok) throw new Error('Failed to save service');
            
            hideServiceModal();
            await loadServices();
            showMessage(messageBox, 'تم حفظ الخدمة بنجاح', true);
        } catch (error) {
            console.error('Error saving service:', error);
            showMessage(messageBox, 'فشل في حفظ الخدمة', false);
        }
    };

    const editService = (serviceId) => {
        const service = allServices.find(s => s.id === serviceId);
        if (service) {
            showServiceModal(service);
        }
    };

    const deleteService = async (serviceId) => {
        if (!confirm('هل أنت متأكد من حذف هذه الخدمة؟')) return;
        
        try {
            const response = await fetch(`/api/admin/services/${serviceId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            
            if (!response.ok) throw new Error('Failed to delete service');
            
            await loadServices();
            showMessage('تم حذف الخدمة بنجاح', 'success');
        } catch (error) {
            console.error('Error deleting service:', error);
            showMessage('فشل في حذف الخدمة', 'error');
        }
    };


    // --- Modal and Action Functions ---
    let currentSalonId = null;
    window.salonPlanOverrides = window.salonPlanOverrides || {};

    const showApprovalModal = (salon) => {
        currentSalonId = salon.id;

        // Render current status badge
        const statusBadgeEl = document.getElementById('modal-salon-status-badge');
        if (statusBadgeEl) statusBadgeEl.innerHTML = formatStatus(salon.status);

        // Reflect current status in toggle UI (on if accepted, off otherwise)
        const statusToggle = document.getElementById('status-toggle');
        if (statusToggle) {
            statusToggle.checked = (salon.status === 'accepted');
        }

        // Current plan: prefer backend stored plan, else infer from latest payment
        const planEl = document.getElementById('modal-current-plan');
        const planMap = {
            '2months_offer': 'عرض شهرين',
            'monthly_200': '200ils',
            'monthly_60': '60ils',
            'per_booking': 'لكل حجز (1)'
        };
        let currentPlan = 'غير محدد';
        if (salon.plan) {
            if (salon.plan === 'monthly_60' && salon.plan_chairs) {
                currentPlan = `لكل كرسي (${salon.plan_chairs})`;
            } else {
                currentPlan = planMap[salon.plan] || salon.plan;
            }
        } else {
            try {
                const payments = window.allAdminPayments || [];
                const related = payments.filter(p => p.salon_id === salon.id);
                if (related.length) {
                    related.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    const last = related[0];
                    const typeToPlan = mapPaymentTypeToPlan(last.payment_type);
                    const paymentTypeMap = {
                        '2months_offer': 'عرض شهرين',
                        'monthly_200': '200ils',
                        'monthly_60': '60ils',
                        'per_booking': 'لكل حجز'
                    };
                    currentPlan = paymentTypeMap[typeToPlan] || paymentTypeMap[last.payment_type] || last.payment_type || 'غير محدد';
                }
            } catch (_) {}
        }
        if (planEl) planEl.textContent = currentPlan;

        // Last payment date
        const lastPaymentEl = document.getElementById('modal-last-payment-date');
        let lastPaymentDate = '—';
        try {
            const payments = window.allAdminPayments || [];
            const related = payments.filter(p => p.salon_id === salon.id);
            if (related.length) {
                related.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                const last = related[0];
                const d = new Date(last.created_at);
                lastPaymentDate = d.toLocaleDateString('ar-IL');
            }
        } catch (_) {}
        if (lastPaymentEl) lastPaymentEl.textContent = lastPaymentDate;

        // Preselect plan: prefer backend salon.plan, else infer from last payment
        const planRadioMap = {
            '2months_offer': 'plan-2months-offer',
            'monthly_200': 'plan-monthly-200',
            'monthly_60': 'plan-monthly-60',
            'per_booking': 'plan-per-booking'
        };
        if (salon.plan && planRadioMap[salon.plan] && document.getElementById(planRadioMap[salon.plan])) {
            document.getElementById(planRadioMap[salon.plan]).checked = true;
        } else {
            try {
                const payments = window.allAdminPayments || [];
                const related = payments.filter(p => p.salon_id === salon.id);
                if (related.length) {
                    related.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    const last = related[0];
                    const pt = last.payment_type;
                    const map = {
                        'offer_200ils': 'plan-2months-offer',
                        'monthly_subscription': 'plan-monthly-200',
                        'per_chair': 'plan-monthly-60',
                        'per_booking': 'plan-per-booking'
                    };
                    const id = map[pt];
                    if (id && document.getElementById(id)) {
                        document.getElementById(id).checked = true;
                    }
                }
            } catch(_) {}
        }

        // Sync chairs input and invoice option with selected plan
        const syncPlanUI = () => {
            const selected = document.querySelector('input[name="plan-type"]:checked')?.value;
            const chairsContainer = document.getElementById('chairs-input-container');
            if (selected === 'monthly_60') {
                chairsContainer?.classList.remove('hidden');
                const ov = window.salonPlanOverrides[salon.id];
                const el = document.getElementById('plan-chairs-input');
                if (el) el.value = ov?.planChairs ? parseInt(ov.planChairs, 10) : 1;
            } else {
                chairsContainer?.classList.add('hidden');
            }
        };
        syncPlanUI();

        document.querySelectorAll('input[name="plan-type"]').forEach(r => {
            r.addEventListener('change', syncPlanUI);
        });

        // Baseline state for change detection
        const statusToggleEl = document.getElementById('status-toggle');
        const initiallySelectedPlan = document.querySelector('input[name="plan-type"]:checked')?.value || null;
        const initialChairs = initiallySelectedPlan === 'monthly_60' ? parseInt(document.getElementById('plan-chairs-input')?.value || '1', 10) : null;
        window.approvalBaseline = window.approvalBaseline || {};
        window.approvalBaseline[currentSalonId] = {
            statusChecked: !!(statusToggleEl && statusToggleEl.checked),
            planSelected: initiallySelectedPlan,
            planChairs: initialChairs
        };

        // Helper to read current selection
        const getCurrentSelection = () => {
            const selPlan = document.querySelector('input[name="plan-type"]:checked')?.value || null;
            const selChairs = selPlan === 'monthly_60' ? parseInt(document.getElementById('plan-chairs-input')?.value || '1', 10) : null;
            const statusChecked = !!document.getElementById('status-toggle')?.checked;
            return { selPlan, selChairs, statusChecked };
        };

        // Update Save button visibility based on changes
        const updateSaveVisibility = () => {
            const baseline = window.approvalBaseline[currentSalonId] || {};
            const cur = getCurrentSelection();
            const statusChanged = baseline.statusChecked !== cur.statusChecked;
            const planChanged = baseline.planSelected !== cur.selPlan;
            const chairsChanged = baseline.planSelected === 'monthly_60' || cur.selPlan === 'monthly_60' ? (baseline.planChairs || 1) !== (cur.selChairs || 1) : false;
            const anyChanged = statusChanged || planChanged || chairsChanged;
            const saveBtn = document.getElementById('save-plan-btn');
            if (saveBtn) {
                if (anyChanged) saveBtn.classList.remove('hidden'); else saveBtn.classList.add('hidden');
            }
        };

        // Attach listeners to detect changes
        statusToggleEl?.addEventListener('change', updateSaveVisibility);
        document.querySelectorAll('input[name="plan-type"]').forEach(r => r.addEventListener('change', updateSaveVisibility));
        document.getElementById('plan-chairs-input')?.addEventListener('input', updateSaveVisibility);
        // Initial visibility set
        updateSaveVisibility();

        const modal = document.getElementById('approval-modal');
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    };

    const hideApprovalModal = () => {
        const modal = document.getElementById('approval-modal');
        modal.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
        currentSalonId = null;
    };
    
    const updateSalonStatus = async (status) => {
        if (!currentSalonId) return;
        const toggleEl = document.getElementById('status-toggle');
        const planSelected = document.querySelector('input[name="plan-type"]:checked')?.value || 'monthly_200';
        const invoiceSelected = (planSelected === '2months_offer') ? 'offer_200ils' : 'none';
        const planChairs = (planSelected === 'monthly_60') ? parseInt(document.getElementById('plan-chairs-input')?.value || '1', 10) : null;
        const payment200ils = invoiceSelected === 'offer_200ils'; // legacy compatibility
        toggleEl && (toggleEl.disabled = true);

        try {
            const response = await fetch(`/api/admin/salon/status/${currentSalonId}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status, payment200ils, invoiceOption: invoiceSelected, planType: planSelected, planChairs })
            });

            const result = await response.json();

            if (response.ok) {
                showMessage(messageBox, `تم تحديث حالة الصالون إلى: ${status === 'accepted' ? 'مقبول' : 'مرفوض'}.`, true);
                // Store override locally to reflect plan in UI immediately
                window.salonPlanOverrides[currentSalonId] = { planType: planSelected, planChairs };
                hideApprovalModal();
                await loadSalons('pending'); // Reload pending list
                if (currentView === 'dashboard-view') {
                     await loadAdminStats(); // Refresh stats
                } else if (currentView === 'all-salons-view') {
                     await loadSalons('all'); // Refresh full list
                }
            } else {
                showMessage(messageBox, result.error || 'فشل في تحديث الحالة.', false);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            toggleEl && (toggleEl.disabled = false);
        }
    };

    const performPlanSave = async (invoiceOption) => {
        if (!currentSalonId) return;
        const saveBtn = document.getElementById('save-plan-btn');
        const originalSaveText = saveBtn.innerHTML;
        const planSelected = document.querySelector('input[name="plan-type"]:checked')?.value || 'monthly_200';
        const planChairs = (planSelected === 'monthly_60') ? parseInt(document.getElementById('plan-chairs-input')?.value || '1', 10) : null;
        const statusToggle = document.getElementById('status-toggle');
        const status = statusToggle && statusToggle.checked ? 'accepted' : 'rejected';
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الحفظ...';
        try {
            const response = await fetch(`/api/admin/salon/status/${currentSalonId}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status, invoiceOption, planType: planSelected, planChairs })
            });
            const result = await response.json();
            if (response.ok) {
                showMessage(messageBox, 'تم حفظ تغييرات الباقة بنجاح.', true);
                window.salonPlanOverrides[currentSalonId] = { planType: planSelected, planChairs };
                hideApprovalModal();
                if (currentView === 'dashboard-view') {
                    await loadAdminStats();
                } else {
                    await loadSalons(currentView === 'all-salons-view' ? 'all' : 'pending');
                }
            } else {
                showMessage(messageBox, result.error || 'فشل في حفظ التغييرات.', false);
            }
        } catch (error) {
            console.error('Error saving plan:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalSaveText;
        }
    };

    const savePlanOnly = () => {
        if (!currentSalonId) return;
        // Determine if plan actually changed compared to baseline
        const planSelected = document.querySelector('input[name="plan-type"]:checked')?.value || null;
        const planChairs = planSelected === 'monthly_60' ? parseInt(document.getElementById('plan-chairs-input')?.value || '1', 10) : null;
        const baseline = window.approvalBaseline && window.approvalBaseline[currentSalonId] ? window.approvalBaseline[currentSalonId] : { planSelected: null, planChairs: null };
        const planChanged = baseline.planSelected !== planSelected;
        const chairsChanged = (planSelected === 'monthly_60' || baseline.planSelected === 'monthly_60') ? (baseline.planChairs || 1) !== (planChairs || 1) : false;
        const suggested = (planSelected === '2months_offer') ? 'offer_200ils' : (planSelected === 'per_booking' ? 'none' : 'renewal');

        if (planChanged || chairsChanged) {
            // Show invoice confirmation only when plan changed
            const modal = document.getElementById('invoice-confirm-modal');
            modal.classList.add('modal-open');
            document.body.classList.add('modal-open');
            const closeModal = () => {
                modal.classList.remove('modal-open');
                document.body.classList.remove('modal-open');
            };
            const yesBtn = document.getElementById('invoice-confirm-yes');
            const noBtn = document.getElementById('invoice-confirm-no');
            const closeBtn = document.getElementById('invoice-confirm-close');
            const onYes = async () => { yesBtn.removeEventListener('click', onYes); noBtn.removeEventListener('click', onNo); closeBtn.removeEventListener('click', onClose); closeModal(); await performPlanSave(suggested); };
            const onNo = async () => { yesBtn.removeEventListener('click', onYes); noBtn.removeEventListener('click', onNo); closeBtn.removeEventListener('click', onClose); closeModal(); await performPlanSave('none'); };
            const onClose = () => { yesBtn.removeEventListener('click', onYes); noBtn.removeEventListener('click', onNo); closeBtn.removeEventListener('click', onClose); closeModal(); };
            yesBtn.addEventListener('click', onYes);
            noBtn.addEventListener('click', onNo);
            closeBtn.addEventListener('click', onClose);
        } else {
            // No plan change — save directly (status and any non-invoice changes)
            performPlanSave('none');
        }
    };

    // Previous Invoices Modal Logic (exactly mirror payments.html behavior)
    function openInvoicesModal(salonId) {
      const modal = document.getElementById('invoices-modal');
      const list = document.getElementById('invoices-container');

      const formatDate = (dateStr) => {
        try { return new Date(dateStr).toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' }); }
        catch { return dateStr; }
      };

      const localizePaymentType = (type) => {
        const map = {
          'offer_200ils': 'عرض 200 شيكل',
          'monthly_subscription': 'اشتراك شهري',
          'annual_subscription': 'اشتراك سنوي'
        };
        return map[type] || type;
      };

      const renderInvoices = (payments) => {
        const all = Array.isArray(payments) ? payments : [];
        const salonPayments = all.filter(p => p.salon_id === salonId);
        const completed = salonPayments.filter(p => (p.payment_status === 'completed' || p.payment_status === 'مكتملة'))
                                       .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

        if (!completed.length) {
          list.innerHTML = '<p class="muted">لا توجد فواتير سابقة.</p>';
        } else {
          list.innerHTML = completed.map(inv => `
            <div class="invoice-item">
              <div>
                <div style="font-weight:700; color:#0f172a">${localizePaymentType(inv.payment_type)}</div>
                <div class="muted">${formatDate(inv.created_at)}</div>
              </div>
              <div style="font-weight:700; color:#0f172a">${inv.invoice_number || '---'}</div>
            </div>
          `).join('');
        }

        modal.style.display = 'flex';
      };

      if (window.allAdminPayments && Array.isArray(window.allAdminPayments)) {
        renderInvoices(window.allAdminPayments);
      } else {
        const adminToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
        fetch('/api/admin/payments', { headers:{ 'Authorization': `Bearer ${adminToken}` } })
          .then(res => res.json())
          .then(data => { window.allAdminPayments = data; renderInvoices(window.allAdminPayments); })
          .catch(() => { list.innerHTML = '<p class="muted" style="color:#EF4444">تعذر تحميل الفواتير. حاول لاحقاً.</p>'; modal.style.display = 'flex'; });
      }
    }

    function closeInvoicesModal() { document.getElementById('invoices-modal').style.display = 'none'; }
    document.getElementById('invoices-modal')?.addEventListener('click', (e) => { if (e.target.id === 'invoices-modal') closeInvoicesModal(); });
    
    // Salon details modal logic
    const showSalonDetails = (salon) => {
        document.getElementById('details-salon-name').textContent = salon.salon_name || '---';
        document.getElementById('details-owner-name').textContent = salon.owner_name || '---';
        document.getElementById('details-owner-phone').textContent = salon.owner_phone || '---';
        document.getElementById('details-email').textContent = salon.email || '---';
        const addr = (salon.address && salon.address !== 'undefined') ? salon.address : '';
        document.getElementById('details-address').textContent = addr ? `${addr}, ${salon.city || ''}` : (salon.city || '---');
        document.getElementById('details-gender-focus').textContent = salon.gender_focus === 'women' ? 'نساء' : salon.gender_focus === 'men' ? 'رجال' : '---';

        const modal = document.getElementById('salon-details-modal');
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';

        // Fetch and show date joined from salon location (created_at)
        const dateJoinedEl = document.getElementById('details-date-joined');
        const formatDateDDMMYYYY = (dateInput) => {
            try {
                const d = new Date(dateInput);
                if (isNaN(d.getTime())) return '—';
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            } catch { return '—'; }
        };
        if (salon.id) {
            fetch(`/api/salon/location/${salon.id}`)
                .then(res => res.ok ? res.json() : null)
                .then(data => {
                    if (data && (data.created_at || (data.location && data.location.created_at))) {
                        const created = data.created_at || data.location.created_at;
                        dateJoinedEl.textContent = formatDateDDMMYYYY(created);
                    } else {
                        dateJoinedEl.textContent = '—';
                    }
                })
                .catch(() => { dateJoinedEl.textContent = '—'; });
        } else {
            dateJoinedEl.textContent = '—';
        }
    };

    function hideSalonDetailsModal() {
        const modal = document.getElementById('salon-details-modal');
        modal.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
    }

    document.getElementById('close-salon-details-btn')?.addEventListener('click', hideSalonDetailsModal);
    document.getElementById('salon-details-modal')?.addEventListener('click', function(e) {
        if (e.target === this) hideSalonDetailsModal();
    });
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        navItems.forEach(btn => {
            btn.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view));
        });

        const legacyLogout = document.getElementById('logout-btn');
        if (legacyLogout) {
            legacyLogout.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('adminToken');
                window.location.replace('/auth.html');
            });
        }
        
        document.getElementById('refresh-pending-btn').addEventListener('click', () => loadSalons('pending'));

        // Modal actions
        document.getElementById('approval-close-icon')?.addEventListener('click', hideApprovalModal);
        document.getElementById('save-plan-btn')?.addEventListener('click', savePlanOnly);
        // Toggle should never auto-save; only update the preview badge
        const statusToggle = document.getElementById('status-toggle');
        if (statusToggle) {
            statusToggle.addEventListener('change', (e) => {
                const checked = e.currentTarget.checked;
                const statusBadgeEl = document.getElementById('modal-salon-status-badge');
                if (statusBadgeEl) statusBadgeEl.innerHTML = formatStatus(checked ? 'accepted' : 'rejected');
            });
        }

        // Initial load
        switchView('dashboard-view');
    });

    // Payment Details Modal Functions
    function showAdminPaymentDetails(payment) {
        // Set payment status with color and icon
        const statusSection = document.getElementById('payment-status-section');
        const statusIcon = document.getElementById('payment-status-icon');
        const statusText = document.getElementById('payment-status-text');
        
        if (payment.payment_status === 'completed' || payment.payment_status === 'مكتملة') {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-green-100';
            statusIcon.className = 'fas fa-check-circle text-green-600 ml-2';
            statusText.textContent = 'مكتملة';
            statusText.className = 'text-green-800 font-semibold';
        } else if (payment.payment_status === 'pending' || payment.payment_status === 'معلق') {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-yellow-100';
            statusIcon.className = 'fas fa-clock text-yellow-600 ml-2';
            statusText.textContent = 'قيد الانتظار';
            statusText.className = 'text-yellow-800 font-semibold';
        } else {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-red-100';
            statusIcon.className = 'fas fa-times-circle text-red-600 ml-2';
            statusText.textContent = 'فاشلة';
            statusText.className = 'text-red-800 font-semibold';
        }
        
        // Set payment details
        document.getElementById('payment-invoice-number').textContent = payment.invoice_number || 'غير متوفر';
        document.getElementById('payment-salon-name').textContent = payment.salon_name || 'غير متوفر';
        document.getElementById('payment-date').textContent = new Date(payment.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Payment type localization
        const paymentTypeMap = {
            'offer_200ils': 'عرض 200 شيكل',
            'monthly_subscription': 'اشتراك شهري',
            'annual_subscription': 'اشتراك سنوي'
        };
        document.getElementById('payment-type').textContent = paymentTypeMap[payment.payment_type] || payment.payment_type;
        
        document.getElementById('payment-amount').textContent = `${payment.amount} ${payment.currency}`;
        
        // Payment method localization
        const paymentMethodMap = {
            'cash': 'نقداً',
            'credit_card': 'بطاقة ائتمان',
            'bank_transfer': 'تحويل بنكي',
            'paypal': 'باي بال'
        };
        document.getElementById('payment-method').textContent = paymentMethodMap[payment.payment_method] || payment.payment_method;
        
        // Conditional fields
        const validUntilSection = document.getElementById('payment-valid-until-section');
        if (payment.valid_until) {
            validUntilSection.style.display = 'flex';
            document.getElementById('payment-valid-until').textContent = new Date(payment.valid_until).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } else {
            validUntilSection.style.display = 'none';
        }
        
        const descriptionSection = document.getElementById('payment-description-section');
        if (payment.description) {
            descriptionSection.style.display = 'block';
            document.getElementById('payment-description').textContent = payment.description;
        } else {
            descriptionSection.style.display = 'none';
        }
        
        const adminNotesSection = document.getElementById('payment-admin-notes-section');
        if (payment.admin_notes) {
            adminNotesSection.style.display = 'block';
            document.getElementById('payment-admin-notes').textContent = payment.admin_notes;
        } else {
            adminNotesSection.style.display = 'none';
        }
        
        // Show modal
        document.getElementById('payment-details-modal').style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function hidePaymentDetailsModal() {
        document.getElementById('payment-details-modal').style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    // Close modal when clicking outside
    document.getElementById('payment-details-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            hidePaymentDetailsModal();
        }
    });

    // Add event listeners for admin payment filters
document.addEventListener('DOMContentLoaded', function() {
        // Set current date as placeholder for date filter
        const dateFilter = document.getElementById('admin-date-filter');
        if (dateFilter) {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            dateFilter.setAttribute('placeholder', todayString);
        }
        
        // Search and filter event listeners (Payments)
        document.getElementById('admin-payment-search')?.addEventListener('input', (e) => {
            sessionStorage.setItem('dashboard:payment:search', e.target.value || '');
            filterAdminPayments();
        });
        document.getElementById('admin-status-filter')?.addEventListener('change', (e) => {
            sessionStorage.setItem('dashboard:payment:status', e.target.value || '');
            filterAdminPayments();
        });
        document.getElementById('admin-type-filter')?.addEventListener('change', (e) => {
            sessionStorage.setItem('dashboard:payment:type', e.target.value || '');
            filterAdminPayments();
        });
        document.getElementById('admin-date-filter')?.addEventListener('change', (e) => {
            sessionStorage.setItem('dashboard:payment:date', e.target.value || '');
            filterAdminPayments();
        });
        document.getElementById('admin-all-dates')?.addEventListener('change', (e) => {
            sessionStorage.setItem('dashboard:payment:allDates', e.target.checked ? '1' : '0');
            filterAdminPayments();
        });
        
        // QR Scanner event listener
    document.getElementById('qr-scanner-btn')?.addEventListener('click', openQRScanner);
    
    // Clean Payment Modal event listeners
    document.getElementById('clean-payment-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCleanPaymentModal();
        }
    });

    // Bookings filters
    document.getElementById('admin-booking-search')?.addEventListener('input', (e) => {
        sessionStorage.setItem('dashboard:booking:search', e.target.value || '');
        filterAdminBookings();
    });
    document.getElementById('admin-booking-status')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:booking:status', e.target.value || '');
        filterAdminBookings();
    });
    document.getElementById('admin-booking-date')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:booking:date', e.target.value || '');
        filterAdminBookings();
    });
    document.getElementById('admin-booking-all-dates')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:booking:allDates', e.target.checked ? '1' : '0');
        filterAdminBookings();
    });
    document.getElementById('refresh-bookings')?.addEventListener('click', loadBookings);

    // Services filters
    document.getElementById('services-gender-filter')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:services:gender', e.target.value || '');
        filterServices();
    });
    document.getElementById('services-search')?.addEventListener('input', (e) => {
        sessionStorage.setItem('dashboard:services:search', e.target.value || '');
        filterServices();
    });

    // Salons filters - Pending
    document.getElementById('salon-name-search-pending')?.addEventListener('input', (e) => {
        sessionStorage.setItem('dashboard:salon:pending:name', e.target.value || '');
        loadSalons('pending');
    });
    document.getElementById('salon-plan-filter-pending')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:pending:plan', e.target.value || '');
        loadSalons('pending');
    });
    document.getElementById('salon-status-filter-pending')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:pending:status', e.target.value || '');
        loadSalons('pending');
    });
    document.getElementById('salon-city-filter-pending')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:pending:city', e.target.value || '');
        loadSalons('pending');
    });
    document.getElementById('salon-date-sort-pending')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:pending:sort', e.target.value || '');
        loadSalons('pending');
    });

    // Salons filters - All
    document.getElementById('salon-name-search-all')?.addEventListener('input', (e) => {
        sessionStorage.setItem('dashboard:salon:all:name', e.target.value || '');
        loadSalons('all');
    });
    document.getElementById('salon-plan-filter-all')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:all:plan', e.target.value || '');
        loadSalons('all');
    });
    document.getElementById('salon-status-filter-all')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:all:status', e.target.value || '');
        loadSalons('all');
    });
    document.getElementById('salon-city-filter-all')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:all:city', e.target.value || '');
        loadSalons('all');
    });
    document.getElementById('salon-date-sort-all')?.addEventListener('change', (e) => {
        sessionStorage.setItem('dashboard:salon:all:sort', e.target.value || '');
        loadSalons('all');
    });

    // Persist active view in bottom navigation
    document.querySelectorAll('.nav-item[data-view]')?.forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');
            if (view) sessionStorage.setItem('dashboard:view', view);
        });
    });

    // Restore persisted filters and active view
    (function restoreDashboardState(){
        // View
        const savedView = sessionStorage.getItem('dashboard:view');
        if (savedView) {
            const btn = document.querySelector(`.nav-item[data-view="${savedView}"]`);
            if (btn) btn.click();
        }
        // Payments
        const pSearch = sessionStorage.getItem('dashboard:payment:search') || '';
        const pStatus = sessionStorage.getItem('dashboard:payment:status') || '';
        const pType = sessionStorage.getItem('dashboard:payment:type') || '';
        const pDate = sessionStorage.getItem('dashboard:payment:date') || '';
        const pAllDates = sessionStorage.getItem('dashboard:payment:allDates') === '1';
        document.getElementById('admin-payment-search')?.setAttribute('value', pSearch);
        const sEl = document.getElementById('admin-status-filter'); if (sEl) sEl.value = pStatus;
        const tEl = document.getElementById('admin-type-filter'); if (tEl) tEl.value = pType;
        const dEl = document.getElementById('admin-date-filter'); if (dEl) dEl.value = pDate;
        const aEl = document.getElementById('admin-all-dates'); if (aEl) aEl.checked = pAllDates;
        try { filterAdminPayments(); } catch(_) {}

        // Bookings
        const bSearch = sessionStorage.getItem('dashboard:booking:search') || '';
        const bStatus = sessionStorage.getItem('dashboard:booking:status') || '';
        const bDate = sessionStorage.getItem('dashboard:booking:date') || '';
        const bAllDates = sessionStorage.getItem('dashboard:booking:allDates') === '1';
        document.getElementById('admin-booking-search')?.setAttribute('value', bSearch);
        const bsEl = document.getElementById('admin-booking-status'); if (bsEl) bsEl.value = bStatus;
        const bdEl = document.getElementById('admin-booking-date'); if (bdEl) bdEl.value = bDate;
        const baEl = document.getElementById('admin-booking-all-dates'); if (baEl) baEl.checked = bAllDates;
        try { filterAdminBookings(); } catch(_) {}

        // Services
        const sGender = sessionStorage.getItem('dashboard:services:gender') || '';
        const sSearch = sessionStorage.getItem('dashboard:services:search') || '';
        const sgEl = document.getElementById('services-gender-filter'); if (sgEl) sgEl.value = sGender;
        document.getElementById('services-search')?.setAttribute('value', sSearch);
        try { filterServices(); } catch(_) {}

        // Salons - Pending
        const spName = sessionStorage.getItem('dashboard:salon:pending:name') || '';
        const spPlan = sessionStorage.getItem('dashboard:salon:pending:plan') || '';
        const spStatus = sessionStorage.getItem('dashboard:salon:pending:status') || '';
        const spCity = sessionStorage.getItem('dashboard:salon:pending:city') || '';
        const spSort = sessionStorage.getItem('dashboard:salon:pending:sort') || '';
        const spnEl = document.getElementById('salon-name-search-pending'); if (spnEl) spnEl.setAttribute('value', spName);
        const sppEl = document.getElementById('salon-plan-filter-pending'); if (sppEl) sppEl.value = spPlan;
        const spsEl = document.getElementById('salon-status-filter-pending'); if (spsEl) spsEl.value = spStatus;
        const spcEl = document.getElementById('salon-city-filter-pending'); if (spcEl) spcEl.value = spCity;
        const spsrEl = document.getElementById('salon-date-sort-pending'); if (spsrEl) spsrEl.value = spSort;
        try { loadSalons('pending'); } catch(_) {}

        // Salons - All
        const saName = sessionStorage.getItem('dashboard:salon:all:name') || '';
        const saPlan = sessionStorage.getItem('dashboard:salon:all:plan') || '';
        const saStatus = sessionStorage.getItem('dashboard:salon:all:status') || '';
        const saCity = sessionStorage.getItem('dashboard:salon:all:city') || '';
        const saSort = sessionStorage.getItem('dashboard:salon:all:sort') || '';
        const sanEl = document.getElementById('salon-name-search-all'); if (sanEl) sanEl.setAttribute('value', saName);
        const sapEl = document.getElementById('salon-plan-filter-all'); if (sapEl) sapEl.value = saPlan;
        const sasEl = document.getElementById('salon-status-filter-all'); if (sasEl) sasEl.value = saStatus;
        const sacEl = document.getElementById('salon-city-filter-all'); if (sacEl) sacEl.value = saCity;
        const sasrEl = document.getElementById('salon-date-sort-all'); if (sasrEl) sasrEl.value = saSort;
        try { loadSalons('all'); } catch(_) {}
    })();
});

    // QR Scanner Functions
    let qrStream = null;
    let qrScanning = false;

    function openQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        const video = document.getElementById('qr-video');
        const loading = document.getElementById('qr-loading');
        
        modal.classList.add('modal-open');
        
        // Start camera
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment' // Use back camera if available
            } 
        })
        .then(stream => {
            qrStream = stream;
            video.srcObject = stream;
            loading.style.display = 'none';
            startQRScanning();
        })
        .catch(err => {
            console.error('Camera access denied:', err);
            loading.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
                    <p class="text-red-600">لا يمكن الوصول للكاميرا</p>
                    <p class="text-sm text-gray-500">استخدم الإدخال اليدوي أدناه</p>
                </div>
            `;
        });
    }

    // Clean Payment Modal Functions
    function showCleanPaymentModal(payment) {
        const modal = document.getElementById('clean-payment-modal');
        
        // Populate modal with payment data
        document.getElementById('clean-salon-name').textContent = payment.salon_name || 'غير محدد';
        document.getElementById('clean-invoice-number').textContent = `فاتورة رقم: ${payment.invoice_number}`;
        
        // Amount and type
        const amount = parseFloat(payment.amount).toFixed(2);
        document.getElementById('clean-amount').textContent = `${amount} ${payment.currency}`;
        const paymentTypeMap = {
            'offer_200ils': 'عرض 200 شيكل',
            'monthly_subscription': 'اشتراك شهري',
            'annual_subscription': 'اشتراك سنوي'
        };
        document.getElementById('clean-payment-type').textContent = paymentTypeMap[payment.payment_type] || payment.payment_type;
        
        // Status with styling
        const statusBadge = document.getElementById('clean-status-badge');
        const statusIcon = document.getElementById('clean-status-icon');
        const statusText = document.getElementById('clean-status-text');
        
        if (payment.payment_status === 'completed' || payment.payment_status === 'مكتملة') {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-green-50 border border-green-200 text-green-800';
            statusIcon.className = 'fas fa-check-circle text-green-600';
            statusText.textContent = 'مكتمل';
        } else if (payment.payment_status === 'pending' || payment.payment_status === 'معلق' || payment.payment_status === 'قيد الانتظار') {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-50 border border-yellow-200 text-yellow-800';
            statusIcon.className = 'fas fa-clock text-yellow-600';
            statusText.textContent = 'قيد الانتظار';
        } else {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-red-50 border border-red-200 text-red-800';
            statusIcon.className = 'fas fa-times-circle text-red-600';
            statusText.textContent = 'فاشل';
        }
        
        // Payment method
        const paymentMethodMap = {
            'cash': 'نقداً',
            'credit_card': 'بطاقة ائتمان',
            'bank_transfer': 'تحويل بنكي',
            'paypal': 'باي بال'
        };
        document.getElementById('clean-payment-method').textContent = paymentMethodMap[payment.payment_method] || payment.payment_method || 'غير محدد';
        
        // Dates
        document.getElementById('clean-payment-date').textContent = formatDate(payment.created_at);
        
        const validUntilContainer = document.getElementById('clean-valid-until-container');
        if (payment.valid_until) {
            validUntilContainer.style.display = 'block';
            document.getElementById('clean-valid-until').textContent = formatDate(payment.valid_until);
        } else {
            validUntilContainer.style.display = 'none';
        }
        
        // Description
        const descriptionContainer = document.getElementById('clean-description-container');
        if (payment.description && payment.description.trim()) {
            descriptionContainer.style.display = 'block';
            document.getElementById('clean-description').textContent = payment.description;
        } else {
            descriptionContainer.style.display = 'none';
        }
        
        // Admin notes
        const adminNotesContainer = document.getElementById('clean-admin-notes-container');
        if (payment.admin_notes && payment.admin_notes.trim()) {
            adminNotesContainer.style.display = 'block';
            document.getElementById('clean-admin-notes').textContent = payment.admin_notes;
        } else {
            adminNotesContainer.style.display = 'none';
        }
        
        // Store payment data for editing
        modal.dataset.paymentData = JSON.stringify(payment);
        
        // Show modal
        modal.classList.add('modal-open');
        document.body.classList.add('modal-open');
    }

    function closeCleanPaymentModal() {
        const modal = document.getElementById('clean-payment-modal');
        modal.classList.remove('modal-open');
        document.body.classList.remove('modal-open');
    }

    function editPaymentFromModal() {
        const modal = document.getElementById('clean-payment-modal');
        const paymentData = JSON.parse(modal.dataset.paymentData);
        closeCleanPaymentModal();
        showAdminPaymentDetails(paymentData);
    }

    function closeQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        const video = document.getElementById('qr-video');
        const loading = document.getElementById('qr-loading');
        const result = document.getElementById('qr-scan-result');
        
        // Stop camera
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }
        
        qrScanning = false;
        modal.classList.remove('modal-open');
        
        // Reset UI and ensure all inputs are enabled
        loading.style.display = 'flex';
        loading.innerHTML = `
            <div class="text-center">
                <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">جاري تشغيل الكاميرا...</p>
            </div>
        `;
        result.classList.add('hidden');
        document.getElementById('manual-invoice-input').value = '';
        
        // Ensure all filter inputs remain interactive
        const searchInput = document.getElementById('admin-payment-search');
        const statusFilter = document.getElementById('admin-status-filter');
        const typeFilter = document.getElementById('admin-type-filter');
        const dateFilter = document.getElementById('admin-date-filter');
        const allDatesCheckbox = document.getElementById('admin-all-dates');
        
        [searchInput, statusFilter, typeFilter, dateFilter, allDatesCheckbox].forEach(element => {
            if (element) {
                element.disabled = false;
                element.readOnly = false;
            }
        });
    }

    function startQRScanning() {
        const video = document.getElementById('qr-video');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        qrScanning = true;
        
        function scanFrame() {
            if (!qrScanning || !video.videoWidth || !video.videoHeight) {
                if (qrScanning) {
                    requestAnimationFrame(scanFrame);
                }
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                // QR code detected
                qrScanning = false;
                const scannedData = code.data;
                
                // Show visual feedback
                const loading = document.getElementById('qr-loading');
                loading.style.display = 'flex';
                loading.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p class="text-green-600">تم اكتشاف رمز QR!</p>
                        <p class="text-sm text-gray-600">جاري البحث...</p>
                    </div>
                `;
                
                // Process the scanned invoice number
                setTimeout(() => {
                    searchInvoiceByNumber(scannedData);
                }, 1000);
            } else {
                // Continue scanning
                requestAnimationFrame(scanFrame);
            }
        }
        
        // Start scanning when video is ready
        video.addEventListener('loadedmetadata', () => {
            scanFrame();
        });
        
        // If video is already loaded, start immediately
        if (video.readyState >= 2) {
            scanFrame();
        }
    }

    function searchByManualInput() {
        const input = document.getElementById('manual-invoice-input');
        const invoiceNumber = input.value.trim();
        
        if (!invoiceNumber) {
            alert('يرجى إدخال رقم الفاتورة');
            return;
        }
        
        searchInvoiceByNumber(invoiceNumber);
    }

    function searchInvoiceByNumber(invoiceNumber) {
        if (!window.allAdminPayments) {
            alert('لم يتم تحميل البيانات بعد');
            return;
        }
        
        // Search for invoice
        const payment = window.allAdminPayments.find(p => 
            p.invoice_number === invoiceNumber || 
            p.id.toString() === invoiceNumber
        );
        
        if (payment) {
            // Show success result
            const result = document.getElementById('qr-scan-result');
            const resultText = document.getElementById('qr-result-text');
            
            resultText.textContent = `الفاتورة: ${payment.invoice_number} - ${payment.salon_name} - ${payment.amount} ${payment.currency}`;
            result.classList.remove('hidden');
            
            // Auto-filter to show only this invoice
            setTimeout(() => {
                closeQRScanner();
                
                // Reset all filters first
                document.getElementById('admin-payment-search').value = '';
                document.getElementById('admin-status-filter').value = '';
                document.getElementById('admin-type-filter').value = '';
                document.getElementById('admin-date-filter').value = '';
                document.getElementById('admin-all-dates').checked = true;
                
                // Set search term to invoice number only
                const searchInput = document.getElementById('admin-payment-search');
                if (searchInput) {
                    searchInput.value = invoiceNumber;
                    // Ensure the input is enabled and focusable
                    searchInput.disabled = false;
                    searchInput.readOnly = false;
                    filterAdminPayments();
                }
                
                // Ensure all elements in the payments list are interactive
                setTimeout(() => {
                    const paymentsList = document.getElementById('payments-list');
                    if (paymentsList) {
                        // Re-enable all buttons and interactive elements
                        const buttons = paymentsList.querySelectorAll('button');
                        const inputs = paymentsList.querySelectorAll('input, select, textarea');
                        
                        buttons.forEach(button => {
                            button.disabled = false;
                            button.style.pointerEvents = 'auto';
                            button.style.opacity = '1';
                        });
                        
                        inputs.forEach(input => {
                            input.disabled = false;
                            input.readOnly = false;
                            input.style.pointerEvents = 'auto';
                        });
                        
                        // Ensure the payment list container is interactive
                        paymentsList.style.pointerEvents = 'auto';
                        paymentsList.style.opacity = '1';
                    }
                }, 100);
            }, 2000);
        } else {
            alert('لم يتم العثور على فاتورة بهذا الرقم');
        }
    }

    // --- Services Event Listeners ---
    document.getElementById('add-service-btn')?.addEventListener('click', () => showServiceModal());
    document.getElementById('services-gender-filter')?.addEventListener('change', filterServices);
    document.getElementById('services-search')?.addEventListener('input', filterServices);
</script>

<!-- Service Modal -->
<div id="service-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <h3 id="service-modal-title" class="text-xl font-bold text-primary-dark mb-4 text-center">إضافة خدمة جديدة</h3>
        <form id="service-form" onsubmit="saveService(event)">
            <input type="hidden" id="service-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم الخدمة</label>
                    <input type="text" id="service-name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">الفئة المستهدفة</label>
                    <select id="service-gender" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                        <option value="">اختر الفئة</option>
                        <option value="women">نساء</option>
                        <option value="men">رجال</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">أيقونة الخدمة</label>
                    <input type="file" id="service-icon" accept="image/*" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                    <p class="text-xs text-gray-500 mt-1">اختياري - يفضل PNG أو JPG بحجم 64x64 بكسل</p>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="hideServiceModal()" 
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    إلغاء
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors">
                    حفظ
                </button>
            </div>
        </form>
    </div>
</div>

</body>
</html>
