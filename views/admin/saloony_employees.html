<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="/offline-detect.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Saloony - الموظفون</title>
  <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="./assets/dashboard.css">
  <link rel="stylesheet" href="./assets/admin.css">
  <script defer src="./assets/dashboard.js"></script>
  <script defer src="./assets/admin-header.js"></script>
  <style>
    .ring { position:relative; width:60px; height:60px; border-radius:50%; background: conic-gradient(#06C167 var(--pct,0), #e5e7eb 0); display:grid; place-items:center; }
    .ring::before { content:""; position:absolute; inset:8px; border-radius:50%; background:#fff; }
    .ring-val { position:relative; font-weight:800; font-size:12px; color:#111827; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal { width:96%; max-width:860px; background:#fff; border-radius:16px; border:1px solid #e5e7eb; box-shadow:0 16px 30px rgba(2,6,23,0.2); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid #e5e7eb; }
    .modal-body { padding:16px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="brand">
      <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/36x36/1E293B/ffffff?text=ADM';" alt="Saloony Admin">
      <strong>إدارة الموظفين</strong>
    </div>
    <div class="actions">
      <button id="logout-btn" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></button>
    </div>
  </header>

  <nav class="top-nav">
    <a id="nav-dashboard" class="nav-link" href="/admin/admin_dashboard.html"><i class="fas fa-gauge"></i><span>لوحة الإدارة</span></a>
    <a id="nav-renewals" class="nav-link" href="/admin/renewals.html"><i class="fas fa-receipt"></i><span>التجديدات</span></a>
    <a id="nav-users" class="nav-link" href="/admin/users.html"><i class="fas fa-users"></i><span>المستخدمون</span></a>
    <a id="nav-progress" class="nav-link" href="/admin/progress.html"><i class="fas fa-chart-line"></i><span>التقدم</span></a>
    <a id="nav-employees" class="nav-link" href="/admin/saloony_employees.html"><i class="fas fa-id-badge"></i><span>الموظفون</span></a>
    <a id="nav-insights" class="nav-link" href="/admin/admin_dashboard.html#employee-insights-view"><i class="fas fa-chart-line"></i><span>الزيارات</span></a>
  </nav>

  <main class="flex-grow p-4 md:p-8" style="padding-top: calc(60px + env(safe-area-inset-top))">
    <div id="message-box" class="hidden p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto" role="alert"></div>
    <div id="latest-password-banner" class="hidden max-w-6xl mx-auto mb-4 p-3 rounded-xl border border-yellow-200 bg-yellow-50 text-yellow-800 text-sm"></div>
    <div class="max-w-6xl mx-auto space-y-8">
      <section class="bg-white rounded-xl shadow-sm p-4 flex items-center justify-between">
        <h2 class="section-title">الموظفون</h2>
        <button id="add-employee-btn" class="btn btn-accent"><i class="fas fa-user-plus"></i><span>إضافة موظف</span></button>
      </section>

      <section class="bg-white rounded-xl shadow-sm p-4">
        <h2 class="text-2xl font-extrabold text-primary-dark mb-4">قائمة الموظفين</h2>
        <div id="employees-list" class="table-wrapper">
          <p class="text-center text-gray-500 p-8">جاري تحميل الموظفين...</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Add Employee Modal -->
  <div id="add-employee-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">إضافة موظف</h3>
        <button id="add-employee-close" class="text-gray-600 hover:text-red-600"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="modal-name" type="text" placeholder="الاسم" class="border rounded-lg p-2">
        <input id="modal-email" type="email" placeholder="البريد الإلكتروني (اختياري)" class="border rounded-lg p-2">
        <input id="modal-phone" type="tel" placeholder="رقم الهاتف" class="border rounded-lg p-2">
        <select id="modal-city" class="border rounded-lg p-2">
          <option value="">اختر المدينة</option>
        </select>
        <input id="modal-username" type="text" placeholder="اسم المستخدم/كود الموظف (اختياري)" class="border rounded-lg p-2">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="add-employee-cancel" class="px-3 py-2 rounded-lg border">إلغاء</button>
        <button id="add-employee-save" class="px-3 py-2 rounded-lg bg-green-600 text-white"><i class="fas fa-check"></i> حفظ</button>
      </div>
      <p id="generated-password-hint" class="text-xs text-gray-500 mt-2 hidden"></p>
  </div>
  </div>

  <div id="employee-report-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong id="employee-report-title">تقرير الموظف</strong>
        <button id="employee-report-close" class="btn btn-outline"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="employee-report-body">
        <div class="text-center text-gray-500 p-6">جاري تحميل التقرير...</div>
      </div>
    </div>
  </div>

  <script>
    function showMessage(text, type='info') {
      const box = document.getElementById('message-box');
      box.textContent = text;
      box.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
      if (type === 'success') box.classList.add('bg-green-100','text-green-800');
      else if (type === 'error') box.classList.add('bg-red-100','text-red-800');
      else box.classList.add('bg-blue-100','text-blue-800');
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3000);
    }

    async function fetchEmployees() {
      try {
        const adminToken = localStorage.getItem('adminToken');
        const res = await fetch('/api/admin/employees', { headers: { 'Authorization': `Bearer ${adminToken}` }});
        const data = await res.json();
        const container = document.getElementById('employees-list');
        if (!res.ok || !data.success) {
          container.innerHTML = '<p class="text-center text-red-600 p-8">فشل تحميل الموظفين</p>';
          return;
        }
        const rows = data.employees || [];
        if (rows.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 p-8">لا يوجد موظفون بعد</p>';
          return;
        }
        const html = `
          <table class="w-full text-sm border">
            <thead>
              <tr class="bg-gray-50">
                <th class="p-2 border">الاسم</th>
                <th class="p-2 border">اسم المستخدم</th>
                <th class="p-2 border">البريد</th>
                <th class="p-2 border">الهاتف</th>
                <th class="p-2 border">المدينة</th>
                <th class="p-2 border">إجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => `
                <tr>
                  <td class="p-2 border">${r.name || ''}</td>
                  <td class="p-2 border">${r.username || ''}</td>
                  <td class="p-2 border">${r.email || ''}</td>
                  <td class="p-2 border">${r.phone || ''}</td>
                  <td class="p-2 border">${r.city || ''}</td>
                  <td class="p-2 border">
                    <button class="btn btn-outline text-xs" onclick="resetEmployeePassword(${r.id})"><i class="fas fa-key"></i> توليد كلمة مرور</button>
                    <a class="btn btn-outline text-xs" href="/admin/employee_report.html?id=${r.id}&name=${encodeURIComponent(r.name || '')}"><i class="fas fa-chart-line"></i> عرض التقرير</a>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        container.innerHTML = html;
      } catch (e) {
        document.getElementById('employees-list').innerHTML = '<p class="text-center text-red-600 p-8">حدث خطأ</p>';
      }
    }

    function generatePassword() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';
      let pwd = 'Emp';
      for (let i = 0; i < 7; i++) pwd += chars[Math.floor(Math.random() * chars.length)];
      return pwd;
    }

    function openAddEmployeeModal() {
      const modal = document.getElementById('add-employee-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('generated-password-hint').classList.add('hidden');
    }
    function closeAddEmployeeModal() {
      const modal = document.getElementById('add-employee-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      ['modal-name','modal-email','modal-phone'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      const citySel = document.getElementById('modal-city'); if (citySel) citySel.value = '';
    }
    async function loadCitiesDropdown() {
      try {
        const res = await fetch('/api/cities');
        const data = await res.json();
        const cities = Array.isArray(data) ? data : (data.cities || []);
        const sel = document.getElementById('modal-city');
        sel.innerHTML = '<option value="">اختر المدينة</option>' + (cities.map(c => `<option value="${c}">${c}</option>`).join(''));
      } catch (_) {
        // Fallback list if API fails
        const fallback = ['الرباط','الدار البيضاء','طنجة','فاس','مراكش','سلا','الصخيرات','تمارة'];
        const sel = document.getElementById('modal-city');
        sel.innerHTML = '<option value="">اختر المدينة</option>' + (fallback.map(c => `<option value="${c}">${c}</option>`).join(''));
      }
    }
    async function saveAddEmployee() {
      const name = document.getElementById('modal-name').value.trim();
      const email = document.getElementById('modal-email').value.trim();
      const phone = document.getElementById('modal-phone').value.trim();
      const city = document.getElementById('modal-city').value.trim();
      const username = document.getElementById('modal-username').value.trim();
      if (!name) { showMessage('يرجى إدخال الاسم', 'error'); return; }
      const password = generatePassword();
      const adminToken = localStorage.getItem('adminToken');
      try {
        const res = await fetch('/api/admin/employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
          body: JSON.stringify({ name, email, phone, city, password, username })
        });
        const data = await res.json();
        if (res.ok && data.success) {
          showMessage('تم إنشاء الموظف بنجاح', 'success');
          const banner = document.getElementById('latest-password-banner');
          banner.textContent = `اسم المستخدم: ${data.username} — كلمة المرور المؤقتة: ${password}`;
          banner.classList.remove('hidden');
          closeAddEmployeeModal();
          fetchEmployees();
        } else {
          showMessage(data.message || 'فشل إنشاء الموظف', 'error');
        }
      } catch (_) {
        showMessage('خطأ في الاتصال بالخادم', 'error');
      }
    }

    async function resetEmployeePassword(id) {
      try {
        const adminToken = localStorage.getItem('adminToken');
        const res = await fetch(`/api/admin/employees/${id}/reset_password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` }
        });
        const data = await res.json();
        if (res.ok && data.success) {
          showMessage('تم تعيين كلمة مرور جديدة', 'success');
          const banner = document.getElementById('latest-password-banner');
          banner.textContent = `كلمة المرور المؤقتة الجديدة: ${data.temp_password}`;
          banner.classList.remove('hidden');
        } else {
          showMessage(data.message || 'فشل إعادة تعيين كلمة المرور', 'error');
        }
      } catch (_) {
        showMessage('خطأ في الاتصال بالخادم', 'error');
      }
    }

    function openEmployeeReport(id, name) {
      const modal = document.getElementById('employee-report-modal');
      const title = document.getElementById('employee-report-title');
      const body = document.getElementById('employee-report-body');
      title.textContent = `تقرير الموظف: ${name}`;
      body.innerHTML = '<div class="text-center text-gray-500 p-6">جاري تحميل التقرير...</div>';
      modal.style.display = 'flex';
      loadEmployeeReport(id);
    }
    function closeEmployeeReport() {
      const modal = document.getElementById('employee-report-modal');
      modal.style.display = 'none';
    }
    async function loadEmployeeReport(id) {
      try {
        const adminToken = localStorage.getItem('adminToken');
        const [summaryRes, todayRes] = await Promise.all([
          fetch(`/api/admin/employees/${id}/analytics/summary`, { headers: { 'Authorization': `Bearer ${adminToken}` }}),
          fetch(`/api/admin/employees/${id}/analytics/today`, { headers: { 'Authorization': `Bearer ${adminToken}` }})
        ]);
        const summary = await summaryRes.json();
        const today = await todayRes.json();
        if (!summaryRes.ok || !summary.success) { document.getElementById('employee-report-body').innerHTML = '<div class="text-center text-red-600 p-6">فشل تحميل الملخص</div>'; return; }
        if (!todayRes.ok || !today.success) { document.getElementById('employee-report-body').innerHTML = '<div class="text-center text-red-600 p-6">فشل تحميل زيارات اليوم</div>'; return; }
        const a = summary.all || { activated:0, interested:0, not_interested:0 };
        const t = summary.today || { activated:0, interested:0, not_interested:0 };
        const rev = summary.revenue || { today:0, all:0 };
        const visits = today.visits || [];
        const pctAll = Math.min(100, Math.round((Number(a.activated||0) / 100) * 100));
        const pctToday = Math.min(100, Math.round((Number(t.activated||0) / Math.max(1, 10)) * 100));
        const html = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div class="stat-card">
              <div>
                <div class="text-sm text-gray-500">إجمالي التفعيلات</div>
                <div class="text-2xl font-extrabold">${Number(a.activated||0).toLocaleString('en-US')}</div>
              </div>
              <div class="ring" style="--pct:${pctAll}%"><span class="ring-val">${pctAll}%</span></div>
            </div>
            <div class="stat-card">
              <div>
                <div class="text-sm text-gray-500">تفعيلات اليوم</div>
                <div class="text-2xl font-extrabold">${Number(t.activated||0).toLocaleString('en-US')}</div>
              </div>
              <div class="ring" style="--pct:${pctToday}%"><span class="ring-val">${pctToday}%</span></div>
            </div>
            <div class="stat-card">
              <div>
                <div class="text-sm text-gray-500">الإيراد الإجمالي</div>
                <div class="text-2xl font-extrabold">₪${Number(rev.all||0).toLocaleString('en-US')}</div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-lg font-bold">زيارات اليوم (${visits.length})</div>
            </div>
            ${visits.length === 0 ? '<p class="text-center text-gray-500 p-6">لا توجد زيارات اليوم</p>' : visits.map(v => {
              const timeOnly = new Date(v.visited_at).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
              const status = (v.status||'').toLowerCase();
              const badge = status.includes('activated') || status.includes('paid')
                ? '<span class="sub-badge">مفعّل</span>'
                : status.includes('interested') ? '<span class="sub-badge">مهتم</span>' : '<span class="sub-badge">غير مهتم</span>';
              return `
                <div class="flex justify-between items-center border-b border-gray-100 py-2">
                  <div class="font-semibold">${(v.salon_name||'—').replace(/</g,'&lt;')}</div>
                  <div class="flex items-center gap-2 text-sm">${badge}<span class="text-gray-500">${timeOnly}</span></div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        document.getElementById('employee-report-body').innerHTML = html;
      } catch (_) {
        document.getElementById('employee-report-body').innerHTML = '<div class="text-center text-red-600 p-6">حدث خطأ</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('add-employee-btn').addEventListener('click', openAddEmployeeModal);
      document.getElementById('add-employee-close').addEventListener('click', closeAddEmployeeModal);
      document.getElementById('add-employee-cancel').addEventListener('click', closeAddEmployeeModal);
      document.getElementById('add-employee-save').addEventListener('click', saveAddEmployee);
      loadCitiesDropdown();
      fetchEmployees();
      document.getElementById('employee-report-close').addEventListener('click', closeEmployeeReport);
    });
  </script>
</body>
</html>
