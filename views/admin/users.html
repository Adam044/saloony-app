<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>إدارة المستخدمين - Saloony</title>
  <link rel="icon" href="/Images/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="./assets/dashboard.css">
  <link rel="stylesheet" href="./assets/admin.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="./assets/dashboard.js"></script>
  <script defer src="./assets/admin-header.js"></script>
  <script>
    // Simple auth guard for admin
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      window.location.replace('/auth.html');
    }
  </script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: #f7fafc; color: #0f172a; margin: 0; }
    .bg-primary-dark { background-color: #1E293B; }
    header { position: fixed; top: 0; left: 0; right: 0; background: #1E293B; color: #fff; padding: 12px 16px; padding-top: env(safe-area-inset-top); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20; }
    main { padding: calc(60px + env(safe-area-inset-top)) 16px 24px; max-width: 1100px; margin: 0 auto; }
    .btn { display: inline-flex; align-items: center; gap: 8px; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; border: none; }
    .btn-primary { background: #0f172a; color: #fff; }
    .btn-primary:hover { background: #0b1320; }
    .table-wrapper { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 760px; }
    thead th { background: #f9fafb; color: #6b7280; font-size: 12px; letter-spacing: .04em; text-transform: uppercase; text-align: right; padding: 12px 16px; }
    tbody td { padding: 14px 16px; font-size: 14px; border-top: 1px solid #f1f5f9; }
    tr:hover td { background: #f9fafb; }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .badge-user { background: #DBEAFE; color: #1E40AF; }
    .badge-salon { background: #E5E7EB; color: #374151; }
    .badge-admin { background: #D1FAE5; color: #065F46; }
  </style>
</head>
<body>
  <header class="bg-primary-dark shadow-lg p-2 flex justify-between items-center w-full z-20 fixed top-0" style="padding-top: env(safe-area-inset-top)">
    <div class="flex items-center pl-4 gap-2">
      <a href="/admin/admin_dashboard.html" class="text-white/80 hover:text-white transition duration-150 p-2 rounded-lg hover:bg-white/10" aria-label="Back">
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1E293B/ffffff?text=ADM';" alt="Saloony Admin" class="h-10 w-auto object-contain object-center">
    </div>
    <h1 class="text-xl font-bold text-white">لوحة تحكم الإدارة</h1>
    <button id="logout-btn" class="text-white/80 hover:text-red-400 transition duration-150 p-2 rounded-lg hover:bg-white/10">
      <i class="fas fa-sign-out-alt text-lg"></i>
    </button>
  </header>

  
  <main class="page-container">
    <div class="table-wrapper" id="users-container">
      <p style="text-align:center; color:#6b7280; padding: 24px;">جاري تحميل المستخدمين...</p>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('adminToken');

    async function loadUsersStandalone() {
      const container = document.getElementById('users-container');
      container.innerHTML = '<p style="text-align:center; color:#6b7280; padding: 24px;">جاري تحميل المستخدمين...</p>';
      try {
        const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!res.ok) {
          const errText = await res.text();
          console.error('Failed users fetch:', res.status, errText);
          container.innerHTML = '<p style="text-align:center; color:#EF4444; padding: 24px;">فشل تحميل بيانات المستخدمين.</p>';
          return;
        }
        const data = await res.json();
        const users = Array.isArray(data) ? data : (Array.isArray(data.users) ? data.users : []);

        if (!Array.isArray(users) || users.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#6b7280; padding: 24px;">لا توجد سجلات مستخدمين حالياً.</p>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>الاسم</th>
                <th>البريد الإلكتروني</th>
                <th>الهاتف</th>
                <th>المدينة</th>
                <th>النوع</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${users.map((u, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td style="font-weight:700; color:#0f172a">${u.name}</td>
                  <td>${u.email}</td>
                  <td>${u.phone || '---'}</td>
                  <td>${u.city || '---'}</td>
                  <td>
                    <span class="badge ${u.user_type === 'user' ? 'badge-user' : u.user_type === 'salon' ? 'badge-salon' : 'badge-admin'}">
                      ${u.user_type === 'user' ? 'مستخدم' : u.user_type === 'salon' ? 'صالون' : 'إدارة'}
                    </span>
                  </td>
                  <td>
                    <button class="btn" onclick="generateResetCode('${(u.email||u.phone||'').replace(/'/g,'')}')"><i class="fas fa-key"></i> كود استعادة</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        console.error('Failed to load users:', e);
        container.innerHTML = '<p style="text-align:center; color:#EF4444; padding: 24px;">فشل تحميل بيانات المستخدمين.</p>';
      }
    }

    async function generateResetCode(identifier){
      try {
        const token = localStorage.getItem('adminToken');
        const res = await fetch('/api/admin/password-reset/generate', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ identifier }) });
        const data = await res.json();
        if (res.ok && data.success) {
          try { await navigator.clipboard.writeText(String(data.code)); } catch(_) {}
          alert('رمز الاستعادة: ' + String(data.code));
        } else {
          alert(data.message || 'فشل إنشاء الرمز');
        }
      } catch (_) { alert('خطأ في الاتصال بالخادم'); }
    }

    document.addEventListener('DOMContentLoaded', loadUsersStandalone);
  </script>
</body>
</html>
