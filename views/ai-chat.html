<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>نوڤا - مساعد الجمال الذكي</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#06C167">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="صالوني">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Light Mode Variables (Default) */
        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #FF6B6B;
            --neon-cyan: #06b6d4;
            --neon-pink: #ec4899;
            --neon-green: #10b981;
            --neon-blue: #3b82f6;
            --background-gradient: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            --chat-bg: #ffffff;
            --bg-secondary: #f8fafc;
            --user-message: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --ai-message: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --header-bg: rgba(255, 255, 255, 0.98);
            --modal-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --avatar-ai-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --avatar-user-bg: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --avatar-glow: rgba(16, 185, 129, 0.3);
            --header-ai-avatar-bg: #10b981;
            --header-ai-avatar-glow: rgba(16, 185, 129, 0.4);
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --background-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --chat-bg: #1e293b;
            --bg-secondary: #334155;
            --user-message: linear-gradient(135deg, #06C167 0%, #059669 100%);
            --ai-message: linear-gradient(135deg, #334155 0%, #475569 100%);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #475569;
            --primary-color: #06C167;
            --primary-dark: #05A855;
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.4);
            --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-heavy: 0 10px 25px rgba(0, 0, 0, 0.6);
            --header-bg: rgba(30, 41, 59, 0.95);
            --modal-bg: #334155;
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --success-color: #10b981;
            --error-color: #f87171;
            --warning-color: #fbbf24;
            --neon-blue: #60a5fa;
            --neon-cyan: #22d3ee;
            --avatar-ai-bg: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
            --avatar-user-bg: linear-gradient(135deg, #06C167 0%, #059669 100%);
            --avatar-glow: rgba(34, 211, 238, 0.4);
            --header-ai-avatar-bg: #22d3ee;
            --header-ai-avatar-glow: rgba(34, 211, 238, 0.5);
        }

        /* Enhanced Theme Transitions */
        * {
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                       color 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                       border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                       box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                       background-image 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Theme Switch Animation */
        body.theme-switching {
            animation: themeSwitch 0.6s ease-in-out;
        }

        @keyframes themeSwitch {
            0% { opacity: 1; }
            50% { opacity: 0.8; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes themeRipple {
            0% {
                transform: translate(50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(50%, -50%) scale(100);
                opacity: 0;
            }
        }

        /* Enhanced button animations for theme toggle */
        .action-btn {
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .action-btn:active::before {
            width: 200px;
            height: 200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            direction: rtl;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .chat-header {
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1rem 1.5rem;
            padding-top: calc(1rem + env(safe-area-inset-top));
            box-shadow: var(--shadow-medium);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.625rem;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }

        .back-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(6, 193, 103, 0.3);
        }

        /* Ensure back button is visible in light mode */
        [data-theme="light"] .back-btn {
            color: var(--primary-dark);
            background: rgba(6, 193, 103, 0.1);
        }

        [data-theme="light"] .back-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--header-ai-avatar-bg);
            box-shadow: 0 0 10px var(--header-ai-avatar-glow);
            animation: avatarGlow 3s ease-in-out infinite alternate;
            overflow: hidden;
            background: var(--header-ai-avatar-bg);
        }

        .ai-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @keyframes avatarGlow {
            from {
                box-shadow: 0 0 10px var(--header-ai-avatar-glow);
            }
            to {
                box-shadow: 0 0 15px var(--header-ai-avatar-glow);
            }
        }

        .header-text h1 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--neon-cyan);
            margin-bottom: 0.125rem;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            animation: subtleGlow 4s ease-in-out infinite alternate;
        }

        @keyframes subtleGlow {
            from {
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            }
            to {
                text-shadow: 0 0 8px rgba(0, 255, 255, 0.7);
            }
        }

        .header-text p {
            font-size: 0.875rem;
            color: var(--neon-blue);
            text-shadow: 0 0 5px rgba(0, 128, 255, 0.5);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: rgba(6, 193, 103, 0.1);
            border: 2px solid transparent;
            padding: 0.625rem;
            border-radius: 50%;
            cursor: pointer;
            color: var(--primary-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            min-width: 40px;
            min-height: 40px;
            position: relative;
            overflow: hidden;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(6, 193, 103, 0.4);
            border-color: var(--primary-color);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* Enhanced styling for light mode */
        [data-theme="light"] .action-btn {
            background: rgba(6, 193, 103, 0.15);
            color: var(--primary-dark);
            border-color: rgba(6, 193, 103, 0.2);
        }

        [data-theme="light"] .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Special styling for theme toggle icon */
        #themeIcon {
            transition: all 0.3s ease;
        }

        .action-btn:hover #themeIcon {
            transform: rotate(180deg);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            background: var(--chat-bg);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth; 
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
            padding: 1rem;
            /* Add bottom margin to account for fixed quick-replies and input */
            margin-bottom: 120px;
        }

        /* Messages */
        .message {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--avatar-user-bg);
            color: white;
            box-shadow: 0 0 8px var(--avatar-glow);
        }

        .message.ai .message-avatar {
            background: var(--avatar-ai-bg);
            color: white;
            box-shadow: 0 0 8px var(--avatar-glow);
        }

        .message-content {
            max-width: 70%;
            padding: 0.875rem 1.125rem;
            border-radius: var(--border-radius);
            font-size: 0.9375rem;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }
        
        /* Highlight strong text for AI responses (Structured Output) */
        .message.ai .message-content strong {
            color: var(--primary-color);
            font-weight: 700;
        }

        .message.user .message-content {
            background: var(--user-message);
            color: white;
            border-bottom-left-radius: 6px;
        }

        .message.ai .message-content {
            background: var(--ai-message);
            color: var(--text-primary);
            border-bottom-right-radius: 6px;
            border: 1px solid var(--border-color);
            direction: rtl;
            text-align: right;
        }
        
        /* Error state for AI messages */
        .message.ai .message-content.error {
            background: #fef2f2;
            color: #b91c1c;
            border-color: #fca5a5;
        }

        /* Enhanced AI message formatting styles - RTL optimized */
        .message.ai .message-content .ai-list {
            margin: 0.5rem 0;
            padding-right: 1.5rem;
            padding-left: 0;
            list-style: none;
            direction: rtl;
            text-align: right;
        }

        .message.ai .message-content .ai-list li {
            position: relative;
            margin: 0.25rem 0;
            padding-right: 0.5rem;
            padding-left: 0;
            direction: rtl;
            text-align: right;
        }

        .message.ai .message-content .ai-list li::before {
            content: '•';
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            right: -1rem;
            left: auto;
        }

        .message.ai .message-content .ai-heading {
            margin: 0.75rem 0 0.5rem 0;
            color: var(--primary-color);
            font-weight: 600;
            direction: rtl;
            text-align: right;
        }

        .message.ai .message-content .ai-heading:first-child {
            margin-top: 0;
        }

        .message.ai .message-content h1.ai-heading {
            font-size: 1.125rem;
        }

        .message.ai .message-content h2.ai-heading {
            font-size: 1.0625rem;
        }

        .message.ai .message-content h3.ai-heading {
            font-size: 1rem;
        }

        .message.ai .message-content .ai-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.875rem;
            background: var(--background-secondary);
            border-radius: 6px;
            overflow: hidden;
            direction: rtl;
        }

        .message.ai .message-content .ai-table th,
        .message.ai .message-content .ai-table td {
            padding: 0.5rem 0.75rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            direction: rtl;
        }

        .message.ai .message-content .ai-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .message.ai .message-content .ai-table tr:last-child td {
            border-bottom: none;
        }

        .message.ai .message-content .ai-table tr:nth-child(even) {
            background: rgba(var(--primary-color-rgb), 0.05);
        }

        .message.ai .message-content .ai-paragraph {
            margin: 0.5rem 0;
            direction: rtl;
            text-align: right;
        }

        .message.ai .message-content .ai-paragraph:first-child {
            margin-top: 0;
        }

        .message.ai .message-content .ai-paragraph:last-child {
            margin-bottom: 0;
        }

        .message.ai .message-content em {
            font-style: italic;
            color: var(--text-secondary);
            direction: rtl;
        }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.25rem;
            text-align: center;
        }

        .message.ai .message-time {
            color: var(--text-secondary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none; /* Hidden by default */
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            opacity: 0;
            transform: translateY(10px);
            transition: var(--transition);
        }

        .typing-indicator.show {
            display: flex; /* Show when needed */
            opacity: 1;
            transform: translateY(0);
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--ai-message);
            border-radius: var(--border-radius);
            border-bottom-right-radius: 6px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingPulse {
            0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
            30% { transform: scale(1.2); opacity: 1; }
        }

        /* Input Area - Completely reconstructed */
        .input-container {
            background: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            /* Only safe area padding for mobile compatibility */
            padding-bottom: env(safe-area-inset-bottom);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--ai-message);
            border-radius: 24px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            /* RTL layout: send button on the right */
            flex-direction: row-reverse;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 193, 103, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            background: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.5;
            color: var(--text-primary);
            /* CRITICAL FIX: Default text alignment for LTR text in RTL context */
            text-align: right; 
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        /* Dynamic Send Button Styling */
        .send-btn-wrapper {
            width: 40px;
            height: 40px;
            position: relative;
            flex-shrink: 0;
            /* Ensure proper spacing and alignment */
            margin-left: 0.5rem;
        }
        
        .action-icon {
            background: var(--primary-color);
            border: none;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 1.125rem;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 1;
            transform: scale(1);
        }
        
        .action-icon:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .action-icon:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* Microphone button specific styling */
        #micBtn {
            background: var(--neon-pink);
        }

        #micBtn:hover:not(:disabled) {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Initial state - show send button by default, show microphone */
        #sendBtn {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #micBtn {
            opacity: 1; /* Changed from 0 to 1 to make visible */
            transform: scale(1); /* Changed from scale(0) to scale(1) */
            pointer-events: auto; /* Changed from none to auto */
            position: absolute; /* Ensure same positioning as sendBtn */
            top: 0;
            left: 0;
        }

        /* Quick Replies - Temporarily Hidden */
        .quick-replies {
            display: none; /* Temporarily hidden to fix overlap issue */
            gap: 0.75rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: fixed;
            bottom: 85px; /* Increased for better spacing */
            left: 0;
            right: 0;
            z-index: 99;
            padding: 1rem 1rem 1.5rem 1rem; /* Added bottom padding to prevent cutoff */
            /* Enhanced gradient fade effect */
            background: linear-gradient(to top, var(--chat-bg) 80%, transparent);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .quick-replies::-webkit-scrollbar {
            display: none;
        }

        .quick-reply {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 0.75rem 1.25rem;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            color: var(--text-primary);
            font-weight: 600;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15), 
                        0 1px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            /* Center text alignment */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px; /* Ensure proper touch target */
            /* Enhanced visual appeal */
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        }

        .quick-reply::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(6, 193, 103, 0.2), transparent);
            transition: left 0.5s;
        }

        .quick-reply:hover {
            background: rgba(6, 193, 103, 0.2);
            border-color: rgba(6, 193, 103, 0.6);
            color: var(--primary-color);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(6, 193, 103, 0.4),
                        0 0 30px rgba(6, 193, 103, 0.5),
                        inset 0 0 25px rgba(6, 193, 103, 0.1);
            text-shadow: 0 0 12px rgba(6, 193, 103, 0.8);
            background-image: linear-gradient(135deg, rgba(6, 193, 103, 0.15) 0%, rgba(6, 193, 103, 0.05) 100%);
        }

        .quick-reply:hover::before {
            left: 100%;
        }

        /* Dark mode neon adjustments */
        [data-theme="dark"] .quick-reply:hover {
            box-shadow: 0 4px 12px rgba(6, 193, 103, 0.4),
                        0 0 25px rgba(6, 193, 103, 0.5),
                        inset 0 0 25px rgba(6, 193, 103, 0.15);
            text-shadow: 0 0 10px rgba(6, 193, 103, 0.8);
        }

        /* Light mode neon adjustments */
        [data-theme="light"] .quick-reply:hover {
            box-shadow: 0 4px 12px rgba(6, 193, 103, 0.25),
                        0 0 15px rgba(6, 193, 103, 0.3),
                        inset 0 0 15px rgba(6, 193, 103, 0.08);
            text-shadow: 0 0 6px rgba(6, 193, 103, 0.4);
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 2rem 1.5rem;
            color: var(--text-secondary);
        }

        .welcome-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .welcome-message h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .welcome-message p {
            font-size: 1rem;
            line-height: 1.6;
        }
        
        /* Toast Notification (Non-blocking alert replacement) */
        #toast-container {
            position: fixed;
            top: calc(1rem + 80px); /* Below the header */
            right: 1.5rem;
            left: 1.5rem;
            z-index: 10000;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }
        
        .app-toast {
            max-width: 400px;
            background: #b91c1c; /* red-700 */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-align: right;
        }
        
        .app-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                border-radius: 0;
                height: 100vh;
            }

            .header-content {
                padding: 0;
            }

            .messages-container {
                padding: 0.75rem;
                margin-bottom: 130px; /* Slightly more space on mobile */
            }

            .input-container {
                /* Only safe area padding for mobile */
                padding-bottom: env(safe-area-inset-bottom);
            }

            .quick-replies {
                bottom: 95px; /* Increased for mobile input height + safe area */
                padding: 1rem 0.75rem 1.75rem 0.75rem; /* Enhanced bottom padding for mobile */
                gap: 0.6rem; /* Slightly smaller gap on mobile */
            }

            .message-content {
                max-width: 85%;
            }
            
            #toast-container {
                right: 0.5rem;
                left: 0.5rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                --chat-bg: #1e293b;
                --ai-message: #334155;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --border-color: #475569;
            }
        }

        /* Enhanced Salon Cards - Modern Mobile-First Design */
        .salon-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.25rem;
            margin: 1.5rem 0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 0.75rem;
        }

        @media (max-width: 768px) {
            .salon-cards-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 1rem 0;
                padding: 0 0.5rem;
            }
        }

        .salon-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            transform: translateY(0);
        }

        .salon-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--neon-blue);
        }
        
        @media (prefers-color-scheme: dark) {
            .salon-card {
                background: var(--chat-bg);
                border-color: var(--border-color);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            
            .salon-card:hover {
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            }
        }

        .salon-card-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .salon-card-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(6, 193, 103, 0.1), rgba(0, 255, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .salon-card:hover .salon-card-image::before {
            opacity: 1;
        }

        .salon-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .salon-card:hover .salon-card-image img {
            transform: scale(1.05);
        }

        .salon-card-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .salon-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .salon-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.3;
            margin: 0;
            flex: 1;
        }

        @media (prefers-color-scheme: dark) {
            .salon-card-title {
                color: var(--text-primary);
            }
        }

        .salon-card-badge {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan));
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.3);
        }

        .salon-card-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .salon-card-info-item {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .salon-card-info-item i {
            width: 16px;
            text-align: center;
            color: var(--neon-blue);
        }

        .salon-card-rating {
            color: #fbbf24;
            font-weight: 600;
            background: rgba(251, 191, 36, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .salon-card-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .salon-card-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .salon-card-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .salon-card-btn:hover::before {
            left: 100%;
        }

        .salon-card-btn.primary {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
        }

        .salon-card-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.4);
        }

        .salon-card-btn.secondary {
            background: rgba(var(--neon-blue-rgb), 0.1);
            color: var(--neon-blue);
            border: 1px solid rgba(var(--neon-blue-rgb), 0.2);
        }

        .salon-card-btn.secondary:hover {
            background: var(--neon-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(var(--neon-blue-rgb), 0.3);
        }

        @media (max-width: 480px) {
            .salon-card-content {
                padding: 1.25rem;
            }
            
            .salon-card-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .salon-card-btn {
                padding: 0.875rem 1rem;
            }
        }

        /* Loading skeleton for salon cards */
        .skeleton-card {
            background: #f8f9fa;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .skeleton-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .skeleton-image {
            width: 100%;
            height: 180px;
            background: #e9ecef;
        }

        .skeleton-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .skeleton-title {
            height: 24px;
            background: #e9ecef;
            border-radius: 6px;
            width: 70%;
        }

        .skeleton-text {
            height: 16px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }

        .skeleton-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .skeleton-button {
            flex: 1;
            height: 40px;
            background: #e9ecef;
            border-radius: 12px;
        }

        /* Salon Modal styles unchanged */
        .salon-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .salon-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .salon-modal-content {
            background: white;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9);
            transition: var(--transition);
            color: #1e293b !important;
        }

        .salon-modal.show .salon-modal-content {
            transform: scale(1);
        }

        .salon-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .salon-modal-header h3 {
            color: #1e293b !important;
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .salon-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .salon-modal-close:hover {
            background: var(--ai-message);
            color: var(--text-primary);
        }

        .salon-modal-body {
            padding: 1.5rem;
        }

        .salon-modal-body h4 {
            color: #1e293b !important;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .salon-services-list {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .salon-service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--ai-message);
            border-radius: 8px;
        }

        .salon-service-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .salon-service-price {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: row;
            min-height: 140px;
        }

        .skeleton-image {
            width: 120px;
            height: 140px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            flex-shrink: 0;
        }

        .skeleton-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .skeleton-title {
            height: 20px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            width: 70%;
        }

        .skeleton-text {
            height: 16px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }

        .skeleton-text.short { width: 50%; }
        .skeleton-text.medium { width: 80%; }

        .skeleton-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .skeleton-button {
            flex: 1;
            height: 36px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        /* Confirmation Modal Styles */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-modal-content {
            background: var(--chat-bg);
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            position: relative;
            transform: scale(0.9);
            transition: var(--transition);
            box-shadow: var(--shadow-heavy);
        }

        .confirmation-modal.show .confirmation-modal-content {
            transform: scale(1);
        }

        .confirmation-modal-header {
            padding: 2rem 1.5rem 1rem;
            text-align: center;
        }

        .confirmation-modal-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .confirmation-modal-body {
            padding: 0 1.5rem 1.5rem;
            text-align: center;
        }

        .confirmation-modal-body p {
            color: var(--text-primary);
            margin: 0;
            line-height: 1.5;
        }

        .confirmation-modal-actions {
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .cancel-btn {
            background: var(--ai-message);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .cancel-btn:hover {
            background: var(--border-color);
        }

        .confirm-btn {
            background: var(--primary-color);
            color: white;
        }

        .confirm-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Modal Overlay and Content Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            transform: scale(0.9);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
    /* Additional UI/UX Improvements */
        
        /* Enhanced hover effects for buttons */
        .header-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }

        /* Improved message animations */
        .message {
            animation: slideInMessage 0.3s ease-out;
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Better focus states */
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* Enhanced modal animations */
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }

        .modal.show .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Improved loading states */
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Better scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
            opacity: 0.5;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
            opacity: 0.8;
        }

        /* Enhanced button ripple effect */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-ripple:active::before {
            width: 300px;
            height: 300px;
        }

        /* Improved spacing and typography */
        .message-content {
            line-height: 1.6;
            word-spacing: 0.1em;
        }

        .chat-header h1 {
            letter-spacing: 0.5px;
        }

        /* Enhanced theme transition */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Better mobile responsiveness */
        @media (max-width: 480px) {
            .header-actions button {
                padding: 8px;
                font-size: 14px;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
        }

        </style>
</head>
<body>
    
    <!-- Toast Notification Container (Above all content) -->
    <div id="toast-container"></div>
    
    <!-- Header -->
    <header class="chat-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()" aria-label="العودة">
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <div class="header-info">
                <div class="ai-avatar">
                    <img src="/images/Saloony_logo.png" alt="صالوني" style="width: 36px; height: 36px; object-fit: contain;">
                </div>
                <div class="header-text">
                    <h1>نوڤا</h1>
                    <p id="status-text">مساعد الجمال الذكي</p>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="action-btn btn-ripple" onclick="showNewChatModal()" aria-label="محادثة جديدة" title="محادثة جديدة">
                    <i class="fas fa-plus-circle"></i>
                </button>
                <button class="action-btn btn-ripple" onclick="toggleTheme()" aria-label="تغيير المظهر" title="تغيير المظهر">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            <!-- Welcome Message -->
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">
                    <i class="fas fa-sparkles"></i>
                </div>
                <h2>مرحباً بك! 😊</h2>
                <p>أنا نوڤا، مساعد الجمال الذكي. أسعد بمساعدتك في كل ما يخص الجمال والعناية. كيف يمكنني مساعدتك اليوم؟</p>
            </div>
        </div>

        <!-- Quick Replies -->
        <div class="quick-replies" id="quickReplies">
            <button class="quick-reply" onclick="sendQuickReply('أريد قصة شعر جديدة')">قصة شعر جديدة</button>
            <button class="quick-reply" onclick="sendQuickReply('نصائح للعناية بالبشرة')">العناية بالبشرة</button>
            <button class="quick-reply" onclick="sendQuickReply('أريد حجز موعد')">حجز موعد</button>
            <button class="quick-reply" onclick="sendQuickReply('ألوان مناسبة لي')">ألوان مناسبة</button>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <!-- Dynamic Send Button Wrapper - Now appears on the right due to flex-direction: row-reverse -->
                <div class="send-btn-wrapper">
                    <button class="action-icon btn-ripple" id="sendBtn" onclick="sendMessage()" aria-label="إرسال">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="action-icon btn-ripple" id="micBtn" onclick="simulateVoiceInput()" aria-label="إدخال صوتي" style="opacity: 1; transform: scale(1);">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="اكتب رسالتك هنا..."
                    rows="1"
                    maxlength="1000"
                    oninput="handleDirectionChange(this); updateSendButton(this);"
                ></textarea>
            </div>
        </div>
    </div>

    <!-- Salon Modal -->
    <div class="salon-modal" id="salonModal">
        <div class="salon-modal-content">
            <div class="salon-modal-header">
                <h3 id="salonModalTitle">تفاصيل الصالون</h3>
                <button class="salon-modal-close" onclick="closeSalonModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="salon-modal-body" id="salonModalBody">
                <!-- Salon details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Chat Confirmation Modal -->
    <div class="confirmation-modal" id="newChatModal">
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-header">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 2rem; margin-bottom: 1rem;"></i>
                <h3>محادثة جديدة</h3>
            </div>
            <div class="confirmation-modal-body">
                <p>هل أنت متأكد من أنك تريد بدء محادثة جديدة؟</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">سيتم حذف المحادثة الحالية نهائياً</p>
            </div>
            <div class="confirmation-modal-actions">
                <button class="modal-btn cancel-btn" onclick="closeNewChatModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
                <button class="modal-btn confirm-btn" onclick="confirmNewChat()">
                    <i class="fas fa-plus"></i>
                    محادثة جديدة
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = {};
        let conversationHistory = [];
        let isTyping = false;
        let currentLanguage = 'ar';
        let shownSalons = new Set(); // Track shown salon IDs to prevent duplicates
        
        // === Global Functions (accessible by inline event handlers) ===
        
        // Dynamic Send Button Function
        function updateSendButton(textarea) {
            const sendBtn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');
            
            if (!sendBtn || !micBtn) return; // Safety check
            
            const text = textarea.value.trim();
            if (text.length > 0) {
                // Show Send Button
                sendBtn.style.opacity = '1';
                sendBtn.style.transform = 'scale(1)';
                sendBtn.style.pointerEvents = 'auto';
                sendBtn.disabled = false;
                
                // Hide Mic Button
                micBtn.style.opacity = '0';
                micBtn.style.transform = 'scale(0)';
                micBtn.style.pointerEvents = 'none';
            } else {
                // Show Mic Button
                micBtn.style.opacity = '1';
                micBtn.style.transform = 'scale(1)';
                micBtn.style.pointerEvents = 'auto';
                
                // Hide Send Button
                sendBtn.style.opacity = '0';
                sendBtn.style.transform = 'scale(0)';
                sendBtn.style.pointerEvents = 'none';
                sendBtn.disabled = true;
            }
        }
        
        // Simulates a future voice input feature
        function simulateVoiceInput() {
            showToast('الإدخال الصوتي غير متاح حالياً. يرجى الكتابة.', false);
        }
        
        // Send message function (global scope)
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            
            // Validate input first
            try {
                const validatedMessage = validateInput(message);
                
                if (isTyping) {
                    showInputError('انتظر حتى ينتهي نوڤا من الرد...');
                    return;
                }

                // Add user message to chat
                addMessage(validatedMessage, 'user');
                messageInput.value = '';
                updateSendButton(messageInput);
                
                // Show typing indicator
                isTyping = true;
                showTypingIndicator();

                // Send to AI
                const userId = currentUser?.userId || currentUser?.id || currentUser?.user_id;
                console.log('Current user for AI:', currentUser, 'Using ID:', userId);
                
                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: validatedMessage,
                        user_id: userId || 'anonymous',
                        context: {
                            conversation_history: conversationHistory.slice(-6)
                        }
                    })
                });

                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                isTyping = false;

                if (data.success) {
                    addMessage(data.response, 'ai');
                    conversationHistory.push({
                        user: validatedMessage,
                        ai: data.response,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update dynamic suggestions based on AI response
                    updateDynamicSuggestions(data.response, validatedMessage);
                } else {
                    addMessage(data.fallback_response || 'عذراً، حدث خطأ. يرجى المحاولة مرة أخرى.', 'ai', true);
                }

            } catch (error) {
                console.error('Send message error:', error);
                hideTypingIndicator();
                isTyping = false;
                
                if (error.message.includes('طويلة جداً')) {
                    showInputError('الرسالة طويلة جداً. يرجى تقصيرها.');
                } else if (error.message.includes('فارغة')) {
                    showInputError('يرجى كتابة رسالة قبل الإرسال.');
                } else if (error.message.includes('غير صالحة')) {
                    showInputError('الرسالة تحتوي على محتوى غير صالح.');
                } else if (isTyping) {
                    showInputError('انتظر حتى ينتهي نوڤا من الرد...');
                } else {
                    addMessage('عذراً، حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.', 'ai', true);
                }
            }
        }
        
        // --- UTILITY: Non-blocking Toast Function (Replaced alert) ---
        function showToast(message, isSuccess = false) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'app-toast';
            toast.textContent = message;
            
            if (isSuccess) {
                 toast.style.backgroundColor = '#10b981'; // green-600
                 toast.style.borderColor = '#34d399'; // green-400
            } else {
                 toast.style.backgroundColor = '#b91c1c'; // red-700
                 toast.style.borderColor = '#f87171'; // red-400
            }
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 400);
            }, 4000);
        }
        
        // --- UX: Adaptive Input Direction (RTL/LTR FIX) ---
        function handleDirectionChange(textarea) {
            const text = textarea.value.trim();
            if (text.length === 0) {
                // Default to RTL when empty
                textarea.style.textAlign = 'right';
                textarea.dir = 'rtl';
                return;
            }

            // Check the first non-space character
            const firstChar = text.match(/[a-zA-Z\u0600-\u06FF]/);
            if (firstChar) {
                const charCode = firstChar[0].charCodeAt(0);
                // Check if it's an Arabic character
                const isArabic = charCode >= 0x0600 && charCode <= 0x06FF;

                if (isArabic) {
                    textarea.style.textAlign = 'right';
                    textarea.dir = 'rtl';
                } else {
                    // Treat English and numbers as LTR
                    textarea.style.textAlign = 'left';
                    textarea.dir = 'ltr';
                }
            }
        }
        
        // --- UX: Auto Scroll Fix ---
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            // FIX: Using requestAnimationFrame + setTimeout to ensure DOM render before scroll
            requestAnimationFrame(() => {
                setTimeout(() => {
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                }, 50); 
            });
        }


        // Initialize the chat
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            setupEventListeners();
            loadUserData();
            
            updateSendButton(document.getElementById('messageInput'));
        });

        // Initialize chat functionality
        function initializeChat() {
            const messageInput = document.getElementById('messageInput');
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim() && !isTyping) {
                        sendMessage();
                    }
                }
            });
            
            messageInput.dir = 'rtl';
            messageInput.style.textAlign = 'right';
        }

        // Setup event listeners
        function setupEventListeners() {
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    updateStatus('مستشار الجمال الذكي');
                }
            });

            window.addEventListener('online', () => updateStatus('متصل'));
            window.addEventListener('offline', () => updateStatus('غير متصل'));
        }

        // Load user data
        async function loadUserData() {
            try {
                let userData = localStorage.getItem('salonni_user') || localStorage.getItem('currentUser');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    currentUser.userId = currentUser.userId || currentUser.id || currentUser.user_id;
                    updateWelcomeMessage();
                }
                
                // Load conversation history from localStorage
                const savedConversation = localStorage.getItem('ai_conversation_history');
                if (savedConversation) {
                    try {
                        conversationHistory = JSON.parse(savedConversation);
                        // Restore conversation in UI
                        restoreConversationUI();
                    } catch (error) {
                        console.warn('Failed to parse saved conversation:', error);
                        conversationHistory = [];
                    }
                }
                
                // CRITICAL FIX: Set initial language based on preference or default
                const savedLang = localStorage.getItem('chat_language');
                if (savedLang) {
                    currentLanguage = savedLang;
                    toggleLanguage(false); // Apply saved language without toggling (pass false to prevent saving/toggling state)
                }
                
            } catch (error) {
                console.warn('Failed to load user data:', error);
            }
        }

        // Update welcome message with user info
        function updateWelcomeMessage() {
            if (currentUser && currentUser.name) {
                const welcomeMessage = document.getElementById('welcomeMessage');
                const userName = currentUser.name;
                welcomeMessage.querySelector('h2').textContent = `مرحباً ${userName}! 😊`;
            }
        }

        // Enhanced AI message formatting function
        function formatAIMessage(content) {
            if (!content || typeof content !== 'string') {
                return content;
            }

            // Remove salon markers first
            let formatted = content
                .replace(/\[SHOW_SALON:.*?\]\s*/g, '')
                .replace(/\[SHOW_ALL_SALONS\]\s*/g, '');

            // Convert markdown-style formatting to HTML
            formatted = formatted
                // Bold text: **text** -> <strong>text</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text: *text* -> <em>text</em>
                .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');

            // Handle bullet points and lists
            formatted = formatted
                // Convert bullet points (•, -, *) to proper HTML lists
                .replace(/^[\s]*[•\-\*]\s+(.+)$/gm, '<li>$1</li>')
                // Convert numbered lists (1., 2., etc.) to proper HTML lists
                .replace(/^[\s]*\d+\.\s+(.+)$/gm, '<li>$1</li>');

            // Wrap consecutive <li> elements in <ul> tags
            formatted = formatted.replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/gs, function(match) {
                return '<ul class="ai-list">' + match + '</ul>';
            });

            // Handle headings (### Title -> <h3>Title</h3>)
            formatted = formatted
                .replace(/^###\s+(.+)$/gm, '<h3 class="ai-heading">$1</h3>')
                .replace(/^##\s+(.+)$/gm, '<h2 class="ai-heading">$1</h2>')
                .replace(/^#\s+(.+)$/gm, '<h1 class="ai-heading">$1</h1>');

            // Handle simple tables (for price comparisons)
            // Format: | Column1 | Column2 | Column3 |
            const tableRegex = /(\|[^|\n]+\|[^|\n]*\n)+/g;
            formatted = formatted.replace(tableRegex, function(tableMatch) {
                const rows = tableMatch.trim().split('\n');
                let tableHtml = '<table class="ai-table"><tbody>';
                
                rows.forEach((row, index) => {
                    if (row.trim()) {
                        const cells = row.split('|').filter(cell => cell.trim()).map(cell => cell.trim());
                        if (cells.length > 0) {
                            const tag = index === 0 ? 'th' : 'td';
                            tableHtml += `<tr>${cells.map(cell => `<${tag}>${cell}</${tag}>`).join('')}</tr>`;
                        }
                    }
                });
                
                tableHtml += '</tbody></table>';
                return tableHtml;
            });

            // Handle line breaks and paragraphs
            formatted = formatted
                // Convert double line breaks to paragraph breaks
                .replace(/\n\s*\n/g, '</p><p class="ai-paragraph">')
                // Convert single line breaks to <br> tags
                .replace(/\n/g, '<br>');

            // Wrap in paragraph if not already wrapped
            if (!formatted.includes('<p') && !formatted.includes('<ul') && !formatted.includes('<table') && !formatted.includes('<h')) {
                formatted = '<p class="ai-paragraph">' + formatted + '</p>';
            } else if (formatted.includes('</p><p')) {
                formatted = '<p class="ai-paragraph">' + formatted + '</p>';
            }

            // Clean up any empty paragraphs
            formatted = formatted.replace(/<p[^>]*><\/p>/g, '');

            return formatted;
        }

        // Send message function
        // Input validation and security
        function validateInput(message) {
            if (!message || typeof message !== 'string') {
                throw new Error('Invalid message format');
            }

            message = message.trim();

            if (message.length === 0) {
                throw new Error('Message cannot be empty');
            }

            if (message.length > 1000) {
                throw new Error('Message too long. Please keep it under 1000 characters.');
            }

            // Check for suspicious patterns
            const suspiciousPatterns = [
                /<script/i,
                /javascript:/i,
                /on\w+\s*=/i,
                /eval\s*\(/i,
                /document\./i,
                /window\./i
            ];

            for (const pattern of suspiciousPatterns) {
                if (pattern.test(message)) {
                    throw new Error('Invalid characters detected');
                }
            }

            return message.replace(/\s+/g, ' ').trim();
        }

        function showInputError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'input-error';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                background: #fee;
                color: #c33;
                padding: 0.5rem;
                border-radius: 8px;
                margin: 0.5rem 0;
                font-size: 0.875rem;
                border: 1px solid #fcc;
            `;
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.appendChild(errorDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add message to chat
        function addMessage(content, sender, isError = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-SA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            const avatarContent = sender === 'user' 
                ? '<i class="fas fa-user"></i>' 
                : '<img src="/images/Saloony_logo.png" alt="صالوني" style="width: 28px; height: 28px; object-fit: contain;">';

            // Enhanced content processing with comprehensive formatting
            let processedContent = formatAIMessage(content);

            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${avatarContent}
                </div>
                <div class="message-content ${isError ? 'error' : ''}">
                    ${processedContent}
                    <div class="message-time">${timeString}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            
            // Check if this is an AI response about salons and trigger cards
            if (sender === 'ai' && !isError) {
                let shouldShowCards = false;
                let specificSalon = null;
                
                // Check for specific salon request marker
                const salonMatch = content.match(/\[SHOW_SALON:(.*?)\]/);
                if (salonMatch) {
                    shouldShowCards = true;
                    specificSalon = salonMatch[1];
                }
                // Check for all salons request marker
                else if (content.includes('[SHOW_ALL_SALONS]')) {
                    shouldShowCards = true;
                }
                
                if (shouldShowCards) {
                     // Add salon cards after a short delay
                     setTimeout(async () => {
                         try {
                             let salons = await fetchSalonsForUser();
                             
                             // Filter for specific salon if requested
                             if (specificSalon && salons && salons.length > 0) {
                                 salons = salons.filter(salon => 
                                     salon.salon_name === specificSalon ||
                                     salon.salon_name.includes(specificSalon) ||
                                     specificSalon.includes(salon.salon_name)
                                 );
                             }
                             
                             if (salons && salons.length > 0) {
                                 const cardsHtml = await displaySalonCards(salons);
                                 const cardsDiv = document.createElement('div');
                                 cardsDiv.className = 'message ai';
                                 cardsDiv.innerHTML = `
                                     <div class="message-avatar">
                                         <img src="/images/Saloony_logo.png" alt="صالوني" style="width: 28px; height: 28px; object-fit: contain;">
                                     </div>
                                     <div class="message-content">
                                         ${cardsHtml}
                                     </div>
                                 `;
                                 messagesContainer.appendChild(cardsDiv);
                                 scrollToBottom();
                             }
                         } catch (error) {
                             console.error('Error displaying salon cards:', error);
                         }
                     }, 1000);
                 }
             }
            
            conversationHistory.push({
                content: content,
                sender: sender,
                timestamp: now.toISOString()
            });

            // Save conversation to localStorage
            saveConversationToStorage();

            scrollToBottom();
        }

        // Save conversation to localStorage
        function saveConversationToStorage() {
            try {
                localStorage.setItem('ai_conversation_history', JSON.stringify(conversationHistory));
            } catch (error) {
                console.warn('Failed to save conversation:', error);
            }
        }

        // Restore conversation UI from saved history
        function restoreConversationUI() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = ''; // Clear existing messages
            
            conversationHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                
                const timestamp = new Date(msg.timestamp);
                const timeString = timestamp.toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const avatarContent = msg.sender === 'user' 
                    ? '<i class="fas fa-user"></i>' 
                    : '<img src="/images/Saloony_logo.png" alt="صالوني" style="width: 28px; height: 28px; object-fit: contain;">';

                // Enhanced content processing (same as addMessage)
                let processedContent = formatAIMessage(msg.content);

                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        ${avatarContent}
                    </div>
                    <div class="message-content">
                        ${processedContent}
                        <div class="message-time">${timeString}</div>
                    </div>
                `;

                messagesContainer.appendChild(messageDiv);
            });
            
            scrollToBottom();
        }

        // Quick reply functions
        function sendQuickReply(message) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;
            sendMessage();
        }

        function showContextualQuickReplies(aiResponse) {
            // Quick replies disabled - function disabled to prevent overlap with AI responses
            return; // Early return to disable all quick reply functionality
            
            const quickReplies = document.getElementById('quickReplies');
            const lowerResponse = aiResponse.toLowerCase();
            
            let replies = [];
            
            // Smart suggestions based on AI response content
            if (lowerResponse.includes('صالونات') || lowerResponse.includes('الصالونات')) {
                replies = ['أريد حجز موعد', 'ما الأسعار؟', 'أين الموقع؟'];
            } else if (lowerResponse.includes('شعر') || lowerResponse.includes('قصة') || lowerResponse.includes('قصات')) {
                replies = ['أريد رؤية أمثلة', 'ما الأنسب لوجهي؟', 'شو في صالونات'];
            } else if (lowerResponse.includes('بشرة') || lowerResponse.includes('عناية')) {
                replies = ['مشاكل البشرة', 'روتين يومي', 'منتجات مناسبة'];
            } else if (lowerResponse.includes('منتجات') || lowerResponse.includes('كريم') || lowerResponse.includes('شامبو')) {
                replies = ['أين أجدها؟', 'كم السعر؟', 'بدائل أخرى'];
            } else if (lowerResponse.includes('نصائح') || lowerResponse.includes('أنصحك')) {
                replies = ['شكراً', 'معلومات أكثر', 'شو في صالونات'];
            } else {
                // Default suggestions
                replies = ['أريد رؤية أمثلة', 'ما الأنسب لوجهي؟', 'شو في صالونات'];
            }

            quickReplies.innerHTML = replies.map(reply => 
                `<button class="quick-reply" onclick="sendQuickReply('${reply}')">${reply}</button>`
            ).join('');
            
            quickReplies.style.display = 'flex';
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                quickReplies.style.display = 'none';
            }, 15000);
        }

        // UI Helper functions
        function hideWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
        }

        function hideQuickReplies() {
            const quickReplies = document.getElementById('quickReplies');
            quickReplies.style.display = 'none';
        }

        function showTypingIndicator() {
            isTyping = true;
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Remove existing typing indicator if any
            const existingIndicator = document.getElementById('typingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Create new typing indicator and append to messages container
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator show';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <img src="/images/Saloony_logo.png" alt="صالوني" style="width: 28px; height: 28px; object-fit: contain;">
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            updateStatus('يكتب...');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
            updateStatus(currentLanguage === 'ar' ? 'مستشار الجمال الذكي' : 'Smart Beauty Consultant');
        }

        function updateStatus(status) {
            document.getElementById('status-text').textContent = status;
        }

        // Action functions
        function goBack() {
            // Always go to home section to avoid navigation issues
            const homeUrl = currentUser?.user_type === 'salon' ? '/home_salon.html' : '/home_user.html?view=home';
            window.location.href = homeUrl;
        }

        async function clearChat() {
            if (confirm('هل تريد مسح المحادثة؟')) {
                try {
                    const userId = currentUser?.userId || currentUser?.id || currentUser?.user_id;
                    if (userId) {
                        await fetch('/api/ai-chat/clear', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: userId })
                        });
                    }

                    conversationHistory = [];
                    
                    // Clear conversation from localStorage
                    localStorage.removeItem('ai_conversation_history');
                    
                    const messagesContainer = document.getElementById('messagesContainer');
                    messagesContainer.innerHTML = '';
                    
                    // Re-add welcome message and typing indicator
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'welcome-message';
                    welcomeDiv.id = 'welcomeMessage';
                    welcomeDiv.innerHTML = `
                        <div class="welcome-icon"><i class="fas fa-sparkles"></i></div>
                        <h2>مرحباً بك! 😊</h2>
                        <p>أنا نوڤا، مساعد الجمال الذكي. أسعد بمساعدتك في كل ما يخص الجمال والعناية. كيف يمكنني مساعدتك اليوم؟</p>
                    `;
                    messagesContainer.appendChild(welcomeDiv);
                    
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.id = 'typingIndicator';
                    typingDiv.innerHTML = `
                        <div class="message-avatar">
                            <img src="/images/Saloony_logo.png" alt="صالوني" style="width: 28px; height: 28px; object-fit: contain;">
                        </div>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    `;
                    messagesContainer.appendChild(typingDiv);
                    
                    updateWelcomeMessage();
                    
                    // Quick replies disabled - commented out to prevent overlap with AI responses
                    // const quickReplies = document.getElementById('quickReplies');
                    // quickReplies.innerHTML = `
                    //     <button class="quick-reply" onclick="sendQuickReply('أريد قصة شعر جديدة')">قصة شعر جديدة</button>
                    //     <button class="quick-reply" onclick="sendQuickReply('نصائح للعناية بالبشرة')">العناية بالبشرة</button>
                    //     <button class="quick-reply" onclick="sendQuickReply('أريد حجز موعد')">حجز موعد</button>
                    //     <button class="quick-reply" onclick="sendQuickReply('ألوان مناسبة لي')">ألوان مناسبة</button>
                    // `;
                    // quickReplies.style.display = 'flex';
                    
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            }
        }

        // --- DYNAMIC SUGGESTIONS SYSTEM --- (DISABLED)
        function updateDynamicSuggestions(aiResponse, userMessage) {
            // Quick replies disabled - function disabled to prevent overlap with AI responses
            return; // Early return to disable all quick reply functionality
            
            const quickReplies = document.getElementById('quickReplies');
            if (!quickReplies) return;
            
            // Define suggestion categories based on keywords and context
            const suggestionCategories = {
                haircut: ['قصة شعر أخرى؟', 'نصائح للعناية بالشعر', 'ألوان شعر مناسبة', 'تسريحات مختلفة'],
                skincare: ['منتجات للبشرة', 'روتين يومي للعناية', 'علاج مشاكل البشرة', 'نصائح طبيعية'],
                booking: ['تأكيد الموعد', 'تغيير الموعد', 'خدمات إضافية', 'معلومات الصالون'],
                colors: ['ألوان أخرى', 'نصائح للصبغة', 'العناية بالشعر المصبوغ', 'تدرجات مناسبة'],
                makeup: ['مكياج مناسب', 'منتجات مكياج', 'تطبيق المكياج', 'إزالة المكياج'],
                nails: ['تصاميم أظافر', 'العناية بالأظافر', 'ألوان مناكير', 'أظافر صحية'],
                general: ['خدمات أخرى', 'نصائح جمال', 'أسعار الخدمات', 'حجز موعد']
            };
            
            // Analyze the conversation to determine context
            let category = 'general';
            const combinedText = (aiResponse + ' ' + userMessage).toLowerCase();
            
            if (combinedText.includes('شعر') || combinedText.includes('قص') || combinedText.includes('تسريح')) {
                category = 'haircut';
            } else if (combinedText.includes('بشرة') || combinedText.includes('وجه') || combinedText.includes('عناية')) {
                category = 'skincare';
            } else if (combinedText.includes('موعد') || combinedText.includes('حجز') || combinedText.includes('صالون')) {
                category = 'booking';
            } else if (combinedText.includes('لون') || combinedText.includes('صبغ') || combinedText.includes('تلوين')) {
                category = 'colors';
            } else if (combinedText.includes('مكياج') || combinedText.includes('ميك اب')) {
                category = 'makeup';
            } else if (combinedText.includes('أظافر') || combinedText.includes('مناكير')) {
                category = 'nails';
            }
            
            // Get suggestions for the determined category
            const suggestions = suggestionCategories[category];
            
            // Update the quick replies with contextual suggestions
            quickReplies.innerHTML = suggestions.map(suggestion => 
                `<button class="quick-reply" onclick="sendQuickReply('${suggestion}')">${suggestion}</button>`
            ).join('');
            
            // Show the quick replies with a smooth animation
            quickReplies.style.display = 'flex';
            quickReplies.style.opacity = '0';
            setTimeout(() => {
                quickReplies.style.opacity = '1';
            }, 100);
        }

        // --- LANGUAGE TOGGLE FIX ---
        function toggleLanguage(toggle = true) {
            const messageInput = document.getElementById('messageInput');
            
            if (toggle) {
                currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            }
            
            // Set base direction and language
            if (currentLanguage === 'en') {
                document.documentElement.lang = 'en';
                document.documentElement.dir = 'ltr';
                messageInput.placeholder = 'Type your message here...';
                updateStatus('Smart Beauty Consultant');
                showToast('Language switched to English', true);
            } else {
                document.documentElement.lang = 'ar';
                document.documentElement.dir = 'rtl';
                messageInput.placeholder = 'اكتب رسالتك هنا...';
                updateStatus('مستشار الجمال الذكي');
                if (toggle) { // Only show toast if explicitly toggled
                     showToast('تم تحويل اللغة إلى العربية', true);
                }
            }
            
            // Apply new direction to input field, resetting alignment
            handleDirectionChange(messageInput);
            
            // Save preference locally
            localStorage.setItem('chat_language', currentLanguage);
        }
        // --- END LANGUAGE TOGGLE FIX ---

        function initializeUserData() {
            try {
                let userData = localStorage.getItem('salonni_user') || localStorage.getItem('currentUser');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    currentUser.userId = currentUser.userId || currentUser.id || currentUser.user_id;
                }
            } catch (error) {
                console.warn('Failed to load user data:', error);
            }
        }

        initializeUserData();

        // Salon Cards Functions
        function generateSkeletonCards(count = 3) {
            const skeletonCards = Array(count).fill().map(() => `
                <div class="salon-card skeleton-card">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-text medium"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text medium"></div>
                        <div class="skeleton-buttons">
                            <div class="skeleton-button"></div>
                            <div class="skeleton-button"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            return `<div class="salon-cards-container">${skeletonCards}</div>`;
        }

        async function displaySalonCards(salons) {
            if (!salons || salons.length === 0) {
                return '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">لا توجد صالونات متاحة في منطقتك حالياً.</p>';
            }

            // Filter out already shown salons
            const newSalons = salons.filter(salon => {
                const salonId = salon.id || salon.salonId;
                return !shownSalons.has(salonId);
            });

            // If no new salons, show a message
            if (newSalons.length === 0) {
                return '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">تم عرض جميع الصالونات المتاحة في منطقتك.</p>';
            }

            // Limit to 3 salons at a time
            const salonsToShow = newSalons.slice(0, 3);
            
            // Add shown salon IDs to the set
            salonsToShow.forEach(salon => {
                const salonId = salon.id || salon.salonId;
                shownSalons.add(salonId);
            });

            const cardsHtml = salonsToShow.map(salon => `
                <div class="salon-card">
                    <div class="salon-card-image">
                        ${salon.image_url && !salon.image_url.includes('placehold.co') ? 
                            `<img src="${salon.image_url}" alt="${salon.salon_name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-cut\\'></i>';">` :
                            `<i class="fas fa-cut"></i>`
                        }
                    </div>
                    <div class="salon-card-content">
                        <div class="salon-card-header">
                            <h3 class="salon-card-title">${salon.salon_name}</h3>
                            ${salon.is_featured ? '<div class="salon-card-badge">مميز</div>' : ''}
                        </div>
                        <div class="salon-card-info">
                            <div class="salon-card-info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${salon.city}</span>
                            </div>
                            <div class="salon-card-info-item">
                                <i class="fas fa-location-dot"></i>
                                <span>${salon.address || 'العنوان غير متوفر'}</span>
                            </div>
                            <div class="salon-card-info-item">
                                ${salon.avg_rating && salon.avg_rating > 0 ? 
                                    `<div class="salon-card-rating">
                                        <i class="fas fa-star"></i>
                                        ${parseFloat(salon.avg_rating).toFixed(1)} (${salon.review_count || 0} تقييم)
                                    </div>` :
                                    `<div class="salon-card-rating">
                                        <i class="fas fa-star"></i>
                                        جديد
                                    </div>`
                                }
                            </div>
                        </div>
                        <div class="salon-card-actions">
                            <button class="salon-card-btn secondary" onclick="showSalonDetails(${salon.id || salon.salonId})">
                                <i class="fas fa-info-circle"></i>
                                <span>التفاصيل</span>
                            </button>
                            <a href="/salon/${salon.id || salon.salonId}" class="salon-card-btn primary">
                                <i class="fas fa-calendar-check"></i>
                                <span>احجز الآن</span>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');

            return `<div class="salon-cards-container">${cardsHtml}</div>`;
        }

        async function fetchSalonsForUser() {
            try {
                const userCity = currentUser?.city || 'رام الله';
                const userGender = currentUser?.gender || 'male';
                
                const response = await fetch(`/api/discovery/${encodeURIComponent(userCity)}/${userGender}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const allSalons = [
                        ...(data.citySalons || []),
                        ...(data.featuredSalons || [])
                    ];
                    
                    const uniqueSalons = allSalons.filter((salon, index, self) => 
                        index === self.findIndex(s => (s.id || s.salonId) === (salon.id || salon.salonId))
                    );
                    
                    return uniqueSalons;
                } else {
                    console.warn('Failed to fetch salons:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching salons:', error);
                return [];
            }
        }

        // --- AI LEARNING: User Interaction Tracking ---
        let userInteractions = JSON.parse(localStorage.getItem('salonni_user_interactions') || '[]');
        
        function trackUserInteraction(type, data) {
            const interaction = {
                type: type, // 'salon_view', 'salon_book', 'service_interest', 'query_type'
                data: data,
                timestamp: new Date().toISOString(),
                userId: currentUser?.userId || 'anonymous'
            };
            
            userInteractions.push(interaction);
            
            // Keep only last 100 interactions to prevent storage bloat
            if (userInteractions.length > 100) {
                userInteractions = userInteractions.slice(-100);
            }
            
            localStorage.setItem('salonni_user_interactions', JSON.stringify(userInteractions));
            
            // Send to backend for AI learning
            sendInteractionToBackend(interaction);
        }
        
        async function sendInteractionToBackend(interaction) {
            try {
                if (!currentUser?.userId) return; // Skip if no user ID
                
                const response = await fetch('/api/ai-chat/learn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.userId,
                        interaction: interaction
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Interaction learned successfully:', result.message);
                } else {
                    console.warn('Failed to send interaction to backend:', response.status);
                }
            } catch (error) {
                console.warn('Error sending interaction to backend:', error);
            }
        }
        
        function getUserPreferences() {
            const interactions = userInteractions.slice(-50); // Last 50 interactions
            const preferences = {
                preferredServices: {},
                preferredCities: {},
                bookingPatterns: {},
                queryTypes: {}
            };
            
            interactions.forEach(interaction => {
                switch (interaction.type) {
                    case 'salon_view':
                    case 'salon_book':
                        if (interaction.data.city) {
                            preferences.preferredCities[interaction.data.city] = 
                                (preferences.preferredCities[interaction.data.city] || 0) + 1;
                        }
                        if (interaction.data.services) {
                            interaction.data.services.forEach(service => {
                                preferences.preferredServices[service] = 
                                    (preferences.preferredServices[service] || 0) + 1;
                            });
                        }
                        break;
                    case 'service_interest':
                        preferences.preferredServices[interaction.data.service] = 
                            (preferences.preferredServices[interaction.data.service] || 0) + 2; // Higher weight
                        break;
                    case 'query_type':
                        preferences.queryTypes[interaction.data.queryType] = 
                            (preferences.queryTypes[interaction.data.queryType] || 0) + 1;
                        break;
                }
            });
            
            return preferences;
        }

        async function showSalonDetails(salonId) {
            if (!salonId) return;

            try {
                const response = await fetch(`/api/salon/details/${salonId}`);
                if (!response.ok) throw new Error('Failed to fetch salon details');
                
                const data = await response.json();
                if (!data.success) throw new Error('Salon not found');
                
                const salon = data.salon;
                
                // Track user interaction
                trackUserInteraction('salon_view', {
                    salonId: salonId,
                    salonName: salon.salon_name,
                    city: salon.city,
                    source: 'ai_chat'
                });
                
                const servicesResponse = await fetch(`/api/salons/${salonId}/services`);
                const servicesData = servicesResponse.ok ? await servicesResponse.json() : { services: [] };
                
                // Track service interests
                if (servicesData.services && servicesData.services.length > 0) {
                    servicesData.services.forEach(service => {
                        trackUserInteraction('service_interest', {
                            service: service.name_ar,
                            salonId: salonId,
                            price: service.price
                        });
                    });
                }
                
                const modalTitle = document.getElementById('salonModalTitle');
                const modalBody = document.getElementById('salonModalBody');
                
                modalTitle.textContent = salon.salon_name;
                
                const servicesHtml = servicesData.services && servicesData.services.length > 0 ?
                    `<div class="salon-services-list">
                        ${servicesData.services.map(service => `
                            <div class="salon-service-item">
                                <span class="salon-service-name">${service.name_ar}</span>
                                <span class="salon-service-price">${service.price ? parseFloat(service.price).toFixed(0) + ' ₪' : 'السعر عند الاستفسار'}</span>
                            </div>
                        `).join('')}
                    </div>` :
                    '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">لا توجد خدمات محددة</p>';
                
                modalBody.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">معلومات الصالون</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><i class="fas fa-location-dot"></i> ${salon.address || 'العنوان غير متوفر'}</p>
                        ${salon.salon_phone ? `<p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><i class="fas fa-phone"></i> ${salon.salon_phone}</p>` : ''}
                        ${salon.avg_rating && salon.avg_rating > 0 ? `<p style="color: #fbbf24; margin-bottom: 1rem;"><i class="fas fa-star"></i> ${parseFloat(salon.avg_rating).toFixed(1)} (${salon.review_count || 0} تقييم)</p>` : ''}
                    </div>
                    
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">الخدمات المتاحة</h4>
                        ${servicesHtml}
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <a href="/salon/${salonId}" class="salon-card-btn primary" style="display: inline-block; padding: 0.75rem 2rem;" onclick="trackBookingClick(${salonId}, '${salon.salon_name}', '${salon.city}')">
                            <i class="fas fa-calendar-check"></i> احجز موعد الآن
                        </a>
                    </div>
                `;
                
                document.getElementById('salonModal').classList.add('show');
                
            } catch (error) {
                console.error('Error showing salon details:', error);
                showToast('عذراً، حدث خطأ في تحميل تفاصيل الصالون', false);
            }
        }

        function trackBookingClick(salonId, salonName, city) {
            trackUserInteraction('salon_book', {
                salonId: salonId,
                salonName: salonName,
                city: city,
                source: 'ai_chat_modal'
            });
        }

        function closeSalonModal() {
            document.getElementById('salonModal').classList.remove('show');
        }

        // Close modal when clicking outside
        document.getElementById('salonModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSalonModal();
            }
        });

        // Theme Toggle Functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Add theme switching animation class
            document.body.classList.add('theme-switching');
            
            // Create ripple effect from theme button
            const themeButton = document.querySelector('.theme-toggle');
            if (themeButton) {
                const ripple = document.createElement('div');
                ripple.className = 'theme-ripple';
                ripple.style.cssText = `
                    position: fixed;
                    top: 50%;
                    right: 20px;
                    width: 20px;
                    height: 20px;
                    background: ${newTheme === 'dark' ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.8)'};
                    border-radius: 50%;
                    transform: translate(50%, -50%) scale(0);
                    animation: themeRipple 0.6s ease-out forwards;
                    pointer-events: none;
                    z-index: 9999;
                `;
                document.body.appendChild(ripple);
                
                // Remove ripple after animation
                setTimeout(() => {
                    if (ripple.parentNode) {
                        ripple.parentNode.removeChild(ripple);
                    }
                }, 600);
            }
            
            // Apply theme change with slight delay for smooth transition
            setTimeout(() => {
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update theme icon with animation
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.style.transform = 'scale(0.8) rotate(180deg)';
                    setTimeout(() => {
                        if (newTheme === 'dark') {
                            themeIcon.className = 'fas fa-sun';
                        } else {
                            themeIcon.className = 'fas fa-moon';
                        }
                        themeIcon.style.transform = 'scale(1) rotate(0deg)';
                    }, 150);
                }
                
                // Remove theme switching class after transition
                setTimeout(() => {
                    document.body.classList.remove('theme-switching');
                }, 300);
            }, 100);
        }

        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.getElementById('themeIcon');
            if (savedTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }

        // New Chat Modal Functions
        function showNewChatModal() {
            document.getElementById('newChatModal').classList.add('show');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('show');
        }

        function confirmNewChat() {
            clearChat();
            closeNewChatModal();
        }

        // Close new chat modal when clicking outside
        document.getElementById('newChatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewChatModal();
            }
        });

        // Initialize theme when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>
</body>
</html>