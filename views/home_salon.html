<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صالوني - لوحة تحكم الصالون</title>
    <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script>
        (function() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (!isStandalone) {
                window.location.replace('/index.html');
                return;
            }
            const token = localStorage.getItem('salonni_token');
            const userRaw = localStorage.getItem('salonni_user');
            const user = userRaw ? JSON.parse(userRaw) : null;
            if (!token || !user || user.user_type !== 'salon') {
                window.location.replace('/auth.html');
            }
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap');
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #F9FAFB; /* Very light gray */
            padding-bottom: 80px; /* Space for the fixed bottom navigation */
            position: relative;
            overflow-x: hidden;
        }
        
        /* Force navigation to stay at bottom */
        nav[style*="position: fixed"] {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            z-index: 99999 !important;
            transform: none !important;
        }
        /* New Uber-Inspired Colors */
        .bg-primary-dark { background-color: #1E293B; } /* Deep Charcoal Blue/Slate */
        .text-secondary { color: #06C167; } /* Vibrant Teal-Green Accent */
        .border-secondary { border-color: #06C167; }
        .bg-secondary { background-color: #06C167; } /* Secondary background */
        .bg-secondary-soft { background-color: rgba(6, 193, 103, 0.1); } /* Light transparent accent bg */
        
        .btn-action { 
            background-color: #06C167; 
            color: #1E293B; 
            transition: all 0.2s; 
            font-weight: 700; 
            box-shadow: 0 4px 10px rgba(6, 193, 103, 0.3);
        }
        .btn-action:hover { background-color: #05ae5d; }
        
        /* Custom scrollbar for web view */
        .scrollbar-hidden::-webkit-scrollbar { display: none; }
        .scrollbar-hidden { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Style for active nav item (Pill style) */
        .nav-active {
            color: #1E293B; /* Primary Dark */
            background-color: #06C167; /* Secondary Teal-Green */
            border-radius: 9999px; /* Full rounded pill */
            box-shadow: 0 2px 8px rgba(6, 193, 103, 0.5);
            padding: 8px 16px !important; /* Larger click area for active state */
        }
        .nav-item {
             padding: 4px 12px; /* Standard padding for inactive state */
        }

        /* RTL input fix for consistency */
        input[type="time"], input[type="number"], input[type="date"] { direction: ltr; }
        
        /* Style for selected closed days */
        .day-selected {
            background-color: #ef4444; /* red-500 */
            color: white;
            border-color: #ef4444;
        }
        /* Custom Message for empty states */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            text-align: center;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            margin-top: 20px;
        }
        .empty-state i {
            font-size: 2.5rem;
            color: #94A3B8; /* Slate gray */
            margin-bottom: 12px;
        }
        .empty-state p {
            color: #64748B; /* Slate gray text */
            font-weight: 500;
        }
        
        /* Enhanced body animation during pull */
        body.pulling {
            transform-origin: top center;
            transition: transform 0.1s ease-out;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pullBounce {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        
        /* Confirmation Modal Styles */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-open-overlay {
            display: flex !important;
            opacity: 1 !important;
        }
        .modal-content-confirm {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        /* Update Modal Styles */
        .update-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .update-modal.show {
            display: flex;
        }

        .update-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .update-modal.show .update-modal-content {
            transform: scale(1);
        }

        .update-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #06C167, #05ae5d);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: white;
            font-size: 24px;
        }

        .update-btn {
            background: linear-gradient(135deg, #06C167, #05ae5d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(6, 193, 103, 0.3);
            width: 100%;
        }

        .update-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(6, 193, 103, 0.4);
        }
    </style>
</head>
<body>



<div class="min-h-screen flex flex-col">
    <header id="app-header" class="bg-primary-dark shadow-lg p-2 flex justify-between items-center w-full z-20">
        <div class="flex items-center pl-8 pr-4">
            <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1E293B/ffffff?text=LOGO';" alt="شعار صالوني" class="w-12 h-12 object-contain object-center scale-[2.5]">
        </div>
        <div class="flex items-center">
            <button id="logout-btn" class="text-white/80 hover:text-red-400 transition duration-150 p-2 rounded-lg hover:bg-white/10">
                <i class="fas fa-sign-out-alt text-lg"></i>
            </button>
        </div>
    </header>
    
    <main class="flex-grow p-4 pt-[60px] md:p-8">
        <div id="message-box" class="hidden p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto" role="alert"></div>
        <div class="max-w-6xl mx-auto space-y-8">
            
            <div id="appointments-view" class="view-content">
                <section class="bg-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3 text-center">
                        <span class="inline-flex items-center justify-center gap-2">
                            <i class="fas fa-clipboard-list"></i>
                            المواعيد
                            <span id="appointments-count" class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold rounded-full bg-secondary text-white hidden">0</span>
                        </span>
                        <button id="refresh-appointments-btn" class="ml-3 px-3 py-1 text-sm rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-700 inline-flex items-center gap-2" title="تحديث المواعيد">
                            <i class="fas fa-sync-alt"></i>
                            تحديث
                        </button>
                    </h2>
                    <div class="flex space-x-2 space-x-reverse mb-4 border-b pb-2">
                        <button class="tab-appointments px-3 py-1 font-bold text-sm rounded-xl text-white bg-primary-dark transition-all" data-filter="today">اليوم</button>
                        <button class="tab-appointments px-3 py-1 text-sm rounded-xl text-gray-500 bg-gray-200 hover:bg-gray-300 transition-all" data-filter="completed">المكتملة</button>
                        <button class="tab-appointments px-3 py-1 text-sm rounded-xl text-gray-500 bg-gray-200 hover:bg-gray-300 transition-all" data-filter="upcoming">القادمة</button>
                        <button class="tab-appointments px-3 py-1 text-sm rounded-xl text-gray-500 bg-gray-200 hover:bg-gray-300 transition-all" data-filter="cancelled">الملغاة</button>
                    </div>

                    <div id="appointments-list-container" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">جاري تحميل المواعيد...</p>
                    </div>
                </section>
            </div>
            
            <div id="management-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b pb-2 text-center">
                    <span class="inline-flex items-center justify-center gap-2">
                        <i class="fas fa-calendar-alt"></i>
                        إدارة الصالون والجدول
                    </span>
                </h2>

                <section class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                    <h3 class="text-xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3">إدارة فريق العمل</h3>
                    <form id="add-staff-form" class="flex gap-4 mb-6">
                        <input type="text" id="staff-name-input" placeholder="اسم الموظف/الحلاق" required class="flex-grow p-3 border border-gray-300 rounded-xl text-right">
                        <button type="submit" class="btn-action px-6 py-2 rounded-xl font-bold flex-shrink-0">
                            <i class="fas fa-user-plus ml-1"></i> إضافة
                        </button>
                    </form>
                    <div id="staff-list-container" class="space-y-3">
                        <p class="text-gray-500 text-sm">سيظهر أعضاء الفريق هنا.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                    <h3 class="text-xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3">أوقات العمل الأساسية</h3>
                    
                    <form id="schedule-form" class="space-y-4 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">وقت الفتح (لكل الأيام)</label>
                                <input type="time" id="opening-time-input" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">وقت الإغلاق (لكل الأيام)</label>
                                <input type="time" id="closing-time-input" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Hours Display -->
                        <div id="hours-display" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                            <span class="text-sm text-blue-700 font-medium">
                                <i class="fas fa-clock ml-1"></i>
                                ساعات العمل: <span id="hours-count">0</span> ساعة
                            </span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">أيام العطلة الأسبوعية (اضغط للتحديد)</label>
                            <div id="closed-days-container" class="flex flex-wrap gap-2 text-sm">
                                </div>
                        </div>

                        <button type="submit" class="btn-action w-full py-3 rounded-xl font-bold mt-4">
                            <i class="fas fa-save ml-1"></i> حفظ أوقات العمل
                        </button>
                    </form>

                    <h4 class="text-lg font-bold text-primary-dark mt-8 mb-4 border-r-4 border-gray-400 pr-3">إضافة فترات استراحة (روتينية)</h4>
                    <form id="add-break-form" class="space-y-4 p-4 border border-gray-200 rounded-xl">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">بداية الاستراحة</label>
                                <input type="time" id="break-start-input" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">نهاية الاستراحة</label>
                                <input type="time" id="break-end-input" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">سبب الاستراحة (اختياري)</label>
                            <input type="text" id="break-reason-input" placeholder="مثال: فطور" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">تنطبق على:</label>
                            <select id="break-staff-select" class="w-full p-3 border border-gray-300 rounded-lg appearance-none text-right">
                                <option value="all">جميع العاملين</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-action w-full py-3 rounded-xl font-bold">
                            <i class="fas fa-pause-circle ml-1"></i> إضافة استراحة روتينية
                        </button>
                    </form>

                    <h4 class="text-lg font-bold text-primary-dark mt-8 mb-4 border-r-4 border-gray-400 pr-3">الاستراحات الروتينية المضافة</h4>
                    <div id="breaks-list-container" class="space-y-3">
                        </div>

                </section>
                
                <section class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                    <h3 class="text-xl font-bold text-primary-dark mb-4 border-r-4 border-red-500 pr-3">تعديلات الجدول المخصصة (إجازات/تعديلات مؤقتة)</h3>

                    <form id="add-modification-form" class="space-y-4 p-4 border border-gray-200 rounded-xl">
                        
                        <div class="flex space-x-4 space-x-reverse">
                            <label class="flex items-center text-gray-700 font-medium">
                                <input type="radio" name="mod_type" value="once" checked class="h-4 w-4 text-red-600 focus:ring-red-500 ml-2 mod-type-radio">
                                تعديل لمرة واحدة (تاريخ محدد)
                            </label>
                            <label class="flex items-center text-gray-700 font-medium">
                                <input type="radio" name="mod_type" value="recurring" class="h-4 w-4 text-red-600 focus:ring-red-500 ml-2 mod-type-radio">
                                تعديل متكرر (يوم أسبوع محدد)
                            </label>
                        </div>

                        <div id="once-mod-fields" class="space-y-4 border-t pt-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700">التاريخ</label>
                                <input type="date" id="mod-date-input" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>

                        <div id="recurring-mod-fields" class="space-y-4 hidden border-t pt-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700">يوم الأسبوع</label>
                                <select id="mod-day-index-select" class="w-full p-3 border border-gray-300 rounded-lg appearance-none text-right">
                                    </select>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="flex items-center text-gray-700 font-medium">
                                <input type="checkbox" id="mod-is-closed" class="h-4 w-4 text-red-600 focus:ring-red-500 ml-2">
                                إغلاق اليوم كاملاً
                            </label>
                        </div>

                        <div id="mod-time-fields" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">إغلاق من</label>
                                <input type="time" id="mod-start-time-input" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">إلى</label>
                                <input type="time" id="mod-end-time-input" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">تنطبق على:</label>
                            <select id="mod-staff-select" class="w-full p-3 border border-gray-300 rounded-lg appearance-none text-right">
                                <option value="all">جميع العاملين</option>
                            </select>
                        </div>
                        
                        <div class="relative">
                            <input type="text" id="mod-reason-input" placeholder="السبب (مثال: إجازة العيد)" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                            <i class="fas fa-tag text-lg text-primary-dark absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                        </div>

                        <button type="submit" class="btn-action w-full py-3 rounded-xl font-bold bg-red-600 hover:bg-red-700 text-white">
                            <i class="fas fa-calendar-times ml-1"></i> إضافة تعديل مؤقت
                        </button>
                    </form>

                    <h4 class="text-lg font-bold text-primary-dark mt-8 mb-4 border-b pb-2">التعديلات المضافة</h4>
                    <div id="modifications-list-container" class="space-y-3">
                        </div>
                </section>

            </div>
            
                    <div id="salon-view" class="view-content">
                        <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b pb-2 text-center">
                            <span class="inline-flex items-center justify-center gap-2">
                                <i class="fas fa-store"></i>
                                ملف الصالون والخدمات
                            </span>
                        </h2>

                        <section class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-primary-dark border-r-4 border-secondary pr-3">المعلومات الأساسية</h3>
                                <div class="flex gap-2">
                                    <button id="btn-edit-info" type="button" class="px-3 py-2 rounded-lg bg-primary text-white hover:bg-primary-dark inline-flex items-center">
                                        <i class="fas fa-edit ml-1"></i> تعديل
                                    </button>
                                    <button id="btn-cancel-edit" type="button" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 hidden">
                                        إلغاء
                                    </button>
                                </div>
                            </div>

                            <!-- Edit Image Modal -->
                            <div id="edit-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden">
                                <div class="max-w-md mx-auto bg-white rounded-2xl shadow-2xl mt-24 p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-primary-dark">تعديل صورة الصالون</h4>
                                        <button id="modal-close-btn" class="text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <form id="modal-salon-info-form" class="space-y-4">
                                        <!-- Salon Image Upload -->
                                        <div class="relative">
                                            <label class="block text-sm font-medium text-gray-700 mb-2 text-right">صورة الصالون</label>
                                            <div class="flex items-center space-x-4 space-x-reverse">
                                                <div class="flex-1">
                                                    <input type="file" id="modal-info-salon-image" accept="image/*" class="w-full p-3 border border-gray-300 rounded-xl">
                                                </div>
                                                <div id="modal-image-preview-container" class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-gray-50">
                                                    <img id="modal-image-preview" class="w-full h-full object-cover rounded-xl hidden" alt="معاينة الصورة" loading="lazy" decoding="async">
                                                    <i class="fas fa-image text-gray-400 text-2xl" id="modal-image-placeholder"></i>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1 text-right">اختر صورة جديدة للصالون (اختياري)</p>
                                        </div>
                                        <div class="flex gap-3 pt-2">
                                            <button type="button" id="modal-cancel-btn" class="flex-1 px-4 py-3 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold">
                                                <i class="fas fa-times ml-1"></i> إلغاء
                                            </button>
                                            <button type="submit" id="modal-save-btn" class="flex-1 px-4 py-3 rounded-xl bg-primary text-white hover:bg-primary-dark font-bold">
                                                <i class="fas fa-save ml-1"></i> حفظ الصورة
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Editable Display -->
                            <div id="salon-info-display" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Editable Salon Name -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">اسم الصالون</span>
                            <input type="text" id="editable-salon-name" class="font-bold text-primary-dark bg-transparent border-none outline-none text-right flex-1 ml-2 focus:bg-white focus:border focus:border-secondary focus:rounded px-2 py-1" placeholder="اسم الصالون">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">اسم المالك</span>
                            <span id="disp-owner-name" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">هاتف الصالون</span>
                            <span id="disp-salon-phone" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">هاتف المالك</span>
                            <span id="disp-owner-phone" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl md:col-span-2">
                            <span class="text-gray-600">العنوان</span>
                            <span id="disp-address" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">المدينة</span>
                            <span id="disp-city" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">الفئة</span>
                            <span id="disp-gender-focus" class="font-bold text-primary-dark">...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600">حالة الصالون</span>
                            <span id="disp-status" class="font-bold text-primary-dark">...</span>
                        </div>
                        <!-- Editable Profile Picture -->
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl md:col-span-2">
                            <div class="relative w-20 h-20 border rounded-xl overflow-hidden bg-gray-100 cursor-pointer hover:opacity-80 transition-opacity" onclick="document.getElementById('editable-profile-image').click()">
                                <img id="editable-profile-img" class="w-full h-full object-cover" src="https://placehold.co/80x80/ccc/333?text=S" alt="Salon Image" loading="lazy" decoding="async" width="80" height="80">
                                <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all flex items-center justify-center">
                                    <i class="fas fa-camera text-white opacity-0 hover:opacity-100 transition-opacity"></i>
                                </div>
                            </div>
                            <input type="file" id="editable-profile-image" accept="image/*" class="hidden">
                            <span class="text-gray-600">صورة الصالون (اضغط للتغيير)</span>
                        </div>
                    </div>
                    
                    <!-- Save Button (Hidden by default, shown when changes are made) -->
                    <div id="profile-save-container" class="hidden mb-4">
                        <button id="save-profile-changes" class="btn-action w-full py-3 rounded-xl font-bold">
                            <i class="fas fa-save ml-1"></i> حفظ التغييرات
                        </button>
                        <!-- Inline message shown under the button -->
                        <div id="profile-save-message" class="hidden mt-2 text-center"></div>
                    </div>

                    <form id="salon-info-form" class="space-y-4 hidden" enctype="multipart/form-data">
                        <div class="relative">
                            <input type="text" id="info-salon-name" placeholder="اسم الصالون" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                        </div>
                        
                        <!-- Salon Image Upload -->
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-2 text-right">صورة الصالون <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <div class="flex-1">
                                    <input type="file" id="info-salon-image" accept="image/*" class="w-full p-3 border border-gray-300 rounded-xl">
                                </div>
                                <div id="image-preview-container" class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-gray-50">
                    <img id="image-preview" class="w-full h-full object-cover rounded-xl hidden" alt="معاينة الصورة" loading="lazy" decoding="async">
                                    <i class="fas fa-image text-gray-400 text-2xl" id="image-placeholder"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-right">اختر صورة للصالون (مطلوب عند التسجيل، اختياري للتحديث)</p>
                            <!-- Centered Edit Trigger Below Image -->
                            <div class="mt-4 flex justify-center">
                                <button id="btn-edit-info-centered" type="button" class="px-4 py-2 rounded-xl bg-primary text-white hover:bg-primary-dark inline-flex items-center shadow">
                                    <i class="fas fa-edit ml-2"></i>
                                    تعديل معلومات الصالون
                                </button>
                            </div>
                        </div>
                         <div class="relative">
                            <input type="text" id="info-owner-name" placeholder="اسم المالك" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                        </div>
                        <div class="relative">
                            <input type="tel" id="info-salon-phone" placeholder="هاتف الصالون" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                        </div>
                        <!-- FIX: ADD MISSING OWNER PHONE INPUT -->
                        <div class="relative">
                            <input type="tel" id="info-owner-phone" placeholder="هاتف المالك" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                        </div>
                        <!-- END FIX -->
                        <div class="relative">
                            <input type="text" id="info-address" placeholder="العنوان" required class="w-full p-3 border border-gray-300 rounded-xl text-right">
                        </div>
                        <div class="relative">
                            <select id="info-city" required class="w-full p-3 border border-gray-300 rounded-xl appearance-none text-right">
                                </select>
                        </div>
                        <div class="relative">
                            <select id="info-gender-focus" required class="w-full p-3 border border-gray-300 rounded-xl appearance-none text-right">
                                <option value="men">رجال</option>
                                <option value="women">نساء</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-action w-full py-3 rounded-xl font-bold mt-4">
                            <i class="fas fa-sync-alt ml-1"></i> تحديث المعلومات الأساسية
                        </button>
                    </form>
                </section>


                <section class="bg-white p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3 text-center">
                        <span class="inline-flex items-center justify-center gap-2">
                            <i class="fas fa-scissors"></i>
                            إدارة خدمات الصالون
                        </span>
                    </h3>
                    <p class="text-gray-500 mb-6 border-r-4 border-secondary pr-3">اختر الخدمات التي تقدمها، ثم حدد السعر والوقت اللازم لكل خدمة.</p>
                    
                    <!-- Add Service Manually Button -->
                    <div class="mb-6 text-center">
                        <button id="add-manual-service-btn" class="bg-gradient-to-r from-secondary to-orange-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 transform hover:scale-105 relative z-10" style="background: linear-gradient(to right, #06C167, #f97316) !important; color: white !important; display: inline-block !important; visibility: visible !important;">
                            <i class="fas fa-plus-circle ml-2"></i>
                            لم تجد خدمتك؟ أضفها يدوياً
                        </button>
                    </div>
                    
                    <div id="services-list-container" class="space-y-4">
                        <p class="text-gray-500 text-center py-4">جاري تحميل قائمة الخدمات...</p>
                    </div>

                    <!-- Auto-save enabled: remove manual save button -->
                    <div id="services-message" class="mt-4 text-center font-medium"></div>
                </section>
            </div>

            <!-- Reviews View -->
            <div id="reviews-view" class="view-content hidden">
                <section class="bg-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3 text-center">
                        <span class="inline-flex items-center justify-center gap-2">
                            <i class="fas fa-star"></i>
                            مراجعات الصالون
                        </span>
                    </h2>
                    <div id="reviews-loading" class="text-gray-500 text-center py-4 hidden">جاري تحميل المراجعات...</div>
                    <div id="reviews-empty" class="text-gray-500 text-center py-4 hidden">لا توجد مراجعات حتى الآن.</div>
                    <div id="reviews-list" class="space-y-4"></div>
                </section>
            </div>
            
            <!-- Invoices View -->
            <div id="invoices-view" class="view-content hidden">
                <section class="bg-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-primary-dark mb-4 border-r-4 border-secondary pr-3 text-center">
                        <span class="inline-flex items-center justify-center gap-2">
                            <i class="fas fa-receipt"></i>
                            الفواتير والمدفوعات
                        </span>
                    </h2>
                    
                    <div id="invoices-loading" class="text-gray-500 text-center py-4 hidden">جاري تحميل الفواتير...</div>
                    <div id="invoices-empty" class="text-gray-500 text-center py-4 hidden">لا توجد فواتير حتى الآن.</div>
                    <div id="invoices-list" class="space-y-4"></div>
                </section>
            </div>
            
        </div>
    </main>
    
<nav class="bg-white border-t border-gray-200 p-1.5 pb-5 flex justify-around shadow-2xl" 
     style="position: fixed !important; 
            bottom: 0 !important; 
            left: 0 !important; 
            right: 0 !important; 
            width: 100vw !important; 
            z-index: 99999 !important;
            height: 70px !important;
            box-sizing: border-box !important;
            margin: 0 !important;
            transform: none !important;">
        <button id="nav-appointments" class="nav-item flex flex-col items-center p-2 transition-all duration-300 text-primary-dark nav-active" data-view="appointments-view">
            <i class="fas fa-clipboard-list text-lg"></i>
            <span class="text-xs font-medium mt-1">المواعيد</span>
        </button>
        <button id="nav-management" class="nav-item flex flex-col items-center p-2 transition-all duration-300 text-gray-500 hover:text-primary-dark" data-view="management-view">
            <i class="fas fa-calendar-alt text-lg"></i>
            <span class="text-xs font-medium mt-1">الإدارة</span>
        </button>
        <button id="nav-salon" class="nav-item flex flex-col items-center p-2 transition-all duration-300 text-gray-500 hover:text-primary-dark" data-view="salon-view">
            <i class="fas fa-store-alt text-lg"></i>
            <span class="text-xs font-medium mt-1">الصالون</span>
        </button>
        <button id="nav-reviews" class="nav-item flex flex-col items-center p-2 transition-all duration-300 text-gray-500 hover:text-primary-dark" data-view="reviews-view">
            <i class="fas fa-star text-lg"></i>
            <span class="text-xs font-medium mt-1">المراجعات</span>
        </button>
        <button id="nav-invoices" class="nav-item flex flex-col items-center p-2 transition-all duration-300 text-gray-500 hover:text-primary-dark" data-view="invoices-view">
            <i class="fas fa-receipt text-lg"></i>
            <span class="text-xs font-medium mt-1">الفواتير</span>
        </button>
    </nav>
</div>

<div id="confirm-modal-overlay" class="fixed inset-0 z-50 transition-opacity hidden">
    <div class="modal-content-confirm">
        <h3 class="text-xl font-bold text-primary-dark mb-4">تأكيد الإجراء</h3>
        <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
        <div class="flex justify-center space-x-4 space-x-reverse">
            <button id="confirm-modal-cancel" class="px-6 py-2 rounded-xl bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 transition">
                إلغاء
            </button>
            <button id="confirm-modal-confirm" class="px-6 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition">
                تأكيد الحذف
            </button>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div id="invoice-modal-overlay" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-start justify-center p-4 hidden overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full margin-auto max-h-calc(100vh - 4rem) overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex justify-between items-center mb-6 p-6">
            <h3 class="text-2xl font-bold text-primary-dark">تفاصيل الفاتورة</h3>
            <button onclick="hideInvoiceModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="px-6 pb-6 space-y-6">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-primary-light to-secondary-light rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-xl font-bold text-primary-dark mb-1">صالون الأناقة</h4>
                        <p class="text-primary-dark opacity-80" id="invoice-modal-number">رقم الفاتورة</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary-dark" id="invoice-amount">المبلغ</div>
                        <div class="text-sm text-primary-dark opacity-80" id="invoice-type">نوع الدفع</div>
                    </div>
                </div>
            </div>
            
            <!-- Status Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-info-circle text-primary-dark"></i>
                        <span class="font-medium text-gray-700">حالة الدفع</span>
                    </div>
                    <div id="invoice-status-container" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium">
                        <i id="invoice-status-icon"></i>
                        <span id="invoice-status-text">الحالة</span>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-credit-card text-primary-dark"></i>
                        <span class="font-medium text-gray-700">طريقة الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="invoice-method">طريقة الدفع</p>
                </div>
            </div>
            
            <!-- Date Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-calendar text-primary-dark"></i>
                        <span class="font-medium text-gray-700">تاريخ الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="invoice-date">التاريخ</p>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4" id="invoice-valid-container">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-clock text-primary-dark"></i>
                        <span class="font-medium text-gray-700">صالح حتى</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="invoice-valid-until">التاريخ</p>
                </div>
            </div>
            
            <!-- Description Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-4" id="invoice-description-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-file-text text-primary-dark"></i>
                    <span class="font-medium text-gray-700">الوصف</span>
                </div>
                <p class="text-gray-700 leading-relaxed" id="invoice-description">الوصف</p>
            </div>
            
            <!-- Admin Notes Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-4" id="invoice-notes-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-sticky-note text-primary-dark"></i>
                    <span class="font-medium text-gray-700">ملاحظات إدارية</span>
                </div>
                <p class="text-gray-700 leading-relaxed italic" id="invoice-notes">ملاحظات إدارية</p>
            </div>
            
            <!-- QR Code Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-qrcode text-primary-dark"></i>
                    <span class="font-medium text-gray-700">رمز QR للفاتورة</span>
                </div>
                <div class="text-center">
                    <div id="invoice-qr-code" class="flex justify-center mb-3">
                        <!-- QR code will be generated here -->
                    </div>
                    <p class="text-xs text-gray-600">يمكن للإدارة مسح هذا الرمز للوصول السريع للفاتورة</p>
                </div>
            </div>
            
            <!-- Close Button -->
            <div class="flex justify-end">
                <button onclick="hideInvoiceModal()" class="px-6 py-2 bg-primary-dark text-white rounded-xl font-bold hover:bg-primary-darker transition-colors">
                    إغلاق
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Salon home page scripts loaded. Initializing dashboard...');

    // --- State & Core Elements ---
    let currentSalon = JSON.parse(localStorage.getItem('salonni_user')) || {};
    console.log('Current salon data from localStorage:', currentSalon);

    // Automatic push subscription function for salons
    async function ensurePushSubscription() {
        try {
            // Check if we already registered push subscription in this session
            const sessionKey = 'push_subscription_registered_salon';
            if (sessionStorage.getItem(sessionKey)) {
                console.debug('Push subscription already registered this session');
                return true;
            }

            if (!('serviceWorker' in navigator)) return false;
            // Ensure SW registered
            const regExisting = await navigator.serviceWorker.getRegistration();
            if (!regExisting) {
                try { await navigator.serviceWorker.register('/service-worker.js'); } catch (e) {}
            }
            const reg = await navigator.serviceWorker.ready;

            // Request notification permission if not granted
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    try { await Notification.requestPermission(); } catch (e) {}
                }
                if (Notification.permission !== 'granted') {
                    // Permission denied or not granted; cannot subscribe for push
                    return false;
                }
            }

            // Fetch VAPID public key from server
            const pubRes = await fetch('/api/push/public-key');
            const { publicKey, success } = await pubRes.json();
            if (!success || !publicKey || publicKey.length < 30) {
                throw new Error('Invalid VAPID public key from server');
            }
            const vapidKey = publicKey;
            const toUint8Array = (base64String) => {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const raw = atob(base64);
                const output = new Uint8Array(raw.length);
                for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
                return output;
            };

            // Get or create subscription
            const existing = await reg.pushManager.getSubscription();
            const sub = existing || await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: toUint8Array(vapidKey) });

            // Persist to server with current salon id
            const body = {
                user_id: currentSalon?.userId || currentSalon?.id || null,
                salon_id: currentSalon?.salonId || null,
                subscription: sub.toJSON()
            };
            await fetch('/api/push/subscribe', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            });
            
            // Mark as registered for this session
            sessionStorage.setItem(sessionKey, 'true');
            console.debug('Salon push subscription saved for', { user_id: body.user_id, salon_id: body.salon_id });
            return true;
        } catch (e) {
            console.debug('ensurePushSubscription failed:', e);
            return false;
        }
    }
    
    // CRITICAL FIX: Ensure we get BOTH the user ID (for profile fetch) and the salon ID (for business logic)
    const userId = currentSalon.userId; // ID from users table
    const salonId = currentSalon.salonId; // ID from salons table (used for nearly all calls below)
    
    console.log('User ID being used:', userId);
    console.log('Salon ID being used:', salonId);
    
    // CRITICAL FIX: Session Check must rely on both IDs for a complete session
    if (!userId || !salonId) {
        console.error('No required user/salon ID found in localStorage. Redirecting to login.');
        window.location.href = '/auth.html';
        return;
    }

    // Automatically register for push notifications
    try {
        await ensurePushSubscription();
    } catch (e) {
        console.debug('Failed to register push subscription:', e);
    }
    let staffList = []; // Array to hold staff data
    const daysOfWeekNames = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];

    // --- DOM Element Variables (Consolidated) ---
    const messageBox = document.getElementById('message-box');
    const staffListContainer = document.getElementById('staff-list-container');
    const addStaffForm = document.getElementById('add-staff-form');
    const staffNameInput = document.getElementById('staff-name-input');
    const breakStaffSelect = document.getElementById('break-staff-select');
    
    // Schedule/Breaks
    const scheduleForm = document.getElementById('schedule-form');
    const openingTimeInput = document.getElementById('opening-time-input');
    const closingTimeInput = document.getElementById('closing-time-input');
    const closedDaysContainer = document.getElementById('closed-days-container');
    const addBreakForm = document.getElementById('add-break-form');
    const breakStartInput = document.getElementById('break-start-input');
    const breakEndInput = document.getElementById('break-end-input');
    const breakReasonInput = document.getElementById('break-reason-input');
    const breaksListContainer = document.getElementById('breaks-list-container');
    
    // Hours calculation functionality
    const hoursDisplay = document.getElementById('hours-display');
    
    function calculateAndDisplayHours() {
        const openingTime = openingTimeInput.value;
        const closingTime = closingTimeInput.value;
        
        if (openingTime && closingTime) {
            const openingMinutes = timeToMinutes(openingTime);
            const closingMinutes = timeToMinutes(closingTime);
            
            let totalMinutes;
            if (closingMinutes > openingMinutes) {
                // Same day (e.g., 9:00 AM to 6:00 PM)
                totalMinutes = closingMinutes - openingMinutes;
            } else {
                // Overnight (e.g., 10:00 PM to 2:00 AM)
                totalMinutes = (24 * 60) - openingMinutes + closingMinutes;
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (totalMinutes === 0) {
                hoursDisplay.innerHTML = '<p class="text-red-600 text-sm"><i class="fas fa-exclamation-triangle ml-1"></i>لا يمكن أن تكون ساعات العمل صفر</p>';
                hoursDisplay.classList.remove('hidden');
            } else {
                const hoursText = hours > 0 ? `${hours} ساعة` : '';
                const minutesText = minutes > 0 ? `${minutes} دقيقة` : '';
                const timeText = [hoursText, minutesText].filter(Boolean).join(' و ');
                
                hoursDisplay.innerHTML = `<p class="text-green-600 text-sm"><i class="fas fa-clock ml-1"></i>ساعات العمل: ${timeText}</p>`;
                hoursDisplay.classList.remove('hidden');
            }
        } else {
            hoursDisplay.classList.add('hidden');
        }
    }
    
    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    // Add event listeners for real-time calculation
    openingTimeInput.addEventListener('input', calculateAndDisplayHours);
    closingTimeInput.addEventListener('input', calculateAndDisplayHours);
    
    // Modifications 
    const addModificationForm = document.getElementById('add-modification-form');
    const modificationsListContainer = document.getElementById('modifications-list-container');
    const modStaffSelect = document.getElementById('mod-staff-select'); 
    const modDayIndexSelect = document.getElementById('mod-day-index-select');
    const modTypeRadios = document.querySelectorAll('.mod-type-radio');
    const onceModFields = document.getElementById('once-mod-fields');
    const recurringModFields = document.getElementById('recurring-mod-fields');
    const modIsClosedCheckbox = document.getElementById('mod-is-closed');
    const modTimeFields = document.getElementById('mod-time-fields');
    const modStartTimeInput = document.getElementById('mod-start-time-input');
    const modEndTimeInput = document.getElementById('mod-end-time-input');
    
    // Salon Info/Services
    const salonInfoForm = document.getElementById('salon-info-form');
    const infoSalonName = document.getElementById('info-salon-name');
    const infoOwnerName = document.getElementById('info-owner-name');
    const infoSalonPhone = document.getElementById('info-salon-phone');
    // FIXED: Get new owner phone input
    const infoOwnerPhone = document.getElementById('info-owner-phone');
    const infoAddress = document.getElementById('info-address');
    const infoCity = document.getElementById('info-city');
    const infoGenderFocus = document.getElementById('info-gender-focus');
    const servicesListContainer = document.getElementById('services-list-container');
    const saveServicesBtn = document.getElementById('save-services-btn');
    const servicesMessage = document.getElementById('services-message');
    // Readonly display and edit toggle elements (moved earlier to avoid TDZ)
    const salonInfoDisplay = document.getElementById('salon-info-display');
    const btnEditInfo = document.getElementById('btn-edit-info');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    
    // Confirmation Modal Elements
    const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
    const confirmModalMessage = document.getElementById('confirm-modal-message');
    const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');
    const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');

    // Edit Image Modal Elements
    const editInfoModal = document.getElementById('edit-info-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSalonInfoForm = document.getElementById('modal-salon-info-form');
    const modalInfoSalonImage = document.getElementById('modal-info-salon-image');
    const modalImagePreview = document.getElementById('modal-image-preview');
    const modalImagePlaceholder = document.getElementById('modal-image-placeholder');

    const openEditModal = () => {
        if (!editInfoModal) return;
        // Reset image input and preview
        modalInfoSalonImage.value = '';
        modalImagePreview.classList.add('hidden');
        modalImagePlaceholder.classList.remove('hidden');
        
        // Show current salon image if available
        if (currentSalon.image_url && !currentSalon.image_url.includes('placehold.co')) {
            modalImagePreview.src = currentSalon.image_url;
            modalImagePreview.classList.remove('hidden');
            modalImagePlaceholder.classList.add('hidden');
        }

        editInfoModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    };

    const closeEditModal = () => {
        if (!editInfoModal) return;
        editInfoModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    };

    // Hook buttons
    if (btnEditInfo) {
        btnEditInfo.addEventListener('click', openEditModal);
    }
    // New centered trigger under image input
    const btnEditInfoCentered = document.getElementById('btn-edit-info-centered');
    if (btnEditInfoCentered) {
        btnEditInfoCentered.addEventListener('click', openEditModal);
    }
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeEditModal);
    if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeEditModal);

    // Image preview functionality for modal
    if (modalInfoSalonImage) {
        modalInfoSalonImage.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const url = URL.createObjectURL(file);
                    modalImagePreview.src = url;
                    modalImagePreview.loading = 'lazy';
                    modalImagePreview.decoding = 'async';
                    modalImagePreview.classList.remove('hidden');
                    if (modalImagePlaceholder) modalImagePlaceholder.classList.add('hidden');
                } catch (error) {
                    console.error('Error generating image preview:', error);
                    showMessage(messageBox, 'خطأ في معالجة الصورة', false);
                }
            }
        });
    }

    // Submit handler: handle image upload only
    if (modalSalonInfoForm) {
        modalSalonInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const btn = e.submitter;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الحفظ';

                let imageUrl = currentSalon.image_url; // Keep existing image by default

                // Handle image upload if a new image is selected
                if (modalInfoSalonImage.files && modalInfoSalonImage.files[0]) {
                    try {
                        const formData = new FormData();
                        formData.append('image', modalInfoSalonImage.files[0]);
                        formData.append('salon_id', salonId);
                        const uploadResp = await fetch(`/api/upload?salon_id=${salonId}`, {
                            method: 'POST',
                            body: formData
                        });
                        const uploadJson = await uploadResp.json();
                        if (!uploadResp.ok || !uploadJson.success) {
                            throw new Error(uploadJson.message || 'فشل رفع الصورة');
                        }
                        imageUrl = uploadJson.image_url;
                    } catch (error) {
                        throw new Error('فشل في رفع الصورة');
                    }
                }

                // Update only the image
                const infoData = {
                    salon_name: currentSalon.salon_name,
                    owner_name: currentSalon.owner_name,
                    salon_phone: currentSalon.salon_phone,
                    owner_phone: currentSalon.owner_phone,
                    address: currentSalon.address,
                    city: currentSalon.city,
                    gender_focus: currentSalon.gender_focus,
                    image_url: imageUrl
                };

                const response = await fetch(`/api/salon/info/${salonId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(infoData),
                });
                const data = await response.json();
                if (data.success) {
                    await loadSalonInfo();
                    showMessage(messageBox, 'تم تحديث صورة الصالون بنجاح.', true);
                    closeEditModal();
                } else {
                    showMessage(messageBox, data.message || 'فشل تحديث الصورة.', false);
                }
            } catch (error) {
                console.error('Error saving image:', error);
                showMessage(messageBox, error.message || 'خطأ في الشبكة.', false);
            } finally {
                const submitBtn = modalSalonInfoForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save ml-1"></i> حفظ الصورة';
                }
            }
        });
    }


    // --- Utility Functions (Moved to Top) ---

    const showMessage = (element, message, isSuccess = true) => {
        element.classList.remove('hidden'); 
        element.textContent = message;
        element.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
        
        element.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'border-red-200', 'border-green-200');
        
        element.classList.add('border');
        element.classList.add(...(isSuccess ? ['bg-green-100', 'text-green-700', 'border-green-200'] : ['bg-red-100', 'text-red-700', 'border-red-200']));
        
        setTimeout(() => { element.classList.add('hidden'); }, 5000);
    };

    // --- PWA Notifications & Sound ---
    // Ensure service worker is registered (fallback if opened directly)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
            if (!reg) {
                navigator.serviceWorker.register('/service-worker.js').catch(() => {});
            }
        }).catch(() => {});

        // Register Push Subscription and send to server (only once per session)
        (async () => {
            try {
                // Check if we already registered push subscription in this session
                const sessionKey = 'push_subscription_registered_salon';
                if (sessionStorage.getItem(sessionKey)) {
                    console.debug('Push subscription already registered this session');
                    return;
                }

                const reg = await navigator.serviceWorker.ready;
                if (!('pushManager' in reg)) return;

                // Request permission
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return;

                // Fetch public key
                const pubRes = await fetch('/api/push/public-key');
                const { publicKey, success } = await pubRes.json();
                if (!success || !publicKey || publicKey.length < 30) return;
                const vapidKey = publicKey;

                const toUint8Array = (base64String) => {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                    const raw = atob(base64);
                    const output = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
                    return output;
                };

                const existing = await reg.pushManager.getSubscription();
                const sub = existing || await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: toUint8Array(vapidKey)
                });

                // Send to server in the expected format
                const raw = localStorage.getItem('salonni_user');
                const user = raw ? JSON.parse(raw) : {};
                const body = {
                    user_id: user.userId || user.userid || user.id || null,
                    salon_id: user.salonId || user.salon_id || user.salonid || null,
                    subscription: sub.toJSON()
                };
                await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                // Mark as registered for this session
                sessionStorage.setItem(sessionKey, 'true');
                console.debug('Salon push subscription saved for', { user_id: body.user_id, salon_id: body.salon_id });
            } catch (err) {
                console.debug('Push subscription error:', err);
            }
        })();
    }

    const notificationAudio = new Audio('/sounds/salon_notifications.wav');
    notificationAudio.preload = 'auto';
    let audioUnlocked = false;
    let audioCtx = null;
    const unlockAudio = async () => {
        if (audioUnlocked) return;
        try {
            // Resume audio context without playing the notification sound file
            audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx && audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
            // Play a short, silent oscillator to unlock audio without audible output
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0; // silence
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.01);
        } catch (e) {}
        audioUnlocked = true;
    };
    document.addEventListener('click', unlockAudio, { once: true });

    const playNotificationSound = () => {
        notificationAudio.currentTime = 0;
        notificationAudio.play().catch((err) => {
            console.debug('Audio play blocked:', err);
        });
    };

    // Unified local notification helper
    const notifyLocal = async ({ title = 'Saloony', body = 'لديك إشعار جديد', url = '/home_salon.html', isSuccess = true, tag = 'saloony' } = {}) => {
        // In-app toast
        showMessage(messageBox, body, !!isSuccess);
        // Sound + vibration
        playNotificationSound();
        if (navigator.vibrate) navigator.vibrate(100);

        // Service Worker notification
        try {
            if (!('serviceWorker' in navigator)) return;
            const reg = await navigator.serviceWorker.ready;
            const sw = navigator.serviceWorker.controller || reg.active;
            if (sw) {
                sw.postMessage({ type: 'saloony-notify', title, body, url, tag });
            } else if ('Notification' in window && Notification.permission === 'granted') {
                reg.showNotification(title, { body, icon: '/images/Saloony-app_icon.png', badge: '/images/Saloony-app_icon.png', data: { url }, tag });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then((res) => {
                    if (res === 'granted') {
                        const ctrl = navigator.serviceWorker.controller || reg.active;
                        if (ctrl) ctrl.postMessage({ type: 'saloony-notify', title, body, url, tag });
                        else reg.showNotification(title, { body, icon: '/images/Saloony-app_icon.png', badge: '/images/Saloony-app_icon.png', data: { url }, tag });
                    }
                }).catch(() => {});
            }
        } catch (e) {}
    };

    // Helper: show refresh banner when new events arrive
    let refreshBanner;
    const showRefreshBanner = () => {
        if (!refreshBanner) {
            refreshBanner = document.getElementById('refresh-banner');
        }
        if (refreshBanner) refreshBanner.classList.remove('hidden');
    };

    // --- Real-time Notifications (WebSocket with SSE fallback) ---
    let sseSource = null;
    let isWebSocketConnected = false;
    
    // Initialize WebSocket connection first
    const initWebSocket = () => {
        try {
            const socket = window.io ? io() : null;
            if (socket && salonId) {
                socket.emit('joinSalon', salonId);
                
                socket.on('connect', () => {
                    console.log('WebSocket connected for salon:', salonId);
                    isWebSocketConnected = true;
                    // Clear any existing SSE fallback polling
                    if (window.__salonSsePollInterval) {
                        clearInterval(window.__salonSsePollInterval);
                        window.__salonSsePollInterval = null;
                    }
                    // Close SSE if WebSocket is working
                    if (sseSource) {
                        sseSource.close();
                        sseSource = null;
                    }
                });
                
                socket.on('disconnect', () => {
                    console.log('WebSocket disconnected, falling back to SSE');
                    isWebSocketConnected = false;
                    // Fallback to SSE when WebSocket disconnects
                    initSSE();
                });
                
                socket.on('joinedSalon', ({ room }) => {
                    console.log('Joined WebSocket room:', room);
                });
                
                // Handle appointment_booked events
                socket.on('appointment_booked', (payload) => {
                    try {
                        const d = new Date(payload.start_time);
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const yyyy = d.getFullYear();
                        let h = d.getHours();
                        const isAM = h < 12;
                        h = h % 12 || 12;
                        const suffix = isAM ? 'صباحًا' : 'مساءً';
                        const msg = `لديك حجز جديد بتاريخ ${dd}/${mm}/${yyyy} على الساعة ${h} ${suffix}`;
                        notifyLocal({ title: 'حجز جديد', body: msg, url: '/home_salon.html#appointments', isSuccess: true, tag: 'appointment_booked' });
                        // Auto-refresh appointments silently to reflect the new booking
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    } catch (e) { 
                        console.warn('WebSocket appointment_booked handler error:', e.message); 
                    }
                });
                
                // Handle appointment_cancelled events
                socket.on('appointment_cancelled', (payload) => {
                    try {
                        const d = new Date(payload.start_time);
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const yyyy = d.getFullYear();
                        let h = d.getHours();
                        const isAM = h < 12;
                        h = h % 12 || 12;
                        const suffix = isAM ? 'صباحًا' : 'مساءً';
                        const msg = `تم إلغاء موعد بتاريخ ${dd}/${mm}/${yyyy} على الساعة ${h} ${suffix}${payload.late ? ' (إلغاء متأخر)' : ''}`;
                        notifyLocal({ title: 'إلغاء موعد', body: msg, url: '/home_salon.html#appointments', isSuccess: false, tag: 'appointment_cancelled' });
                        // Auto-refresh appointments silently to reflect the cancellation
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    } catch (e) { 
                        console.warn('WebSocket appointment_cancelled handler error:', e.message); 
                    }
                });
                
                // Handle appointment_status_updated events
                socket.on('appointment_status_updated', (payload) => {
                    try {
                        // Auto-refresh appointments silently to reflect the status change
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    } catch (e) { 
                        console.warn('WebSocket appointment_status_updated handler error:', e.message); 
                    }
                });
                
                return socket;
            }
        } catch (error) {
            console.warn('Failed to init WebSocket:', error);
            isWebSocketConnected = false;
        }
        return null;
    };
    
    // SSE fallback function
    const initSSE = () => {
        if (isWebSocketConnected || sseSource) return; // Don't start SSE if WebSocket is working or SSE already exists
        
        try {
            const streamUrl = `/api/salon/stream/${salonId}`;
            sseSource = new EventSource(streamUrl);

            sseSource.onmessage = (e) => {
                try {
                    const payload = JSON.parse(e.data || '{}');
                    if (!payload || !payload.type) return;

                    if (payload.type === 'appointment_booked') {
                        const d = new Date(payload.start_time);
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const yyyy = d.getFullYear();
                        let h = d.getHours();
                        const isAM = h < 12;
                        h = h % 12 || 12;
                        const suffix = isAM ? 'صباحًا' : 'مساءً';
                        const msg = `لديك حجز جديد بتاريخ ${dd}/${mm}/${yyyy} على الساعة ${h} ${suffix}`;
                        notifyLocal({ title: 'حجز جديد', body: msg, url: '/home_salon.html#appointments', isSuccess: true, tag: 'appointment_booked' });
                        // Auto-refresh appointments silently to reflect the new booking
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    } else if (payload.type === 'appointment_cancelled') {
                        const d = new Date(payload.start_time);
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const yyyy = d.getFullYear();
                        let h = d.getHours();
                        const isAM = h < 12;
                        h = h % 12 || 12;
                        const suffix = isAM ? 'صباحًا' : 'مساءً';
                        const msg = `تم إلغاء موعد بتاريخ ${dd}/${mm}/${yyyy} على الساعة ${h} ${suffix}${payload.late ? ' (إلغاء متأخر)' : ''}`;
                        notifyLocal({ title: 'إلغاء موعد', body: msg, url: '/home_salon.html#appointments', isSuccess: false, tag: 'appointment_cancelled' });
                        // Auto-refresh appointments silently to reflect the cancellation
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    }
                } catch (err) {
                    console.warn('SSE parse error:', err);
                }
            };

            sseSource.addEventListener('connected', () => {
                console.log('SSE connected for salon:', salonId);
            });

            sseSource.onerror = (err) => {
                console.warn('SSE error', err);
                // Fallback: lightweight polling every 15s when both WebSocket and SSE fail
                if (!isWebSocketConnected && !window.__salonSsePollInterval) {
                    window.__salonSsePollInterval = setInterval(() => {
                        if (typeof currentAppointmentsFilter !== 'undefined') {
                            loadAppointments(currentAppointmentsFilter, { showLoading: false });
                        }
                    }, 15000);
                }
            };
        } catch (error) {
            console.warn('Failed to init SSE:', error);
        }
    };
    
    // Initialize WebSocket first, fallback to SSE if needed
    const websocket = initWebSocket();
    if (!websocket) {
        initSSE();
    }
    
    // Continue with initialization only if both IDs are found
    const views = {
        'management-view': document.getElementById('management-view'),
        'appointments-view': document.getElementById('appointments-view'),
        'salon-view': document.getElementById('salon-view'),
        'reviews-view': document.getElementById('reviews-view'),
        'invoices-view': document.getElementById('invoices-view'),
    };


    // NEW: Confirmation Modal Logic
    let modalCallback = null;
    let pendingStatusDropdown = null; // used to revert selection on cancel

    const hideConfirmationModal = (opts = { resetOnHide: true }) => {
        confirmModalOverlay.classList.remove('modal-open-overlay');
        confirmModalOverlay.style.display = 'none';
        if (modalCallback) {
            confirmModalConfirmBtn.removeEventListener('click', modalCallback);
            modalCallback = null;
        }
        // If cancelling, revert dropdown selection
        if (opts.resetOnHide && pendingStatusDropdown) {
            pendingStatusDropdown.disabled = false;
            pendingStatusDropdown.style.opacity = '1';
            pendingStatusDropdown.value = '';
            pendingStatusDropdown = null;
        }
    };
    
    confirmModalCancelBtn.addEventListener('click', () => hideConfirmationModal({ resetOnHide: true }));
    
    const showConfirmationModal = (message, callback, confirmText = 'تأكيد') => {
        confirmModalMessage.textContent = message;
        confirmModalConfirmBtn.textContent = confirmText;
        
        // Clear previous event listener
        if (modalCallback) {
            confirmModalConfirmBtn.removeEventListener('click', modalCallback);
            modalCallback = null;
        }

        // Set new event listener
        modalCallback = () => {
            // Do not reset selection on confirm; proceed with callback
            hideConfirmationModal({ resetOnHide: false });
            callback();
        };
        confirmModalConfirmBtn.addEventListener('click', modalCallback);
        
        // Show modal
        confirmModalOverlay.style.display = 'flex';
        setTimeout(() => confirmModalOverlay.classList.add('modal-open-overlay'), 10);
    };


    const showView = async (viewId) => {
        Object.values(views).forEach(view => view.classList.add('hidden'));
        views[viewId].classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.classList.remove('nav-active', 'text-primary-dark', 'text-gray-500');
            btn.classList.add('text-gray-500', 'hover:text-primary-dark');
            if (btn.getAttribute('data-view') === viewId) {
                btn.classList.add('nav-active', 'text-primary-dark');
                btn.classList.remove('text-gray-500', 'hover:text-primary-dark');
            }
        });
        
        if (viewId === 'management-view') {
            await loadStaff(); 
            await loadSchedule();
        } else if (viewId === 'appointments-view') {
            await loadAppointments('today');
        } else if (viewId === 'salon-view') {
            console.log('=== SHOWING SALON VIEW ===');
            await loadSalonInfo();
            console.log('loadSalonInfo() completed');
            
            const genderFocus = currentSalon.gender_focus || 'men'; 
            console.log('About to call loadServiceManagement with genderFocus:', genderFocus);
            await loadServiceManagement(genderFocus);
            console.log('loadServiceManagement() completed');
        } else if (viewId === 'reviews-view') {
            await loadSalonReviews();
        } else if (viewId === 'invoices-view') {
            await loadSalonInvoices();
        }
    };
    
    // --- Date/Time Utility ---
    
    // Function to get Arabic time period based on hour
    const getTimePeriodArabic = (hour24) => {
        if (hour24 >= 5 && hour24 < 12) return 'صباحًا';
        if (hour24 >= 12 && hour24 < 16) return 'ظهرًا';
        if (hour24 >= 16 && hour24 < 19) return 'بعد الظهر';
        return 'مساءً';
    };
    
    // Enhanced time formatting with Arabic periods
    const formatTimeWithPeriod = (isoString) => {
        const date = new Date(isoString);
        const hour24 = date.getHours();
        const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
        const minutes = date.getMinutes();
        const period = getTimePeriodArabic(hour24);
        
        if (minutes === 0) {
            return `${hour12} ${period}`;
        } else {
            return `${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
    };
    
    const formatAppointmentTime = (isoString) => {
        const date = new Date(isoString);
        // Date part: Use English date format for clarity in appointments list
        const datePart = date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
        // Time part: Use new Arabic period formatting
        const timePart = formatTimeWithPeriod(isoString);
            
        return `${datePart} - ${timePart}`;
    };

    const formatTimeRange = (startTime, endTime) => {
        // FIX: Handle both time strings (HH:MM) and full ISO strings
        let start = startTime, end = endTime;
        
        if (startTime.includes(':') && startTime.length <= 5) {
             // It's just a time string, append a date for locale conversion
             start = `2000-01-01T${startTime}:00`;
             end = `2000-01-01T${endTime}:00`;
        } else if (startTime.includes(' ') && !startTime.includes('T')) {
             // Handle YYYY-MM-DD HH:MM:SS format from server
             start = startTime.replace(' ', 'T');
             end = endTime.replace(' ', 'T');
        }
        
        const startDate = new Date(start);
        const endDate = new Date(end);
        
        // Simple time formatting using the Date object (only hours/minutes are needed for breaks/schedules)
        const formatClockTime = (d) => {
            const hour24 = d.getHours();
            const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
            const minutes = d.getMinutes();
            const period = getTimePeriodArabic(hour24);
            
            if (minutes === 0) {
                return `${hour12} ${period}`;
            } else {
                return `${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
            }
        }
        
        const startTimePart = formatClockTime(startDate);
        const endTimePart = formatClockTime(endDate);
            
        return `${startTimePart} - ${endTimePart}`;
    };
    
    const renderEmptyState = (container, text, icon) => {
         container.innerHTML = `
            <div class="empty-state">
                <i class="fas ${icon}"></i>
                <p>${text}</p>
            </div>
         `;
    };

    // =============================
    // Reviews Rendering and Loader
    // =============================
    const formatRatingStars = (rating) => {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        return `
            ${'<i class="fas fa-star text-yellow-400"></i>'.repeat(fullStars)}
            ${halfStar ? '<i class="fas fa-star-half-alt text-yellow-400"></i>' : ''}
            ${'<i class="far fa-star text-yellow-400"></i>'.repeat(emptyStars)}
        `;
    };

    // Helper functions to format review dates consistently as dd/mm/yyyy
    const formatDateDDMMYYYY = (dateInput) => {
        if (!dateInput) return '--/--/----';
        let d = null;
        if (dateInput instanceof Date) {
            d = dateInput;
        } else if (typeof dateInput === 'string') {
            let s = dateInput.trim();
            // Handle 'YYYY-MM-DD'
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                s = `${s}T00:00:00`;
            }
            // Handle 'YYYY-MM-DD HH:MM(:SS)?'
            else if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(?::\d{2})?$/.test(s)) {
                s = s.replace(' ', 'T');
            }
            d = new Date(s);
        } else if (typeof dateInput === 'number') {
            d = new Date(dateInput);
        } else {
            d = new Date(dateInput);
        }
        if (isNaN(d.getTime())) return '--/--/----';
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    };

    const formatReviewDate = (dateString) => {
        const formattedDate = formatDateDDMMYYYY(dateString);
        return `
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">
                <i class="fas fa-calendar-alt text-secondary"></i>
                ${formattedDate}
            </span>
        `;
    };

    const renderSalonReviews = (reviews) => {
        const list = document.getElementById('reviews-list');
        const empty = document.getElementById('reviews-empty');
        if (!list || !empty) return;

        if (!reviews || reviews.length === 0) {
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        list.innerHTML = reviews.map(r => `
            <div class="p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="inline-flex items-center gap-2 px-2 py-1 bg-gray-100 text-primary-dark rounded-full text-xs font-semibold">
                        <i class="fas fa-user-circle text-secondary"></i>
                        ${r.user_name || 'مستخدم'}
                    </span>
                    ${formatReviewDate(r.date_posted || r.created_at)}
                </div>
                <div class="text-yellow-500 text-sm mb-2">${formatRatingStars(parseFloat(r.rating || 0))}</div>
                <p class="text-sm text-gray-700"><i class="fas fa-comment ml-2 text-secondary"></i>${(r.comment || '').trim() || 'بدون تعليق'}</p>
            </div>
        `).join('');
    };

    const renderSalonInvoices = (payments) => {
        const list = document.getElementById('invoices-list');
        const empty = document.getElementById('invoices-empty');
        if (!list || !empty) return;

        if (!payments || payments.length === 0) {
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        
        list.innerHTML = payments.map((payment, index) => {
            const statusColor = (payment.payment_status === 'completed' || payment.payment_status === 'مكتملة') ? 'text-green-600' : 
                               (payment.payment_status === 'pending' || payment.payment_status === 'معلق') ? 'text-yellow-600' : 
                               'text-red-600';
            
            const statusIcon = (payment.payment_status === 'completed' || payment.payment_status === 'مكتملة') ? 'fas fa-check-circle' : 
                              (payment.payment_status === 'pending' || payment.payment_status === 'معلق') ? 'fas fa-clock' : 
                              'fas fa-times-circle';
            
            // Format date as dd/mm/yy
            const paymentDate = new Date(payment.created_at).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
            });
            
            const paymentType = payment.payment_type === 'offer_200ils' ? 'عرض شهرين - 200 شيكل' : payment.payment_type;

            return `
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <!-- Payment Info -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center justify-center w-12 h-12 bg-primary-light rounded-full">
                                <i class="fas fa-receipt text-primary-dark text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">فاتورة ${payment.invoice_number || '#' + payment.id}</h3>
                                <p class="text-sm text-gray-600">${paymentDate}</p>
                                <p class="text-sm font-medium text-primary-dark">${paymentType}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="font-bold text-lg text-gray-800">${payment.amount} ${payment.currency}</span>
                                    <i class="${statusIcon} ${statusColor} text-sm"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Button -->
                        <button onclick="showInvoiceModal(${JSON.stringify(payment).replace(/"/g, '&quot;')})" 
                                class="px-4 py-2 bg-primary-dark text-white rounded-lg hover:bg-primary-darker transition-colors font-medium">
                            <i class="fas fa-eye ml-2"></i>
                            معاينة
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    };

    const loadSalonReviews = async () => {
        const loading = document.getElementById('reviews-loading');
        const list = document.getElementById('reviews-list');
        const empty = document.getElementById('reviews-empty');
        if (loading) loading.classList.remove('hidden');
        if (list) list.innerHTML = '';
        if (empty) empty.classList.add('hidden');

        try {
            const response = await fetch(`/api/reviews/salon/${salonId}`);
            const data = await response.json();
            if (data.success) {
                renderSalonReviews(data.reviews || []);
            } else {
                showMessage(messageBox, data.message || 'فشل في جلب المراجعات.', false);
                renderSalonReviews([]);
            }
        } catch (error) {
            console.error('Error loading salon reviews:', error);
            showMessage(messageBox, 'خطأ في الشبكة أثناء جلب المراجعات.', false);
            renderSalonReviews([]);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    };

    // Global variable to store all invoices for filtering
    let allInvoices = [];

    const loadSalonInvoices = async () => {
        const loading = document.getElementById('invoices-loading');
        const list = document.getElementById('invoices-list');
        const empty = document.getElementById('invoices-empty');
        if (loading) loading.classList.remove('hidden');
        if (list) list.innerHTML = '';
        if (empty) empty.classList.add('hidden');

        try {
            const response = await fetch(`/api/salon/payments/${salonId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('salonToken')}`
                }
            });
            const data = await response.json();
            if (data.success) {
                allInvoices = data.payments || [];
                renderSalonInvoices(allInvoices);
            } else {
                showMessage(messageBox, data.message || 'فشل في جلب الفواتير.', false);
                allInvoices = [];
                renderSalonInvoices([]);
            }
        } catch (error) {
            console.error('Error loading salon invoices:', error);
            showMessage(messageBox, 'خطأ في الشبكة أثناء جلب الفواتير.', false);
            allInvoices = [];
            renderSalonInvoices([]);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    };

    // Filter and search functionality - REMOVED for user interface simplification
    // Users don't need filters, they can see all their invoices directly

    // ===========================================
    // SECTION 1: Appointments Logic 
    // ===========================================
    
    const appointmentsListContainer = document.getElementById('appointments-list-container');
    const tabAppointmentButtons = document.querySelectorAll('.tab-appointments');

    // Create refresh banner element if not present
    (function ensureRefreshBanner() {
        if (!document.getElementById('refresh-banner')) {
            const banner = document.createElement('div');
            banner.id = 'refresh-banner';
            banner.className = 'hidden mx-4 my-2 p-3 rounded-xl bg-secondary-soft text-secondary font-bold flex items-center justify-between shadow';
            banner.innerHTML = `
                <span class="inline-flex items-center gap-2">
                    <i class="fas fa-bell"></i>
                    تم وصول تحديثات جديدة. انقر للتحديث.
                </span>
                <button id="refresh-banner-btn" class="px-3 py-1 rounded-lg bg-secondary text-white text-sm font-bold">تحديث الآن</button>
            `;
            const parent = appointmentsListContainer?.parentElement || document.querySelector('#appointments-view');
            if (parent) parent.insertBefore(banner, appointmentsListContainer);
            const btn = banner.querySelector('#refresh-banner-btn');
            btn?.addEventListener('click', () => {
                if (typeof currentAppointmentsFilter !== 'undefined') {
                    loadAppointments(currentAppointmentsFilter);
                }
                banner.classList.add('hidden');
            });
        }
    })();

    const renderAppointmentCard = (appointment, filter) => {
        console.log('DEBUG: Appointment data:', JSON.stringify(appointment, null, 2));
        const isScheduled = appointment.status === 'Scheduled';
        const isPast = filter === 'past';
        
        let statusClass = 'bg-gray-200 text-gray-700';
        let statusText = 'غير معروف';
        
        if (appointment.status === 'Scheduled') {
            statusClass = 'bg-secondary-soft text-secondary font-bold';
            statusText = 'مؤكد';
        } else if (appointment.status === 'Cancelled') {
            statusClass = 'bg-red-100 text-red-700';
            statusText = 'ملغي';
        } else if (appointment.status === 'Completed') {
            statusClass = 'bg-green-100 text-green-700';
            statusText = 'منتهي';
        } else if (appointment.status === 'Absent') {
            statusClass = 'bg-orange-100 text-orange-700';
            statusText = 'غائب';
        }

        // Check if 10 minutes have passed since appointment start time
        const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Jerusalem"}));
        const appointmentStartTime = new Date(appointment.start_time);
        const tenMinutesAfterStart = new Date(appointmentStartTime.getTime() + 10 * 60 * 1000);
        // Only allow status change if the appointment has started AND it is currently Scheduled
        const canChangeStatus = now >= tenMinutesAfterStart && appointment.status === 'Scheduled'; 
        // Display helpers
        const startDateDisplay = new Date(appointment.start_time).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const startTimeDisplay = formatTimeWithPeriod(appointment.start_time);
        const availableAtDisplay = formatTimeWithPeriod(tenMinutesAfterStart.toISOString());
        
        const hideActions = (filter === 'past' || filter === 'completed' || appointment.status === 'Cancelled');
        const actionButtons = (!hideActions) ? `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-2">تحديث حالة الموعد:</label>
                ${canChangeStatus ? `
                    <select class="w-full p-2 border border-gray-300 rounded-xl text-sm status-dropdown" data-id="${appointment.id}">
                        <option value="">اختر الحالة...</option>
                        <option value="Completed">تم الخدمة</option>
                        <option value="Cancelled">إلغاء</option>
                        <option value="Absent">غائب</option>
                    </select>
                ` : `
                    <div class="w-full p-3 border border-gray-200 rounded-xl text-sm bg-gray-50 text-gray-700 text-center">
                        ${appointment.status === 'Scheduled' 
                            ? `
                                <span class="inline-flex items-center gap-2 mb-1">
                                    <i class="fas fa-info-circle text-gray-400"></i>
                                    يمكن تحديث الحالة بعد 10 دقائق من بداية الموعد
                                </span>
                                <br />
                                <small class="inline-flex items-center gap-2">
                                    <i class="fas fa-clock text-gray-400"></i>
                                    متاح في: ${availableAtDisplay}
                                </small>
                              `
                            : 'تم تحديد حالة هذا الموعد مسبقاً.'}
                    </div>
                `}
            </div>
        ` : '';

        return `
            <div class="bg-white p-5 rounded-xl shadow-lg border-r-4 ${isScheduled ? 'border-secondary' : 'border-gray-300'} hover:shadow-xl transition-shadow" data-appointment-id="${appointment.id}">
                <!-- Date/Time and Status Header -->
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="inline-block bg-gray-100 text-gray-800 font-semibold px-4 py-2 rounded-lg text-base">
                            <i class="fas fa-calendar-day ml-1"></i> ${startDateDisplay}
                        </span>
                        <span class="inline-block bg-blue-100 text-blue-800 font-semibold px-4 py-2 rounded-lg text-base">
                            <i class="fas fa-clock ml-1"></i> ${startTimeDisplay}
                        </span>
                    </div>
                    <span class="text-xs font-bold px-3 py-2 rounded-lg ${statusClass} shadow-sm">${statusText}</span>
                </div>
                
                <!-- Customer Info -->
                <div class="bg-gray-50 p-3 rounded-lg mb-3">
                    <p class="font-bold text-lg text-gray-800 mb-1">
                        <i class="fas fa-user-circle ml-2 text-secondary"></i> ${appointment.user_name}
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <i class="fas fa-phone ml-2 text-primary-dark/70"></i> ${appointment.user_phone}
                    </p>
                    ${appointment.staff_name ? `
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-user-tie ml-2 text-primary-dark/70"></i> مع: ${appointment.staff_name}
                        </p>` : ''}
                        
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-dollar-sign ml-2 text-primary-dark/70"></i> السعر: ${parseFloat(appointment.price).toFixed(0)} شيكل
                        </p>
                        
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${appointment.all_services && appointment.all_services.length > 0 ? 
                                appointment.all_services.map(service => `
                                    <span class="inline-block bg-gradient-to-r from-teal-500 to-teal-600 text-white text-xs font-medium px-3 py-1 rounded-full shadow-sm">
                                        <i class="fas fa-scissors ml-1"></i> ${service.name_ar}
                                    </span>
                                `).join('') : 
                                `<span class="inline-block bg-gradient-to-r from-teal-500 to-teal-600 text-white text-xs font-medium px-3 py-1 rounded-full shadow-sm">
                                    <i class="fas fa-scissors ml-1"></i> ${appointment.service_name || 'خدمة غير محددة'}
                                </span>`
                            }
                        </div>
                </div>
                
                ${actionButtons}
            </div>
        `;
    };

    let currentAppointmentsFilter = 'today';
    let appointmentsFetchController = null;
    const loadAppointments = async (filter, opts = {}) => {
        const showLoading = opts.showLoading !== false;
        if (showLoading) {
            appointmentsListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">جاري تحميل المواعيد...</p>';
        }

        tabAppointmentButtons.forEach(btn => {
            btn.classList.remove('bg-primary-dark', 'text-white');
            btn.classList.add('text-gray-500', 'bg-gray-200');
            if (btn.getAttribute('data-filter') === filter) {
                btn.classList.add('bg-primary-dark', 'text-white');
                btn.classList.remove('text-gray-500', 'bg-gray-200');
            }
        });
        currentAppointmentsFilter = filter;

        // Cancel any in-flight request to avoid race conditions
        if (appointmentsFetchController) {
            try { appointmentsFetchController.abort(); } catch (e) {}
        }
        appointmentsFetchController = new AbortController();
        const { signal } = appointmentsFetchController;

        // CRITICAL FIX: Use salonId for business-related API calls
        try {
            const response = await fetch(`/api/salon/appointments/${salonId}/${filter}`, { signal });
            const data = await response.json();
            
            if (data.success && data.appointments.length > 0) {
                appointmentsListContainer.innerHTML = data.appointments.map(appt => renderAppointmentCard(appt, filter)).join('');
                attachAppointmentListeners(filter);
                const countEl = document.getElementById('appointments-count');
                if (countEl) { countEl.textContent = data.appointments.length; countEl.classList.remove('hidden'); }
            } else {
                 let emptyText = '';
                 let icon = '';
                 if (filter === 'today') {
                     emptyText = 'لا توجد مواعيد مقررة ليومك الحالي. استعد ليوم هادئ!';
                     icon = 'fa-calendar-check';
                 } else if (filter === 'completed') {
                     emptyText = 'لا توجد مواعيد مكتملة حتى الآن.';
                     icon = 'fa-check-circle';
                 } else if (filter === 'upcoming') {
                     emptyText = 'لا توجد مواعيد قادمة.';
                     icon = 'fa-calendar-plus';
                 } else if (filter === 'cancelled') {
                     emptyText = 'لا توجد مواعيد ملغاة حالياً.';
                     icon = 'fa-ban';
                 } else {
                     emptyText = 'لا توجد مواعيد مطابقة لهذا الفلتر.';
                     icon = 'fa-clipboard-list';
                 }
                renderEmptyState(appointmentsListContainer, emptyText, icon);
                const countEl = document.getElementById('appointments-count');
                if (countEl) { countEl.textContent = '0'; countEl.classList.remove('hidden'); }
            }
        } catch (error) {
            if (error && error.name === 'AbortError') {
                return; // silently ignore
            }
            console.error('Error loading appointments:', error);
            showMessage(messageBox, 'فشل في جلب المواعيد من الخادم.', false);
            renderEmptyState(appointmentsListContainer, 'فشل في جلب المواعيد من الخادم.', 'fa-server');
            const countEl = document.getElementById('appointments-count');
            if (countEl) { countEl.textContent = '0'; countEl.classList.remove('hidden'); }
        }
    };
    
    const attachAppointmentListeners = (currentFilter) => {
        document.querySelectorAll('.status-dropdown').forEach(dropdown => {
            dropdown.addEventListener('change', (e) => {
                const appointmentId = e.currentTarget.getAttribute('data-id');
                const status = e.currentTarget.value;
                if (status) {
                    // For Completed or Absent, show confirmation modal
                    if (status === 'Completed' || status === 'Absent') {
                        pendingStatusDropdown = dropdown;
                        const isAbsent = status === 'Absent';
                        const message = isAbsent
                            ? 'هل أنت متأكد من تحديد هذا الموعد كـ غائب؟ سيتم إضافة إنذار إلى حساب العميل.'
                            : 'تأكيد إنهاء هذا الموعد كـ مكتمل؟';
                        const confirmText = isAbsent ? 'تأكيد الغياب' : 'تأكيد الإنهاء';
                        showConfirmationModal(message, () => {
                            updateAppointmentStatus(appointmentId, status, currentFilter);
                            // Clear pending after starting update
                            pendingStatusDropdown = null;
                        }, confirmText);
                    } else {
                        // For Cancelled or other statuses, proceed directly
                        updateAppointmentStatus(appointmentId, status, currentFilter);
                    }
                }
            });
        });
    };
    
    const updateAppointmentStatus = async (appointmentId, status, currentFilter) => {
        try {
            const dropdown = document.querySelector(`.status-dropdown[data-id="${appointmentId}"]`);
            if (dropdown) {
                dropdown.disabled = true;
                dropdown.style.opacity = '0.6';
            }
            
            const response = await fetch(`/api/salon/appointment/status/${appointmentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }),
            });
            const data = await response.json();

            if (data.success) {
                showMessage(messageBox, data.message || 'تم تحديث حالة الموعد بنجاح.', true);
                loadAppointments(currentFilter);
            } else {
                showMessage(messageBox, data.message || 'فشل في تحديث حالة الموعد.', false);
                if (dropdown) {
                    dropdown.disabled = false;
                    dropdown.style.opacity = '1';
                    dropdown.value = ''; // Reset dropdown
                }
            }

        } catch (error) {
            console.error('Error updating appointment status:', error);
            showMessage(messageBox, 'خطأ في الشبكة أثناء تحديث الحالة.', false);
            const dropdown = document.querySelector(`.status-dropdown[data-id="${appointmentId}"]`);
            if (dropdown) {
                dropdown.disabled = false;
                dropdown.style.opacity = '1';
                dropdown.value = ''; // Reset dropdown
            }
        }
    };

    tabAppointmentButtons.forEach(btn => {
        btn.addEventListener('click', () => loadAppointments(btn.getAttribute('data-filter')));
    });
    const refreshBtn = document.getElementById('refresh-appointments-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            if (typeof currentAppointmentsFilter !== 'undefined') {
                loadAppointments(currentAppointmentsFilter);
            }
        });
    }
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => loadAppointments(currentAppointmentsFilter));
    }

    // ===========================================
    // SECTION 2: Management Logic (Staff, Schedule, Breaks, Modifications)
    // ===========================================
    
    // --- Staff Management ---
    const renderStaffList = (staff) => {
        staffListContainer.innerHTML = staff.length > 0 ? '' : `
            <div class="empty-state">
                <i class="fas fa-users-slash"></i>
                <p>لم تقم بإضافة أي موظفين بعد. أضف مختصيك الآن!</p>
            </div>
        `;
        // Clear and repopulate break and modification staff dropdowns
        breakStaffSelect.innerHTML = '<option value="all">جميع العاملين</option>';
        modStaffSelect.innerHTML = '<option value="all">جميع العاملين</option>';

        staff.forEach(s => {
            const staffDiv = document.createElement('div');
            staffDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg shadow-sm border border-gray-200';
            staffDiv.innerHTML = `
                <span class="font-medium text-primary-dark"><i class="fas fa-user-tag ml-2 text-secondary"></i> ${s.name}</span>
                <button type="button" class="text-red-500 hover:text-red-700 text-sm delete-staff-btn p-1 rounded-full transition" data-id="${s.id}" data-name="${s.name}">
                    <i class="fas fa-trash-alt"></i> حذف
                </button>
            `;
            staffListContainer.appendChild(staffDiv);

            // Populate dropdowns
            const optionBreak = document.createElement('option');
            optionBreak.value = s.id;
            optionBreak.textContent = s.name;
            breakStaffSelect.appendChild(optionBreak);
            
            const optionMod = document.createElement('option');
            optionMod.value = s.id;
            optionMod.textContent = s.name;
            modStaffSelect.appendChild(optionMod);
        });

        document.querySelectorAll('.delete-staff-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const staffId = e.currentTarget.getAttribute('data-id');
                const staffName = e.currentTarget.getAttribute('data-name');
                showConfirmationModal(`هل أنت متأكد من حذف الموظف: ${staffName}؟ هذا الإجراء لا يمكن التراجع عنه وقد يفشل لوجود مواعيد سابقة مرتبطة به.`, 
                                    () => deleteStaffConfirmed(staffId),
                                    'نعم، احذف الموظف');
            });
        });
    };

    const loadStaff = async () => {
        // CRITICAL FIX: Use salonId for business-related API calls
        try {
            const response = await fetch(`/api/salon/staff/${salonId}`);
            const data = await response.json();
            if (data.success) {
                staffList = data.staff;
                renderStaffList(staffList);
            } else {
                showMessage(messageBox, 'فشل تحميل قائمة العاملين.', false);
            }
        } catch (error) {
            console.error('Error loading staff:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        }
    };
    
    const deleteStaffConfirmed = async (staffId) => {
        try {
            const response = await fetch(`/api/salon/staff/${staffId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                await loadStaff();
                showMessage(messageBox, 'تم حذف الموظف بنجاح.', true);
                await loadSchedule(); 
            } else {
                // Display specific error from backend (e.g., FK constraint)
                showMessage(messageBox, data.message || 'فشل حذف الموظف. قد يكون مرتبطًا بحجوزات.', false);
            }
        } catch (error) {
            console.error('Error deleting staff:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        }
    };
    
    const addStaff = async (e) => {
        e.preventDefault();
        const name = staffNameInput.value.trim();
        if (!name) return;

        try {
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/staff/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name }),
            });
            const data = await response.json();
            if (data.success) {
                staffNameInput.value = '';
                await loadStaff();
                showMessage(messageBox, 'تم إضافة الموظف بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل إضافة الموظف.', false);
            }
        } catch (error) {
            console.error('Error adding staff:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            addStaffForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-user-plus ml-1"></i> إضافة';
            addStaffForm.querySelector('button[type="submit"]').disabled = false;
        }
    };

    addStaffForm.addEventListener('submit', addStaff);


    // --- Schedule & Breaks & Modifications Logic ---
    
    // Day Index Select for Recurring Modification
    daysOfWeekNames.forEach((name, index) => {
        const option = document.createElement('option');
        // FIX: Day index 0 should be Sunday, 6 is Saturday
        option.value = index; 
        option.textContent = name;
        modDayIndexSelect.appendChild(option);
    });
    
    // Modification UI Toggles
    modTypeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const isOnce = e.target.value === 'once';
            onceModFields.classList.toggle('hidden', !isOnce);
            recurringModFields.classList.toggle('hidden', isOnce);
            document.getElementById('mod-date-input').required = isOnce;
            // FIX: Set/unset required on the select element itself
            modDayIndexSelect.required = !isOnce; 
            if(isOnce) modDayIndexSelect.removeAttribute('required'); else modDayIndexSelect.setAttribute('required', 'true');
        });
    });

    modIsClosedCheckbox.addEventListener('change', (e) => {
        const isClosedFullDay = e.target.checked;
        // Show interval fields when NOT closing all day; hide them for full-day closure
        modTimeFields.classList.toggle('hidden', isClosedFullDay);
        // Require times when creating an interval closure
        modStartTimeInput.required = !isClosedFullDay;
        modEndTimeInput.required = !isClosedFullDay;

        if (isClosedFullDay) {
            // For full-day closure, clear any times
            modStartTimeInput.value = '';
            modEndTimeInput.value = '';
        }

        const modBtn = addModificationForm.querySelector('button[type="submit"]');
        modBtn.classList.toggle('bg-red-600', isClosedFullDay);
        modBtn.classList.toggle('hover:bg-red-700', isClosedFullDay);
        modBtn.classList.toggle('btn-action', !isClosedFullDay);
    });

    const loadSchedule = async () => {
        // CRITICAL FIX: Use salonId for business-related API calls
        try {
            const response = await fetch(`/api/salon/schedule/${salonId}`);
            const data = await response.json();
            
            if (data.success) {
                const schedule = data.schedule || {};
                openingTimeInput.value = schedule.opening_time || '09:00';
                closingTimeInput.value = schedule.closing_time || '18:00';
                
                // FIX: Ensure closed_days is an array before passing
                const closedDaysArray = Array.isArray(schedule.closed_days) ? schedule.closed_days : (schedule.closed_days || []);
                renderClosedDays(closedDaysArray);

                renderBreaks(data.breaks || []);
                renderModifications(data.modifications || []); 
            } else {
                openingTimeInput.value = '09:00';
                closingTimeInput.value = '18:00';
                renderClosedDays([]);
                renderBreaks([]);
                renderModifications([]); 
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
            showMessage(messageBox, 'فشل تحميل الجدول الزمني.', false);
        }
    };

    const renderClosedDays = (closedDays) => {
        const dayNames = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        closedDaysContainer.innerHTML = '';
        
        // Convert numbers in closedDays array to strings for includes check
        const closedDayStrings = closedDays.map(String); 

        dayNames.forEach((name, index) => {
            const isChecked = closedDayStrings.includes(String(index));
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `day-${index}`;
            input.value = index;
            input.checked = isChecked;
            input.className = 'hidden peer';

            const label = document.createElement('label');
            label.htmlFor = `day-${index}`;
            label.className = `cursor-pointer px-3 py-2 rounded-full border transition-all duration-200 text-sm 
                                ${isChecked ? 'day-selected' : 'bg-gray-200 text-gray-700 border-gray-300 hover:bg-gray-300'}`;
            label.textContent = name;
            
            closedDaysContainer.appendChild(input);
            closedDaysContainer.appendChild(label);

            input.addEventListener('change', () => {
                label.classList.toggle('day-selected');
                label.classList.toggle('bg-gray-200');
                label.classList.toggle('text-gray-700');
            });
        });
    };
    
    const saveSchedule = async (e) => {
        e.preventDefault();
        const openingTime = openingTimeInput.value;
        const closingTime = closingTimeInput.value;

        // Removed validation: Allow any opening/closing time combination (including overnight schedules like 9am-1am)

        const selectedDays = Array.from(document.querySelectorAll('#closed-days-container input:checked')).map(input => parseInt(input.value));
        
        const scheduleData = {
            opening_time: openingTime,
            closing_time: closingTime,
            closed_days: selectedDays
        };

        try {
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الحفظ';
            
            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/schedule/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scheduleData),
            });
            const data = await response.json();
            if (data.success) {
                showMessage(messageBox, 'تم تحديث أوقات العمل بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل تحديث أوقات العمل.', false);
            }
        } catch (error) {
            console.error('Error saving schedule:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            scheduleForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save ml-1"></i> حفظ أوقات العمل';
            scheduleForm.querySelector('button[type="submit"]').disabled = false;
        }
    };
    scheduleForm.addEventListener('submit', saveSchedule);
    
    const renderBreaks = (breaks) => {
        breaksListContainer.innerHTML = breaks.length > 0 ? '' : `
            <div class="empty-state p-4 border-gray-200 border-dashed border-2">
                <i class="fas fa-mug-hot"></i>
                <p>لم تُسجل فترات استراحة روتينية بعد.</p>
            </div>
        `;
        breaks.forEach(b => {
            // FIX: Ensure staff_id is parsed correctly (can be null/string)
            const staff = staffList.find(s => s.id === (b.staff_id ? parseInt(b.staff_id) : null));
            const staffName = staff ? staff.name : 'جميع العاملين';
            
            const breakDiv = document.createElement('div');
            breakDiv.className = 'flex justify-between items-center p-3 bg-red-50 rounded-lg border-r-4 border-red-400 shadow-sm';
            breakDiv.innerHTML = `
                <div class="space-y-1">
                    <p class="font-medium text-red-800">${formatTimeRange(b.start_time, b.end_time)}</p>
                    <p class="text-xs text-red-600">تنطبق على: ${staffName}</p>
                    ${b.reason ? `<p class="text-xs text-red-600">السبب: ${b.reason}</p>` : ''}
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 text-sm delete-break-btn p-1 rounded-full transition" data-id="${b.id}" data-staff="${staffName}">
                    <i class="fas fa-times-circle"></i> حذف
                </button>
            `;
            breaksListContainer.appendChild(breakDiv);
        });

        document.querySelectorAll('.delete-break-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const breakId = e.currentTarget.getAttribute('data-id');
                const staffName = e.currentTarget.getAttribute('data-staff');
                showConfirmationModal(`هل أنت متأكد من حذف فترة الاستراحة الروتينية للمختص: ${staffName}؟`, 
                                    () => deleteBreakConfirmed(breakId));
            });
        });
    };
    
    const deleteBreakConfirmed = async (breakId) => {
        try {
            const response = await fetch(`/api/salon/break/${breakId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                await loadSchedule();
                showMessage(messageBox, 'تم حذف الاستراحة بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل حذف الاستراحة.', false);
            }
        } catch (error) {
            console.error('Error deleting break:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        }
    };
    
    addBreakForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const startTime = breakStartInput.value;
        const endTime = breakEndInput.value;
        const reason = (breakReasonInput.value || '').trim();
        
        // Client-side validation: Start time must be before end time
        if (startTime >= endTime) {
            showMessage(messageBox, 'وقت بداية الاستراحة يجب أن يكون قبل وقت النهاية.', false);
            return;
        }

        const staffId = breakStaffSelect.value === 'all' ? null : parseInt(breakStaffSelect.value);
        
        const breakData = {
            start_time: startTime,
            end_time: endTime,
            staff_id: staffId,
            reason: reason || null,
        };

        try {
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الإضافة';

            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/break/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(breakData),
            });
            const data = await response.json();
            if (data.success) {
                breakStartInput.value = '';
                breakEndInput.value = '';
                breakReasonInput.value = '';
                await loadSchedule();
                showMessage(messageBox, 'تم إضافة الاستراحة بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل إضافة الاستراحة.', false);
            }
        } catch (error) {
            console.error('Error adding break:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
             addBreakForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-pause-circle ml-1"></i> إضافة استراحة روتينية';
             addBreakForm.querySelector('button[type="submit"]').disabled = false;
        }
    });

    // --- NEW Modification Logic ---
    const renderModifications = (modifications) => {
        modificationsListContainer.innerHTML = modifications.length > 0 ? '' : `
            <div class="empty-state p-4 border-gray-200 border-dashed border-2">
                <i class="fas fa-calendar-times"></i>
                <p>لا توجد تعديلات مؤقتة أو إجازات مجدولة حالياً.</p>
            </div>
        `;
        modifications.forEach(mod => {
            // FIX: Ensure staff_id is parsed correctly (can be null/string)
            const staff = staffList.find(s => s.id === (mod.staff_id ? parseInt(mod.staff_id) : null));
            const staffName = staff ? staff.name : 'جميع العاملين';
            
            let modDetails = '';
            let typeColor = '';
            
            if (mod.mod_type === 'once') {
                modDetails = `بتاريخ: ${mod.mod_date}`;
                typeColor = 'border-blue-400 bg-blue-50';
            } else {
                // FIX: Ensure mod_day_index is treated as number/string for lookup
                const dayIndex = mod.mod_day_index !== null ? parseInt(mod.mod_day_index) : -1; 
                modDetails = `كل: ${daysOfWeekNames[dayIndex] || 'يوم غير محدد'}`;
                typeColor = 'border-orange-400 bg-orange-50';
            }
            
            // Use closure_type from API: 'full_day'|'interval'|'legacy'
            const closureType = mod.closure_type;
            const isFullDay = !!mod.is_full_day || closureType === 'full_day';
            let timeInfo = '';
            let badgeHtml = '';
            if (closureType === 'full_day') {
                timeInfo = '<span class="font-bold text-red-600">مغلق بالكامل</span>';
                badgeHtml = '<span class="inline-block text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded ml-2">إغلاق كامل</span>';
            } else if (closureType === 'interval') {
                timeInfo = `إغلاق من ${formatTimeRange(mod.start_time, mod.end_time)}`;
                badgeHtml = '<span class="inline-block text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded ml-2">إغلاق بفترة</span>';
            } else {
                timeInfo = `ساعات مخصصة (قديم): ${formatTimeRange(mod.start_time, mod.end_time)}`;
                badgeHtml = '<span class="inline-block text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded ml-2">قديم</span>';
            }

            const modDiv = document.createElement('div');
            modDiv.className = `flex justify-between items-center p-3 rounded-lg border-r-4 shadow-sm ${typeColor}`;
            modDiv.innerHTML = `
                <div class="space-y-1">
                    <p class="font-medium text-primary-dark">${mod.reason} ${badgeHtml}</p>
                    <p class="text-xs text-gray-700">${timeInfo} - ${modDetails}</p>
                    <p class="text-xs text-gray-500">ينطبق على: ${staffName}</p>
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 text-sm delete-mod-btn p-1 rounded-full transition" data-id="${mod.id}" data-reason="${mod.reason}">
                    <i class="fas fa-trash-alt"></i> حذف
                </button>
            `;
            modificationsListContainer.appendChild(modDiv);
        });

        document.querySelectorAll('.delete-mod-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modId = e.currentTarget.getAttribute('data-id');
                const reason = e.currentTarget.getAttribute('data-reason');
                showConfirmationModal(`هل أنت متأكد من حذف تعديل الجدول: "${reason}"؟`, 
                                    () => deleteModificationConfirmed(modId));
            });
        });
    };
    
    const addModification = async (e) => {
        e.preventDefault();
        
        // FIX: Define btn at the beginning of the function
        const btn = e.submitter; 

        const modType = document.querySelector('input[name="mod_type"]:checked').value;
        const isClosedFullDay = modIsClosedCheckbox.checked; // determines closure_type
        const staffId = modStaffSelect.value === 'all' ? null : parseInt(modStaffSelect.value);

        let modData = {
            salon_id: salonId,
            mod_type: modType,
            closure_type: isClosedFullDay ? 'full_day' : 'interval',
            reason: document.getElementById('mod-reason-input').value.trim(),
            staff_id: staffId
        };
        
        if (modType === 'once') {
            modData.mod_date = document.getElementById('mod-date-input').value;
            modData.mod_day_index = null;
        } else {
            modData.mod_day_index = parseInt(modDayIndexSelect.value);
            modData.mod_date = null;
        }

        // Closure semantics:
        // - If "إغلاق اليوم كاملاً" is checked => full-day closure (no times)
        // - Otherwise => interval closure (times required)
        if (isClosedFullDay) {
            modData.start_time = null;
            modData.end_time = null;
        } else {
            if (!modStartTimeInput.value || !modEndTimeInput.value) {
                showMessage(messageBox, 'يرجى تحديد وقتي الإغلاق (من/إلى).', false);
                return;
            }
            modData.start_time = modStartTimeInput.value;
            modData.end_time = modEndTimeInput.value;
            if (modData.start_time >= modData.end_time) {
                showMessage(messageBox, 'وقت الإغلاق (من) يجب أن يكون قبل (إلى).', false);
                return;
            }
        }

        // Basic validation check
        if (!modData.reason || (modType === 'once' && !modData.mod_date) || (modType === 'recurring' && modData.mod_day_index === undefined)) {
            showMessage(messageBox, 'يرجى ملء جميع الحقول المطلوبة للتعديل.', false);
            return;
        }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الإضافة';

            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/schedule/modification/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(modData),
            });
            const data = await response.json();
            
            if (data.success) {
                addModificationForm.reset();
                // Reset checkbox state for next entry
                modIsClosedCheckbox.checked = false;
                modTimeFields.classList.remove('hidden'); 
                modStartTimeInput.required = true;
                modEndTimeInput.required = true;
                
                await loadSchedule();
                showMessage(messageBox, 'تم إضافة التعديل بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل إضافة التعديل.', false);
            }
        } catch (error) {
            console.error('Error adding modification:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            const isClosed = modIsClosedCheckbox.checked;
            const defaultColor = isClosed ? 'bg-red-600 hover:bg-red-700 text-white' : 'btn-action';
            // Restore button classes to default state
            btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white', 'btn-action');
            btn.classList.add('w-full', 'py-3', 'rounded-xl', 'font-bold', isClosed ? 'bg-red-600' : 'btn-action', isClosed ? 'hover:bg-red-700' : 'hover:bg-green-600', 'text-white');
            btn.innerHTML = '<i class="fas fa-calendar-times ml-1"></i> إضافة تعديل مؤقت';
            btn.disabled = false;
        }
    };
    
    const deleteModificationConfirmed = async (modId) => {
        try {
            const response = await fetch(`/api/salon/schedule/modification/${modId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                await loadSchedule();
                showMessage(messageBox, 'تم حذف التعديل بنجاح.', true);
            } else {
                showMessage(messageBox, data.message || 'فشل حذف التعديل.', false);
            }
        } catch (error) {
            console.error('Error deleting modification:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        }
    };
    
    addModificationForm.addEventListener('submit', addModification);


    // ===========================================
    // SECTION 3: Salon Profile & Services Logic
    // ===========================================

    // --- Salon Info ---
    const populateCityDropdowns = async (selectedCity = null) => {
        try {
            const response = await fetch('/api/cities');
            const cities = await response.json();
            
            infoCity.innerHTML = '<option value="" disabled selected>المدينة</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === selectedCity) {
                    option.selected = true;
                }
                infoCity.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading cities:', error);
            showMessage(messageBox, 'فشل تحميل قائمة المدن.', false);
        }
    };

    // Readonly display and edit toggle elements (already declared above)

    const dispSalonName = document.getElementById('disp-salon-name');
    const dispOwnerName = document.getElementById('disp-owner-name');
    const dispSalonPhone = document.getElementById('disp-salon-phone');
    const dispOwnerPhone = document.getElementById('disp-owner-phone');
    const dispAddress = document.getElementById('disp-address');
    const dispCity = document.getElementById('disp-city');
    const dispGenderFocus = document.getElementById('disp-gender-focus');
    const dispStatus = document.getElementById('disp-status');
    const dispImage = document.getElementById('disp-image');

    const updateSalonInfoDisplay = (info) => {
        const show = (el, val) => { el.textContent = (val && String(val).trim()) ? val : '...'; };
        try {
            // Update editable salon name input
            const editableSalonName = document.getElementById('editable-salon-name');
            if (editableSalonName) {
                editableSalonName.value = info.salon_name || '';
                editableSalonName.dataset.originalValue = info.salon_name || '';
            }
            
            show(dispOwnerName, info.owner_name);
            show(dispSalonPhone, info.salon_phone);
            show(dispOwnerPhone, info.owner_phone);
            show(dispAddress, info.address);
            show(dispCity, info.city);
            dispGenderFocus.textContent = info.gender_focus === 'women' ? 'نساء' : 'رجال';
            // Map backend status to user-facing Arabic labels
            const statusMap = { accepted: 'نشط', pending: 'قيد الانتظار', rejected: 'مرفوض' };
            if (dispStatus) {
                const s = (info.status || '').toLowerCase();
                dispStatus.textContent = statusMap[s] || 'غير معروف';
            }
            const fallbackInitial = (info.salon_name || 'S').charAt(0);
            
            // Update editable profile image
            const editableProfileImg = document.getElementById('editable-profile-img');
            if (editableProfileImg) {
                editableProfileImg.src = (info.image_url && !info.image_url.includes('placehold.co'))
                    ? info.image_url
                    : `https://placehold.co/80x80/ccc/333?text=${fallbackInitial}`;
                editableProfileImg.dataset.originalSrc = editableProfileImg.src;
            }
        } catch (e) {
            console.warn('Failed to update display:', e);
        }
    };
    // Expose globally to avoid scope issues in event handlers elsewhere
    window.updateSalonInfoDisplay = updateSalonInfoDisplay;

    const setEditMode = (isEditing) => {
        const displayEl = salonInfoDisplay;
        const formEl = salonInfoForm;
        const editBtnEl = btnEditInfo;
        const cancelBtnEl = btnCancelEdit;

        if (isEditing) {
            if (displayEl) displayEl.classList.add('hidden');
            if (formEl) formEl.classList.remove('hidden');
            if (editBtnEl) editBtnEl.classList.add('hidden');
            if (cancelBtnEl) cancelBtnEl.classList.remove('hidden');
        } else {
            if (displayEl) displayEl.classList.remove('hidden');
            if (formEl) formEl.classList.add('hidden');
            if (editBtnEl) editBtnEl.classList.remove('hidden');
            if (cancelBtnEl) cancelBtnEl.classList.add('hidden');
        }
    };

    // Toggle handlers
    if (btnEditInfo) {
        btnEditInfo.addEventListener('click', openEditModal);
    }
    if (btnCancelEdit) {
        btnCancelEdit.addEventListener('click', () => {
            // Reset form values to current saved state
            if (currentSalon) {
                infoSalonName.value = currentSalon.salon_name || '';
                infoOwnerName.value = currentSalon.owner_name || '';
                infoSalonPhone.value = currentSalon.salon_phone || '';
                infoOwnerPhone.value = currentSalon.owner_phone || '';
                infoAddress.value = currentSalon.address || '';
                infoGenderFocus.value = currentSalon.gender_focus || 'men';
                populateCityDropdowns(currentSalon.city);
            }
            // Removed edit mode toggling; keep display as-is
        });
    }

    const loadSalonInfo = async () => {
        // Fetch full profile info for update fields
        console.log('=== LOAD SALON INFO CALLED ===');
        if (!userId) {
            console.error('ERROR: userId is null/undefined!');
            return;
        }
        
        try {
            // CRITICAL FIX: Use the userId for the API call, as the server handles the join
            const requestBody = { user_type: 'salon', userId: userId };
            console.log('Sending request to /api/user/profile with body:', requestBody);
            
            const response = await fetch('/api/user/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            console.log('Profile API response data:', data);
            
            // Normalize keys from backend to handle different casings/aliases
            const info = {
                ...data,
                userId: (data.userId !== undefined ? data.userId : (data.userid !== undefined ? data.userid : userId)),
                salonId: (data.salonId !== undefined ? data.salonId : (data.salonid !== undefined ? data.salonid : (data.id !== undefined ? data.id : salonId)))
            };
            
            // Proceed only if we have a valid salonId
            if (info.salonId) {

                await populateCityDropdowns(info.city);

                // Populate all form fields correctly
                infoSalonName.value = info.salon_name || '';
                infoOwnerName.value = info.owner_name || '';
                infoSalonPhone.value = info.salon_phone || '';
                infoOwnerPhone.value = info.owner_phone || ''; 
                infoAddress.value = info.address || '';
                infoGenderFocus.value = info.gender_focus || 'men';
                
                // Update local state (CRITICAL: Preserve both userId and salonId)
                currentSalon = { 
                    ...currentSalon, 
                    ...info, 
                    // Explicitly re-set/confirm primary IDs and core fields for safety
                    userId: info.userId, 
                    salonId: info.salonId, 
                    salon_name: info.salon_name, 
                    gender_focus: info.gender_focus,
                    owner_phone: info.owner_phone, 
                    image_url: info.image_url
                };
                localStorage.setItem('salonni_user', JSON.stringify(currentSalon));
                
                // Display existing image if available
                const imagePreview = document.getElementById('image-preview');
                const imagePlaceholder = document.getElementById('image-placeholder');

                if (info.image_url && !info.image_url.includes('placehold.co')) {
                    imagePreview.src = info.image_url;
                    imagePreview.classList.remove('hidden');
                    if (imagePlaceholder) imagePlaceholder.classList.add('hidden');
                } else {
                    imagePreview.classList.add('hidden');
                    if (imagePlaceholder) imagePlaceholder.classList.remove('hidden');
                }

                // Populate readonly display
                updateSalonInfoDisplay(info);
                // Default to display mode; edit mode removed
            } else {
                showMessage(messageBox, 'فشل تحميل معلومات الصالون.', false);
            }
        } catch (error) {
            console.error('Error loading salon info:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        }
    };

    // --- Image Handling ---
    const convertImageToBase64 = (file) => {
        return new Promise((resolve, reject) => {
            try {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_DIMENSION = 1024; // cap image size
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        // Resize maintaining aspect ratio
                        if (width > height && width > MAX_DIMENSION) {
                            height = Math.round(height * (MAX_DIMENSION / width));
                            width = MAX_DIMENSION;
                        } else if (height >= width && height > MAX_DIMENSION) {
                            width = Math.round(width * (MAX_DIMENSION / height));
                            height = MAX_DIMENSION;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Compress using JPEG at moderate quality
                        const QUALITY = 0.7;
                        const base64 = canvas.toDataURL('image/jpeg', QUALITY);
                        resolve(base64);
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            } catch (e) {
                reject(e);
            }
        });
    };

    // Expose globally so other script blocks/handlers can access it
    window.convertImageToBase64 = convertImageToBase64;

    // Image preview functionality
    const imageInput = document.getElementById('info-salon-image');
    const imagePreview = document.getElementById('image-preview');
    const imagePlaceholder = document.getElementById('image-placeholder');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                // No need to convert to base64 for preview, direct object URL is faster
                const url = URL.createObjectURL(file);
                imagePreview.src = url;
                imagePreview.loading = 'lazy';
                imagePreview.decoding = 'async';
                imagePreview.classList.remove('hidden');
                if (imagePlaceholder) imagePlaceholder.classList.add('hidden');

                // Ensure the preview container only shows the image
                imagePreviewContainer.innerHTML = '';
                imagePreviewContainer.appendChild(imagePreview);
            } catch (error) {
                console.error('Error generating image preview:', error);
                showMessage(messageBox, 'خطأ في معالجة الصورة', false);
            }
        }
    });

    const saveSalonInfo = async (e) => {
        e.preventDefault();
        
        // Get form elements
        const infoSalonName = document.getElementById('info-salon-name');
        const infoOwnerName = document.getElementById('info-owner-name');
        const infoSalonPhone = document.getElementById('info-salon-phone');
        const infoOwnerPhone = document.getElementById('info-owner-phone');
        const infoAddress = document.getElementById('info-address');
        const infoCity = document.getElementById('info-city');
        const infoGenderFocus = document.getElementById('info-gender-focus');
        
        // Handle image file - required if no existing image
        let imageUrl = currentSalon.image_url; // Keep existing image by default
        const imageFile = imageInput.files[0];
        
        // Check if image is required (no existing image or existing image is placeholder)
        const isDefaultPlaceholder = !imageUrl || imageUrl.includes('placehold.co');
        
        if (imageFile) {
            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('salon_id', salonId);
                const uploadResp = await fetch(`/api/upload?salon_id=${salonId}`, {
                    method: 'POST',
                    body: formData
                });
                const uploadJson = await uploadResp.json();
                if (!uploadResp.ok || !uploadJson.success) {
                    throw new Error(uploadJson.message || 'فشل رفع الصورة');
                }
                imageUrl = uploadJson.image_url;
            } catch (error) {
                console.error('Error uploading image:', error);
                showMessage(messageBox, 'خطأ في رفع الصورة', false);
                return;
            }
        } else if (isDefaultPlaceholder) {
            showMessage(messageBox, 'يرجى اختيار صورة للصالون', false);
            return;
        }
        
        // Collect all data for the update
        const infoData = {
            salon_name: infoSalonName.value,
            owner_name: infoOwnerName.value,
            salon_phone: infoSalonPhone.value,
            owner_phone: infoOwnerPhone.value, 
            address: infoAddress.value,
            city: infoCity.value,
            gender_focus: infoGenderFocus.value,
            image_url: imageUrl 
        };
        
        try {
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري التحديث';

            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/info/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(infoData),
            });
            const data = await response.json();
            if (data.success) {
                // Reload info to update local state (currentSalon)
                await loadSalonInfo(); 
                showMessage(messageBox, 'تم تحديث المعلومات الأساسية بنجاح.', true);
                
                // If gender focus changed, reload service management
                if (infoData.gender_focus !== currentSalon.gender_focus) {
                    currentSalon.gender_focus = infoData.gender_focus; // Update locally immediately
                    await loadServiceManagement(infoData.gender_focus);
                }

                // Edit mode removed; keep current display
            } else {
                showMessage(messageBox, data.message || 'فشل تحديث المعلومات.', false);
            }
        } catch (error) {
            console.error('Error saving salon info:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            salonInfoForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-sync-alt ml-1"></i> تحديث المعلومات الأساسية';
            salonInfoForm.querySelector('button[type="submit"]').disabled = false;
        }
    };
    
    salonInfoForm.addEventListener('submit', saveSalonInfo);


    // --- Service Management ---
    const generateDurationOptions = (selectedDuration) => {
        let options = '';
        for (let min = 5; min <= 120; min += 5) {
            options += `<option value="${min}" ${min === selectedDuration ? 'selected' : ''}>${min} دقيقة</option>`;
        }
        return options;
    };

    const renderServiceCards = (masterServices, salonServices) => {
        servicesListContainer.innerHTML = '';
        
        // FIX: Ensure salonServices are correctly mapped to master service IDs for lookup
        const salonServicesMap = new Map();
        salonServices.forEach(s => salonServicesMap.set(s.id, s));

        if (!masterServices || masterServices.length === 0) {
            renderEmptyState(servicesListContainer, `لا توجد خدمات رئيسية متاحة لهذه الفئة (${currentSalon.gender_focus === 'men' ? 'رجال' : 'نساء'}).`, 'fa-wrench');
            return;
        }

        // Separate main services and add-ons
        const mainServices = masterServices.filter(service => service.service_type === 'main');
        const addOnServices = masterServices.filter(service => service.service_type === 'add_on');

        // Render main services section
        if (mainServices.length > 0) {
            const mainHeader = document.createElement('div');
            mainHeader.className = 'mb-4';
            mainHeader.innerHTML = `
                <div class="flex items-center justify-between">
                  <button id="btn-salon-more-main" class="py-2 px-4 rounded-xl border hover:bg-gray-100 font-bold text-primary-dark">
                    <i class="fas fa-cut ml-2 text-secondary"></i>الخدمات الأساسية
                  </button>
                </div>
                <p class="text-gray-600 text-sm">الخدمات التي تحتاج وقت محدد في الجدولة</p>
            `;
            servicesListContainer.appendChild(mainHeader);
            const mainList = document.createElement('div');
            mainList.id = 'main-list-container';
            servicesListContainer.appendChild(mainList);

            // Only render currently selected main services
            const selectedMainServices = (Array.isArray(salonServices) ? salonServices : []).filter(s => s.service_type === 'main');
            selectedMainServices.forEach(sel => {
                const master = mainServices.find(ms => ms.id === (sel.id ?? sel.service_id));
                if (!master) return;
                ensureServiceCardRendered(master, parseFloat(sel.price), parseInt(sel.duration));
            });
        }

        // Render add-ons section (modal-only, no pre-rendered cards)
        if (addOnServices.length > 0) {
            const addOnHeader = document.createElement('div');
            addOnHeader.className = 'mb-4 mt-8';
            addOnHeader.innerHTML = `
                <div class="flex items-center justify-between">
                  <button id="btn-salon-more-addons" class="py-2 px-4 rounded-xl border hover:bg-gray-100 font-bold text-primary-dark">
                    <i class="fas fa-plus-circle ml-2 text-orange-500"></i>الإضافات
                  </button>
                </div>
                <p class="text-gray-600 text-sm">خدمات إضافية لا تحتاج وقت في الجدولة (المدة تلقائياً 0 دقيقة)</p>
            `;
            servicesListContainer.appendChild(addOnHeader);
            const addOnList = document.createElement('div');
            addOnList.id = 'add-on-list-container';
            servicesListContainer.appendChild(addOnList);
            // Render only currently selected add-ons
            const selectedAddOnServices = (Array.isArray(salonServices) ? salonServices : []).filter(s => s.service_type === 'add_on');
            selectedAddOnServices.forEach(sel => {
                const master = addOnServices.find(ms => ms.id === (sel.id ?? sel.service_id));
                if (!master) return;
                ensureServiceCardRendered(master, parseFloat(sel.price), 0);
            });
        }

        attachServiceListeners();

        // Expose data for modal and wire triggers
        window.masterServicesCache = masterServices;
        window.salonServicesCache = salonServices;
        document.getElementById('btn-salon-more-main')?.addEventListener('click', () => {
            openSalonServicesExplorer('main');
        });
        document.getElementById('btn-salon-more-addons')?.addEventListener('click', () => {
            openSalonServicesExplorer('add_on');
        });
    };

    const attachServiceListeners = () => {
        // Wire remove buttons for any existing cards
        document.querySelectorAll('.remove-service-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const card = e.currentTarget.closest('[data-service-id]');
                if (card) {
                    card.remove();
                    scheduleAutoSave();
                }
            });
        });

        // Wire inputs to auto-save
        document.querySelectorAll('.details-inputs input[data-type="price"], .details-inputs select[data-type="duration"], .details-inputs input[data-type="duration"]').forEach(input => {
            ['input','change'].forEach(ev => input.addEventListener(ev, scheduleAutoSave));
        });
    };

    // --- Auto-save helpers ---
    let autoSaveTimer = null;
    const collectSelectedServicesFromDOM = () => {
        const selected = [];
        let hasError = false;
        document.querySelectorAll('[data-service-id]').forEach(card => {
            const serviceId = card.getAttribute('data-service-id');
            const serviceType = card.getAttribute('data-service-type');
            const isManual = card.getAttribute('data-is-manual') === 'true';
            
            // Skip manual services from auto-save - they are handled separately
            if (isManual) {
                return;
            }
            
            const priceInput = card.querySelector('.details-inputs input[data-type="price"]');
            const durationElement = serviceType === 'add_on'
                ? card.querySelector('.details-inputs input[data-type="duration"]')
                : card.querySelector('.details-inputs select[data-type="duration"]');
            const price = priceInput ? parseFloat(priceInput.value) : NaN;
            const duration = durationElement ? parseInt(durationElement.value) : NaN;
            if (isNaN(price) || price <= 0) {
                showMessage(servicesMessage, 'يرجى إدخال سعر صحيح (أكبر من صفر).', false);
                hasError = true;
                return;
            }
            if (serviceType === 'main' && (isNaN(duration) || duration <= 0)) {
                showMessage(servicesMessage, 'يرجى تحديد مدة صحيحة للخدمة الأساسية.', false);
                hasError = true;
                return;
            }
            selected.push({
                service_id: parseInt(serviceId),
                price,
                duration: serviceType === 'add_on' ? 0 : duration,
                service_type: serviceType
            });
        });
        return { selected, hasError };
    };

    const showSavingMini = () => {
        if (document.getElementById('saving-mini')) return;
        const el = document.createElement('div');
        el.id = 'saving-mini';
        el.className = 'fixed bottom-4 right-4 z-50 bg-white rounded-xl shadow p-2 text-sm flex items-center';
        el.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الحفظ...';
        document.body.appendChild(el);
    };
    const hideSavingMini = () => {
        const el = document.getElementById('saving-mini');
        if (el) el.remove();
    };

    const autoSaveServices = async () => {
        const { selected, hasError } = collectSelectedServicesFromDOM();
        if (hasError || selected.length === 0) { hideSavingMini(); return; }
        try {
            const response = await fetch(`/api/salon/services/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ services: selected })
            });
            const data = await response.json();
            if (!data.success) {
                showMessage(servicesMessage, data.message || 'فشل في الحفظ التلقائي.', false);
            } else {
                // Reflect latest selection to cache (optional)
                window.salonServicesCache = selected.map(s => ({ id: s.service_id, price: s.price, duration: s.duration, service_type: s.service_type }));
                showMessage(servicesMessage, 'تم الحفظ تلقائيًا.', true);
                setTimeout(() => { servicesMessage.textContent = ''; }, 1500);
            }
        } catch (e) {
            console.error('Auto-save error:', e);
            showMessage(servicesMessage, 'خطأ في الشبكة أثناء الحفظ التلقائي.', false);
        } finally {
            hideSavingMini();
        }
    };

    const scheduleAutoSave = () => {
        try {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            showSavingMini();
            autoSaveTimer = setTimeout(autoSaveServices, 800);
        } catch (_) {}
    };
    // Expose debounced auto-save globally for external scripts
    window.scheduleAutoSave = scheduleAutoSave;

    const loadServiceManagement = async (genderFocus) => {
        console.log('Loading service management for genderFocus:', genderFocus, 'and salonId:', salonId);
        servicesListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">جاري تحميل قائمة الخدمات...</p>';
        try {
            // Fetch Master services first
            console.log('Fetching master services for gender:', genderFocus);
            const masterResponse = await fetch(`/api/services/master/${genderFocus}`);
            console.log('Master services response status:', masterResponse.status);
            const masterData = await masterResponse.json();
            console.log('Master services data:', masterData);
            
            // Then fetch Salon's active services
            // CRITICAL FIX: Use salonId for business-related API calls
            console.log('Fetching salon services for salonId:', salonId);
            const salonResponse = await fetch(`/api/salon/services/${salonId}`);
            console.log('Salon services response status:', salonResponse.status);
            const salonData = await salonResponse.json();
            console.log('Salon services data:', salonData);

            if (masterData.success && salonData.success) {
                renderServiceCards(masterData.services, salonData.services);
            } else {
                showMessage(servicesMessage, 'فشل تحميل الخدمات الرئيسية أو خدمات الصالون.', false);
                renderEmptyState(servicesListContainer, 'فشل تحميل قائمة الخدمات.', 'fa-server');
            }
        } catch (error) {
            console.error('Error loading service data:', error);
            showMessage(servicesMessage, 'فشل الاتصال بـ API إدارة الخدمات.', false);
            renderEmptyState(servicesListContainer, 'فشل تحميل قائمة الخدمات.', 'fa-server');
        }
    };

    const saveServices = async () => {
        const selectedServices = [];
        let validationError = false;

        document.querySelectorAll('[data-service-id]').forEach(card => {
            const serviceId = card.getAttribute('data-service-id');
            const serviceType = card.getAttribute('data-service-type');

            const priceInput = card.querySelector('.details-inputs input[data-type="price"]');
            const durationElement = serviceType === 'add_on'
                ? card.querySelector('.details-inputs input[data-type="duration"]')
                : card.querySelector('.details-inputs select[data-type="duration"]');

            const price = priceInput ? parseFloat(priceInput.value) : NaN;
            const duration = durationElement ? parseInt(durationElement.value) : NaN;

            if (isNaN(price) || price <= 0) {
                showMessage(servicesMessage, `يرجى إدخال سعر صحيح (أكبر من صفر) للخدمة.`, false);
                validationError = true;
                return;
            }

            if (serviceType === 'main' && (isNaN(duration) || duration <= 0)) {
                showMessage(servicesMessage, `يرجى تحديد مدة صحيحة (أكبر من صفر) للخدمة الأساسية.`, false);
                validationError = true;
                return;
            }

            // For add-on services, allow duration to be 0 or any positive value
            if (serviceType === 'add_on' && (isNaN(duration) || duration < 0)) {
                showMessage(servicesMessage, `يرجى إدخال مدة صحيحة (0 أو أكثر) للخدمة الإضافية.`, false);
                validationError = true;
                return;
            }

            selectedServices.push({
                service_id: parseInt(serviceId),
                price: price,
                duration: duration
            });
        });
        
        if (validationError) return;

        if (selectedServices.length === 0) {
            showMessage(servicesMessage, 'يرجى اختيار خدمة واحدة على الأقل للحفظ.', false);
            return;
        }

        try {
            // Show overlay while saving and reloading
            const overlay = document.createElement('div');
            overlay.id = 'saving-overlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
            overlay.innerHTML = '<div class="bg-white rounded-2xl shadow-xl p-4 text-center"><i class="fas fa-spinner fa-spin ml-2"></i> جاري حفظ الخدمات...</div>';
            document.body.appendChild(overlay);

            if (saveServicesBtn) {
                saveServicesBtn.disabled = true;
                saveServicesBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الحفظ...';
            }

            // CRITICAL FIX: Use salonId for business-related API calls
            const response = await fetch(`/api/salon/services/${salonId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ services: selectedServices })
            });

            const data = await response.json();
            
            if (data.success) {
                showMessage(servicesMessage, 'تم حفظ الخدمات بنجاح!', true);
                await loadServiceManagement(currentSalon.gender_focus);
            } else {
                showMessage(servicesMessage, data.message || 'فشل في حفظ الخدمات.', false);
            }
        } catch (error) {
            console.error('Save services error:', error);
            showMessage(servicesMessage, 'خطأ في الشبكة أثناء عملية الحفظ.', false);
        } finally {
            if (saveServicesBtn) {
                saveServicesBtn.disabled = false;
                saveServicesBtn.innerHTML = '<i class="fas fa-save ml-2"></i> حفظ الخدمات والأسعار';
            }
            const ov = document.getElementById('saving-overlay');
            if (ov) ov.remove();
        }
    };
    // Manual save removed; guard listener
    if (saveServicesBtn) {
        saveServicesBtn.addEventListener('click', saveServices);
    }
    

    // --- Initialization and Event Attachments ---
    
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const view = e.currentTarget.getAttribute('data-view');
            showView(view);
            // Scroll to the absolute top of the page (no section heading)
            window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        });
    });

    showView('appointments-view');

    // Ensure edit button is visible by default
    if (btnEditInfo) {
        btnEditInfo.classList.remove('hidden');
        btnEditInfo.style.display = 'inline-flex';
    }
    
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        // Use the unified confirmation modal for logout confirmation
        showConfirmationModal('هل أنت متأكد من أنك تريد تسجيل الخروج؟', () => {
            localStorage.removeItem('salonni_user');
            localStorage.removeItem('salonni_token');
            console.log('Salon logging out.');
            window.location.replace('/auth.html');
        }, 'تسجيل الخروج');
    });
});
    // Global helper: generate 5–120 minute options for duration selects
    function generateDurationOptions(selectedDuration) {
      let options = '';
      for (let min = 5; min <= 120; min += 5) {
        options += `<option value="${min}" ${min === selectedDuration ? 'selected' : ''}>${min} دقيقة</option>`;
      }
      return options;
    }
    // Helper: ensure a service card exists; create dynamically if missing
    function ensureServiceCardRendered(service, priceOverride, durationOverride) {
      const existing = document.querySelector(`[data-service-id="${service.id}"]`);
      if (existing) return existing;

      const isAddOn = service.service_type === 'add_on';
      const containerId = isAddOn ? 'add-on-list-container' : 'main-list-container';
      const container = document.getElementById(containerId);
      if (!container) return null;

      const initialPrice = typeof priceOverride === 'number' ? priceOverride : (isAddOn ? 25 : 50);
      const initialDuration = typeof durationOverride === 'number' ? durationOverride : (isAddOn ? 0 : 30);

      const card = document.createElement('div');
      card.className = `p-4 rounded-xl shadow-md border transition-all duration-300 mb-3 ${isAddOn ? 'border-orange-400 bg-orange-50' : 'border-secondary bg-secondary-soft'}`;
      card.setAttribute('data-service-id', service.id);
      card.setAttribute('data-service-type', service.service_type);
      
      // Mark manual services to exclude them from auto-save
      if (service.is_manual) {
        card.setAttribute('data-is-manual', 'true');
      }

      const header = `
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center space-x-3 space-x-reverse">
            <label class="text-lg font-bold text-primary-dark">
              <i class="fas ${service.icon} ml-2 ${isAddOn ? 'text-orange-500' : 'text-secondary'}"></i> ${service.name_ar}
              ${isAddOn ? '<span class="text-sm text-orange-600 font-normal mr-2">(إضافة)</span>' : ''}
            </label>
          </div>
          <button class="remove-service-btn py-1 px-3 rounded-xl border hover:bg-gray-100" data-id="${service.id}">
            <i class="fas fa-trash-alt ml-2"></i>إزالة
          </button>
        </div>`;
      const details = isAddOn ? `
        <div class="details-inputs space-y-3 pt-3 border-t opacity-100" data-id="${service.id}">
          <div class="flex space-x-4 space-x-reverse">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">السعر (ILS)</label>
              <input type="number" data-id="${service.id}" data-type="price" value="${initialPrice}" min="5" step="5" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg text-right">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">المدة (دقيقة)</label>
              <input type="number" data-id="${service.id}" data-type="duration" value="0" min="0" step="5" class="mt-1 w-full p-2 border border-gray-300 rounded-lg text-right" placeholder="0">
            </div>
          </div>
        </div>` : `
        <div class="details-inputs space-y-3 pt-3 border-t opacity-100" data-id="${service.id}">
          <div class="flex space-x-4 space-x-reverse">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">السعر (ILS)</label>
              <input type="number" data-id="${service.id}" data-type="price" value="${initialPrice}" min="5" step="5" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg text-right">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">المدة</label>
              <select data-id="${service.id}" data-type="duration" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg appearance-none text-right">
                ${generateDurationOptions(initialDuration)}
              </select>
            </div>
          </div>
        </div>`;
      card.innerHTML = header + details;

      container.appendChild(card);
      // Wire remove button
      const removeBtn = card.querySelector('.remove-service-btn');
      removeBtn?.addEventListener('click', () => {
        card.remove();
        scheduleAutoSave();
      });

      // Wire inputs for auto-save
      const priceInput = card.querySelector('input[data-type="price"]');
      const durationInput = service.service_type === 'add_on'
        ? card.querySelector('input[data-type="duration"]')
        : card.querySelector('select[data-type="duration"]');
      ['input','change'].forEach(ev => {
        if (priceInput) priceInput.addEventListener(ev, scheduleAutoSave);
        if (durationInput) durationInput.addEventListener(ev, scheduleAutoSave);
      });
      return card;
    }
</script>
<script>
// Shared services explorer for salon (search + category + inline price/duration + add)
function openSalonServicesExplorer(prefCategory = 'all') {
  const allServices = Array.isArray(window.masterServicesCache) ? window.masterServicesCache : [];
  const current = new Map(
    (Array.isArray(window.salonServicesCache) ? window.salonServicesCache : []).map(s => [s.id, s])
  );
  if (!allServices.length) return;

  let modal = document.getElementById('salon-services-explorer-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'salon-services-explorer-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
    modal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-xl w-11/12 max-w-2xl p-4 text-right">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center">
            <i class="fas fa-search text-secondary ml-2 text-xl"></i>
            <h3 class="text-lg font-bold text-primary-dark">إدارة الخدمات السريعة</h3>
          </div>
          <button id="salon-explorer-close" class="py-1 px-3 rounded-xl border">إغلاق</button>
        </div>
        <div class="flex items-center gap-2 mb-3">
          <input id="salon-explorer-search" type="text" class="flex-1 border rounded-xl px-3 py-2" placeholder="ابحث باسم الخدمة...">
          <select id="salon-explorer-category" class="border rounded-xl px-2 py-2">
            <option value="all">الكل</option>
            <option value="main">الأساسية</option>
            <option value="add_on">الإضافات</option>
          </select>
        </div>
        <div id="salon-explorer-list" class="max-h-96 overflow-y-auto space-y-2"></div>
        <div class="mt-3 text-xs text-gray-500">يتم حفظ التغييرات تلقائيًا.</div>
      </div>`;
    document.body.appendChild(modal);
  }

  const closeBtn = modal.querySelector('#salon-explorer-close');
  const searchInput = modal.querySelector('#salon-explorer-search');
  const categorySelect = modal.querySelector('#salon-explorer-category');
  const listEl = modal.querySelector('#salon-explorer-list');

  const renderList = () => {
    const q = (searchInput.value || '').trim();
    const cat = categorySelect.value;
    const chosenIds = new Set(Array.from(document.querySelectorAll('[data-service-id]')).map(el => parseInt(el.getAttribute('data-service-id'))));
    const filtered = allServices.filter(s => {
      const matchesCat = cat === 'all' ? true : s.service_type === cat;
      const matchesQuery = q ? (s.name_ar || '').includes(q) : true;
      return matchesCat && matchesQuery && !chosenIds.has(s.id);
    });

    listEl.innerHTML = filtered.map(s => {
      const price = (s.service_type === 'add_on' ? 25 : 50);
      const duration = (s.service_type === 'add_on' ? 0 : 30);
      const isAddOn = s.service_type === 'add_on';
      return `
        <div class="border rounded-xl p-3 flex items-center justify-between">
          <div class="flex-1">
            <div class="font-bold text-primary-dark">${s.name_ar}</div>
            <div class="text-sm ${isAddOn ? 'text-orange-600' : 'text-gray-600'}">${isAddOn ? 'إضافة' : 'خدمة أساسية'}</div>
          </div>
          <div class="flex items-center gap-2">
            <input type="number" class="w-24 p-2 border rounded-lg text-right" data-field="price" data-id="${s.id}" value="${price}" min="5" step="5" placeholder="السعر">
            ${isAddOn
              ? `<input type="number" class="w-20 p-2 border rounded-lg text-right" data-field="duration" data-id="${s.id}" value="0" min="0" step="5" placeholder="0">`
              : `<select class="w-24 p-2 border rounded-lg text-right" data-field="duration" data-id="${s.id}">${[...Array(24)].map((_,i)=>{const v=(i+1)*5;return `<option value="${v}" ${v===duration?'selected':''}>${v} دقيقة</option>`}).join('')}</select>`
            }
            <button class="py-1.5 px-3 rounded-xl btn-action" data-action="add" data-id="${s.id}">إضافة</button>
          </div>
        </div>`;
    }).join('');

    // Wire add buttons
    listEl.querySelectorAll('button[data-action="add"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.getAttribute('data-id'));
        const s = allServices.find(x => x.id === id);
        if (!s) return;
        const priceEl = listEl.querySelector(`input[data-field="price"][data-id="${id}"]`);
        const durEl = s.service_type === 'add_on' 
          ? listEl.querySelector(`input[data-field="duration"][data-id="${id}"]`)
          : listEl.querySelector(`select[data-field="duration"][data-id="${id}"]`);
        const price = priceEl ? parseFloat(priceEl.value) : (s.service_type === 'add_on' ? 25 : 50);
        const duration = durEl ? parseInt(durEl.value) : (s.service_type === 'add_on' ? 0 : 30);

        // Ensure card exists (especially for add-ons) and reflect selection
        let card = document.querySelector(`[data-service-id="${id}"]`);
        if (!card) {
          card = ensureServiceCardRendered(s, price, duration);
        }
        const details = card?.querySelector(`.details-inputs[data-id="${id}"]`);
        const priceInput = details?.querySelector('input[data-type="price"]');
        const durationInput = s.service_type === 'add_on'
          ? details?.querySelector('input[data-type="duration"]')
          : details?.querySelector('select[data-type="duration"]');
        if (priceInput) priceInput.value = isNaN(price) ? (s.service_type === 'add_on' ? 25 : 50) : price;
        if (durationInput) durationInput.value = isNaN(duration) ? (s.service_type === 'add_on' ? 0 : 30) : duration;
        // Trigger auto-save after adding
        scheduleAutoSave();

        // Visual cue and ensure immediate visibility
        if (card) {
          try {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const oldShadow = card.style.boxShadow;
            card.style.boxShadow = '0 0 0 3px rgba(56, 189, 248, 0.5)';
            setTimeout(() => { card.style.boxShadow = oldShadow || ''; }, 700);
          } catch (_) {}
        }
      });
    });
  };

  modal.classList.remove('hidden');
  categorySelect.value = ['main','add_on'].includes(prefCategory) ? prefCategory : 'all';
  renderList();

  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', (e) => { if (e.target.id === 'salon-services-explorer-modal') modal.classList.add('hidden'); });
  searchInput.addEventListener('input', renderList);
  categorySelect.addEventListener('change', renderList);
}
</script>
<!-- Socket.IO client for real-time updates -->
<script src="/socket.io/socket.io.js"></script>
<!-- Note: WebSocket initialization is now handled in the main script above -->

<!-- Update Available Modal -->
<div id="update-modal" class="update-modal">
  <div class="update-modal-content">
    <div class="update-icon">
      <i class="fas fa-sync-alt"></i>
    </div>
    <h3 class="text-xl font-bold text-primary-dark mb-2">تحديث جديد متاح</h3>
    <p class="text-gray-600 mb-6">إصدار جديد من التطبيق متاح الآن. قم بالتحديث للحصول على أحدث الميزات والتحسينات.</p>
    <button id="update-btn" class="update-btn">
      <i class="fas fa-download ml-2"></i>
      تحديث الآن
    </button>
  </div>
</div>

<!-- Notification Permission Modal -->
<div id="notify-permission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-xl w-11/12 max-w-md p-6 text-right">
    <div class="flex items-center mb-4">
      <i class="fas fa-bell text-secondary ml-2 text-2xl"></i>
      <h3 class="text-xl font-bold text-primary-dark">تفعيل إشعارات الصالون</h3>
    </div>
    <p class="text-gray-600 mb-4">الإشعارات تضمن وصول التنبيهات عن الحجوزات الجديدة والإلغاءات فورًا. يُنصح بتفعيلها لضمان تجربة أفضل.</p>
    <div class="flex justify-between mt-6">
      <button id="notify-permission-enable" class="btn-action py-2 px-4 rounded-xl font-bold">تفعيل الإشعارات</button>
      <button id="notify-permission-later" class="py-2 px-4 rounded-xl border">لاحقًا</button>
    </div>
  </div>
</div>
<script>
  // Controlled Notification Permission Flow
  (function(){
    const modal = document.getElementById('notify-permission-modal');
    const enableBtn = document.getElementById('notify-permission-enable');
    const laterBtn = document.getElementById('notify-permission-later');
    const STORAGE_KEY = 'saloony_notify_later';

    function shouldShowModal() {
      if (!('Notification' in window)) return false;
      const permission = Notification.permission;
      if (permission === 'granted') return false;
      const snoozeUntil = localStorage.getItem(STORAGE_KEY);
      if (snoozeUntil && Date.now() < parseInt(snoozeUntil)) return false;
      return true;
    }

    function showModalIfNeeded() {
      if (shouldShowModal()) {
        modal.classList.remove('hidden');
      }
    }

    async function ensureSW() {
      if ('serviceWorker' in navigator) {
        try {
          const reg = await navigator.serviceWorker.getRegistration();
          if (!reg) await navigator.serviceWorker.register('/service-worker.js');
        } catch (e) {}
      }
    }

    enableBtn?.addEventListener('click', async () => {
      modal.classList.add('hidden');
      await ensureSW();
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          // Trigger subscription flow already present in page
          const reg = await navigator.serviceWorker.ready;
          const existing = await reg.pushManager.getSubscription();
          if (!existing) {
            const res = await fetch('/api/push/public-key');
            const { publicKey } = await res.json();
            const vapidKey = publicKey || 'BEluXw4-FAKE-PLACEHOLDER-FALLBACK';
            const toUint8Array = (base64String) => {
              const padding = '='.repeat((4 - base64String.length % 4) % 4);
              const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
              const raw = atob(base64);
              const output = new Uint8Array(raw.length);
              for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
              return output;
            };
            const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: toUint8Array(vapidKey) });
            const raw = localStorage.getItem('salonni_user');
            const user = raw ? JSON.parse(raw) : {};
            await fetch('/api/push/subscribe', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: user.userId || user.id || null, salon_id: user.salonId || null, subscription: sub.toJSON() })
            });
          }
        }
      } catch (e) {}
    });

    // Snooze for 24 hours
    laterBtn?.addEventListener('click', () => {
      const nextTime = Date.now() + 24 * 60 * 60 * 1000;
      localStorage.setItem(STORAGE_KEY, String(nextTime));
      modal.classList.add('hidden');
    });

    // Show modal when page becomes visible (prevents showing during background tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') showModalIfNeeded();
    });
    // Initial check
    showModalIfNeeded();
  })();
</script>

<!-- Inline Profile Editing Script -->
<script>
  // Inline editing functionality for salon name and profile picture
  (function() {
    let hasChanges = false;
    const saveContainer = document.getElementById('profile-save-container');
    const saveButton = document.getElementById('save-profile-changes');
    const editableSalonName = document.getElementById('editable-salon-name');
    const editableProfileImage = document.getElementById('editable-profile-image');
    const editableProfileImg = document.getElementById('editable-profile-img');
    
    // Show message function
    function showMessage(messageBox, message, isSuccess) {
      if (!messageBox) return;
      
      messageBox.textContent = message;
      messageBox.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
      
      if (isSuccess) {
        messageBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
      } else {
        messageBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
      }
      
      messageBox.classList.remove('hidden');
      
      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 5000);
    }
    
    function showSaveButton() {
      if (!hasChanges) {
        hasChanges = true;
        saveContainer.classList.remove('hidden');
      }
    }
    
    function hideSaveButton() {
      hasChanges = false;
      saveContainer.classList.add('hidden');
    }
    
    // Monitor salon name changes
    if (editableSalonName) {
      editableSalonName.addEventListener('input', function() {
        const originalValue = this.dataset.originalValue || '';
        if (this.value.trim() !== originalValue.trim()) {
          showSaveButton();
        } else {
          // Check if image also has no changes
          const originalSrc = editableProfileImg?.dataset.originalSrc || '';
          const currentSrc = editableProfileImg?.src || '';
          if (currentSrc === originalSrc) {
            hideSaveButton();
          }
        }
      });
    }
    
    // Monitor profile image changes
    if (editableProfileImage) {
      editableProfileImage.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            editableProfileImg.src = e.target.result;
            showSaveButton();
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Save changes handler
    if (saveButton) {
      saveButton.addEventListener('click', async function() {
        const messageBox = document.getElementById('profile-save-message');
        
        try {
          saveButton.disabled = true;
          saveButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الحفظ...';
          
          const user = JSON.parse(localStorage.getItem('salonni_user') || '{}');
          
          // Prepare complete salon data like in signup
          const salonData = {
            // Use inline editable name; keep other fields from current user profile
            salon_name: (editableSalonName?.value || '').trim(),
            owner_name: user.owner_name,
            salon_phone: user.salon_phone,
            owner_phone: user.owner_phone,
            address: user.address,
            city: user.city,
            gender_focus: user.gender_focus,
            image_url: user.image_url // Keep existing image by default
          };

          if (!salonData.salon_name) {
            showMessage(messageBox, 'يرجى إدخال اسم الصالون.', false);
            return;
          }
          
          // Handle image upload if changed
          const modalInfoSalonImage = document.getElementById('modal-info-salon-image');
          const editableProfileImage = document.getElementById('editable-profile-image');
          
          // Check both modal image and editable profile image
          let imageFile = null;
          if (modalInfoSalonImage && modalInfoSalonImage.files[0]) {
            imageFile = modalInfoSalonImage.files[0];
          } else if (editableProfileImage && editableProfileImage.files[0]) {
            imageFile = editableProfileImage.files[0];
          }
          
          if (imageFile) {
            try {
              const formData = new FormData();
              formData.append('image', imageFile);
              formData.append('salon_id', user.salonId);
              const uploadResp = await fetch(`/api/upload?salon_id=${user.salonId}`, {
                method: 'POST',
                body: formData
              });
              const uploadJson = await uploadResp.json();
              if (!uploadResp.ok || !uploadJson.success) {
                throw new Error(uploadJson.message || 'فشل رفع الصورة');
              }
              salonData.image_url = uploadJson.image_url;
            } catch (error) {
              console.error('Error uploading image:', error);
              showMessage(messageBox, 'خطأ في رفع الصورة', false);
              return;
            }
          }
          
          const response = await fetch(`/api/salon/info/${user.salonId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(salonData)
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // Update stored user data with all the new information
            const updatedUser = {
              ...user,
              salon_name: salonData.salon_name,
              owner_name: salonData.owner_name,
              salon_phone: salonData.salon_phone,
              owner_phone: salonData.owner_phone,
              address: salonData.address,
              city: salonData.city,
              gender_focus: salonData.gender_focus,
              image_url: data.image_url || salonData.image_url
            };
            
            localStorage.setItem('salonni_user', JSON.stringify(updatedUser));
            
            // Update display elements
            updateSalonInfoDisplay(updatedUser);
            
            // Update image preview if changed
            if (data.image_url) {
              const imagePreview = document.getElementById('image-preview');
              const imagePlaceholder = document.getElementById('image-placeholder');
              imagePreview.src = data.image_url;
              imagePreview.classList.remove('hidden');
              if (imagePlaceholder) imagePlaceholder.classList.add('hidden');
            }
            
            showMessage(messageBox, 'تم حفظ التغييرات بنجاح!', true);
            hideSaveButton();
          } else {
            throw new Error(data.message || 'فشل في حفظ التغييرات');
          }
        } catch (error) {
          console.error('Error saving profile changes:', error);
          showMessage(messageBox, error.message || 'حدث خطأ أثناء حفظ التغييرات', false);
        } finally {
          saveButton.disabled = false;
          saveButton.innerHTML = '<i class="fas fa-save ml-1"></i> حفظ التغييرات';
        }
      });
    }
  })();

  // Invoice Modal Functions
  window.showInvoiceModal = function(payment) {
    const modal = document.getElementById('invoice-modal-overlay');
    if (!modal) return;
    
    // Populate modal with payment data
    const invoiceNumber = document.getElementById('invoice-modal-number');
    const statusContainer = document.getElementById('invoice-status-container');
    const statusIcon = document.getElementById('invoice-status-icon');
    const statusText = document.getElementById('invoice-status-text');
    const invoiceDate = document.getElementById('invoice-date');
    const invoiceType = document.getElementById('invoice-type');
    const invoiceAmount = document.getElementById('invoice-amount');
    const invoiceMethod = document.getElementById('invoice-method');
    const invoiceValidUntil = document.getElementById('invoice-valid-until');
    const invoiceDescription = document.getElementById('invoice-description');
    const invoiceNotes = document.getElementById('invoice-notes');
    
    // Containers for conditional display
    const methodContainer = document.getElementById('invoice-method-container');
    const validContainer = document.getElementById('invoice-valid-container');
    const descriptionContainer = document.getElementById('invoice-description-container');
    const notesContainer = document.getElementById('invoice-notes-container');
    
    // Set invoice number
    if (invoiceNumber) {
      invoiceNumber.textContent = `رقم الفاتورة: ${payment.invoice_number}`;
    }
    
    // Set status
    if (statusContainer && statusIcon && statusText) {
      if (payment.payment_status === 'completed' || payment.payment_status === 'مكتملة') {
        statusContainer.className = 'flex items-center justify-center p-4 rounded-xl bg-green-50 border border-green-200';
        statusIcon.className = 'fas fa-check-circle text-2xl text-green-600';
        statusText.textContent = 'دفع مكتمل';
        statusText.className = 'font-bold text-lg text-green-800';
      } else if (payment.payment_status === 'pending' || payment.payment_status === 'معلق') {
        statusContainer.className = 'flex items-center justify-center p-4 rounded-xl bg-yellow-50 border border-yellow-200';
        statusIcon.className = 'fas fa-clock text-2xl text-yellow-600';
        statusText.textContent = 'دفع معلق';
        statusText.className = 'font-bold text-lg text-yellow-800';
      } else {
        statusContainer.className = 'flex items-center justify-center p-4 rounded-xl bg-red-50 border border-red-200';
        statusIcon.className = 'fas fa-times-circle text-2xl text-red-600';
        statusText.textContent = 'دفع فاشل';
        statusText.className = 'font-bold text-lg text-red-800';
      }
    }
    
    // Set date
    if (invoiceDate) {
      const paymentDate = new Date(payment.created_at).toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      invoiceDate.textContent = paymentDate;
    }
    
    // Set type
    if (invoiceType) {
      const paymentType = payment.payment_type === 'offer_200ils' ? 'عرض شهرين - 200 شيكل' : payment.payment_type;
      invoiceType.textContent = paymentType;
    }
    
    // Set amount
    if (invoiceAmount) {
      invoiceAmount.textContent = `${payment.amount} ${payment.currency}`;
    }
    
    // Set payment method (conditional)
    if (payment.payment_method && methodContainer && invoiceMethod) {
      methodContainer.style.display = 'flex';
      invoiceMethod.textContent = payment.payment_method;
    } else if (methodContainer) {
      methodContainer.style.display = 'none';
    }
    
    // Set valid until (conditional)
    if (payment.valid_until && validContainer && invoiceValidUntil) {
      validContainer.style.display = 'flex';
      const validDate = new Date(payment.valid_until).toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      invoiceValidUntil.textContent = validDate;
    } else if (validContainer) {
      validContainer.style.display = 'none';
    }
    
    // Set description (conditional)
    if (payment.description && descriptionContainer && invoiceDescription) {
      descriptionContainer.style.display = 'block';
      invoiceDescription.textContent = payment.description;
    } else if (descriptionContainer) {
      descriptionContainer.style.display = 'none';
    }
    
    // Set admin notes (conditional)
    if (payment.admin_notes && notesContainer && invoiceNotes) {
      notesContainer.style.display = 'block';
      invoiceNotes.textContent = payment.admin_notes;
    } else if (notesContainer) {
      notesContainer.style.display = 'none';
    }
    
    // Generate QR code for invoice
    generateInvoiceQRCode(payment.invoice_number || payment.id);
    
    // Show modal
    modal.classList.remove('hidden');
  };

  // Function to generate QR code for invoice
  function generateInvoiceQRCode(invoiceNumber) {
    const qrContainer = document.getElementById('invoice-qr-code');
    if (!qrContainer) return;
    
    // Clear previous QR code
    qrContainer.innerHTML = '';
    
    // Create QR code using a simple library-free approach
    // For production, you might want to use a proper QR code library
    const qrData = invoiceNumber;
    const qrSize = 150;
    
    // Create QR code using Google Charts API (simple fallback)
    const qrImg = document.createElement('img');
    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(qrData)}`;
    qrImg.alt = 'Invoice QR Code';
    qrImg.className = 'border-2 border-gray-300 rounded-lg shadow-sm';
    qrImg.style.width = `${qrSize}px`;
    qrImg.style.height = `${qrSize}px`;
    
    qrContainer.appendChild(qrImg);
  }

  window.hideInvoiceModal = function() {
    const modal = document.getElementById('invoice-modal-overlay');
    if (modal) {
      modal.classList.add('hidden');
    }
  };

  // Close modal when clicking outside
  document.getElementById('invoice-modal-overlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
      hideInvoiceModal();
    }
  });

  // Event listeners removed for user invoice filters - users don't need search/filter functionality
</script>

<!-- Manual Service Addition Modal -->
<div id="manual-service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-xl w-11/12 max-w-md p-6 text-right">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center">
        <i class="fas fa-plus-circle text-secondary ml-2 text-2xl"></i>
        <h3 class="text-xl font-bold text-primary-dark">إضافة خدمة يدوياً</h3>
      </div>
      <button id="manual-service-close" class="py-1 px-3 rounded-xl border hover:bg-gray-100">إغلاق</button>
    </div>
    
    <form id="manual-service-form" class="space-y-4">
      <div>
        <label class="block text-sm font-bold text-primary-dark mb-2">اسم الخدمة</label>
        <input type="text" id="manual-service-name" class="w-full border rounded-xl px-3 py-2" placeholder="مثال: قص شعر خاص" required>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-primary-dark mb-2">نوع الخدمة</label>
        <select id="manual-service-type" class="w-full border rounded-xl px-3 py-2" required>
          <option value="">اختر نوع الخدمة</option>
          <option value="main">خدمة أساسية (تحتاج وقت محدد)</option>
          <option value="add_on">خدمة إضافية (لا تحتاج وقت)</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-primary-dark mb-2">السعر (شيكل)</label>
        <input type="number" id="manual-service-price" class="w-full border rounded-xl px-3 py-2" placeholder="50" min="1" required>
      </div>
      
      <div id="manual-service-duration-container">
        <label class="block text-sm font-bold text-primary-dark mb-2">المدة (دقيقة)</label>
        <select id="manual-service-duration" class="w-full p-3 border border-gray-300 rounded-lg">
          <option value="0">0 دقيقة</option>
          <option value="5">5 دقائق</option>
          <option value="10">10 دقائق</option>
          <option value="15">15 دقيقة</option>
          <option value="20">20 دقيقة</option>
          <option value="25">25 دقيقة</option>
          <option value="30" selected>30 دقيقة</option>
          <option value="35">35 دقيقة</option>
          <option value="40">40 دقيقة</option>
          <option value="45">45 دقيقة</option>
          <option value="50">50 دقيقة</option>
          <option value="55">55 دقيقة</option>
          <option value="60">60 دقيقة</option>
          <option value="65">65 دقيقة</option>
          <option value="70">70 دقيقة</option>
          <option value="75">75 دقيقة</option>
          <option value="80">80 دقيقة</option>
          <option value="85">85 دقيقة</option>
          <option value="90">90 دقيقة</option>
          <option value="95">95 دقيقة</option>
          <option value="100">100 دقيقة</option>
          <option value="105">105 دقيقة</option>
          <option value="110">110 دقيقة</option>
          <option value="115">115 دقيقة</option>
          <option value="120">120 دقيقة</option>
        </select>
      </div>
      
      <div class="flex justify-between mt-6">
        <button type="submit" class="bg-gradient-to-r from-secondary to-orange-500 text-white px-6 py-2 rounded-xl font-bold hover:shadow-lg transition-all relative z-10" style="background: linear-gradient(to right, #06C167, #f97316) !important; color: white !important; display: inline-block !important; visibility: visible !important;">
          <i class="fas fa-plus ml-2"></i>إضافة الخدمة
        </button>
        <button type="button" id="manual-service-cancel" class="py-2 px-4 rounded-xl border hover:bg-gray-100">إلغاء</button>
      </div>
    </form>
  </div>
</div>

<script>
// Manual Service Addition Functionality
document.addEventListener('DOMContentLoaded', function() {
  const addManualServiceBtn = document.getElementById('add-manual-service-btn');
  const manualServiceModal = document.getElementById('manual-service-modal');
  const manualServiceForm = document.getElementById('manual-service-form');
  const manualServiceClose = document.getElementById('manual-service-close');
  const manualServiceCancel = document.getElementById('manual-service-cancel');
  const manualServiceType = document.getElementById('manual-service-type');
  const manualServiceDurationContainer = document.getElementById('manual-service-duration-container');
  const servicesMessage = document.getElementById('services-message');

  // Show message function for manual service modal
  function showMessage(messageBox, message, isSuccess) {
    if (!messageBox) return;
    
    messageBox.textContent = message;
    messageBox.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
    
    if (isSuccess) {
      messageBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
    } else {
      messageBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
    }
    
    messageBox.classList.remove('hidden');
    
    setTimeout(() => {
      messageBox.classList.add('hidden');
    }, 5000);
  }

  // Show/hide duration field based on service type
  manualServiceType.addEventListener('change', function() {
    if (this.value === 'add_on') {
      manualServiceDurationContainer.style.display = 'none';
    } else {
      manualServiceDurationContainer.style.display = 'block';
    }
  });

  // Open modal
  addManualServiceBtn.addEventListener('click', function() {
    manualServiceModal.classList.remove('hidden');
    document.getElementById('manual-service-name').focus();
  });

  // Close modal functions
  const closeModal = () => {
    manualServiceModal.classList.add('hidden');
    manualServiceForm.reset();
    manualServiceDurationContainer.style.display = 'block';
  };

  manualServiceClose.addEventListener('click', closeModal);
  manualServiceCancel.addEventListener('click', closeModal);

  // Close modal when clicking outside
  manualServiceModal.addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });

  // Handle form submission
  manualServiceForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const serviceName = document.getElementById('manual-service-name').value.trim();
    const serviceType = document.getElementById('manual-service-type').value;
    const servicePrice = parseFloat(document.getElementById('manual-service-price').value);
    
    // Get duration in minutes directly from number input
    let serviceDuration = 0;
    if (serviceType === 'main') {
      const durationValue = parseInt(document.getElementById('manual-service-duration').value);
      serviceDuration = durationValue || 0;
    }

    if (!serviceName || !serviceType || !servicePrice) {
      showMessage(servicesMessage, 'يرجى ملء جميع الحقول المطلوبة.', false);
      return;
    }

    try {
      // Create a temporary service object with negative ID to distinguish from master services
      // Use a smaller negative number that fits within PostgreSQL integer range (-2147483648 to 2147483647)
      const tempServiceId = -(Math.floor(Math.random() * 1000000) + 1000000);
      const newService = {
        id: tempServiceId,
        name_ar: serviceName,
        service_type: serviceType,
        price: servicePrice,
        duration: serviceDuration,
        is_manual: true
      };

      // Add the service directly to the services list
      const servicesListContainer = document.getElementById('services-list-container');
      
      // Find the appropriate container based on service type
      let targetContainer;
      if (serviceType === 'main') {
        targetContainer = document.getElementById('main-list-container');
        if (!targetContainer) {
          // Create main services section if it doesn't exist
          const mainHeader = document.createElement('div');
          mainHeader.className = 'mb-4';
          mainHeader.innerHTML = `
            <div class="flex items-center justify-between">
              <button id="btn-salon-more-main" class="py-2 px-4 rounded-xl border hover:bg-gray-100 font-bold text-primary-dark">
                <i class="fas fa-cut ml-2 text-secondary"></i>الخدمات الأساسية
              </button>
            </div>
            <p class="text-gray-600 text-sm">الخدمات التي تحتاج وقت محدد في الجدولة</p>
          `;
          servicesListContainer.appendChild(mainHeader);
          targetContainer = document.createElement('div');
          targetContainer.id = 'main-list-container';
          servicesListContainer.appendChild(targetContainer);
        }
      } else {
        targetContainer = document.getElementById('add-on-list-container');
        if (!targetContainer) {
          // Create add-ons section if it doesn't exist
          const addOnHeader = document.createElement('div');
          addOnHeader.className = 'mb-4 mt-8';
          addOnHeader.innerHTML = `
            <div class="flex items-center justify-between">
              <button id="btn-salon-more-addons" class="py-2 px-4 rounded-xl border hover:bg-gray-100 font-bold text-primary-dark">
                <i class="fas fa-plus-circle ml-2 text-orange-500"></i>الإضافات
              </button>
            </div>
            <p class="text-gray-600 text-sm">خدمات إضافية لا تحتاج وقت في الجدولة (المدة تلقائياً 0 دقيقة)</p>
          `;
          servicesListContainer.appendChild(addOnHeader);
          targetContainer = document.createElement('div');
          targetContainer.id = 'add-on-list-container';
          servicesListContainer.appendChild(targetContainer);
        }
      }

      // Create service card
      const serviceCard = ensureServiceCardRendered(newService, servicePrice, serviceDuration);
      if (serviceCard) {
        targetContainer.appendChild(serviceCard);
        
        // Trigger auto-save
        if (window.scheduleAutoSave) {
          window.scheduleAutoSave();
        }
        
        showMessage(servicesMessage, `تم إضافة خدمة "${serviceName}" بنجاح!`, true);
        
        // Close the modal after successful addition
        closeModal();
      }
      
    } catch (error) {
      console.error('Error adding manual service:', error);
      showMessage(servicesMessage, 'حدث خطأ أثناء إضافة الخدمة. يرجى المحاولة مرة أخرى.', false);
    }
  });
});
</script>

<!-- Header is non-sticky now -->

<!-- Update Manager Script -->
<script src="/update-manager.js"></script>

</body>
</html>
