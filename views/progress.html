<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>التقدم والنمو - Saloony</title>
  <link rel="icon" href="/Images/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    :root { 
      --primary:#0f172a; 
      --primary-darker:#0b1320; 
      --secondary:#0ea5e9; 
      --accent:#10b981; 
      --border:#e5e7eb; 
      --muted:#6b7280; 
      --surface:#ffffff; 
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background:#f3f6fb; color:#0f172a; margin:0; }
    header { position:fixed; top:0; left:0; right:0; background:#0f172a; color:#fff; padding:12px 16px; padding-top: env(safe-area-inset-top); display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:20; }
    .btn { display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; border:none; }
    .btn-primary { background:#0f172a; color:#fff; }
    .btn-primary:hover { background:#0b1320; }
    main { padding: calc(88px + env(safe-area-inset-top)) 16px 120px; max-width: 1250px; margin: 0 auto; }
    .grid { display:grid; gap:16px; }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .card { background:var(--surface); border:1px solid var(--border); border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,0.06); padding:18px; }
    .card h3 { margin:0 0 8px; font-size:16px; font-weight:800; color:#0f172a; }
    .kpi { display:flex; align-items:center; justify-content:space-between; }
    .kpi .value { font-size:34px; font-weight:900; color:#2563eb; text-shadow: 0 2px 10px rgba(37,99,235,0.25); letter-spacing:.02em; }
    .kpi .label { color:#64748b; font-weight:800; letter-spacing:.02em; }
    .filters { display:grid; grid-template-columns: 1fr 160px 160px; gap:12px; }
    input, select { width:100%; border:1px solid var(--border); border-radius:12px; padding:10px 14px; font-size:14px; background:#fff; }
    .table-wrapper { background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table { width:100%; border-collapse:collapse; min-width: 720px; }
    thead th { background:#f9fafb; color:#6b7280; font-size:12px; letter-spacing:.04em; text-transform:uppercase; text-align:right; padding:12px 16px; }
    tbody td { padding:14px 16px; font-size:14px; border-top:1px solid #f1f5f9; }
    tr:hover td { background:#f9fafb; }
    .muted { color: var(--muted); }
    /* Bottom Navbar */
    .bottom-nav {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(6px);
      border-top: 2px solid rgba(14,165,233,0.2);
      padding: 6px 12px;
      display:flex; align-items:center; justify-content:space-around;
      position: fixed; bottom: 0; left:0; right:0; width:100vw;
      z-index: 9999; min-height: 62px; box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -8px 24px rgba(14,165,233,0.15);
    }
    .nav-item { display:flex; flex-direction:column; align-items:center; padding:8px 12px; border-radius:12px; transition: all .25s ease; color:#6b7280; }
    .nav-item i { font-size:20px; }
    .nav-item span { font-size:12px; margin-top:4px; font-weight:700; }
    .nav-item:hover { color:#0ea5e9; background: rgba(14,165,233,0.08); }
    .nav-active { color:#0ea5e9; background: rgba(14,165,233,0.12); }
    /* Micro-interactions */
    .card { transition: transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,0.10); }

    /* Mobile fixes */
    @media (max-width: 640px) {
      header { padding: 10px 12px; }
      main { padding-top: calc(80px + env(safe-area-inset-top)); }
      .grid-4 { grid-template-columns: 1fr; }
      .kpi .value { font-size: 26px; }
      .filters { grid-template-columns: 1fr; }
      .card { padding: 14px; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:8px">
      <i class="fas fa-chart-line"></i>
      <strong>لوحة التقدم والنمو</strong>
    </div>
    <button class="btn btn-primary" onclick="window.location.href='/admin_dashboard.html'">
      <i class="fas fa-arrow-right"></i>
      عودة للوحة الإدارة
    </button>
  </header>

  <main>
    <!-- Sections controlled by bottom navbar -->

    <!-- Overview Section -->
    <section id="tab-overview" class="grid">
      <!-- KPIs -->
      <div class="grid grid-4">
        <div class="card kpi">
          <div>
            <div class="label">صالونات انضمت اليوم</div>
            <div class="value" id="kpi-today">0</div>
          </div>
          <div style="background:#FEF3C7; color:#B45309; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-sun"></i><span>اليوم</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">صالونات هذا الشهر</div>
            <div class="value" id="kpi-month">0</div>
          </div>
          <div style="background:#DBEAFE; color:#1D4ED8; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-calendar-alt"></i><span>شهري</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">إجمالي الصالونات المنضمة</div>
            <div class="value" id="kpi-total">0</div>
          </div>
          <div style="background:#D1FAE5; color:#065F46; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-store-alt"></i><span>إجمالي</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">نسبة النمو مقابل الشهر الماضي</div>
            <div class="value" id="kpi-growth">0%</div>
          </div>
          <div style="background:#E0E7FF; color:#3730A3; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-arrow-up-right-dots"></i><span>نمو</span></div>
        </div>
      </div>

      <!-- Revenue KPIs -->
      <div class="grid grid-4">
        <div class="card kpi" style="border-image: linear-gradient(90deg, rgba(14,165,233,0.35), rgba(16,185,129,0.35)) 1; border-width:1px">
          <div>
            <div class="label">إيراد هذا الشهر</div>
            <div class="value" id="kpi-revenue-month">₪0</div>
          </div>
          <div style="background:#DBEAFE; color:#1D4ED8; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-wallet"></i><span>شهري</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">إيراد اليوم</div>
            <div class="value" id="kpi-revenue-today">₪0</div>
          </div>
          <div style="background:#FEF3C7; color:#B45309; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-bolt"></i><span>اليوم</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">إجمالي الإيراد</div>
            <div class="value" id="kpi-revenue-total">₪0</div>
          </div>
          <div style="background:#D1FAE5; color:#065F46; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-coins"></i><span>إجمالي</span></div>
        </div>
        <div class="card kpi">
          <div>
            <div class="label">نمو الإيراد مقابل الشهر الماضي</div>
            <div class="value" id="kpi-revenue-growth">0%</div>
          </div>
          <div style="background:#E0E7FF; color:#3730A3; padding:8px 10px; border-radius:10px; font-weight:800; display:flex; align-items:center; gap:8px"><i class="fas fa-chart-line"></i><span>نمو</span></div>
        </div>
      </div>

      
      <!-- Charts removed per request -->
    </section>

    <!-- Monthly Section -->
    <section id="tab-monthly" class="grid" style="display:none">
      <div class="card">
        <h3>تفصيل شهري للانضمام</h3>
        <div id="monthly-breakdown" class="table-wrapper">
          <p class="text-center muted" style="padding: 24px;">جاري التحميل...</p>
        </div>
      </div>
    </section>

    <!-- Details Section -->
    <section id="tab-details" class="grid" style="display:none">
      <div class="card">
        <h3>قائمة الصالونات المنضمة</h3>
        <div class="filters" style="grid-template-columns: 160px 160px 160px; margin-top: 12px;">
          <select id="details-year"></select>
          <select id="details-month"></select>
          <select id="details-day"></select>
        </div>
        <div class="table-wrapper" id="onboarded-list">
          <p class="text-center muted" style="padding: 24px;">جاري التحميل...</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation Bar -->
  <nav class="bottom-nav" id="progress-bottom-nav">
    <button class="nav-item nav-active" data-tab="overview"><i class="fas fa-chart-pie"></i><span>نظرة عامة</span></button>
    <button class="nav-item" data-tab="monthly"><i class="fas fa-calendar-alt"></i><span>شهري</span></button>
    <button class="nav-item" data-tab="details"><i class="fas fa-list-ul"></i><span>تفاصيل</span></button>
  </nav>

  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) { window.location.replace('/auth.html'); }

    let salons = [];
    let payments = [];
    let onboarding = []; // { salon_id, salon_name, city, gender, onboard_date }

    function monthKey(d) {
      const dt = new Date(d);
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    }
    function formatMonthLabel(key) {
      const [y,m] = key.split('-');
      return `${m}/${y}`;
    }
    function formatDate(d) {
      try { return new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' }); } catch { return d; }
    }
    function formatCurrencyILS(amount) {
      const num = Number(amount || 0);
      return `₪${num.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    }

    async function loadData() {
      const [salonsRes, paymentsRes] = await Promise.all([
        fetch('/api/admin/salons', { headers:{ 'Authorization': `Bearer ${adminToken}` } }),
        fetch('/api/admin/payments', { headers:{ 'Authorization': `Bearer ${adminToken}` } })
      ]);
      salons = await salonsRes.json();
      payments = await paymentsRes.json();

      // Build onboarding date per salon: earliest completed payment date (as proxy)
      const bySalon = new Map();
      for (const p of payments) {
        if (p.payment_status === 'completed' || p.payment_status === 'مكتملة') {
          const first = bySalon.get(p.salon_id);
          if (!first || new Date(p.created_at) < new Date(first)) {
            bySalon.set(p.salon_id, p.created_at);
          }
        }
      }
      onboarding = salons
        .filter(s => s.status === 'accepted')
        .map(s => ({
          salon_id: s.id,
          salon_name: s.salon_name,
          city: s.city,
          gender: s.gender_focus,
          onboard_date: bySalon.get(s.id) || null
        }))
        .filter(s => s.onboard_date); // only salons with activation date

      refreshAllViews();
    }

    // Overview filters removed per request

    function getFilteredOnboarding() {
      return onboarding.slice();
    }

    function computeKPIs() {
      const data = getFilteredOnboarding();
      const today = new Date();
      const todayKey = today.toISOString().slice(0,10);
      const monthKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

      const kpiTotal = data.length;
      const kpiToday = data.filter(o => o.onboard_date && o.onboard_date.slice(0,10) === todayKey).length;
      const kpiMonth = data.filter(o => monthKey(o.onboard_date) === monthKeyStr).length;

      // Growth vs last month
      const lastMonthKey = `${today.getFullYear()}-${String(today.getMonth()).padStart(2,'0')}`;
      const lastMonth = data.filter(o => monthKey(o.onboard_date) === lastMonthKey).length;
      const growth = lastMonth === 0 ? (kpiMonth > 0 ? 100 : 0) : Math.round(((kpiMonth - lastMonth) / lastMonth) * 100);

      document.getElementById('kpi-total').textContent = kpiTotal;
      document.getElementById('kpi-today').textContent = kpiToday;
      document.getElementById('kpi-month').textContent = kpiMonth;
      document.getElementById('kpi-growth').textContent = `${growth}%`;
    }

    function computeRevenueKPIs() {
      // Restrict to completed payments and to salons passing filters
      const allowedSalonIds = new Set(getFilteredOnboarding().map(o => o.salon_id));
      const completed = payments.filter(p => (p.payment_status === 'completed' || p.payment_status === 'مكتملة') && allowedSalonIds.has(p.salon_id));

      const today = new Date();
      const todayKey = today.toISOString().slice(0,10);
      const monthKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      const lastMonthKey = `${today.getFullYear()}-${String(today.getMonth()).padStart(2,'0')}`;

      const sumAll = completed.reduce((acc, p) => acc + Number(p.amount || 0), 0);
      const sumToday = completed.filter(p => p.created_at?.slice(0,10) === todayKey)
                                .reduce((acc, p) => acc + Number(p.amount || 0), 0);
      const sumMonth = completed.filter(p => monthKey(p.created_at) === monthKeyStr)
                                .reduce((acc, p) => acc + Number(p.amount || 0), 0);
      const sumLastMonth = completed.filter(p => monthKey(p.created_at) === lastMonthKey)
                                   .reduce((acc, p) => acc + Number(p.amount || 0), 0);
      const revGrowth = sumLastMonth === 0 ? (sumMonth > 0 ? 100 : 0) : Math.round(((sumMonth - sumLastMonth) / sumLastMonth) * 100);

      document.getElementById('kpi-revenue-total').textContent = formatCurrencyILS(sumAll);
      document.getElementById('kpi-revenue-today').textContent = formatCurrencyILS(sumToday);
      document.getElementById('kpi-revenue-month').textContent = formatCurrencyILS(sumMonth);
      document.getElementById('kpi-revenue-growth').textContent = `${revGrowth}%`;
    }

    let monthlyChart, growthChart;
    function renderCharts() {
      const data = getFilteredOnboarding().slice().sort((a,b) => new Date(a.onboard_date) - new Date(b.onboard_date));
      const monthlyMap = new Map();
      for (const o of data) {
        const k = monthKey(o.onboard_date);
        monthlyMap.set(k, (monthlyMap.get(k) || 0) + 1);
      }
      const labels = Array.from(monthlyMap.keys()).sort();
      const values = labels.map(k => monthlyMap.get(k));
      const cumulative = values.reduce((acc, v) => { acc.push((acc[acc.length-1] || 0) + v); return acc; }, []);

      const mCtx = document.getElementById('monthlyOnboardChart');
      const gCtx = document.getElementById('growthChart');

      if (monthlyChart) monthlyChart.destroy();
      if (growthChart) growthChart.destroy();

      // Chart theme and gradients for a modern professional feel
      const gradientBar = mCtx.getContext('2d').createLinearGradient(0, 0, 0, 160);
      gradientBar.addColorStop(0, 'rgba(14,165,233,0.9)');
      gradientBar.addColorStop(1, 'rgba(14,165,233,0.15)');

      const gctx = gCtx.getContext('2d');
      const gradientLine = gctx.createLinearGradient(0, 0, 0, 160);
      gradientLine.addColorStop(0, 'rgba(15,23,42,0.20)');
      gradientLine.addColorStop(1, 'rgba(15,23,42,0.02)');

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15,23,42,0.9)',
            titleColor: '#fff',
            bodyColor: '#e5e7eb',
            padding: 12,
            borderColor: 'rgba(255,255,255,0.15)',
            borderWidth: 1,
            displayColors: false
          }
        },
        scales: {
          x: { grid: { color: '#eef2f7' }, ticks: { color: '#64748b', font: { weight: '700' } } },
          y: { grid: { color: '#eef2f7' }, ticks: { color: '#64748b' } }
        }
      };

      monthlyChart = new Chart(mCtx, {
        type: 'bar',
        data: {
          labels: labels.map(formatMonthLabel),
          datasets: [{
            label: 'الانضمام الشهري',
            data: values,
            backgroundColor: gradientBar,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: commonOptions
      });

      growthChart = new Chart(gCtx, {
        type: 'line',
        data: {
          labels: labels.map(formatMonthLabel),
          datasets: [{
            label: 'النمو التراكمي',
            data: cumulative,
            borderColor: '#0f172a',
            backgroundColor: gradientLine,
            fill: true,
            borderWidth: 3,
            tension: 0.35,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: '#0f172a'
          }]
        },
        options: commonOptions
      });
    }

    function renderMonthlyBreakdown() {
      const container = document.getElementById('monthly-breakdown');
      const data = getFilteredOnboarding();
      const monthlyMap = new Map();
      for (const o of data) {
        const k = monthKey(o.onboard_date);
        monthlyMap.set(k, (monthlyMap.get(k) || 0) + 1);
      }
      const rows = Array.from(monthlyMap.entries()).sort((a,b) => a[0].localeCompare(b[0]));
      container.innerHTML = `
        <table>
          <thead><tr><th>الشهر</th><th>عدد الصالونات</th></tr></thead>
          <tbody>
            ${rows.map(([k, v]) => `<tr><td>${formatMonthLabel(k)}</td><td>${v}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
    }

    function renderOnboardedList() {
      const container = document.getElementById('onboarded-list');
      const data = getFilteredOnboarding().filter(o => {
        const ySel = document.getElementById('details-year');
        const mSel = document.getElementById('details-month');
        const dSel = document.getElementById('details-day');
        if (!ySel || !mSel || !dSel) return true;
        const yVal = ySel.value; // '' => all years
        const mVal = mSel.value; // '' => all months
        const dayVal = dSel.value; // '' => all days
        const dt = new Date(o.onboard_date);
        const yearOk = !yVal || dt.getFullYear() === parseInt(yVal, 10);
        const monthOk = !mVal || (dt.getMonth()+1) === parseInt(mVal, 10);
        const dayOk = !dayVal || dt.getDate() === parseInt(dayVal, 10);
        return yearOk && monthOk && dayOk;
      });
      if (data.length === 0) { container.innerHTML = '<p class="text-center muted" style="padding:24px">لا توجد نتائج.</p>'; return; }
      container.innerHTML = `
        <table>
          <thead><tr><th>الصالون</th><th>المدينة</th><th>الفئة</th><th>تاريخ الانضمام</th></tr></thead>
          <tbody>
            ${data.map(o => `<tr><td>${o.salon_name}</td><td>${o.city || '---'}</td><td>${o.gender === 'women' ? 'نساء' : 'رجال'}</td><td>${formatDate(o.onboard_date)}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
    }

    function refreshAllViews() {
      computeKPIs();
      computeRevenueKPIs();
      renderMonthlyBreakdown();
      renderOnboardedList();
    }

    // Tabs behavior via bottom navbar
    document.addEventListener('DOMContentLoaded', () => {
      loadData().catch(e => console.error('Progress load error', e));
      // Populate Details filters (year/month) and default to current
      (function initDetailFilters(){
        const monthNames = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
        const ySel = document.getElementById('details-year');
        const mSel = document.getElementById('details-month');
        const dSel = document.getElementById('details-day');
        if (ySel && mSel) {
          const now = new Date();
          const currentYear = now.getFullYear();
          const startYear = 2025;
          const years = [];
          for (let y = startYear; y <= currentYear; y++) years.push(y);
          ySel.innerHTML = `<option value="">كل السنوات</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
          ySel.value = String(currentYear);
          mSel.innerHTML = `<option value="">كل الأشهر</option>` + monthNames.map((name, idx) => `<option value="${idx+1}">${name}</option>`).join('');
          mSel.value = String(now.getMonth()+1);
          function daysInMonth(year, month) { return new Date(year, month, 0).getDate(); }
          function updateDaysOptions() {
            const yVal = ySel.value;
            const mVal = mSel.value;
            if (!dSel) return;
            if (!mVal) {
              dSel.innerHTML = `<option value="">كل الأيام</option>`;
              dSel.value = '';
              dSel.disabled = true;
              return;
            }
            dSel.disabled = false;
            const theYear = yVal ? parseInt(yVal, 10) : currentYear;
            const theMonth = parseInt(mVal, 10);
            const count = daysInMonth(theYear, theMonth);
            const options = Array.from({ length: count }, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
            dSel.innerHTML = `<option value="">كل الأيام</option>` + options;
            dSel.value = '';
          }
          updateDaysOptions();
          window.__updateDaysOptions = updateDaysOptions;
        }
      })();
      document.getElementById('details-year')?.addEventListener('change', () => { window.__updateDaysOptions?.(); renderOnboardedList(); });
      document.getElementById('details-month')?.addEventListener('change', () => { window.__updateDaysOptions?.(); renderOnboardedList(); });
      document.getElementById('details-day')?.addEventListener('change', renderOnboardedList);
      const nav = document.getElementById('progress-bottom-nav');
      nav.addEventListener('click', (e) => {
        const btn = e.target.closest('.nav-item');
        if (!btn) return;
        document.querySelectorAll('#progress-bottom-nav .nav-item').forEach(b => b.classList.remove('nav-active'));
        btn.classList.add('nav-active');
        const t = btn.dataset.tab;
        document.getElementById('tab-overview').style.display = (t === 'overview') ? '' : 'none';
        document.getElementById('tab-monthly').style.display = (t === 'monthly') ? '' : 'none';
        document.getElementById('tab-details').style.display = (t === 'details') ? '' : 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  </script>
</body>
</html>