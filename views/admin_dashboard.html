<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saloony - لوحة تحكم الإدارة</title>
    <link rel="icon" type="image/png" href="/images/Saloony-app_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #F8FAFC; /* Light background */
            padding-bottom: 64px; /* Space for the fixed bottom navigation */
        }

        .bg-primary-dark { background-color: #1E293B; } /* Deep Charcoal Blue/Slate */
        .text-secondary { color: #06C167; } /* Vibrant Teal-Green Accent */
        .btn-approve { background-color: #06C167; color: #1E293B; }
        .btn-reject { background-color: #EF4444; color: white; }
        
        .nav-active {
            color: #06C167 !important; 
            background-color: rgba(6, 193, 103, 0.1) !important; 
            border-radius: 0.75rem !important;
            box-shadow: 0 2px 8px rgba(6, 193, 103, 0.2) !important;
        }
        .nav-item { padding: 0.5rem; }

        /* Card styles */
        .stat-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: flex-start;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 95%;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            margin: auto;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }
        .modal-open {
            display: flex !important;
            opacity: 1 !important;
        }
        .modal-open .modal-content {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }

        /* Responsive Table Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body dir="rtl">
<script>
    // Security Check: Ensure admin token exists
    (function() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            // Redirect to splash/auth if no admin token
            window.location.replace('/auth.html'); 
        }
    })();
</script>

<div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-primary-dark shadow-lg p-2 flex justify-between items-center w-full z-20 fixed top-0">
        <div class="flex items-center pl-8 pr-4">
            <img src="/images/Saloony_logo.png" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1E293B/ffffff?text=ADM';" alt="Saloony Admin" class="w-12 h-12 object-contain object-center scale-[2.5]">
        </div>
        <h1 class="text-xl font-bold text-white">لوحة تحكم الإدارة</h1>
        <button id="logout-btn" class="text-white/80 hover:text-red-400 transition duration-150 p-2 rounded-lg hover:bg-white/10">
            <i class="fas fa-sign-out-alt text-lg"></i>
        </button>
    </header>

    <main class="flex-grow p-4 pt-[60px] md:p-8">
        <div id="message-box" class="hidden p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto" role="alert"></div>
        <div class="max-w-6xl mx-auto space-y-8">

            <!-- 1. Dashboard Overview -->
            <div id="dashboard-view" class="view-content">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2">نظرة عامة</h2>
                <div id="stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <p class="col-span-full text-center text-gray-500">جاري تحميل الإحصائيات...</p>
                </div>
            </div>

            <!-- 2. Pending Salons -->
            <div id="pending-salons-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-red-500/50 pb-2 flex justify-between items-center">
                    <span class="inline-flex items-center gap-2">
                         <i class="fas fa-clock-rotate-left text-red-500"></i> الصالونات قيد الانتظار (<span id="pending-count">0</span>)
                    </span>
                    <button id="refresh-pending-btn" class="text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-sync-alt ml-1"></i> تحديث
                    </button>
                </h2>
                <div id="pending-salons-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل الصالونات...</p>
                </div>
            </div>

            <!-- 3. All Salons -->
            <div id="all-salons-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2">إدارة الصالونات</h2>
                <div id="all-salons-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل جميع الصالونات...</p>
                </div>
            </div>
            
            <!-- 4. All Users -->
            <div id="all-users-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2">إدارة المستخدمين</h2>
                <div id="all-users-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل المستخدمين...</p>
                </div>
            </div>
            
            <!-- 5. Payments -->
            <div id="payments-view" class="view-content hidden">
                <h2 class="text-3xl font-extrabold text-primary-dark mb-6 border-b-4 border-secondary/50 pb-2">إدارة المدفوعات</h2>
                
                <!-- Search and Filter Controls -->
                <div class="mb-6 space-y-4 bg-white p-4 rounded-xl shadow-sm">
                    <!-- Search Bar -->
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <input type="text" id="admin-payment-search" placeholder="البحث في المدفوعات (رقم الفاتورة، اسم الصالون، المبلغ...)" 
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-light focus:border-primary-dark transition-colors">
                            <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <!-- QR Scanner Button -->
                        <button id="qr-scanner-btn" class="px-6 py-3 bg-gradient-to-r from-primary-dark to-secondary text-white rounded-xl hover:shadow-lg transition-all duration-200 flex items-center gap-2 whitespace-nowrap">
                            <i class="fas fa-qrcode text-lg"></i>
                            <span class="font-medium">مسح QR</span>
                        </button>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="flex flex-wrap gap-3">
                        <select id="admin-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">جميع الحالات</option>
                            <option value="completed">مكتملة</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="failed">فاشلة</option>
                        </select>
                        
                        <select id="admin-type-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                            <option value="">جميع الأنواع</option>
                            <option value="offer_200ils">عرض 200 شيكل</option>
                            <option value="monthly_subscription">اشتراك شهري</option>
                            <option value="annual_subscription">اشتراك سنوي</option>
                        </select>
                        
                        <input type="date" id="admin-date-from" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark" placeholder="من تاريخ">
                        <input type="date" id="admin-date-to" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark" placeholder="إلى تاريخ">
                        
                        <button id="admin-clear-filters" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times ml-2"></i>
                            مسح الفلاتر
                        </button>
                    </div>
                </div>
                
                <div id="payments-list" class="table-wrapper">
                    <p class="text-center text-gray-500 p-8">جاري تحميل المدفوعات...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar (Fixed for PWA feel) -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full p-2 pb-5 flex justify-around shadow-2xl z-20">
        <button id="nav-dashboard" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-secondary nav-active" data-view="dashboard-view">
            <i class="fas fa-tachometer-alt text-xl"></i>
            <span class="text-xs font-bold mt-1">الرئيسية</span>
        </button>
        <button id="nav-pending" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="pending-salons-view">
            <i class="fas fa-user-clock text-xl"></i>
            <span class="text-xs font-medium mt-1">الانتظار</span>
            <span id="nav-pending-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
        </button>
        <button id="nav-salons" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="all-salons-view">
            <i class="fas fa-store-alt text-xl"></i>
            <span class="text-xs font-medium mt-1">الصالونات</span>
        </button>
        <button id="nav-users" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="all-users-view">
            <i class="fas fa-users text-xl"></i>
            <span class="text-xs font-medium mt-1">المستخدمين</span>
        </button>
        <button id="nav-payments" class="nav-item flex flex-col items-center p-3 rounded-xl transition-all duration-300 text-gray-500 hover:text-secondary hover:bg-secondary/10" data-view="payments-view">
            <i class="fas fa-receipt text-xl"></i>
            <span class="text-xs font-medium mt-1">المدفوعات</span>
        </button>
    </nav>
</div>

<!-- Salon Approval/Rejection Modal -->
<div id="approval-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-primary-dark mb-4 text-center">مراجعة الصالون</h3>
        <div id="salon-details-view" class="space-y-3 p-4 bg-gray-50 rounded-lg">
            <p><span class="font-bold text-primary-dark">اسم الصالون:</span> <span id="modal-salon-name">...</span></p>
            <p><span class="font-bold text-primary-dark">اسم المالك:</span> <span id="modal-owner-name">...</span></p>
            <p><span class="font-bold text-primary-dark">هاتف المالك:</span> <span id="modal-owner-phone">...</span></p>
            <p><span class="font-bold text-primary-dark">البريد الإلكتروني:</span> <span id="modal-email">...</span></p>
            <p><span class="font-bold text-primary-dark">العنوان:</span> <span id="modal-address">...</span></p>
            <p><span class="font-bold text-primary-dark">الفئة المستهدفة:</span> <span id="modal-gender-focus">...</span></p>
            <div class="flex flex-col items-center pt-2">
                <span class="font-bold text-primary-dark mb-2">صورة الصالون:</span>
                <img id="modal-image-preview" src="https://placehold.co/150x100/1E293B/ffffff?text=صورة" class="w-full max-w-[200px] h-auto object-cover rounded-lg shadow-md" alt="Salon Image Preview">
            </div>
        </div>

        <div id="payment-checkbox-container" class="mt-4 p-4 border border-green-300 rounded-lg bg-green-50">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="payment-200ils-checkbox" class="h-5 w-5 text-green-600 focus:ring-green-500 ml-3 rounded">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-green-800">💰 عرض الدفع المسبق - 200 شيكل / شهرين</span>
                    <span class="text-xs text-green-700 mt-1">✅ سيتم إنشاء فاتورة دفع تلقائياً عند الموافقة</span>
                </div>
            </label>
        </div>
        
        <div class="flex justify-center space-x-4 space-x-reverse mt-6">
            <button id="approve-btn" class="flex-1 btn-approve py-3 rounded-xl font-bold hover:bg-[#05AE5D] transition">
                <i class="fas fa-check ml-2"></i> موافقة
            </button>
            <button id="reject-btn" class="flex-1 btn-reject py-3 rounded-xl font-bold hover:bg-red-600 transition">
                <i class="fas fa-times ml-2"></i> رفض
            </button>
        </div>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 mt-4 text-sm w-full">إغلاق</button></div>
    </div>
</div>

<!-- Clean Payment Details Modal -->
<div id="clean-payment-modal" class="modal-overlay">
    <div class="modal-content max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-primary-dark">تفاصيل الفاتورة</h3>
            <button onclick="closeCleanPaymentModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-primary-light to-secondary-light rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-xl font-bold text-primary-dark mb-1" id="clean-salon-name">اسم الصالون</h4>
                        <p class="text-primary-dark opacity-80" id="clean-invoice-number">رقم الفاتورة</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary-dark" id="clean-amount">المبلغ</div>
                        <div class="text-sm text-primary-dark opacity-80" id="clean-payment-type">نوع الدفع</div>
                    </div>
                </div>
            </div>
            
            <!-- Status Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-info-circle text-primary-dark"></i>
                        <span class="font-medium text-gray-700">حالة الدفع</span>
                    </div>
                    <div id="clean-status-badge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium">
                        <i id="clean-status-icon"></i>
                        <span id="clean-status-text">الحالة</span>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-credit-card text-primary-dark"></i>
                        <span class="font-medium text-gray-700">طريقة الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-payment-method">طريقة الدفع</p>
                </div>
            </div>
            
            <!-- Date Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-calendar text-primary-dark"></i>
                        <span class="font-medium text-gray-700">تاريخ الدفع</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-payment-date">التاريخ</p>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4" id="clean-valid-until-container">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-clock text-primary-dark"></i>
                        <span class="font-medium text-gray-700">صالح حتى</span>
                    </div>
                    <p class="text-gray-800 font-medium" id="clean-valid-until">التاريخ</p>
                </div>
            </div>
            
            <!-- Description Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-4" id="clean-description-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-file-text text-primary-dark"></i>
                    <span class="font-medium text-gray-700">الوصف</span>
                </div>
                <p class="text-gray-700 leading-relaxed" id="clean-description">الوصف</p>
            </div>
            
            <!-- Admin Notes Section -->
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4" id="clean-admin-notes-container">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-sticky-note text-amber-600"></i>
                    <span class="font-medium text-amber-800">ملاحظات الإدارة</span>
                </div>
                <p class="text-amber-700 leading-relaxed" id="clean-admin-notes">الملاحظات</p>
            </div>
        </div>
        
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="closeCleanPaymentModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div id="payment-details-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-primary-dark">تفاصيل الدفعة</h3>
            <button onclick="hidePaymentDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Payment Status -->
            <div class="flex items-center justify-between p-3 rounded-lg" id="payment-status-section">
                <span class="font-semibold">الحالة:</span>
                <div class="flex items-center" id="payment-status-display">
                    <i id="payment-status-icon" class="ml-2"></i>
                    <span id="payment-status-text"></span>
                </div>
            </div>
            
            <!-- Payment Details -->
            <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">رقم الفاتورة:</span>
                    <span id="payment-invoice-number" class="text-primary-dark font-mono"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">اسم الصالون:</span>
                    <span id="payment-salon-name" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">تاريخ الدفع:</span>
                    <span id="payment-date" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">نوع الدفع:</span>
                    <span id="payment-type" class="text-primary-dark"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">المبلغ:</span>
                    <span id="payment-amount" class="text-primary-dark font-bold text-lg"></span>
                </div>
                
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-700">طريقة الدفع:</span>
                    <span id="payment-method" class="text-primary-dark"></span>
                </div>
                
                <div id="payment-valid-until-section" class="flex justify-between">
                    <span class="font-semibold text-gray-700">صالح حتى:</span>
                    <span id="payment-valid-until" class="text-primary-dark"></span>
                </div>
                
                <div id="payment-description-section" class="border-t pt-3">
                    <span class="font-semibold text-gray-700 block mb-2">الوصف:</span>
                    <p id="payment-description" class="text-gray-600 text-sm"></p>
                </div>
                
                <div id="payment-admin-notes-section" class="border-t pt-3">
                    <span class="font-semibold text-gray-700 block mb-2">ملاحظات الإدارة:</span>
                    <p id="payment-admin-notes" class="text-gray-600 text-sm"></p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center mt-6">
            <button onclick="hidePaymentDetailsModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qr-scanner-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-primary-dark">مسح رمز QR للفاتورة</h3>
            <button onclick="closeQRScanner()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Camera Preview -->
            <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 300px;">
                <video id="qr-video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <div class="absolute inset-0 flex items-center justify-center" id="qr-loading">
                    <div class="text-center">
                        <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">جاري تشغيل الكاميرا...</p>
                    </div>
                </div>
                <div class="absolute inset-0 border-2 border-dashed border-primary-dark opacity-50 m-8 rounded-lg"></div>
            </div>
            
            <!-- Manual Input Fallback -->
            <div class="border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">أو أدخل رقم الفاتورة يدوياً:</label>
                <div class="flex gap-2">
                    <input type="text" id="manual-invoice-input" placeholder="رقم الفاتورة" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-light focus:border-primary-dark">
                    <button onclick="searchByManualInput()" class="px-4 py-2 bg-primary-dark text-white rounded-lg hover:bg-primary-darker transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div id="qr-scan-result" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <span class="font-medium text-green-800">تم العثور على الفاتورة!</span>
                    </div>
                    <p id="qr-result-text" class="text-sm text-green-700"></p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeQRScanner()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                إلغاء
            </button>
        </div>
    </div>
</div>

<script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
        // Redirection already handled above, but here for local script safety
        window.location.replace('/auth.html'); 
    }

    let currentView = 'dashboard-view';
    let pendingSalonsData = [];

    // Utility function to display messages
    const showMessage = (element, message, isSuccess = true) => {
        element.classList.remove('hidden'); 
        element.textContent = message;
        element.className = 'p-3 mb-4 text-center rounded-xl font-medium max-w-6xl mx-auto';
        
        element.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'border-red-200', 'border-green-200');
        
        element.classList.add('border');
        element.classList.add(...(isSuccess ? ['bg-green-100', 'text-green-700', 'border-green-200'] : ['bg-red-100', 'text-red-700', 'border-red-200']));
        
        setTimeout(() => { element.classList.add('hidden'); }, 5000);
    };
    const messageBox = document.getElementById('message-box');

    // Utility function to format date
    const formatDate = (dateString) => {
        if (!dateString) return 'غير محدد';
        try {
            // Handle different server date formats (ISO, YYYY-MM-DD HH:MM:SS)
            let date = new Date(dateString);
            if (dateString.includes(' ') && !dateString.includes('T')) {
                date = new Date(dateString.replace(' ', 'T'));
            }
            if (isNaN(date.getTime())) {
                return dateString;
            }
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch (e) {
            return dateString;
        }
    };
    
    // Utility function to format status
    const formatStatus = (status) => {
        let color = 'bg-gray-200 text-gray-700';
        let text = 'غير معروف';
        if (status === 'pending') {
            color = 'bg-yellow-100 text-yellow-800';
            text = 'قيد الانتظار';
        } else if (status === 'accepted') {
            color = 'bg-[#06C167]/20 text-secondary';
            text = 'مقبول / نشط';
        } else if (status === 'rejected') {
            color = 'bg-red-100 text-red-700';
            text = 'مرفوض';
        }
        return `<span class="px-3 py-1 rounded-full text-xs font-bold ${color}">${text}</span>`;
    };

    // --- View Switching ---
    const views = {
        'dashboard-view': document.getElementById('dashboard-view'),
        'pending-salons-view': document.getElementById('pending-salons-view'),
        'all-salons-view': document.getElementById('all-salons-view'),
        'all-users-view': document.getElementById('all-users-view'),
        'payments-view': document.getElementById('payments-view'),
    };
    
    const navItems = document.querySelectorAll('.nav-item');

    const switchView = async (viewId) => {
        Object.values(views).forEach(view => view.classList.add('hidden'));
        views[viewId].classList.remove('hidden');

        navItems.forEach(btn => {
            btn.classList.remove('nav-active', 'text-secondary', 'text-gray-500');
            btn.classList.add('text-gray-500', 'hover:text-secondary', 'hover:bg-secondary/10');
            btn.querySelector('span:last-child').classList.remove('font-bold');
            btn.querySelector('span:last-child').classList.add('font-medium');
            if (btn.getAttribute('data-view') === viewId) {
                btn.classList.add('nav-active', 'text-secondary');
                btn.classList.remove('text-gray-500', 'hover:text-secondary', 'hover:bg-secondary/10');
                btn.querySelector('span:last-child').classList.add('font-bold');
                btn.querySelector('span:last-child').classList.remove('font-medium');
            }
        });
        
        currentView = viewId;
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if (viewId === 'dashboard-view') {
            await loadAdminStats();
        } else if (viewId === 'pending-salons-view') {
            await loadSalons('pending');
        } else if (viewId === 'all-salons-view') {
            await loadSalons('all');
        } else if (viewId === 'all-users-view') {
            await loadUsers();
        } else if (viewId === 'payments-view') {
            await loadPayments();
        }
    };
    
    // --- Data Loading Functions ---

    const loadAdminStats = async () => {
        const grid = document.getElementById('stats-grid');
        grid.innerHTML = '<p class="col-span-full text-center text-gray-500">جاري تحميل الإحصائيات...</p>';
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const stats = await response.json();
            
            // Define stat cards
            const statCards = [
                { title: 'إجمالي المستخدمين', count: stats.totalUsers || 0, icon: 'fa-users', color: 'text-blue-500' },
                { title: 'إجمالي الصالونات', count: stats.totalSalons || 0, icon: 'fa-store-alt', color: 'text-primary-dark' },
                { title: 'صالونات قيد الانتظار', count: stats.pendingSalons || 0, icon: 'fa-user-clock', color: 'text-red-500' },
                { title: 'المواعيد الكلية', count: stats.totalAppointments || 0, icon: 'fa-calendar-check', color: 'text-secondary' },
                { title: 'الصالونات النشطة', count: stats.activeSalons || 0, icon: 'fa-check-circle', color: 'text-green-500' },
                { title: 'صالونات الرجال', count: stats.menSalons || 0, icon: 'fa-mars', color: 'text-indigo-500' },
                { title: 'صالونات النساء', count: stats.womenSalons || 0, icon: 'fa-venus', color: 'text-pink-500' },
                { title: 'المدفوعات المكتملة', count: '---', icon: 'fa-receipt', color: 'text-orange-500' },
            ];
            
            grid.innerHTML = statCards.map(card => `
                <div class="stat-card">
                    <div class="space-y-1">
                        <p class="text-gray-500 text-sm">${card.title}</p>
                        <p class="text-3xl font-extrabold text-primary-dark">${card.count}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center ${card.color} bg-gray-100/50">
                        <i class="fas ${card.icon} text-xl"></i>
                    </div>
                </div>
            `).join('');

            // Update pending badge in navigation
            const badge = document.getElementById('nav-pending-badge');
            const pendingCountEl = document.getElementById('pending-count');
            const pendingCount = parseInt(stats.pendingSalons || 0);
            if (badge) {
                badge.textContent = pendingCount;
                badge.classList.toggle('hidden', pendingCount === 0);
            }
            if (pendingCountEl) {
                 pendingCountEl.textContent = pendingCount;
            }

        } catch (error) {
            console.error('Error fetching stats:', error);
            grid.innerHTML = '<p class="col-span-full text-center text-red-500">فشل تحميل الإحصائيات.</p>';
            showMessage(messageBox, 'فشل تحميل الإحصائيات من الخادم.', false);
        }
    };

    const loadSalons = async (filter) => {
        const container = filter === 'pending' ? document.getElementById('pending-salons-list') : document.getElementById('all-salons-list');
        const listName = filter === 'pending' ? 'Pending Salons' : 'All Salons';
        
        container.innerHTML = `<p class="text-center text-gray-500 p-8">جاري تحميل ${listName}...</p>`;

        try {
            const response = await fetch('/api/admin/salons', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const allSalons = await response.json();
            
            pendingSalonsData = allSalons.filter(s => s.status === 'pending');
            const filteredSalons = filter === 'all' ? allSalons : pendingSalonsData;

            if (filter === 'pending') {
                 const badge = document.getElementById('nav-pending-badge');
                 const pendingCountEl = document.getElementById('pending-count');
                 const count = pendingSalonsData.length;
                 if (badge) {
                     badge.textContent = count;
                     badge.classList.toggle('hidden', count === 0);
                 }
                 if (pendingCountEl) {
                    pendingCountEl.textContent = count;
                 }
            }

            if (filteredSalons.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">لا توجد صالونات ${filter === 'pending' ? 'قيد الانتظار' : 'مسجلة'} حالياً.</p>`;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200 bg-white rounded-xl shadow-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم الصالون</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المالك / الهاتف</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المدينة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الفئة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${filteredSalons.map((salon, index) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-dark font-bold">${salon.salon_name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                    ${salon.owner_name} <br> <span class="text-xs text-gray-500">${salon.owner_phone}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${salon.city}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${salon.gender_focus === 'women' ? 'نساء' : 'رجال'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${formatStatus(salon.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="view-salon-btn text-blue-600 hover:text-blue-800 transition duration-150 p-1 rounded" data-id="${salon.id}">
                                        <i class="fas fa-eye ml-1"></i> عرض
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.querySelectorAll('.view-salon-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const salonId = parseInt(e.currentTarget.dataset.id);
                    const salon = pendingSalonsData.find(s => s.id === salonId) || allSalons.find(s => s.id === salonId);
                    if (salon) {
                        showApprovalModal(salon);
                    } else {
                        showMessage(messageBox, 'فشل العثور على بيانات الصالون.', false);
                    }
                });
            });

        } catch (error) {
            console.error('Error fetching salons:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات الصالونات.</p>';
        }
    };
    
    const loadUsers = async () => {
        const container = document.getElementById('all-users-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل المستخدمين...</p>';
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const users = await response.json();

            if (users.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد سجلات مستخدمين حالياً.</p>';
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200 bg-white rounded-xl shadow-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">البريد الإلكتروني</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الهاتف</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المدينة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النوع</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${users.map((user, index) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-primary-dark">${user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.email}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.phone || '---'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${user.city || '---'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${user.user_type === 'user' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'}">
                                        ${user.user_type === 'user' ? 'مستخدم' : user.user_type === 'salon' ? 'صالون' : 'إدارة'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error fetching users:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات المستخدمين.</p>';
        }
    };
    
    const loadPayments = async () => {
        const container = document.getElementById('payments-list');
        container.innerHTML = '<p class="text-center text-gray-500 p-8">جاري تحميل المدفوعات...</p>';
        try {
            const response = await fetch('/api/admin/payments', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const payments = await response.json();

            // Store all payments globally for filtering
            window.allAdminPayments = payments;

            if (payments.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد سجلات مدفوعات حالياً.</p>';
                return;
            }

            renderAdminPayments(payments);
        } catch (error) {
            console.error('Error fetching payments:', error);
            container.innerHTML = '<p class="text-center text-red-500 p-8">فشل تحميل بيانات المدفوعات.</p>';
        }
    };

    const renderAdminPayments = (payments) => {
        const container = document.getElementById('payments-list');
        
        if (payments.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8">لا توجد نتائج تطابق البحث.</p>';
            return;
        }

        // Clean and minimal payment cards
        container.innerHTML = `
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                ${payments.map((p, index) => {
                    const paymentDate = formatDate(p.created_at);
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden">
                            <div class="p-6">
                                <!-- Salon Name -->
                                <div class="mb-3">
                                    <h3 class="font-bold text-lg text-gray-800 truncate">${p.salon_name || 'غير محدد'}</h3>
                                </div>
                                
                                <!-- Invoice Number -->
                                <div class="mb-3">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-hashtag text-primary-dark text-sm"></i>
                                        <span class="text-sm text-gray-600">رقم الفاتورة:</span>
                                    </div>
                                    <p class="font-mono text-primary-dark font-medium mt-1">${p.invoice_number}</p>
                                </div>
                                
                                <!-- Date -->
                                <div class="mb-4">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-calendar text-primary-dark text-sm"></i>
                                        <span class="text-sm text-gray-600">التاريخ:</span>
                                    </div>
                                    <p class="text-gray-800 font-medium mt-1">${paymentDate}</p>
                                </div>
                                
                                <!-- View Details Button -->
                                <button onclick="showCleanPaymentModal(${JSON.stringify(p).replace(/"/g, '&quot;')})" 
                                        class="w-full flex items-center justify-center gap-2 px-4 py-3 border-2 border-primary-dark bg-transparent text-primary-dark rounded-lg hover:bg-primary-dark hover:text-white hover:shadow-md transition-all duration-200 font-medium">
                                    <i class="fas fa-eye text-primary-dark"></i>
                                    <span>عرض التفاصيل</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    };

    // Filter and search functionality for admin payments
    const filterAdminPayments = () => {
        if (!window.allAdminPayments) return;
        
        const searchTerm = document.getElementById('admin-payment-search')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-status-filter')?.value || '';
        const typeFilter = document.getElementById('admin-type-filter')?.value || '';
        const dateFrom = document.getElementById('admin-date-from')?.value || '';
        const dateTo = document.getElementById('admin-date-to')?.value || '';

        let filteredPayments = window.allAdminPayments.filter(payment => {
            // Search filter
            const matchesSearch = !searchTerm || 
                payment.invoice_number?.toLowerCase().includes(searchTerm) ||
                payment.salon_name?.toLowerCase().includes(searchTerm) ||
                payment.amount?.toString().includes(searchTerm) ||
                payment.description?.toLowerCase().includes(searchTerm);

            // Status filter
            const matchesStatus = !statusFilter || payment.payment_status === statusFilter;

            // Type filter
            const matchesType = !typeFilter || payment.payment_type === typeFilter;

            // Date filter
            const paymentDate = new Date(payment.created_at);
            const matchesDateFrom = !dateFrom || paymentDate >= new Date(dateFrom);
            const matchesDateTo = !dateTo || paymentDate <= new Date(dateTo + 'T23:59:59');

            return matchesSearch && matchesStatus && matchesType && matchesDateFrom && matchesDateTo;
        });

        renderAdminPayments(filteredPayments);
    };

    // Clear all filters for admin payments
    const clearAdminFilters = () => {
        document.getElementById('admin-payment-search').value = '';
        document.getElementById('admin-status-filter').value = '';
        document.getElementById('admin-type-filter').value = '';
        document.getElementById('admin-date-from').value = '';
        document.getElementById('admin-date-to').value = '';
        if (window.allAdminPayments) {
            renderAdminPayments(window.allAdminPayments);
        }
    };

    // --- Modal and Action Functions ---
    let currentSalonId = null;

    const showApprovalModal = (salon) => {
        currentSalonId = salon.id;
        document.getElementById('modal-salon-name').textContent = salon.salon_name;
        document.getElementById('modal-owner-name').textContent = salon.owner_name;
        document.getElementById('modal-owner-phone').textContent = salon.owner_phone;
        document.getElementById('modal-email').textContent = salon.email;
        document.getElementById('modal-address').textContent = `${salon.address}, ${salon.city}`;
        document.getElementById('modal-gender-focus').textContent = salon.gender_focus === 'women' ? 'نساء' : 'رجال';
        
        const imgEl = document.getElementById('modal-image-preview');
        imgEl.src = salon.image_url || 'https://placehold.co/150x100/1E293B/ffffff?text=صورة';
        imgEl.onerror = function() { this.src = 'https://placehold.co/150x100/1E293B/ffffff?text=صورة'; };
        
        // Hide offer checkbox if salon is already accepted
        const offerContainer = document.getElementById('offer-checkbox-container');
        if (offerContainer) {
            offerContainer.classList.toggle('hidden', salon.status !== 'pending');
        }

        const modal = document.getElementById('approval-modal');
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    };

    const hideApprovalModal = () => {
        const modal = document.getElementById('approval-modal');
        modal.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
        currentSalonId = null;
        // Reset checkbox state
        document.getElementById('payment-200ils-checkbox').checked = false;
    };
    
    const updateSalonStatus = async (status) => {
        if (!currentSalonId) return;

        const approveBtn = document.getElementById('approve-btn');
        const rejectBtn = document.getElementById('reject-btn');
        const payment200ils = document.getElementById('payment-200ils-checkbox').checked;

        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        
        const originalApproveText = approveBtn.innerHTML;
        const originalRejectText = rejectBtn.innerHTML;

        if (status === 'accepted') {
            approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الموافقة...';
        } else {
            rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الرفض...';
        }

        try {
            const response = await fetch(`/api/admin/salon/status/${currentSalonId}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status, payment200ils })
            });

            const result = await response.json();

            if (response.ok) {
                showMessage(messageBox, `تم تحديث حالة الصالون إلى: ${status === 'accepted' ? 'مقبول' : 'مرفوض'}.`, true);
                hideApprovalModal();
                await loadSalons('pending'); // Reload pending list
                if (currentView === 'dashboard-view') {
                     await loadAdminStats(); // Refresh stats
                } else if (currentView === 'all-salons-view') {
                     await loadSalons('all'); // Refresh full list
                }
            } else {
                showMessage(messageBox, result.error || 'فشل في تحديث الحالة.', false);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showMessage(messageBox, 'خطأ في الشبكة.', false);
        } finally {
            approveBtn.disabled = false;
            rejectBtn.disabled = false;
            approveBtn.innerHTML = originalApproveText;
            rejectBtn.innerHTML = originalRejectText;
        }
    };
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        navItems.forEach(btn => {
            btn.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view));
        });

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('adminToken');
            window.location.replace('/auth.html');
        });
        
        document.getElementById('refresh-pending-btn').addEventListener('click', () => loadSalons('pending'));

        // Modal actions
        document.getElementById('close-modal-btn').addEventListener('click', hideApprovalModal);
        document.getElementById('approve-btn').addEventListener('click', () => updateSalonStatus('accepted'));
        document.getElementById('reject-btn').addEventListener('click', () => updateSalonStatus('rejected'));

        // Initial load
        switchView('dashboard-view');
    });

    // Payment Details Modal Functions
    function showAdminPaymentDetails(payment) {
        // Set payment status with color and icon
        const statusSection = document.getElementById('payment-status-section');
        const statusIcon = document.getElementById('payment-status-icon');
        const statusText = document.getElementById('payment-status-text');
        
        if (payment.payment_status === 'completed') {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-green-100';
            statusIcon.className = 'fas fa-check-circle text-green-600 ml-2';
            statusText.textContent = 'مكتملة';
            statusText.className = 'text-green-800 font-semibold';
        } else if (payment.payment_status === 'pending') {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-yellow-100';
            statusIcon.className = 'fas fa-clock text-yellow-600 ml-2';
            statusText.textContent = 'قيد الانتظار';
            statusText.className = 'text-yellow-800 font-semibold';
        } else if (payment.payment_status === 'failed') {
            statusSection.className = 'flex items-center justify-between p-3 rounded-lg bg-red-100';
            statusIcon.className = 'fas fa-times-circle text-red-600 ml-2';
            statusText.textContent = 'فاشلة';
            statusText.className = 'text-red-800 font-semibold';
        }
        
        // Set payment details
        document.getElementById('payment-invoice-number').textContent = payment.invoice_number || 'غير متوفر';
        document.getElementById('payment-salon-name').textContent = payment.salon_name || 'غير متوفر';
        document.getElementById('payment-date').textContent = new Date(payment.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Payment type localization
        const paymentTypeMap = {
            'offer_200ils': 'عرض 200 شيكل',
            'monthly_subscription': 'اشتراك شهري',
            'annual_subscription': 'اشتراك سنوي'
        };
        document.getElementById('payment-type').textContent = paymentTypeMap[payment.payment_type] || payment.payment_type;
        
        document.getElementById('payment-amount').textContent = `${payment.amount} ${payment.currency}`;
        
        // Payment method localization
        const paymentMethodMap = {
            'cash': 'نقداً',
            'credit_card': 'بطاقة ائتمان',
            'bank_transfer': 'تحويل بنكي',
            'paypal': 'باي بال'
        };
        document.getElementById('payment-method').textContent = paymentMethodMap[payment.payment_method] || payment.payment_method;
        
        // Conditional fields
        const validUntilSection = document.getElementById('payment-valid-until-section');
        if (payment.valid_until) {
            validUntilSection.style.display = 'flex';
            document.getElementById('payment-valid-until').textContent = new Date(payment.valid_until).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } else {
            validUntilSection.style.display = 'none';
        }
        
        const descriptionSection = document.getElementById('payment-description-section');
        if (payment.description) {
            descriptionSection.style.display = 'block';
            document.getElementById('payment-description').textContent = payment.description;
        } else {
            descriptionSection.style.display = 'none';
        }
        
        const adminNotesSection = document.getElementById('payment-admin-notes-section');
        if (payment.admin_notes) {
            adminNotesSection.style.display = 'block';
            document.getElementById('payment-admin-notes').textContent = payment.admin_notes;
        } else {
            adminNotesSection.style.display = 'none';
        }
        
        // Show modal
        document.getElementById('payment-details-modal').style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function hidePaymentDetailsModal() {
        document.getElementById('payment-details-modal').style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    // Close modal when clicking outside
    document.getElementById('payment-details-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            hidePaymentDetailsModal();
        }
    });

    // Add event listeners for admin payment filters
    document.addEventListener('DOMContentLoaded', function() {
        // Search and filter event listeners
        document.getElementById('admin-payment-search')?.addEventListener('input', filterAdminPayments);
        document.getElementById('admin-status-filter')?.addEventListener('change', filterAdminPayments);
        document.getElementById('admin-type-filter')?.addEventListener('change', filterAdminPayments);
        document.getElementById('admin-date-from')?.addEventListener('change', filterAdminPayments);
        document.getElementById('admin-date-to')?.addEventListener('change', filterAdminPayments);
        document.getElementById('admin-clear-filters')?.addEventListener('click', clearAdminFilters);
        
        // QR Scanner event listener
    document.getElementById('qr-scanner-btn')?.addEventListener('click', openQRScanner);
    
    // Clean Payment Modal event listeners
    document.getElementById('clean-payment-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCleanPaymentModal();
        }
    });
});

    // QR Scanner Functions
    let qrStream = null;
    let qrScanning = false;

    function openQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        const video = document.getElementById('qr-video');
        const loading = document.getElementById('qr-loading');
        
        modal.classList.add('modal-open');
        
        // Start camera
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment' // Use back camera if available
            } 
        })
        .then(stream => {
            qrStream = stream;
            video.srcObject = stream;
            loading.style.display = 'none';
            startQRScanning();
        })
        .catch(err => {
            console.error('Camera access denied:', err);
            loading.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
                    <p class="text-red-600">لا يمكن الوصول للكاميرا</p>
                    <p class="text-sm text-gray-500">استخدم الإدخال اليدوي أدناه</p>
                </div>
            `;
        });
    }

    // Clean Payment Modal Functions
    function showCleanPaymentModal(payment) {
        const modal = document.getElementById('clean-payment-modal');
        
        // Populate modal with payment data
        document.getElementById('clean-salon-name').textContent = payment.salon_name || 'غير محدد';
        document.getElementById('clean-invoice-number').textContent = `فاتورة رقم: ${payment.invoice_number}`;
        
        // Amount and type
        const amount = parseFloat(payment.amount).toFixed(2);
        document.getElementById('clean-amount').textContent = `${amount} ${payment.currency}`;
        const type = payment.payment_type === 'offer_200ils' ? 'عرض شهرين - 200 شيكل' : payment.payment_type;
        document.getElementById('clean-payment-type').textContent = type;
        
        // Status with styling
        const statusBadge = document.getElementById('clean-status-badge');
        const statusIcon = document.getElementById('clean-status-icon');
        const statusText = document.getElementById('clean-status-text');
        
        if (payment.payment_status === 'completed') {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-green-50 border border-green-200 text-green-800';
            statusIcon.className = 'fas fa-check-circle text-green-600';
            statusText.textContent = 'مكتمل';
        } else if (payment.payment_status === 'pending') {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-50 border border-yellow-200 text-yellow-800';
            statusIcon.className = 'fas fa-clock text-yellow-600';
            statusText.textContent = 'معلق';
        } else {
            statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium bg-red-50 border border-red-200 text-red-800';
            statusIcon.className = 'fas fa-times-circle text-red-600';
            statusText.textContent = 'فاشل';
        }
        
        // Payment method
        document.getElementById('clean-payment-method').textContent = payment.payment_method || 'غير محدد';
        
        // Dates
        document.getElementById('clean-payment-date').textContent = formatDate(payment.created_at);
        
        const validUntilContainer = document.getElementById('clean-valid-until-container');
        if (payment.valid_until) {
            validUntilContainer.style.display = 'block';
            document.getElementById('clean-valid-until').textContent = formatDate(payment.valid_until);
        } else {
            validUntilContainer.style.display = 'none';
        }
        
        // Description
        const descriptionContainer = document.getElementById('clean-description-container');
        if (payment.description && payment.description.trim()) {
            descriptionContainer.style.display = 'block';
            document.getElementById('clean-description').textContent = payment.description;
        } else {
            descriptionContainer.style.display = 'none';
        }
        
        // Admin notes
        const adminNotesContainer = document.getElementById('clean-admin-notes-container');
        if (payment.admin_notes && payment.admin_notes.trim()) {
            adminNotesContainer.style.display = 'block';
            document.getElementById('clean-admin-notes').textContent = payment.admin_notes;
        } else {
            adminNotesContainer.style.display = 'none';
        }
        
        // Store payment data for editing
        modal.dataset.paymentData = JSON.stringify(payment);
        
        // Show modal
        modal.classList.add('modal-open');
        document.body.classList.add('modal-open');
    }

    function closeCleanPaymentModal() {
        const modal = document.getElementById('clean-payment-modal');
        modal.classList.remove('modal-open');
        document.body.classList.remove('modal-open');
    }

    function editPaymentFromModal() {
        const modal = document.getElementById('clean-payment-modal');
        const paymentData = JSON.parse(modal.dataset.paymentData);
        closeCleanPaymentModal();
        showAdminPaymentDetails(paymentData);
    }

    function closeQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        const video = document.getElementById('qr-video');
        const loading = document.getElementById('qr-loading');
        const result = document.getElementById('qr-scan-result');
        
        // Stop camera
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }
        
        qrScanning = false;
        modal.classList.remove('modal-open');
        
        // Reset UI
        loading.style.display = 'flex';
        loading.innerHTML = `
            <div class="text-center">
                <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">جاري تشغيل الكاميرا...</p>
            </div>
        `;
        result.classList.add('hidden');
        document.getElementById('manual-invoice-input').value = '';
    }

    function startQRScanning() {
        // Simple QR detection simulation
        // In a real implementation, you'd use a QR code library like jsQR
        qrScanning = true;
        
        // For demo purposes, we'll just listen for manual input
        // In production, implement actual QR scanning with jsQR library
    }

    function searchByManualInput() {
        const input = document.getElementById('manual-invoice-input');
        const invoiceNumber = input.value.trim();
        
        if (!invoiceNumber) {
            alert('يرجى إدخال رقم الفاتورة');
            return;
        }
        
        searchInvoiceByNumber(invoiceNumber);
    }

    function searchInvoiceByNumber(invoiceNumber) {
        if (!window.allAdminPayments) {
            alert('لم يتم تحميل البيانات بعد');
            return;
        }
        
        // Search for invoice
        const payment = window.allAdminPayments.find(p => 
            p.invoice_number === invoiceNumber || 
            p.id.toString() === invoiceNumber
        );
        
        if (payment) {
            // Show success result
            const result = document.getElementById('qr-scan-result');
            const resultText = document.getElementById('qr-result-text');
            
            resultText.textContent = `الفاتورة: ${payment.invoice_number} - ${payment.salon_name} - ${payment.amount} ${payment.currency}`;
            result.classList.remove('hidden');
            
            // Auto-filter to show only this invoice
            setTimeout(() => {
                closeQRScanner();
                
                // Set search term to invoice number
                const searchInput = document.getElementById('admin-payment-search');
                if (searchInput) {
                    searchInput.value = invoiceNumber;
                    filterAdminPayments();
                }
                
                // Show payment details
                setTimeout(() => {
                    showAdminPaymentDetails(payment);
                }, 500);
            }, 2000);
        } else {
            alert('لم يتم العثور على فاتورة بهذا الرقم');
        }
    }
</script>
</body>
</html>
